<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>CKA笔记 - Linux技术博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Linux技术博客"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Linux技术博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1 准备DNS解析"><meta property="og:type" content="blog"><meta property="og:title" content="罗宇"><meta property="og:url" content="https://luovip.github.io/"><meta property="og:site_name" content="罗宇"><meta property="og:description" content="1 准备DNS解析"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://luovip.github.io/img/avatar.png"><meta property="article:published_time" content="2025-05-10T05:12:42.000Z"><meta property="article:modified_time" content="2025-05-11T07:30:59.334Z"><meta property="article:author" content="removeif"><meta property="article:tag" content="CKA笔记"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://luovip.github.io/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2025/05/10/CKA%E8%AE%A4%E8%AF%81/CKA%E7%AC%94%E8%AE%B0/"},"headline":"Linux技术博客","image":["http://example.com/img/cka-exam.jpg"],"datePublished":"2025-05-10T05:12:42.000Z","dateModified":"2025-05-11T07:30:59.334Z","author":{"@type":"Person","name":"罗宇"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject"}},"description":"1 准备DNS解析"}</script><link rel="canonical" href="http://example.com/2025/05/10/CKA%E8%AE%A4%E8%AF%81/CKA%E7%AC%94%E8%AE%B0/"><link rel="icon" href="/img/favicon.svg"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/6.0.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark-reasonable.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/css/cyberpunk.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdnjs.loli.net/ajax/libs/pace/1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Linux技术博客</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">音乐</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/about">关于我</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/img/cka-exam.jpg" alt="CKA笔记"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2025-05-10 13:12:42  <span class="level-item"> 罗宇 </span><a class="commentCountImg" href="/2025/05/10/CKA%E8%AE%A4%E8%AF%81/CKA%E7%AC%94%E8%AE%B0/#comment-container"><span class="display-none-class">/2025/05/10/CKA认证/CKA笔记/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="a127c554dbbaf6f0531d577c53651058">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>2 小时  <i class="fas fa-pencil-alt"> </i>20.2 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">CKA笔记</h1><div class="content"><h1 id="1-准备DNS解析"><a href="#1-准备DNS解析" class="headerlink" title="1 准备DNS解析"></a>1 准备DNS解析</h1><span id="more"></span>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这一步需要在所有机器上完成</span></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.8.3 k8s-master</span></span><br><span class="line"><span class="string">192.168.8.4 k8s-worker1</span></span><br><span class="line"><span class="string">192.168.8.5 k8s-worker2</span></span><br><span class="line"><span class="string">192.168.30.133 registry.xiaohui.cn</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h1 id="2-Docker-CE-部署"><a href="#2-Docker-CE-部署" class="headerlink" title="2 Docker CE 部署"></a>2 Docker CE 部署</h1><h2 id="2-1-添加Docker仓库"><a href="#2-1-添加Docker仓库" class="headerlink" title="2.1 添加Docker仓库"></a>2.1 添加Docker仓库</h2><p>&emsp;&emsp;为了节约网络流量和时间，这一步只在k8s-master这一台机器上完成</p>
<p>&emsp;&emsp;如需练习worker节点加入到k8s集群的操作，在k8s-master上初始化好k8s集群后，再来其他节点完成这个步骤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y ca-certificates curl gnupg lsb-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加公钥到系统</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://mirrors.nju.edu.cn/docker-ce/linux/ubuntu/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加仓库到系统</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://mirrors.nju.edu.cn/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断仓库是否已做好</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line">root@k8s-master:~# apt update</span><br><span class="line">Hit:1 https://mirrors.nju.edu.cn/docker-ce/linux/ubuntu noble InRelease</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="2-2-安装Docker-CE"><a href="#2-2-安装Docker-CE" class="headerlink" title="2.2 安装Docker CE"></a>2.2 安装Docker CE</h2><p>&emsp;&emsp;为了节约网络流量和时间，这一步只在k8s-master这一台机器上完成</p>
<p>&emsp;&emsp;如需练习worker节点加入到k8s集群的操作，在k8s-master上初始化好k8s集群后，再来其他节点完成这个步骤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"><span class="comment"># 部署完Docker CE之后，还需要cri-docker shim才可以和Kubernetes集成</span></span><br></pre></td></tr></table></figure>

<h2 id="2-3-CRI-Docker-部署"><a href="#2-3-CRI-Docker-部署" class="headerlink" title="2.3 CRI-Docker 部署"></a>2.3 CRI-Docker 部署</h2><p>&emsp;&emsp;为了节约网络流量和时间，这一步只在k8s-master这一台机器上完成</p>
<p>&emsp;&emsp;如需练习worker节点加入到k8s集群的操作，在k8s-master上初始化好k8s集群后，再来其他节点完成这个步骤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载cri-docker</span></span><br><span class="line">wget http://hub.gitmirror.com/https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.17/cri-dockerd_0.3.17.3-0.ubuntu-jammy_amd64.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装cri-docker</span></span><br><span class="line">dpkg -i cri-dockerd_0.3.17.3-0.ubuntu-jammy_amd64.deb</span><br></pre></td></tr></table></figure>

<h3 id="2-3-1-将镜像指引到国内"><a href="#2-3-1-将镜像指引到国内" class="headerlink" title="2.3.1 将镜像指引到国内"></a>2.3.1 将镜像指引到国内</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /lib/systemd/system/cri-docker.service /etc/systemd/system/cri-docker.service</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;s/ExecStart=.*/ExecStart=\/usr\/bin\/cri-dockerd --container-runtime-endpoint fd:\/\/ --network-plugin=cni --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com\/google_containers\/pause:3.10/&#x27;</span> /etc/systemd/system/cri-docker.service</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart cri-docker.service</span><br><span class="line">systemctl <span class="built_in">enable</span> cri-docker.service</span><br></pre></td></tr></table></figure>

<h1 id="3-Containerd-部署"><a href="#3-Containerd-部署" class="headerlink" title="3 Containerd 部署"></a>3 Containerd 部署</h1><h2 id="3-1-安装Containerd"><a href="#3-1-安装Containerd" class="headerlink" title="3.1 安装Containerd"></a>3.1 安装Containerd</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/containerd/nerdctl/releases/download/v1.7.7/nerdctl-full-1.7.7-linux-amd64.tar.gz</span><br><span class="line">tar Cxzvvf /usr/local nerdctl-full-1.7.7-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<h2 id="3-2-生成配置文件"><a href="#3-2-生成配置文件" class="headerlink" title="3.2 生成配置文件"></a>3.2 生成配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line"><span class="comment">#使用systemd</span></span><br><span class="line">sed -i <span class="string">&#x27;s/SystemdCgroup = false/SystemdCgroup = true/&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"><span class="comment">#沙盒镜像改为国内</span></span><br><span class="line">sed -i <span class="string">&#x27;s|sandbox_image = &quot;registry.k8s.io/pause:3.8&quot;|sandbox_image = &quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.10&quot;|&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"><span class="comment">#添加加速器地址</span></span><br><span class="line">sed -i <span class="string">&#x27;/\[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry\]/&#123;n;s|config_path = &quot;&quot;|config_path = &quot;/etc/containerd/certs.d&quot;|&#125;&#x27;</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>

<h2 id="3-3-使用镜像加速器"><a href="#3-3-使用镜像加速器" class="headerlink" title="3.3 使用镜像加速器"></a>3.3 使用镜像加速器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/containerd/certs.d/docker.io -p</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/containerd/certs.d/docker.io/hosts.toml &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">server = <span class="string">&quot;https://xxx.xxx.xxx&quot;</span></span><br><span class="line">[host.<span class="string">&quot;https://xxx.xxx.xxx&quot;</span>]</span><br><span class="line">  capabilities = [<span class="string">&quot;pull&quot;</span>, <span class="string">&quot;resolve&quot;</span>, <span class="string">&quot;push&quot;</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="3-4-启动Containerd服务"><a href="#3-4-启动Containerd服务" class="headerlink" title="3.4 启动Containerd服务"></a>3.4 启动Containerd服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now containerd</span><br><span class="line">systemctl <span class="built_in">enable</span> --now buildkit</span><br></pre></td></tr></table></figure>

<h2 id="3-5-nerdctl命令自动补齐"><a href="#3-5-nerdctl命令自动补齐" class="headerlink" title="3.5 nerdctl命令自动补齐"></a>3.5 nerdctl命令自动补齐</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nerdctl completion bash &gt; /etc/bash_completion.d/nerdctl</span><br><span class="line"><span class="built_in">source</span> /etc/bash_completion.d/nerdctl</span><br></pre></td></tr></table></figure>

<h1 id="4-创建第一个容器"><a href="#4-创建第一个容器" class="headerlink" title="4 创建第一个容器"></a>4 创建第一个容器</h1><h2 id="4-1-运行容器"><a href="#4-1-运行容器" class="headerlink" title="4.1 运行容器"></a>4.1 运行容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8000:80 --name container1 class-docker.myk8s.cn/library/nginx</span><br><span class="line">docker ps</span><br><span class="line">CONTAINER ID    IMAGE                             COMMAND                   CREATED          STATUS    PORTS                   NAMES</span><br><span class="line">eea8ed66990c    class-docker.myk8s.cn/library/nginx:latest    <span class="string">&quot;/docker-entrypoint.…&quot;</span>    7 seconds ago    Up        0.0.0.0:8000-&gt;80/tcp    container1 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果用的是containerd，运行容器的命令就是下面这样的</span></span><br><span class="line">nerdctl run -d -p 8000:80 --name container1 class-docker.myk8s.cn/library/nginx</span><br><span class="line">nerdctl ps</span><br><span class="line">CONTAINER ID    IMAGE                                                   COMMAND                   CREATED           STATUS    PORTS                   NAMES</span><br><span class="line">1353d09a9df3    class-docker.myk8s.cn/library/nginx:latest    <span class="string">&quot;/docker-entrypoint.…&quot;</span>    21 seconds ago    Up        0.0.0.0:8000-&gt;80/tcp    container1</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;参数解释：</p>
<p>&emsp;&emsp;&emsp;-d 是指后台运行</p>
<p>&emsp;&emsp;&emsp;-p 是端口映射，此处是将宿主机的8000端口和容器内的80端口映射到一起</p>
<p>&emsp;&emsp;&emsp;–name 是指容器的名字</p>
<p>&emsp;&emsp;&emsp;nginx 是指本次使用的镜像名字</p>
<h2 id="4-2-进入容器"><a href="#4-2-进入容器" class="headerlink" title="4.2 进入容器"></a>4.2 进入容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it container1 /bin/bash</span><br><span class="line">root@eea8ed66990c:/# <span class="built_in">echo</span> hello lixiaohui &gt; /usr/share/nginx/html/index.html</span><br><span class="line">root@eea8ed66990c:/# <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果用的是containerd，进入容器的命令就是下面这样的</span></span><br><span class="line"><span class="comment"># exec -it 是指通过交互式进入terminal</span></span><br><span class="line">nerdctl <span class="built_in">exec</span> -it container1 /bin/bash</span><br><span class="line">root@1353d09a9df3:/# <span class="built_in">echo</span> hello lixiaohui &gt; /usr/share/nginx/html/index.html</span><br><span class="line">root@1353d09a9df3:/# <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h2 id="4-3-访问容器内容"><a href="#4-3-访问容器内容" class="headerlink" title="4.3 访问容器内容"></a>4.3 访问容器内容</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:8000</span><br><span class="line">hello lixiaohui</span><br></pre></td></tr></table></figure>

<h1 id="5-镜像相关操作"><a href="#5-镜像相关操作" class="headerlink" title="5 镜像相关操作"></a>5 镜像相关操作</h1><h2 id="5-1-Commit-构建"><a href="#5-1-Commit-构建" class="headerlink" title="5.1 Commit 构建"></a>5.1 Commit 构建</h2><p>1.将上述实验中的container1容器生成一个新的镜像：nginx:v1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker commit container1 nginx:v1</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>
<p>2.如果用的是containerd，commit方法构建容器镜像的命令就是下面这样的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nerdctl commit container1 nginx:v1</span><br><span class="line">nerdctl images</span><br></pre></td></tr></table></figure>

<p>3.输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY    TAG       IMAGE ID        CREATED           PLATFORM       SIZE         BLOB SIZE</span><br><span class="line">nginx         latest    0d17b565c37b    13 minutes ago    linux/amd64    149.1 MiB    54.1 MiB</span><br><span class="line">nginx         v1        edc2905109d8    5 seconds ago     linux/amd64    149.2 MiB    54.1 MiB</span><br></pre></td></tr></table></figure>

<h2 id="5-2-使用Commit镜像"><a href="#5-2-使用Commit镜像" class="headerlink" title="5.2 使用Commit镜像"></a>5.2 使用Commit镜像</h2><p>1.使用nginx:v1镜像在本机的3000端口提供一个名为lixiaohuicommit的容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3000:80 --name lixiaohuicommit nginx:v1</span><br><span class="line">curl http://127.0.0.1:3000</span><br><span class="line"></span><br><span class="line">hello lixiaohui</span><br></pre></td></tr></table></figure>

<p>2.如果用的是containerd，使用容器镜像的命令就是下面这样的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nerdctl run -d -p 3000:80 --name lixiaohuicommit nginx:v1</span><br><span class="line">curl http://127.0.0.1:3000</span><br><span class="line"></span><br><span class="line">hello lixiaohui</span><br></pre></td></tr></table></figure>

<h2 id="5-3-Dockerfile构建"><a href="#5-3-Dockerfile构建" class="headerlink" title="5.3 Dockerfile构建"></a>5.3 Dockerfile构建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; dockerfile &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">FROM class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">MAINTAINER 939958092@qq.com</span></span><br><span class="line"><span class="string">RUN echo hello lixiaohui dockerfile container &gt; /usr/local/apache2/htdocs/index.html</span></span><br><span class="line"><span class="string">EXPOSE 80</span></span><br><span class="line"><span class="string">WORKDIR /usr/local/apache2/htdocs/</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t httpd:v1 -f dockerfile .</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<p>如果用的是containerd，dockerfile方式构建容器镜像的命令就是下面这样的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nerdctl build  -t httpd:v1 -f dockerfile .</span><br><span class="line">nerdctl images</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY    TAG       IMAGE ID        CREATED               PLATFORM       SIZE         BLOB SIZE</span><br><span class="line">httpd         v1        494736083f8f    About a minute ago    linux/amd64    150.2 MiB    53.8 MiB</span><br><span class="line">nginx         latest    2d17cc4981bf    4 minutes ago         linux/amd64    149.1 MiB    54.1 MiB</span><br><span class="line">nginx         v1        fc81b1ce4076    3 minutes ago         linux/amd64    149.2 MiB    54.1 MiB</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;docker build -t httpd:v1 -f dockerfile .<br>&emsp;&emsp;不管是docker还是nerdctl，这个命令后面还有一个英文的句号.是指当前目录</p>
<h2 id="5-4-使用Dockerfile镜像"><a href="#5-4-使用Dockerfile镜像" class="headerlink" title="5.4 使用Dockerfile镜像"></a>5.4 使用Dockerfile镜像</h2><p>1.用httpd:v1的镜像在本机4000端口上提供一个名为lixiaohuidockerfile的容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 4000:80 --name lixiaohuidockerfile httpd:v1</span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure>
<p>2.如果用的是containerd，dockerfile方式构建容器镜像的使用命令就是下面这样的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nerdctl run -d -p 4000:80 --name lixiaohuidockerfile httpd:v1</span><br><span class="line">nerdctl ps</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID    IMAGE                             COMMAND                   CREATED          STATUS    PORTS                   NAMES</span><br><span class="line">534323e724a7    docker.io/library/nginx:latest    <span class="string">&quot;/docker-entrypoint.…&quot;</span>    5 minutes ago    Up        0.0.0.0:8000-&gt;80/tcp    container1             </span><br><span class="line">7ee887b78a75    docker.io/library/httpd:v1        <span class="string">&quot;httpd-foreground&quot;</span>        3 seconds ago    Up        0.0.0.0:4000-&gt;80/tcp    lixiaohuidockerfile    </span><br><span class="line">a41ef87ba51f    docker.io/library/nginx:v1        <span class="string">&quot;/docker-entrypoint.…&quot;</span>    3 minutes ago    Up        0.0.0.0:3000-&gt;80/tcp    lixiaohuicommit        </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:4000</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello lixiaohui dockerfile container</span><br></pre></td></tr></table></figure>

<h2 id="5-5-删除容器"><a href="#5-5-删除容器" class="headerlink" title="5.5 删除容器"></a>5.5 删除容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> -f container1 lixiaohuidockerfile lixiaohuicommit </span><br></pre></td></tr></table></figure>

<h1 id="6-构建私有仓库"><a href="#6-构建私有仓库" class="headerlink" title="6 构建私有仓库"></a>6 构建私有仓库</h1><p>&emsp;&emsp;构建私有仓库请使用另外一台单独的机器，将IP设置为192.168.30.133，并确保在本文档最开始的地方在所有节点之间执行了添加&#x2F;etc&#x2F;hosts文件操作</p>
<h2 id="6-1-生成root证书信息"><a href="#6-1-生成root证书信息" class="headerlink" title="6.1 生成root证书信息"></a>6.1 生成root证书信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out /etc/ssl/private/selfsignroot.key 4096</span><br><span class="line">openssl req -x509 -new -nodes -sha512 -days 3650 -subj <span class="string">&quot;/C=CN/ST=Shanghai/L=Shanghai/O=Company/OU=SH/CN=Root&quot;</span> \</span><br><span class="line">-key /etc/ssl/private/selfsignroot.key \</span><br><span class="line">-out /usr/local/share/ca-certificates/selfsignroot.crt</span><br></pre></td></tr></table></figure>

<h2 id="6-2-生成服务器私钥以及证书请求文件"><a href="#6-2-生成服务器私钥以及证书请求文件" class="headerlink" title="6.2 生成服务器私钥以及证书请求文件"></a>6.2 生成服务器私钥以及证书请求文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out /etc/ssl/private/registry.key 4096</span><br><span class="line">openssl req -sha512 -new \</span><br><span class="line">-subj <span class="string">&quot;/C=CN/ST=Shanghai/L=Shanghai/O=Company/OU=SH/CN=xiaohui.cn&quot;</span> \</span><br><span class="line">-key /etc/ssl/private/registry.key \</span><br><span class="line">-out registry.csr</span><br></pre></td></tr></table></figure>

<h2 id="6-3-生成openssl-cnf扩展文件"><a href="#6-3-生成openssl-cnf扩展文件" class="headerlink" title="6.3 生成openssl cnf扩展文件"></a>6.3 生成openssl cnf扩展文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; certs.cnf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[req]</span></span><br><span class="line"><span class="string">req_extensions = v3_req</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">[req_distinguished_name]</span></span><br><span class="line"><span class="string">[v3_req ]</span></span><br><span class="line"><span class="string">basicConstraints = CA:FALSE</span></span><br><span class="line"><span class="string">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1 = registry.xiaohui.cn</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="6-4-签发证书"><a href="#6-4-签发证书" class="headerlink" title="6.4 签发证书"></a>6.4 签发证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> registry.csr \</span><br><span class="line">-CA /usr/local/share/ca-certificates/selfsignroot.crt \</span><br><span class="line">-CAkey /etc/ssl/private/selfsignroot.key -CAcreateserial \</span><br><span class="line">-out /etc/ssl/certs/registry.crt \</span><br><span class="line">-days 3650 -extensions v3_req -extfile certs.cnf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="6-5-信任根证书"><a href="#6-5-信任根证书" class="headerlink" title="6.5 信任根证书"></a>6.5 信任根证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update-ca-certificates</span><br></pre></td></tr></table></figure>

<h2 id="6-6-部署Harbor仓库"><a href="#6-6-部署Harbor仓库" class="headerlink" title="6.6 部署Harbor仓库"></a>6.6 部署Harbor仓库</h2><h3 id="6-6-1-部署Docker-CE"><a href="#6-6-1-部署Docker-CE" class="headerlink" title="6.6.1 部署Docker CE"></a>6.6.1 部署Docker CE</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://mirror.nju.edu.cn/docker-ce/linux/ubuntu/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://mirror.nju.edu.cn/docker-ce/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="6-6-2-添加Docker镜像加速器"><a href="#6-6-2-添加Docker镜像加速器" class="headerlink" title="6.6.2 添加Docker镜像加速器"></a>6.6.2 添加Docker镜像加速器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只限在国内部署时才需要加速，在国外这样加速反而缓慢</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://xxx.xxx.xxx&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="6-6-3-Compose支持"><a href="#6-6-3-Compose支持" class="headerlink" title="6.6.3 Compose支持"></a>6.6.3 Compose支持</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加Compose支持，并启动Docker服务</span></span><br><span class="line">curl -L <span class="string">&quot;http://hub.gitmirror.com/https://github.com/docker/compose/releases/download/v2.34.0/docker-compose-linux-x86_64&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart docker</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://hub.gitmirror.com/https://github.com/goharbor/harbor/releases/download/v2.12.2/harbor-offline-installer-v2.12.2.tgz</span><br><span class="line">tar xf harbor-offline-installer-v2.12.2.tgz -C /usr/local/bin</span><br><span class="line"><span class="built_in">cd</span> /usr/local/bin/harbor</span><br><span class="line">docker load -i harbor.v2.12.2.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="6-6-4-修改harbor-yml"><a href="#6-6-4-修改harbor-yml" class="headerlink" title="6.6.4 修改harbor.yml"></a>6.6.4 修改harbor.yml</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在harbor.yml中，修改以下参数，定义了网址、证书、密码</span></span><br><span class="line">vim harbor.yml</span><br><span class="line"><span class="comment"># 修改hostname为registry.xiaohui.cn</span></span><br><span class="line"><span class="comment"># 修改https处的certificate为/etc/ssl/certs/registry.crt</span></span><br><span class="line"><span class="comment"># 修改https处的private_key为/etc/ssl/private/registry.key</span></span><br><span class="line"><span class="comment"># 修改harbor_admin_password为admin</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./prepare</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure>

<h2 id="6-7-生成服务文件"><a href="#6-7-生成服务文件" class="headerlink" title="6.7 生成服务文件"></a>6.7 生成服务文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/harbor.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Harbor</span></span><br><span class="line"><span class="string">After=docker.service systemd-networkd.service systemd-resolved.service</span></span><br><span class="line"><span class="string">Requires=docker.service</span></span><br><span class="line"><span class="string">Documentation=http://github.com/vmware/harbor</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=5</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/docker-compose -f /usr/local/bin/harbor/docker-compose.yml up</span></span><br><span class="line"><span class="string">ExecStop=/usr/local/bin/docker-compose -f /usr/local/bin/harbor/docker-compose.yml down</span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> harbor --now</span><br></pre></td></tr></table></figure>

<h2 id="6-8-上传镜像到本地仓库"><a href="#6-8-上传镜像到本地仓库" class="headerlink" title="6.8 上传镜像到本地仓库"></a>6.8 上传镜像到本地仓库</h2><p>&emsp;&emsp;在所有的机器上，将registry.xiaohui.cn以及其对应的IP添加到&#x2F;etc&#x2F;hosts，然后将上述实验中的httpd:v1镜像，改名为带上IP:PORT形式，尝试上传我们的镜像到本地仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker login registry.xiaohui.cn</span><br><span class="line">docker tag httpd:v1 registry.xiaohui.cn/library/httpd:v1</span><br><span class="line">docker push registry.xiaohui.cn/library/httpd:v1</span><br></pre></td></tr></table></figure>

<h1 id="7-Kubernetes部署"><a href="#7-Kubernetes部署" class="headerlink" title="7 Kubernetes部署"></a>7 Kubernetes部署</h1><h2 id="7-1-关闭swap分区"><a href="#7-1-关闭swap分区" class="headerlink" title="7.1 关闭swap分区"></a>7.1 关闭swap分区</h2><p>&emsp;&emsp;为了节约网络流量和时间，这一步只在k8s-master这一台机器上完成</p>
<p>&emsp;&emsp;如需练习worker节点加入到k8s集群的操作，在k8s-master上初始化好k8s集群后，再来其他节点完成这个步骤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实时关闭</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line">sed -i <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure>

<h2 id="7-2-允许iptables检查桥接流量"><a href="#7-2-允许iptables检查桥接流量" class="headerlink" title="7.2 允许iptables检查桥接流量"></a>7.2 允许iptables检查桥接流量</h2><p>&emsp;&emsp;为了节约网络流量和时间，这一步只在k8s-master这一台机器上完成</p>
<p>&emsp;&emsp;如需练习worker节点加入到k8s集群的操作，在k8s-master上初始化好k8s集群后，再来其他节点完成这个步骤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> sysctl --system</span><br></pre></td></tr></table></figure>

<h2 id="7-3-安装kubeadm"><a href="#7-3-安装kubeadm" class="headerlink" title="7.3 安装kubeadm"></a>7.3 安装kubeadm</h2><p>&emsp;&emsp;为了节约网络流量和时间，这一步只在k8s-master这一台机器上完成</p>
<p>&emsp;&emsp;如需练习worker节点加入到k8s集群的操作，在k8s-master上初始化好k8s集群后，再来其他节点完成这个步骤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">root@k8s-master:~# apt-get update &amp;&amp; apt-get install -y apt-transport-https curl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装K8S软件包仓库-阿里云</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/apt/sources.list.d/k8s.list &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">deb https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/deb /</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装软件包仓库的公钥</span></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/deb/Release.key | apt-key add -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新软件包的仓库索引</span></span><br><span class="line">apt-get update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始安装</span></span><br><span class="line">apt-get install -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 操作系统所有软件包升级时将忽略kubelet、kubeadm、kubectl</span></span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>

<h2 id="7-4-添加命令自动补齐"><a href="#7-4-添加命令自动补齐" class="headerlink" title="7.4 添加命令自动补齐"></a>7.4 添加命令自动补齐</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl completion bash &gt; /etc/bash_completion.d/kubectl</span><br><span class="line">root@k8s-master:~# kubeadm completion bash &gt; /etc/bash_completion.d/kubeadm</span><br><span class="line">root@k8s-master:~# <span class="built_in">source</span> /etc/bash_completion.d/kubectl</span><br><span class="line">root@k8s-master:~# <span class="built_in">source</span> /etc/bash_completion.d/kubeadm</span><br></pre></td></tr></table></figure>

<h2 id="7-5-集成CRI-Docker"><a href="#7-5-集成CRI-Docker" class="headerlink" title="7.5 集成CRI-Docker"></a>7.5 集成CRI-Docker</h2><p>&emsp;&emsp;为了节约网络流量和时间，这一步只在k8s-master这一台机器上完成</p>
<p>&emsp;&emsp;如需练习worker节点加入到k8s集群的操作，在k8s-master上初始化好k8s集群后，再来其他节点完成这个步骤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保证K8S和docker进行通信</span></span><br><span class="line">root@k8s-master:~# crictl config runtime-endpoint unix:///run/cri-dockerd.sock</span><br><span class="line">WARN[0000] Config <span class="string">&quot;/etc/crictl.yaml&quot;</span> does not exist, trying next: <span class="string">&quot;/usr/bin/crictl.yaml&quot;</span></span><br><span class="line">INFO[0000] No --get, --<span class="built_in">set</span> or --list provided, setting key <span class="string">&quot;runtime-endpoint&quot;</span> to value <span class="string">&quot;unix:///run/cri-dockerd.sock&quot;</span></span><br><span class="line"></span><br><span class="line">root@k8s-master:~# crictl images</span><br><span class="line">IMAGE               TAG                 IMAGE ID            SIZE</span><br></pre></td></tr></table></figure>

<h2 id="7-6-集成containerd"><a href="#7-6-集成containerd" class="headerlink" title="7.6 集成containerd"></a>7.6 集成containerd</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crictl config runtime-endpoint unix:///run/containerd/containerd.sock</span><br><span class="line">crictl images</span><br></pre></td></tr></table></figure>

<h2 id="7-7-集群部署"><a href="#7-7-集群部署" class="headerlink" title="7.7 集群部署"></a>7.7 集群部署</h2><p>&emsp;&emsp;kubeadm.yaml中name字段必须在网络中可被解析，也可以将解析记录添加到集群中所有机器的&#x2F;etc&#x2F;hosts中</p>
<p>&emsp;&emsp;初始化集群部署的操作只能在k8s-master上执行</p>
<h3 id="7-7-1-初始化配置修改"><a href="#7-7-1-初始化配置修改" class="headerlink" title="7.7.1 初始化配置修改"></a>7.7.1 初始化配置修改</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化配置</span></span><br><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm.yaml</span><br><span class="line">sed -i <span class="string">&#x27;s/.*advert.*/  advertiseAddress: 192.168.8.3/g&#x27;</span> kubeadm.yaml</span><br><span class="line">sed -i <span class="string">&#x27;s/.*name.*/  name: k8s-master/g&#x27;</span> kubeadm.yaml</span><br><span class="line">sed -i <span class="string">&#x27;s|imageRepo.*|imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers|g&#x27;</span> kubeadm.yaml</span><br><span class="line">sed -i <span class="string">&quot;/^\\s*networking:/a\\  podSubnet: 172.16.0.0/16&quot;</span> kubeadm.yaml</span><br><span class="line"><span class="comment"># 注意下面的替换，只有在集成的是CRI-Docker时才需要执行，Containerd不需要</span></span><br><span class="line">sed -i <span class="string">&#x27;s/  criSocket.*/  criSocket: unix:\/\/\/run\/cri-dockerd.sock/&#x27;</span> kubeadm.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认配置</span></span><br><span class="line">root@k8s-master:~# vim kubeadm.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta4</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- <span class="built_in">groups</span>:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.8.3</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: unix:///run/cri-dockerd.sock</span><br><span class="line">  imagePullPolicy: IfNotPresent</span><br><span class="line">  imagePullSerial: <span class="literal">true</span></span><br><span class="line">  name: k8s-master</span><br><span class="line">  taints: null</span><br><span class="line">timeouts:</span><br><span class="line">  controlPlaneComponentHealthCheck: 4m0s</span><br><span class="line">  discovery: 5m0s</span><br><span class="line">  etcdAPICall: 2m0s</span><br><span class="line">  kubeletHealthCheck: 4m0s</span><br><span class="line">  kubernetesAPICall: 1m0s</span><br><span class="line">  tlsBootstrap: 5m0s</span><br><span class="line">  upgradeManifests: 5m0s</span><br><span class="line">---</span><br><span class="line">apiServer: &#123;&#125;</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta4</span><br><span class="line">caCertificateValidityPeriod: 87600h0m0s</span><br><span class="line">certificateValidityPeriod: 8760h0m0s</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns: &#123;&#125;</span><br><span class="line">encryptionAlgorithm: RSA-2048</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: 1.32.0</span><br><span class="line">networking:</span><br><span class="line">  podSubnet: 172.16.0.0/16</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">proxy: &#123;&#125;</span><br><span class="line">scheduler: &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-7-2-集群初始化"><a href="#7-7-2-集群初始化" class="headerlink" title="7.7.2 集群初始化"></a>7.7.2 集群初始化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模块加载</span></span><br><span class="line">root@k8s-master:~# modprobe br_netfilter</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 集群初始化</span></span><br><span class="line">root@k8s-master:~# kubeadm init --config kubeadm.yaml</span><br><span class="line">...</span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.8.3:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:0c3038d57ed67ce8da15c8f192f775a9489b340e95cd7f1fec89ab38ef7bef14</span><br></pre></td></tr></table></figure>

<h3 id="7-7-3-授权管理权限"><a href="#7-7-3-授权管理权限" class="headerlink" title="7.7.3 授权管理权限"></a>7.7.3 授权管理权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<h3 id="7-7-4-查看集群状态"><a href="#7-7-4-查看集群状态" class="headerlink" title="7.7.4 查看集群状态"></a>7.7.4 查看集群状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get nodes</span><br><span class="line">NAME         STATUS     ROLES           AGE     VERSION</span><br><span class="line">k8s-master   NotReady   control-plane   4m54s   v1.33.0</span><br></pre></td></tr></table></figure>

<h2 id="7-8-部署Calico网络插件"><a href="#7-8-部署Calico网络插件" class="headerlink" title="7.8 部署Calico网络插件"></a>7.8 部署Calico网络插件</h2><p>&emsp;&emsp;Calico网络插件部署的操作在所有节点上执行</p>
<h3 id="7-8-1-安装calico组件"><a href="#7-8-1-安装calico组件" class="headerlink" title="7.8.1 安装calico组件"></a>7.8.1 安装calico组件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用operator安装calico组件-可能会失败</span></span><br><span class="line"><span class="comment"># 以下为github的地址，可能会失败</span></span><br><span class="line">root@k8s-master:~# kubectl create -f https://raw.gitmirror.com/projectcalico/calico/refs/tags/v3.29.3/manifests/tigera-operator.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决办法：</span></span><br><span class="line"><span class="comment"># 1.获取Calico images到本地</span></span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/operator:v1.36.7</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/typha:v3.29.3</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/ctl:v3.29.3</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/node:v3.29.3</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/cni:v3.29.3</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/apiserver:v3.29.3</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/kube-controllers:v3.29.3</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/dikastes:v3.29.3</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/pod2daemon-flexvol:v3.29.3</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/csi:v3.29.3</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/cnlxh/node-driver-registrar:v3.29.3</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/operator:v1.36.7 quay.io/tigera/operator:v1.36.7</span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/typha:v3.29.3 docker.io/calico/typha:v3.29.3</span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/ctl:v3.29.3 docker.io/calico/ctl:v3.29.3</span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/node:v3.29.3 docker.io/calico/node:v3.29.3</span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/cni:v3.29.3 docker.io/calico/cni:v3.29.3</span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/apiserver:v3.29.3 docker.io/calico/apiserver:v3.29.3</span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/kube-controllers:v3.29.3 docker.io/calico/kube-controllers:v3.29.3</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/dikastes:v3.29.3 docker.io/calico/dikastes:v3.29.3</span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/pod2daemon-flexvol:v3.29.3 docker.io/calico/pod2daemon-flexvol:v3.29.3</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/csi:v3.29.3 docker.io/calico/csi:v3.29.3</span><br><span class="line">docker tag registry.cn-shanghai.aliyuncs.com/cnlxh/node-driver-registrar:v3.29.3 docker.io/calico/node-driver-registrar:v3.29.3</span><br><span class="line">  </span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/operator:v1.36.7</span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/typha:v3.29.3</span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/ctl:v3.29.3</span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/node:v3.29.3</span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/cni:v3.29.3</span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/apiserver:v3.29.3</span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/kube-controllers:v3.29.3</span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/dikastes:v3.29.3</span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/pod2daemon-flexvol:v3.29.3</span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/csi:v3.29.3</span><br><span class="line">docker rmi registry.cn-shanghai.aliyuncs.com/cnlxh/node-driver-registrar:v3.29.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.发布本地的yaml到集群-master</span></span><br><span class="line">kubectl create -f https://www.linuxcenter.cn/files/cka/cka-yaml/tigera-operator-calico-3.29.3.yaml</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# kubectl get pod -A</span><br><span class="line">NAMESPACE         NAME                                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system       coredns-746c97786-bbjbh              0/1     Pending   0          21m</span><br><span class="line">kube-system       coredns-746c97786-czlp7              0/1     Pending   0          21m</span><br><span class="line">kube-system       etcd-k8s-master                      1/1     Running   0          21m</span><br><span class="line">kube-system       kube-apiserver-k8s-master            1/1     Running   0          21m</span><br><span class="line">kube-system       kube-controller-manager-k8s-master   1/1     Running   0          21m</span><br><span class="line">kube-system       kube-proxy-nktm6                     1/1     Running   0          21m</span><br><span class="line">kube-system       kube-scheduler-k8s-master            1/1     Running   0          21m</span><br><span class="line">tigera-operator   tigera-operator-75b4cd596c-hl7s7     1/1     Running   0          43s</span><br></pre></td></tr></table></figure>

<h3 id="7-8-2-设置calico在集群的网段"><a href="#7-8-2-设置calico在集群的网段" class="headerlink" title="7.8.2 设置calico在集群的网段"></a>7.8.2 设置calico在集群的网段</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用下面的自定义资源设置一下calico在集群中的网段</span></span><br><span class="line"><span class="comment"># 以下为github的地址，可能会失败</span></span><br><span class="line">root@k8s-master:~# wget https://raw.gitmirror.com/projectcalico/calico/refs/tags/v3.29.3/manifests/custom-resources.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.使用下面的地址执行</span></span><br><span class="line">root@k8s-master:~# wget https://www.linuxcenter.cn/files/cka/cka-yaml/custom-resources-calico-3.29.3.yaml</span><br><span class="line">root@k8s-master:~# <span class="built_in">mv</span> custom-resources-calico-3.29.3.yaml custom-resources.yaml</span><br></pre></td></tr></table></figure>

<h3 id="7-8-3-确认资源的地址"><a href="#7-8-3-确认资源的地址" class="headerlink" title="7.8.3 确认资源的地址"></a>7.8.3 确认资源的地址</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# vim custom-resources.yaml</span><br><span class="line"><span class="comment"># This section includes base Calico installation configuration.</span></span><br><span class="line"><span class="comment"># For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.Installation</span></span><br><span class="line">apiVersion: operator.tigera.io/v1</span><br><span class="line">kind: Installation</span><br><span class="line">metadata:</span><br><span class="line">  name: default</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># Configures Calico networking.</span></span><br><span class="line">  calicoNetwork:</span><br><span class="line">    ipPools:</span><br><span class="line">    - name: default-ipv4-ippool</span><br><span class="line">      blockSize: 26</span><br><span class="line">      cidr: 172.16.0.0/16      <span class="comment">#这里换成上面规定好的172.16.0.0/16</span></span><br><span class="line">      encapsulation: VXLANCrossSubnet</span><br><span class="line">      natOutgoing: Enabled</span><br><span class="line">      nodeSelector: all()</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="comment"># This section configures the Calico API server.</span></span><br><span class="line"><span class="comment"># For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.APIServer</span></span><br><span class="line">apiVersion: operator.tigera.io/v1</span><br><span class="line">kind: APIServer</span><br><span class="line">metadata:</span><br><span class="line">  name: default</span><br><span class="line">spec: &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-8-4-自定义资源发布到集群"><a href="#7-8-4-自定义资源发布到集群" class="headerlink" title="7.8.4 自定义资源发布到集群"></a>7.8.4 自定义资源发布到集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl apply -f custom-resources.yaml</span><br></pre></td></tr></table></figure>

<h3 id="7-8-5查询集群组件状态"><a href="#7-8-5查询集群组件状态" class="headerlink" title="7.8.5查询集群组件状态"></a>7.8.5查询集群组件状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询集群组件是否工作正常，正常应该都处于running</span></span><br><span class="line">root@k8s-master:~# kubectl get pod -A</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决工作中pod一直处于pending的方法</span></span><br><span class="line"><span class="comment"># 对于某个pod</span></span><br><span class="line">kubectl get pod calico-apiserver-644d4cf9f4-vkxj6 -n calico-system -o yaml | grep image:</span><br></pre></td></tr></table></figure>

<h2 id="7-9-加入Worker节点"><a href="#7-9-加入Worker节点" class="headerlink" title="7.9 加入Worker节点"></a>7.9 加入Worker节点</h2><p>&emsp;&emsp;加入节点操作需在所有的worker节点完成，这里要注意，Worker节点需要完成以下先决条件才能执行kubeadm join</p>
<p>&emsp;&emsp;&emsp;1.Docker、CRI-Docker 部署</p>
<p>&emsp;&emsp;&emsp;2.Swap分区关闭</p>
<p>&emsp;&emsp;&emsp;3.iptables桥接流量的允许</p>
<p>&emsp;&emsp;&emsp;4.安装kubeadm等软件</p>
<p>&emsp;&emsp;&emsp;5.集成CRI-Docker</p>
<p>&emsp;&emsp;&emsp;6.所有节点的&#x2F;etc&#x2F;hosts中互相添加对方的解析</p>
<p>&emsp;&emsp;如果时间长忘记了join参数，可以在master节点上用以下方法重新生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;如果有多个CRI对象，在worker节点上执行以下命令加入节点时，指定CRI对象，案例如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> kubeadm <span class="built_in">join</span> 192.168.8.3:6443 --token 56aycu.d0ijt2m8wlm5hi66 --discovery-token-ca-cert-hash sha256:e254bb01196a997505e072b301fea7b162f0fbfee3dc8def3889e5e081a3a0b2</span><br><span class="line"></span><br><span class="line">root@k8s-worker1:~# kubeadm <span class="built_in">join</span> 192.168.8.3:6443 --token 56aycu.d0ijt2m8wlm5hi66 --discovery-token-ca-cert-hash sha256:e254bb01196a997505e072b301fea7b162f0fbfee3dc8def3889e5e081a3a0b2 --cri-socket=unix:///var/run/cri-dockerd.sock</span><br><span class="line"></span><br><span class="line">root@k8s-worker2:~# kubeadm <span class="built_in">join</span> 192.168.8.3:6443 --token 56aycu.d0ijt2m8wlm5hi66 --discovery-token-ca-cert-hash sha256:e254bb01196a997505e072b301fea7b162f0fbfee3dc8def3889e5e081a3a0b2 --cri-socket=unix:///var/run/cri-dockerd.sock</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# kubectl get nodes</span><br><span class="line">NAME          STATUS     ROLES           AGE    VERSION</span><br><span class="line">k8s-master    Ready      control-plane   163m   v1.33.0</span><br><span class="line">k8s-worker1   Ready      &lt;none&gt;          3m1s   v1.33.0</span><br><span class="line">k8s-worker2   Ready      &lt;none&gt;          35s    v1.33.0</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;注意上描述命令最后的–cri-socket参数，在系统中部署了docker和cri-docker时，必须明确指明此参数，并将此参数指向我们的cri-docker，不然命令会报告有两个重复的CRI的错误</p>
<p>&emsp;&emsp;在k8s-master机器上执行以下内容给节点打上角色标签，k8s-worker1 k8s-worker2打上了worker标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl label nodes k8s-worker1 k8s-worker2 node-role.kubernetes.io/worker=</span><br><span class="line">node/k8s-worker1 labeled</span><br><span class="line">node/k8s-worker2 labeled</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# kubectl get nodes</span><br><span class="line">NAME          STATUS     ROLES           AGE     VERSION</span><br><span class="line">k8s-master    Ready      control-plane   167m    v1.33.0</span><br><span class="line">k8s-worker1   Ready      worker          6m53s   v1.33.0</span><br><span class="line">k8s-worker2   Ready      worker          4m27s   v1.33.0</span><br></pre></td></tr></table></figure>

<h2 id="7-10-重置集群"><a href="#7-10-重置集群" class="headerlink" title="7.10 重置集群"></a>7.10 重置集群</h2><p>&emsp;&emsp;如果在安装好集群的情况下，想重复练习初始化集群，或者包括初始化集群报错在内的任何原因，想重新初始化集群时，可以用下面的方法重置集群，重置后，集群就会被删除，可以用于重新部署，一般来说，这个命令仅用于k8s-master这个节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubeadm reset --cri-socket=unix:///var/run/cri-dockerd.sock</span><br><span class="line">...</span><br><span class="line">[reset] Are you sure you want to proceed? [y/N]: y</span><br><span class="line">...</span><br><span class="line">The reset process does not clean CNI configuration. To <span class="keyword">do</span> so, you must remove /etc/cni/net.d</span><br><span class="line"></span><br><span class="line">The reset process does not reset or clean up iptables rules or IPVS tables.</span><br><span class="line">If you wish to reset iptables, you must <span class="keyword">do</span> so manually by using the <span class="string">&quot;iptables&quot;</span> <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">If your cluster was setup to utilize IPVS, run ipvsadm --clear (or similar)</span><br><span class="line">to reset your system<span class="string">&#x27;s IPVS tables.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The reset process does not clean your kubeconfig files and you must remove them manually.</span></span><br><span class="line"><span class="string">Please, check the contents of the $HOME/.kube/config file.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 根据提示，手工完成文件和规则的清理   清理后就可以重新部署集群了</span></span><br><span class="line"><span class="string">root@k8s-master:~# rm -rf /etc/cni/net.d</span></span><br><span class="line"><span class="string">root@k8s-master:~# iptables -F</span></span><br><span class="line"><span class="string">root@k8s-master:~# rm -rf $HOME/.kube/config</span></span><br></pre></td></tr></table></figure>

<h1 id="8-Namespace"><a href="#8-Namespace" class="headerlink" title="8 Namespace"></a>8 Namespace</h1><h2 id="8-1-命令行创建"><a href="#8-1-命令行创建" class="headerlink" title="8.1 命令行创建"></a>8.1 命令行创建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace lixiaohui</span><br><span class="line">kubectl get namespaces</span><br></pre></td></tr></table></figure>

<h2 id="8-2-YAML文件创建"><a href="#8-2-YAML文件创建" class="headerlink" title="8.2 YAML文件创建"></a>8.2 YAML文件创建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; namespace.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Namespace</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: zhangsan</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl create -f namespace.yml </span><br><span class="line">kubectl get namespaces</span><br></pre></td></tr></table></figure>

<p>创建带有namespace属性的资源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image=class-docker.myk8s.cn/library/nginx --namespace=lixiaohui</span><br><span class="line">kubectl get pod -n lixiaohui </span><br></pre></td></tr></table></figure>

<p>每次查询和创建资源都需要带–namespace&#x3D;lixiaohui挺麻烦，可以设置默认值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context --current --namespace=lixiaohui</span><br><span class="line">kubectl config view | grep namespace:</span><br><span class="line">kubectl get pod</span><br></pre></td></tr></table></figure>

<p>删除namespace会删除其下所有资源，但是如果要删除已经切换为默认值的namespace时，可能会卡住，所以我们要先把默认值切换为其他，然后再删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context --current --namespace=default</span><br><span class="line">kubectl delete namespaces lixiaohui zhangsan</span><br></pre></td></tr></table></figure>

<h1 id="CRD自定义资源"><a href="#CRD自定义资源" class="headerlink" title="CRD自定义资源"></a>CRD自定义资源</h1><h2 id="CRD-介绍"><a href="#CRD-介绍" class="headerlink" title="CRD 介绍"></a>CRD 介绍</h2><p>K8S资源类型不止有namespace，还有很多，不过那都是系统自带的，现在我们来看看怎么自定义k8s中的资源</p>
<ol>
<li><p><strong>什么是 CRD？</strong></p>
<ul>
<li><strong>CRD（Custom Resource Definition）</strong> 是 Kubernetes 提供的一种机制，允许用户定义自己的资源类型。这些自定义资源可以像 Kubernetes 原生资源（如 Pod、Service、Deployment 等）一样被管理。</li>
</ul>
</li>
<li><p><strong>为什么需要 CRD？</strong></p>
<ul>
<li><p><strong>扩展 Kubernetes API</strong>：Kubernetes 的原生资源可能无法满足所有用户的需求。CRD 允许用户定义自己的资源类型，从而扩展 Kubernetes 的功能。</p>
</li>
<li><p><strong>管理复杂应用</strong>：有些应用可能需要管理一些特定的资源，这些资源不属于 Kubernetes 原生支持的范围。通过 CRD，你可以将这些资源纳入 Kubernetes 的管理范围，实现统一的资源管理。</p>
</li>
</ul>
</li>
<li><p><strong>CRD 的作用</strong></p>
<ul>
<li><p><strong>定义资源结构</strong>：CRD 允许你定义资源的结构，包括其字段和数据类型。</p>
</li>
<li><p><strong>管理资源生命周期</strong>：Kubernetes 将为你管理这些自定义资源的生命周期，包括创建、更新、删除等操作。</p>
</li>
<li><p><strong>集成 Kubernetes 生态系统</strong>：CRD 可以与 Kubernetes 的其他组件（如控制器、操作符等）集成，实现更复杂的业务逻辑。</p>
</li>
</ul>
</li>
</ol>
<p>在 Kubernetes 的自定义资源定义（CRD）中，CRD 本身只定义了资源的结构和 API，但它不会直接执行任何创建、更新或删除操作。这些操作需要通过一个控制器（Controller）来实现。控制器是一个独立的程序，它监听 CRD 的变化，并根据这些变化执行实际的操作。</p>
<h2 id="查询CRD以及API资源"><a href="#查询CRD以及API资源" class="headerlink" title="查询CRD以及API资源"></a>查询CRD以及API资源</h2><p>先看看系统中的api资源都有哪些，然后我们自己来创建一个</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl api-resources</span><br><span class="line">NAME                                SHORTNAMES                                      APIVERSION                          NAMESPACED   KIND</span><br><span class="line">bindings                                                                            v1                                  <span class="literal">true</span>         Binding</span><br><span class="line">componentstatuses                   cs                                              v1                                  <span class="literal">false</span>        ComponentStatus</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>再来看看现在都有哪些自定义资源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get crd</span><br><span class="line">NAME                                                  CREATED AT</span><br><span class="line">adminnetworkpolicies.policy.networking.k8s.io         2025-03-08T05:07:24Z</span><br><span class="line">apiservers.operator.tigera.io                         2025-03-08T05:07:24Z</span><br><span class="line">bgpconfigurations.crd.projectcalico.org               2025-03-08T05:07:23Z</span><br><span class="line">bgpfilters.crd.projectcalico.org                      2025-03-08T05:07:23Z</span><br><span class="line">bgppeers.crd.projectcalico.org                        2025-03-08T05:07:23Z</span><br><span class="line">blockaffinities.crd.projectcalico.org                 2025-03-08T05:07:23Z</span><br><span class="line">caliconodestatuses.crd.projectcalico.org              2025-03-08T05:07:23Z</span><br><span class="line">clusterinformations.crd.projectcalico.org             2025-03-08T05:07:23Z</span><br><span class="line">crontabs.stable.example.com                           2025-04-10T02:51:46Z</span><br><span class="line">felixconfigurations.crd.projectcalico.org             2025-03-08T05:07:23Z</span><br><span class="line">globalnetworkpolicies.crd.projectcalico.org           2025-03-08T05:07:23Z</span><br><span class="line">globalnetworksets.crd.projectcalico.org               2025-03-08T05:07:24Z</span><br><span class="line">hostendpoints.crd.projectcalico.org                   2025-03-08T05:07:24Z</span><br><span class="line">imagesets.operator.tigera.io                          2025-03-08T05:07:24Z</span><br><span class="line">installations.operator.tigera.io                      2025-03-08T05:07:24Z</span><br><span class="line">ipamblocks.crd.projectcalico.org                      2025-03-08T05:07:24Z</span><br><span class="line">ipamconfigs.crd.projectcalico.org                     2025-03-08T05:07:24Z</span><br><span class="line">ipamhandles.crd.projectcalico.org                     2025-03-08T05:07:24Z</span><br><span class="line">ippools.crd.projectcalico.org                         2025-03-08T05:07:24Z</span><br><span class="line">ipreservations.crd.projectcalico.org                  2025-03-08T05:07:24Z</span><br><span class="line">kubecontrollersconfigurations.crd.projectcalico.org   2025-03-08T05:07:24Z</span><br><span class="line">networkpolicies.crd.projectcalico.org                 2025-03-08T05:07:24Z</span><br><span class="line">networksets.crd.projectcalico.org                     2025-03-08T05:07:24Z</span><br><span class="line">tiers.crd.projectcalico.org                           2025-03-08T05:07:24Z</span><br><span class="line">tigerastatuses.operator.tigera.io                     2025-03-08T05:07:24Z</span><br></pre></td></tr></table></figure>

<h2 id="创建CRD以及API资源"><a href="#创建CRD以及API资源" class="headerlink" title="创建CRD以及API资源"></a>创建CRD以及API资源</h2><p>ok，我们来创建一个自己的crd，crd将注册为api资源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">crd.yaml</span> <span class="string">&lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 名字必需与下面的 spec 字段匹配，并且格式为 &#x27;&lt;名称的复数形式&gt;.&lt;组名&gt;&#x27;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">crontabs.stable.example.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 组名称，用于 REST API：/apis/&lt;组&gt;/&lt;版本&gt;</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">stable.example.com</span></span><br><span class="line">  <span class="comment"># 列举此 CustomResourceDefinition 所支持的版本</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="comment"># 每个版本都可以通过 served 标志来独立启用或禁止</span></span><br><span class="line">      <span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 其中一个且只有一个版本必需被标记为存储版本</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">schema:</span></span><br><span class="line">        <span class="attr">openAPIV3Schema:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">spec:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">properties:</span></span><br><span class="line">                <span class="attr">cronSpec:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">image:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">replicas:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">  <span class="comment"># 可以是 Namespaced 或 Cluster</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="comment"># 名称的复数形式，用于 URL：/apis/&lt;组&gt;/&lt;版本&gt;/&lt;名称的复数形式&gt;</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">crontabs</span></span><br><span class="line">    <span class="comment"># 名称的单数形式，作为命令行使用时和显示时的别名</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">crontab</span></span><br><span class="line">    <span class="comment"># kind 通常是单数形式的驼峰命名（CamelCased）形式。你的资源清单会使用这一形式。</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">CronTab</span></span><br><span class="line">    <span class="comment"># shortNames 允许你在命令行使用较短的字符串来匹配资源</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ct</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl apply -f crd.yaml</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/crontabs.stable.example.com created</span><br></pre></td></tr></table></figure>

<p>此时再看就会有我们自己的crd资源和api资源了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get crd</span><br><span class="line">NAME                                                  CREATED AT</span><br><span class="line">...</span><br><span class="line">crontabs.stable.example.com                           2025-03-10T03:07:46Z</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl api-resources</span><br><span class="line">...</span><br><span class="line">NAME                                SHORTNAMES                                      APIVERSION                          NAMESPACED   KIND</span><br><span class="line">crontabs                            ct                                              stable.example.com/v1               <span class="literal">true</span>         CronTab</span><br></pre></td></tr></table></figure>

<h2 id="查询API资源结构与参数"><a href="#查询API资源结构与参数" class="headerlink" title="查询API资源结构与参数"></a>查询API资源结构与参数</h2><p>我们既然已经注册为api资源，来看看能否explain字段？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl explain crontabs</span><br><span class="line">GROUP:      stable.example.com</span><br><span class="line">KIND:       CronTab</span><br><span class="line">VERSION:    v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">    &lt;empty&gt;</span><br><span class="line">FIELDS:</span><br><span class="line">  apiVersion    &lt;string&gt;</span><br><span class="line">  kind  &lt;string&gt;</span><br><span class="line">  metadata      &lt;ObjectMeta&gt;</span><br><span class="line">  spec  &lt;Object&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>看看都有哪些spec</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl explain crontabs.spec</span><br><span class="line">GROUP:      stable.example.com</span><br><span class="line">KIND:       CronTab</span><br><span class="line">VERSION:    v1</span><br><span class="line"></span><br><span class="line">FIELD: spec &lt;Object&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">    &lt;empty&gt;</span><br><span class="line">FIELDS:</span><br><span class="line">  cronSpec      &lt;string&gt;</span><br><span class="line">    &lt;no description&gt;</span><br><span class="line"></span><br><span class="line">  image &lt;string&gt;</span><br><span class="line">    &lt;no description&gt;</span><br><span class="line"></span><br><span class="line">  replicas      &lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">    &lt;no description&gt;</span><br></pre></td></tr></table></figure>

<p>一切正常，看来我们已经创建了自定义资源，接下来就是等开发人员通过编程等方式创建operator等控制器，来使用我们的资源了</p>
<h1 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h1><h2 id="Pod创建"><a href="#Pod创建" class="headerlink" title="Pod创建"></a>Pod创建</h2><p>一个Pod中只有一个业务容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; pod.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: lixiaohuipod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: hello</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;echo &quot;Hello, lixiaohui!&quot; &amp;&amp; sleep 3600&#x27;]</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f pod.yml </span><br><span class="line">kubectl get pod</span><br><span class="line">kubectl logs lixiaohuipod </span><br></pre></td></tr></table></figure>

<p>一个Pod中有多个业务容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; multicontainer.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: hello</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;echo &quot;Hello, lixiaohui!&quot; &amp;&amp; sleep 3600&#x27;]</span></span><br><span class="line"><span class="string">  - name: httpd</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - name: web</span></span><br><span class="line"><span class="string">        containerPort: 80</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f multicontainer.yml</span><br><span class="line">kubectl get pod</span><br><span class="line">kubectl get -f multicontainer.yml -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP               NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">pod    2/2     Running   0          66s   172.16.200.199   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# curl 172.16.200.199</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="修改Pod"><a href="#修改Pod" class="headerlink" title="修改Pod"></a>修改Pod</h2><p>直接修改yaml文件，然后执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pod.yml</span><br></pre></td></tr></table></figure>

<p>进入容器并修改其内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it pod -c httpd -- /bin/bash</span><br><span class="line">root@pod:/usr/local/apache2# <span class="built_in">echo</span> lixiaohuitest &gt; htdocs/index.html </span><br><span class="line">root@pod:/usr/local/apache2# <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">curl http://172.16.200.199</span><br></pre></td></tr></table></figure>

<h2 id="Init类型容器"><a href="#Init类型容器" class="headerlink" title="Init类型容器"></a>Init类型容器</h2><p>根据安排，myapp-container的容器将等待两个init结束之后才会启动，也就是40秒之后才会启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; init.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: initpd</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: myapp</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: myapp-container</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;echo The app is running! &amp;&amp; sleep 3600&#x27;]</span></span><br><span class="line"><span class="string">  initContainers:</span></span><br><span class="line"><span class="string">  - name: init-myservice</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &quot;sleep 20&quot;]</span></span><br><span class="line"><span class="string">  - name: init-mydb</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &quot;sleep 20&quot;]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f init.yml </span><br><span class="line">kubectl get pod -w</span><br></pre></td></tr></table></figure>

<h2 id="Sidecar类型容器"><a href="#Sidecar类型容器" class="headerlink" title="Sidecar类型容器"></a>Sidecar类型容器</h2><p>两个容器挂载了同一个目录，一个容器负责写入数据，一个容器负责对外展示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; sidecar.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: sidecarpod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: httpd</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">      - mountPath: /usr/local/apache2/htdocs/</span></span><br><span class="line"><span class="string">        name: lixiaohuivolume</span></span><br><span class="line"><span class="string">  - name: busybox</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;echo &quot;Hello sidecar&quot; &gt; /usr/local/apache2/htdocs/index.html &amp;&amp; sleep 3600&#x27;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">      - mountPath: /usr/local/apache2/htdocs/</span></span><br><span class="line"><span class="string">        name: lixiaohuivolume</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: lixiaohuivolume</span></span><br><span class="line"><span class="string">      emptyDir: &#123;&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f sidecar.yml </span><br><span class="line">kubectl get -f sidecar.yml -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME         READY   STATUS    RESTARTS   AGE     IP             NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">sidecarpod   2/2     Running   0          3m54s   172.17.245.1   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://172.17.245.1</span><br><span class="line">Hello sidecar</span><br></pre></td></tr></table></figure>

<h2 id="Static-Pod"><a href="#Static-Pod" class="headerlink" title="Static Pod"></a>Static Pod</h2><p>运行中的 kubelet 会定期扫描配置的目录中的变化， 并且根据文件中出现&#x2F;消失的 Pod 来添加&#x2F;删除 Pod。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl status kubelet</span><br><span class="line">...</span><br><span class="line">Drop-In: /usr/lib/systemd/system/kubelet.service.d</span><br><span class="line">           └─10-kubeadm.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">...</span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -i static /var/lib/kubelet/config.yaml </span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br></pre></td></tr></table></figure>

<p>编写静态pod yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; static.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: staticpod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: hello</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;echo &quot;Hello, lixiaohui!&quot; &amp;&amp; sleep 3600&#x27;]</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>把这个yaml文件复制到&#x2F;etc&#x2F;kubernetes&#x2F;manifests，然后观察pod列表，然后把yaml文件移出此文件夹，再观察pod列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> static.yml /etc/kubernetes/manifests/</span><br><span class="line">kubectl get pod</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">staticpod-k8s-master   1/1     Running   0          74s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /etc/kubernetes/manifests/static.yml </span><br><span class="line">kubectl get pod</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">No resources found <span class="keyword">in</span> default namespace.</span><br></pre></td></tr></table></figure>

<h2 id="Pod-删除"><a href="#Pod-删除" class="headerlink" title="Pod 删除"></a>Pod 删除</h2><p>kubectl delete pod –all会删除所有pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod --all</span><br></pre></td></tr></table></figure>

<h1 id="kubernetes-控制器"><a href="#kubernetes-控制器" class="headerlink" title="kubernetes 控制器"></a>kubernetes 控制器</h1><h2 id="Replica-Set"><a href="#Replica-Set" class="headerlink" title="Replica Set"></a>Replica Set</h2><p>使用nginx镜像创建具有3个pod的RS,并分配合适的标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; rs.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: ReplicaSet</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginxrstest</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: nginxrstest</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 3</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: nginxrstest</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: nginxrstest</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: nginx</span></span><br><span class="line"><span class="string">        image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">          - name: http</span></span><br><span class="line"><span class="string">            containerPort: 80</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f rs.yml </span><br><span class="line">kubectl get replicasets.apps,pods -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME                          DESIRED   CURRENT   READY   AGE    CONTAINERS   IMAGES   SELECTOR</span><br><span class="line">replicaset.apps/nginxrstest   3         3         3       2m4s   nginx        nginx    app=nginxrstest</span><br><span class="line"></span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE   IP              NODE                    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/nginxrstest-chtkc   1/1     Running   0          62s   172.17.93.196   k8s-worker1             &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/nginxrstest-scvhv   1/1     Running   0          62s   172.17.245.4    k8s-worker2             &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/nginxrstest-zqllq   1/1     Running   0          62s   172.17.193.2    k8s-master              &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl http://172.17.93.196</span><br><span class="line">...</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete replicasets nginxrstest</span><br></pre></td></tr></table></figure>

<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>使用nginx镜像创建具有3个副本的Deployment，并分配合适的属性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; deployment.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx-deployment</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 3</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: nginx</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: nginx</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: nginx</span></span><br><span class="line"><span class="string">        image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>我们发现deployment管理了一个RS，而RS又实现了3个pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deployment.yml</span><br><span class="line">kubectl get deployments.apps,replicasets.apps,pods -l app=nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NAME                               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nginx-deployment   3/3     3            3           13s</span><br><span class="line"></span><br><span class="line">NAME                                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nginx-deployment-69795dd799   3         3         3       13s</span><br><span class="line"></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-deployment-69795dd799-7cgwp   1/1     Running   0          13s</span><br><span class="line">pod/nginx-deployment-69795dd799-vm5p4   1/1     Running   0          13s</span><br><span class="line">pod/nginx-deployment-69795dd799-zx9g9   1/1     Running   0          13s</span><br></pre></td></tr></table></figure>

<h2 id="更新Deployment"><a href="#更新Deployment" class="headerlink" title="更新Deployment"></a>更新Deployment</h2><p>将deployment的镜像更改一次</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployments/nginx-deployment nginx=class-docker.myk8s.cn/library/nginx:1.16.1 --record</span><br><span class="line"></span><br><span class="line">查看更新进度</span><br><span class="line">kubectl rollout status deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;nginx-deployment&quot;</span> rollout to finish: 1 out of 3 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;nginx-deployment&quot;</span> rollout to finish: 1 out of 3 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;nginx-deployment&quot;</span> rollout to finish: 1 out of 3 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;nginx-deployment&quot;</span> rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;nginx-deployment&quot;</span> rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;nginx-deployment&quot;</span> rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;nginx-deployment&quot;</span> rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;nginx-deployment&quot;</span> rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">deployment <span class="string">&quot;nginx-deployment&quot;</span> successfully rolled out</span><br></pre></td></tr></table></figure>

<p>更新过程是多了一个replicaset</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployments.apps,replicasets.apps,pods -l app=nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NAME                               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nginx-deployment   3/3     3            3           2m55s</span><br><span class="line"></span><br><span class="line">NAME                                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nginx-deployment-66b957f9d    3         3         3       2m16s</span><br><span class="line">replicaset.apps/nginx-deployment-69795dd799   0         0         0       2m55s</span><br><span class="line"></span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-deployment-66b957f9d-9cwgq   1/1     Running   0          116s</span><br><span class="line">pod/nginx-deployment-66b957f9d-9zn4p   1/1     Running   0          98s</span><br><span class="line">pod/nginx-deployment-66b957f9d-zvgzd   1/1     Running   0          2m16s</span><br></pre></td></tr></table></figure>

<h2 id="回滚-Deployment"><a href="#回滚-Deployment" class="headerlink" title="回滚 Deployment"></a>回滚 Deployment</h2><p>故意将镜像名称命名设置为 nginx:1.161 而不是nginx:1.16.1，发现永远无法更新成功，此时就需要回退</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployments/nginx-deployment nginx=nginx:1.161 --record</span><br><span class="line">kubectl rollout status deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;nginx-deployment&quot;</span> rollout to finish: 1 out of 3 new replicas have been updated...</span><br></pre></td></tr></table></figure>

<p>查看历史版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout <span class="built_in">history</span> deployments/nginx-deployment</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deployment.apps/nginx-deployment </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         kubectl <span class="built_in">set</span> image deployments/nginx-deployment nginx=class-docker.myk8s.cn/library/nginx:1.16.1 --record=<span class="literal">true</span></span><br><span class="line">3         kubectl <span class="built_in">set</span> image deployments/nginx-deployment nginx=nginx:1.161 --record=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout <span class="built_in">history</span> deployment.v1.apps/nginx-deployment --revision=3</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">deployment.apps/nginx-deployment with revision <span class="comment">#3</span></span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:    app=nginx</span><br><span class="line">    pod-template-hash=64bd4564c8</span><br><span class="line">  Annotations:    kubernetes.io/change-cause: kubectl <span class="built_in">set</span> image deployments/nginx-deployment nginx=nginx:1.161 --record=<span class="literal">true</span></span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:    nginx:1.161</span><br><span class="line">    Port:    80/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:    &lt;none&gt;</span><br><span class="line">  Volumes:    &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>回退到版本2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployments/nginx-deployment --to-revision=2</span><br><span class="line">kubectl rollout status deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<h2 id="伸缩-Deployment"><a href="#伸缩-Deployment" class="headerlink" title="伸缩 Deployment"></a>伸缩 Deployment</h2><p>将指定的deployment副本更改为5</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployments/nginx-deployment --replicas=5</span><br><span class="line">kubectl get deployments.apps,replicasets.apps -l app=nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME                               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nginx-deployment   5/5     5            5           5m6s</span><br><span class="line"></span><br><span class="line">NAME                                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nginx-deployment-64bd4564c8   0         0         0       113s</span><br><span class="line">replicaset.apps/nginx-deployment-66b957f9d    5         5         5       4m27s</span><br><span class="line">replicaset.apps/nginx-deployment-69795dd799   0         0         0       5m6s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deployments.apps nginx-deployment</span><br></pre></td></tr></table></figure>

<h2 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h2><p>使用busybox镜像，在每一个节点上都运行一个pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; daemonset.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: DaemonSet</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: lixiaohui</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    daemonset: test</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      name: testpod</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        name: testpod</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: hello</span></span><br><span class="line"><span class="string">        image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">        command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;sleep 3600&#x27;]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f daemonset.yml</span><br><span class="line">kubectl get daemonsets.apps</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME        DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">lixiaohui   2         2         2       2            2           &lt;none&gt;          24s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f daemonset.yml</span><br></pre></td></tr></table></figure>

<h2 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h2><p>使用nginx镜像，创建一个副本数为3的有状态应用，并挂载本地目录到容器中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; statefulset.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: StatefulSet</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: web</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: nginx</span></span><br><span class="line"><span class="string">  serviceName: &quot;nginx&quot;</span></span><br><span class="line"><span class="string">  replicas: 3</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: nginx</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: nginx</span></span><br><span class="line"><span class="string">        image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 80</span></span><br><span class="line"><span class="string">          name: web</span></span><br><span class="line"><span class="string">        volumeMounts:</span></span><br><span class="line"><span class="string">        - name: www</span></span><br><span class="line"><span class="string">          mountPath: /usr/share/nginx/html</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">         - name: www</span></span><br><span class="line"><span class="string">           emptyDir: &#123;&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>发现创建的过程是有次序的，这也验证了有状态应用的启动顺序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f statefulset.yml</span><br><span class="line">kubectl get pods -w</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NAME    READY   STATUS             RESTARTS   AGE</span><br><span class="line">web-0   1/1     Running            0          41s</span><br><span class="line">web-1   0/1     Pending            0          0s</span><br><span class="line">web-1   0/1     Pending            0          0s</span><br><span class="line">web-1   0/1     ContainerCreating   0          0s</span><br><span class="line">web-1   0/1     ContainerCreating   0          0s</span><br><span class="line">web-1   1/1     Running             0          4s</span><br><span class="line">web-2   0/1     Pending             0          0s</span><br><span class="line">web-2   0/1     Pending             0          0s</span><br><span class="line">web-2   0/1     ContainerCreating   0          0s</span><br><span class="line">web-2   0/1     ContainerCreating   0          0s</span><br><span class="line">web-2   1/1     Running             0          4s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">web-0   1/1     Running   0          2m47s</span><br><span class="line">web-1   1/1     Running   0          2m6s</span><br><span class="line">web-2   1/1     Running   0          2m2s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f statefulset.yml</span><br></pre></td></tr></table></figure>

<h2 id="Job与CronJob"><a href="#Job与CronJob" class="headerlink" title="Job与CronJob"></a>Job与CronJob</h2><h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>不断打印CKA JOB字符串，失败最多重试4次</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; job.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: batch/v1</span></span><br><span class="line"><span class="string">kind: Job</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pi</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: pi</span></span><br><span class="line"><span class="string">        image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">        command: [&quot;sh&quot;,  &quot;-c&quot;, &quot;while true;do echo CKA JOB;done&quot;]</span></span><br><span class="line"><span class="string">      restartPolicy: Never</span></span><br><span class="line"><span class="string">  backoffLimit: 4</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f job.yml</span><br><span class="line">kubectl get <span class="built_in">jobs</span>,pods</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME           COMPLETIONS   DURATION   AGE</span><br><span class="line">job.batch/pi   0/1           82s        82s</span><br><span class="line"></span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/pi-66qbm   1/1     Running   0          82s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs pi-66qbm</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CKA JOB</span><br><span class="line">CKA JOB</span><br><span class="line">CKA JOB</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f job.yml</span><br></pre></td></tr></table></figure>

<h3 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h3><p>每分钟打印一次指定字符串</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; cronjob.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: batch/v1</span></span><br><span class="line"><span class="string">kind: CronJob</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cronjobtest</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  schedule: &quot;*/1 * * * *&quot;</span></span><br><span class="line"><span class="string">  jobTemplate:</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      template:</span></span><br><span class="line"><span class="string">        spec:</span></span><br><span class="line"><span class="string">          containers:</span></span><br><span class="line"><span class="string">          - name: hello</span></span><br><span class="line"><span class="string">            image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">            imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">            command:</span></span><br><span class="line"><span class="string">            - /bin/sh</span></span><br><span class="line"><span class="string">            - -c</span></span><br><span class="line"><span class="string">            - date; echo Hello from the Kubernetes cluster</span></span><br><span class="line"><span class="string">          restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f cronjob.yml</span><br><span class="line"><span class="comment"># 这里需要等待一分钟再去get</span></span><br><span class="line">kubectl get cronjobs,pod</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                        SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">cronjob.batch/cronjobtest   */1 * * * *   False     0        23s             83s</span><br><span class="line">NAME                                   READY   STATUS      RESTARTS   AGE</span><br><span class="line">pod/cronjobtest-27444239-kqcjc         0/1     Completed   0          23s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs cronjobtest-27444239-kqcjc </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Wed Mar  2 11:45:00 UTC 2022</span><br><span class="line">Hello from the Kubernetes cluster</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f crobjob.yml</span><br></pre></td></tr></table></figure>

<h1 id="Service-服务发现"><a href="#Service-服务发现" class="headerlink" title="Service 服务发现"></a>Service 服务发现</h1><p>用nginx镜像准备一个3副本的deployment作为后端，并开放80端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; deployment-service.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx-deployment-servicetest</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 3</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: nginx</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: nginx</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: nginx</span></span><br><span class="line"><span class="string">        image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>然后用kubectl expose的命令创建一个针对deployment的服务，并查询endpoint是否准备就绪</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deployment-service.yml</span><br><span class="line">kubectl expose deployment nginx-deployment-servicetest --port=9000 --name=lxhservice --target-port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">kubectl get service,endpoints</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP          27m</span><br><span class="line">service/lxhservice   NodePort    10.96.213.26   &lt;none&gt;        9000:31919/TCP   28s</span><br><span class="line"></span><br><span class="line">NAME                   ENDPOINTS                                                        AGE</span><br><span class="line">endpoints/kubernetes   192.168.8.3:6443                                              27m</span><br><span class="line">endpoints/lxhservice   172.16.152.69:80,172.16.152.72:80,172.16.152.73:80 + 8 more...   28s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.8.3:31919</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete service lxhservice </span><br></pre></td></tr></table></figure>

<h2 id="ClusterIP类型的Service"><a href="#ClusterIP类型的Service" class="headerlink" title="ClusterIP类型的Service"></a>ClusterIP类型的Service</h2><p>ClusterIP是默认的Service类型，对外提供8000端口，并把流量引流到具有app: nginx的后端80端口上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; clusterip.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: my-service</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: nginx</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - protocol: TCP</span></span><br><span class="line"><span class="string">      port: 8000</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f clusterip.yml</span><br><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">my-service   ClusterIP   10.102.224.203   &lt;none&gt;        8000/TCP   88s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.102.224.203:8000</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f clusterip.yml</span><br></pre></td></tr></table></figure>

<h2 id="NodePort类型的Service"><a href="#NodePort类型的Service" class="headerlink" title="NodePort类型的Service"></a>NodePort类型的Service</h2><p>Type: NodePort将会在节点的特定端口上开通服务，本实验中，我们指定了端口为31788</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; nodeport.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nodeservice</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  type: NodePort</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: nginx</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - protocol: TCP</span></span><br><span class="line"><span class="string">      port: 8000</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">      nodePort: 31788</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nodeport.yml</span><br><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">nodeservice   NodePort   10.100.234.83   &lt;none&gt;        8000:31788/TCP   11s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 因为是nodeport，所以用节点IP</span></span><br><span class="line">curl http://192.168.8.3:31788</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f nodeport.yml</span><br></pre></td></tr></table></figure>

<h2 id="Headless类型的Service"><a href="#Headless类型的Service" class="headerlink" title="Headless类型的Service"></a>Headless类型的Service</h2><p>在此类型的Service中，将不会只返回Service IP，会直接返回众多Pod 的IP地址，所以需要进入pod中用集群内DNS进行测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; headless.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: headless</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  clusterIP: None</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: nginx</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - protocol: TCP</span></span><br><span class="line"><span class="string">      port: 8000</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f headless.yml</span><br><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">headless   ClusterIP   None         &lt;none&gt;        8000/TCP   4s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run --<span class="built_in">rm</span> --image=class-docker.myk8s.cn/library/busybox:1.28 -it testpod</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">If you don<span class="string">&#x27;t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string">/ # nslookup headless</span></span><br><span class="line"><span class="string">Server:    10.96.0.10</span></span><br><span class="line"><span class="string">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Name:      headless</span></span><br><span class="line"><span class="string">Address 1: 172.16.127.16 172-16-127-16.headless.lixiaohui.svc.cluster.local</span></span><br><span class="line"><span class="string">Address 2: 172.16.125.86 172-16-125-86.headless.lixiaohui.svc.cluster.local</span></span><br><span class="line"><span class="string">Address 3: 172.16.125.85 172-16-125-85.headless.lixiaohui.svc.cluster.local</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f headless.yml</span><br></pre></td></tr></table></figure>

<h2 id="LoadBalancer类型的Service"><a href="#LoadBalancer类型的Service" class="headerlink" title="LoadBalancer类型的Service"></a>LoadBalancer类型的Service</h2><h3 id="部署metallb负载均衡"><a href="#部署metallb负载均衡" class="headerlink" title="部署metallb负载均衡"></a>部署metallb负载均衡</h3><p>先部署一个<code>metallb controller和Speaker</code></p>
<ol>
<li><p><code>metallb controller</code>用于负责监听 Kubernetes Service 的变化，当服务类型被设置为 LoadBalancer 时，Controller 会从一个预先配置的 IP 地址池中分配一个 IP 地址给该服务，并管理这个 IP 地址的生命周期。</p>
</li>
<li><p><code>Speaker</code>负责将服务的 IP 地址通过标准的路由协议广播到网络中，确保外部流量能够正确路由到集群中的服务。</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://www.linuxcenter.cn/files/cka/cka-yaml/metallb-native.yaml</span><br></pre></td></tr></table></figure>

<p>定义一组由负载均衡对外分配的IP地址范围</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">ippool.yml</span> <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">metallb.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IPAddressPool</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lxh-ip-pool-192-168-8-10-100</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">metallb-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.10</span><span class="number">-192.168</span><span class="number">.8</span><span class="number">.100</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ippool.yml</span><br></pre></td></tr></table></figure>

<p>在 Layer 2 模式下用于控制如何通过 ARP（Address Resolution Protocol）或 NDP（Neighbor Discovery Protocol）协议宣告服务的 IP 地址，使得这些 IP 地址在本地网络中可解析</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">l2Advertisement.yml</span> <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">metallb.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">L2Advertisement</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">l2-myippool</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">metallb-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ipAddressPools:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lxh-ip-pool-192-168-8-10-100</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f l2Advertisement.yml</span><br></pre></td></tr></table></figure>

<h3 id="部署LoadBalancer-服务"><a href="#部署LoadBalancer-服务" class="headerlink" title="部署LoadBalancer 服务"></a>部署LoadBalancer 服务</h3><p>负载均衡准备好之后，创建LoadBalancer类型的服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; loadbalancer.yml &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: loadbalance-service</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: nginx</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - protocol: TCP</span></span><br><span class="line"><span class="string">      port: 80</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">  type: LoadBalancer</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f loadbalancer.yml</span><br></pre></td></tr></table></figure>

<p>获取服务看看是否分配到了负载均衡IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>

<p>从输出上看，分配到了192.168.8.10</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                  TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)          AGE</span><br><span class="line">loadbalance-service   LoadBalancer   10.110.113.122   192.168.8.10   80:30214/TCP     4s</span><br></pre></td></tr></table></figure>

<p>用负载均衡IP访问一下试试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 192.168.8.10</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></pre></td></tr></table></figure>

<p>删除service资源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f loadbalancer.yml</span><br></pre></td></tr></table></figure>


<h2 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h2><p>Ingress 需要Ingress控制器支持，先部署控制器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://www.linuxcenter.cn/files/cka/cka-yaml/ingressdeploy.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n ingress-nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                                        READY   STATUS      RESTARTS   AGE</span><br><span class="line">NAME                                   READY   STATUS      RESTARTS   AGE</span><br><span class="line">ingress-nginx-admission-create-cv22n   0/1     Completed   0          92s</span><br><span class="line">ingress-nginx-admission-patch-lbr2v    0/1     Completed   1          92s</span><br><span class="line">ingress-nginx-controller-tdpb2         1/1     Running     0          92s</span><br><span class="line">ingress-nginx-controller-w2q4g         1/1     Running     0          92s</span><br></pre></td></tr></table></figure>

<p>用nginx镜像生成一个3副本的Pod，并通过Service提供服务，然后再用ingress，以特定域名的方式对外暴露</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; ingress.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx-deployment-ingress</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 3</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: nginx</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: nginx</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: nginx</span></span><br><span class="line"><span class="string">        image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 80</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ingressservice</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: nginx</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - protocol: TCP</span></span><br><span class="line"><span class="string">      port: 80</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: networking.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: lixiaohui</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ingressClassName: nginx</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">    - host: www.lixiaohui.com</span></span><br><span class="line"><span class="string">      http:</span></span><br><span class="line"><span class="string">        paths:</span></span><br><span class="line"><span class="string">          - pathType: Prefix</span></span><br><span class="line"><span class="string">            path: &quot;/&quot;</span></span><br><span class="line"><span class="string">            backend:</span></span><br><span class="line"><span class="string">              service:</span></span><br><span class="line"><span class="string">                name: ingressservice</span></span><br><span class="line"><span class="string">                port:</span></span><br><span class="line"><span class="string">                  number: 80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f ingress.yml</span><br><span class="line">kubectl get deployments,service,ingress</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment-ingress   3/3     3            3           2m</span><br><span class="line"></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">ingressservice   ClusterIP   10.110.117.37   &lt;none&gt;        80/TCP    2m7</span><br><span class="line"></span><br><span class="line">NAME        CLASS   HOSTS               ADDRESS                         PORTS   AGE</span><br><span class="line">lixiaohui   nginx   www.lixiaohui.com   192.168.8.4,192.168.8.5   80      2m26s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">把上述ADDRESS部分的IP和域名绑定解析</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 192.168.8.4 www.lixiaohui.com &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line">curl http://www.lixiaohui.com</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f ingress.yml</span><br></pre></td></tr></table></figure>

<h2 id="Gateway-API"><a href="#Gateway-API" class="headerlink" title="Gateway API"></a>Gateway API</h2><h3 id="Gateway-API-基本介绍"><a href="#Gateway-API-基本介绍" class="headerlink" title="Gateway API 基本介绍"></a>Gateway API 基本介绍</h3><p>Kubernetes Gateway API 是一种新的 API 规范，旨在提供一种在 Kubernetes 中管理网关和负载均衡器的标准方法。它被设计为 Ingress API 的替代方案，提供更丰富的功能和更好的扩展性,Gateway API 的核心思想是通过使用可扩展的、角色导向的、协议感知的配置机制来提供网络服务。</p>
<p>核心组件：</p>
<p>Gateway API 包括几个核心组件：</p>
<ol>
<li><code>GatewayClass</code>：定义一组具有配置相同的网关，由实现该类的控制器管理。</li>
<li><code>Gateway</code>：定义流量处理基础设施（例如云负载均衡器）的一个实例。</li>
<li><code>Route</code>：描述了特定协议的规则，用于将请求从 Gateway 映射到 Kubernetes 服务。目前，HTTPRoute 是比较稳定的版本，而 TCPRoute、UDPRoute、GRPCRoute、TLSRoute 等也在开发中。</li>
</ol>
<p><strong>GatewayClass</strong> 类似于阿里云负载均衡中的<strong>负载均衡实例类型选择</strong>。在阿里云中，用户可以选择应用型负载均衡（ALB）、网络型负载均衡（NLB）或传统型负载均衡（CLB），每种类型都有其特定的配置和功能。在 Kubernetes 中，GatewayClass 定义了一组共享通用配置和行为的 Gateway 集合，类似于选择一种负载均衡的实现类型</p>
<p><strong>Gateway</strong> 类似于阿里云负载均衡中的<strong>具体负载均衡实例</strong>。在阿里云中，用户创建一个负载均衡实例后，可以配置监听端口、协议等。在 Kubernetes 中，Gateway 描述了流量被分配到集群中服务的方式，是 GatewayClass 的具体实现</p>
<p><strong>Route</strong> 类似于阿里云负载均衡中的<strong>转发规则</strong>。在阿里云中，用户可以配置基于域名、路径、HTTP Header 等条件的转发规则。在 Kubernetes 中，Route 描述了通过网关的流量如何映射到服务，例如 HTTPRoute 可以基于请求路径、主机名等条件将流量转发到不同的后端服务。</p>
<p>以下是使用 Gateway 和 HTTPRoute 将 HTTP 流量路由到服务的简单示例：</p>
<p><img src="/files/cka/images/k8s-gatewayapi/gateway-request-flow.svg"></p>
<p>在此示例中，实现为反向代理的 Gateway 的请求数据流如下：</p>
<ol>
<li>客户端开始准备 URL 为 <a target="_blank" rel="noopener" href="http://test.lixiaohui.com/">http://test.lixiaohui.com</a> 的 HTTP 请求</li>
<li>客户端的 DNS 解析器查询目标名称并了解与 Gateway 关联的一个或多个 IP 地址的映射。</li>
<li>客户端向 Gateway IP 地址发送请求；反向代理接收 HTTP 请求并使用 Host: 标头来匹配基于 Gateway 和附加的 HTTPRoute 所获得的配置。</li>
<li>可选的，反向代理可以根据 HTTPRoute 的匹配规则进行请求头和（或）路径匹配。</li>
<li>可选地，反向代理可以修改请求；例如，根据 HTTPRoute 的过滤规则添加或删除标头。</li>
<li>最后，反向代理将请求转发到一个或多个后端。</li>
</ol>
<h3 id="Gateway-API实验"><a href="#Gateway-API实验" class="headerlink" title="Gateway API实验"></a>Gateway API实验</h3><ol>
<li>需要先做metallb，由metalb给service提供外部负载均衡IP</li>
<li>部署nginx Fabric，为GatewayAPI做后端流量处理组件</li>
<li>创建一个基于Fabric的gatewayClass</li>
<li>创建一个gateway，并监听在80端口，并关联刚创建的gatewayClass</li>
<li>创建一个httpRoute，此处定义客户端访问的域名和路径</li>
</ol>
<p>实验效果：</p>
<p>外部客户端可以用浏览器打开<code>http://test.lixiaohui.com</code> 并返回我们的nginx业务网站内容</p>
<p><strong>部署 Gateway API CRD</strong></p>
<p>这一步用于扩展K8S功能，以便于支持Gateway API</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://www.linuxcenter.cn/files/cka/gatewayapi/experimental-install.yaml</span><br></pre></td></tr></table></figure>

<p><strong>部署Fabric自定义资源</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://www.linuxcenter.cn/files/cka/gatewayapi/nginx-fabric-crds.yaml</span><br></pre></td></tr></table></figure>

<p><strong>部署Fabric</strong></p>
<p>这一步部署的Fabric用于处理后端流量处理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://www.linuxcenter.cn/files/cka/gatewayapi/nginx-fabric-deploy.yaml</span><br></pre></td></tr></table></figure>

<p>等它部署好之后，看看pod起来没</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get pods -n nginx-gateway</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-gateway-5c8f44c856-2zt76   2/2     Running   0          32s</span><br></pre></td></tr></table></figure>

<p>这里将会自动创建基于nginx的GatewayClass</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get gatewayclasses.gateway.networking.k8s.io</span><br><span class="line">NAME    CONTROLLER                                   ACCEPTED   AGE</span><br><span class="line">nginx   gateway.nginx.org/nginx-gateway-controller   True       45s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>部署应用，这里的应用是模拟公司的常规业务，稍后用于对外提供服务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">deployment-service.yml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8sgateway-lxhtest</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">class-docker.myk8s.cn/library/nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>为了稳定pod的访问，这里用service的方式做了一个内部暴露</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deployment-service.yml</span><br><span class="line">kubectl expose deployment k8sgateway-lxhtest --port=9000 --name=lxhservice --target-port=80</span><br></pre></td></tr></table></figure>

<ol>
<li>创建一个名为lxh-gateway的gateway并关联了一个名为nginx的gatewayClass，这个gateway提供了一个监听在80端口的http协议的监听器，这个监听器接收来自任何namespace以lixiaohui.com为后缀的所有请求。</li>
<li>创建一个名为lxh-http的httpRoute，并关联我们的gateway，本次httpRoute提供了test.lixiaohui.com的域名根目录的请求入口，并将流量导入到一个名为lxhservice的9000端口</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">gatewayandhttproute.yml</span> <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">gateway.networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lxh-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">gatewayClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">listeners:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">&quot;*.lixiaohui.com&quot;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">allowedRoutes:</span></span><br><span class="line">      <span class="attr">namespaces:</span></span><br><span class="line">        <span class="attr">from:</span> <span class="string">All</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">gateway.networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HTTPRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lxh-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">parentRefs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lxh-gateway</span></span><br><span class="line">  <span class="attr">hostnames:</span> [<span class="string">&quot;test.lixiaohui.com&quot;</span>]</span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">matches:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">PathPrefix</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">backendRefs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lxhservice</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f gatewayandhttproute.yml</span><br></pre></td></tr></table></figure>

<p>可以看到，我们的gateway，已经从负载均衡中，拿到了外部IP地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get service -n nginx-gateway</span><br><span class="line">NAME            TYPE           CLUSTER-IP    EXTERNAL-IP    PORT(S)                      AGE</span><br><span class="line">nginx-gateway   LoadBalancer   10.96.18.47   192.168.8.10   80:31752/TCP,443:32200/TCP   7m1s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>服务后端也有endpoint</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get endpoints -n nginx-gateway</span><br><span class="line">NAME            ENDPOINTS                            AGE</span><br><span class="line">nginx-gateway   172.16.194.67:443,172.16.194.67:80   8m24s</span><br></pre></td></tr></table></figure>

<p>查看我们的gateway和httproute</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get gateways</span><br><span class="line">NAME          CLASS   ADDRESS        PROGRAMMED   AGE</span><br><span class="line">lxh-gateway   nginx   192.168.8.10   True         5m19s</span><br><span class="line">root@k8s-master:~# kubectl get httproute</span><br><span class="line">NAME       HOSTNAMES                AGE</span><br><span class="line">lxh-http   [<span class="string">&quot;test.lixiaohui.com&quot;</span>]   5m25s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 192.168.8.10 test.lixiaohui.com &gt;&gt; /etc/hosts</span><br><span class="line">curl http://test.lixiaohui.com</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></pre></td></tr></table></figure>
<h1 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h1><h2 id="Liveness-Probes"><a href="#Liveness-Probes" class="headerlink" title="Liveness Probes"></a>Liveness Probes</h2><h3 id="文件存活检测"><a href="#文件存活检测" class="headerlink" title="文件存活检测"></a>文件存活检测</h3><p>创建一个名为liveness的容器，并在其中执行文件的创建，休眠，然后再删除文件的操作，然后用livenessProbe来检测</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; liveness.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    test: liveness</span></span><br><span class="line"><span class="string">  name: liveness-exec</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: liveness</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    args:</span></span><br><span class="line"><span class="string">    - /bin/sh</span></span><br><span class="line"><span class="string">    - -c</span></span><br><span class="line"><span class="string">    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span></span><br><span class="line"><span class="string">    livenessProbe:</span></span><br><span class="line"><span class="string">      exec:</span></span><br><span class="line"><span class="string">        command:</span></span><br><span class="line"><span class="string">        - cat</span></span><br><span class="line"><span class="string">        - /tmp/healthy</span></span><br><span class="line"><span class="string">      initialDelaySeconds: 5</span></span><br><span class="line"><span class="string">      periodSeconds: 5</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>1.periodSeconds 字段指定了 kubelet 应该每 5 秒执行一次存活探测。</p>
<p>2.initialDelaySeconds 字段告诉 kubelet 在执行第一次探测前应该等待 5 秒。</p>
<p>3.kubelet 在容器内执行命令 cat &#x2F;tmp&#x2F;healthy 来进行探测。</p>
<p>4.如果命令执行成功并且返回值为 0，kubelet 就会认为这个容器是健康存活的。</p>
<p>5.如果这个命令返回非 0 值，kubelet 会杀死这个容器并重新启动它。</p>
<p>这个容器生命周期的前 30 秒， &#x2F;tmp&#x2F;healthy 文件是存在的。 所以在这最开始的 30 秒内，执行命令 cat &#x2F;tmp&#x2F;healthy 会返回成功代码。 30 秒之后，执行命令 cat &#x2F;tmp&#x2F;healthy 就会返回失败代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f liveness.yml </span><br><span class="line">kubectl describe pod liveness-exec</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                  From               Message</span><br><span class="line">  ----     ------     ----                 ----               -------</span><br><span class="line">  Normal   Scheduled  3m16s                default-scheduler  Successfully assigned lixiaohui/liveness-exec to k8s-worker1</span><br><span class="line">  Normal   Pulled     3m11s                kubelet            Successfully pulled image <span class="string">&quot;busybox&quot;</span> <span class="keyword">in</span> 3.821847462s</span><br><span class="line">  Normal   Pulled     117s                 kubelet            Successfully pulled image <span class="string">&quot;busybox&quot;</span> <span class="keyword">in</span> 3.615149362s</span><br><span class="line">  Normal   Pulling    45s (x3 over 3m15s)  kubelet            Pulling image <span class="string">&quot;busybox&quot;</span></span><br><span class="line">  Normal   Created    43s (x3 over 3m11s)  kubelet            Created container liveness</span><br><span class="line">  Normal   Started    43s (x3 over 3m11s)  kubelet            Started container liveness</span><br><span class="line">  Normal   Pulled     43s                  kubelet            Successfully pulled image <span class="string">&quot;busybox&quot;</span> <span class="keyword">in</span> 2.73613205s</span><br><span class="line">  Warning  Unhealthy  0s (x9 over 2m40s)   kubelet            Liveness probe failed: <span class="built_in">cat</span>: can<span class="string">&#x27;t open &#x27;</span>/tmp/healthy<span class="string">&#x27;: No such file or directory</span></span><br><span class="line"><span class="string">  Normal   Killing    0s (x3 over 2m30s)   kubelet            Container liveness failed liveness probe, will be restarted</span></span><br></pre></td></tr></table></figure>

<p>每30秒在pod事件中就会显示存活探测器失败了，下方信息显示这个容器被杀死并且被重建了3次</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME            READY   STATUS    RESTARTS      AGE</span><br><span class="line">liveness-exec   1/1     Running   3 (63s ago)   4m49s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f liveness.yml</span><br></pre></td></tr></table></figure>

<h3 id="HTTP存活检测"><a href="#HTTP存活检测" class="headerlink" title="HTTP存活检测"></a>HTTP存活检测</h3><p>以httpget的形式访问容器中的&#x2F;lixiaohui页面，根据返回代码来判断是否正常</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; httpget.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: http</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: httpd</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    livenessProbe:</span></span><br><span class="line"><span class="string">      httpGet:</span></span><br><span class="line"><span class="string">        path: /lixiaohui</span></span><br><span class="line"><span class="string">        port: 80</span></span><br><span class="line"><span class="string">        httpHeaders:</span></span><br><span class="line"><span class="string">        - name: Custom-Header</span></span><br><span class="line"><span class="string">          value: Awesome</span></span><br><span class="line"><span class="string">      initialDelaySeconds: 3</span></span><br><span class="line"><span class="string">      periodSeconds: 3</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ol>
<li>kubelet 会向容器内运行的服务发送一个 HTTP GET 请求来执行探测。 如果服务器上 &#x2F;lixiaohui路径下的处理程序返回成功代码，则 kubelet 认为容器是健康存活的。</li>
<li>如果处理程序返回失败代码，则 kubelet 会杀死这个容器并且重新启动它。</li>
<li>任何大于或等于 200 并且小于 400 的返回代码标示成功，其它返回代码都标示失败。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f httpget.yml </span><br><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME   READY   STATUS      RESTARTS   AGE</span><br><span class="line">http   0/1     Completed   3          3m6s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod http</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                    From               Message</span><br><span class="line">  ----     ------     ----                   ----               -------</span><br><span class="line">  Normal   Scheduled  3m28s                  default-scheduler  Successfully assigned lixiaohui/http to k8s-worker1</span><br><span class="line">  Normal   Pulled     3m23s                  kubelet            Successfully pulled image <span class="string">&quot;httpd&quot;</span> <span class="keyword">in</span> 4.365187879s</span><br><span class="line">  Normal   Pulled     3m9s                   kubelet            Successfully pulled image <span class="string">&quot;httpd&quot;</span> <span class="keyword">in</span> 2.794325055s</span><br><span class="line">  Normal   Created    2m54s (x3 over 3m23s)  kubelet            Created container httpd</span><br><span class="line">  Normal   Started    2m54s (x3 over 3m23s)  kubelet            Started container httpd</span><br><span class="line">  Normal   Pulled     2m54s                  kubelet            Successfully pulled image <span class="string">&quot;httpd&quot;</span> <span class="keyword">in</span> 2.497771235s</span><br><span class="line">  Warning  Unhealthy  2m43s (x9 over 3m19s)  kubelet            Liveness probe failed: HTTP probe failed with statuscode: 404</span><br><span class="line">  Normal   Killing    2m43s (x3 over 3m13s)  kubelet            Container httpd failed liveness probe, will be restarted</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f httpget.yml </span><br></pre></td></tr></table></figure>

<h2 id="ReadinessProbe"><a href="#ReadinessProbe" class="headerlink" title="ReadinessProbe"></a>ReadinessProbe</h2><h3 id="TCP存活检测"><a href="#TCP存活检测" class="headerlink" title="TCP存活检测"></a>TCP存活检测</h3><p>kubelet 会在容器启动 5 秒后发送第一个就绪探测。 这会尝试连接容器的 800 端口。如果探测成功，这个 Pod 会被标记为就绪状态，kubelet 将继续每隔 10 秒运行一次检测。</p>
<p>除了就绪探测，这个配置包括了一个存活探测。 kubelet 会在容器启动 15 秒后进行第一次存活探测。 与就绪探测类似，会尝试连接 器的 800 端口。 如果存活探测失败，这个容器会被重新启动。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; readiness.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: tcpcheck</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: httpd</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - name: webport</span></span><br><span class="line"><span class="string">        protocol: TCP</span></span><br><span class="line"><span class="string">        containerPort: 80</span></span><br><span class="line"><span class="string">    readinessProbe:</span></span><br><span class="line"><span class="string">      tcpSocket:</span></span><br><span class="line"><span class="string">        port: 800</span></span><br><span class="line"><span class="string">      initialDelaySeconds: 5</span></span><br><span class="line"><span class="string">      periodSeconds: 10</span></span><br><span class="line"><span class="string">    livenessProbe:</span></span><br><span class="line"><span class="string">      tcpSocket:</span></span><br><span class="line"><span class="string">        port: 800</span></span><br><span class="line"><span class="string">      initialDelaySeconds: 15</span></span><br><span class="line"><span class="string">      periodSeconds: 20</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f readiness.yml </span><br><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME       READY   STATUS    RESTARTS     AGE</span><br><span class="line">tcpcheck   0/1     Running   1 (6s ago)   67s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod tcpcheck</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age               From               Message</span><br><span class="line">  ----     ------     ----              ----               -------</span><br><span class="line">  Normal   Scheduled  60s               default-scheduler  Successfully assigned lixiaohui/tcpcheck to k8s-worker1</span><br><span class="line">  Normal   Pulling    60s               kubelet            Pulling image <span class="string">&quot;httpd&quot;</span></span><br><span class="line">  Normal   Pulled     57s               kubelet            Successfully pulled image <span class="string">&quot;httpd&quot;</span> <span class="keyword">in</span> 2.730390747s</span><br><span class="line">  Normal   Created    57s               kubelet            Created container httpd</span><br><span class="line">  Normal   Started    57s               kubelet            Started container httpd</span><br><span class="line">  Warning  Unhealthy  0s (x7 over 50s)  kubelet            Readiness probe failed: dial tcp 172.16.125.74:800: connect: connection refused</span><br><span class="line">  Warning  Unhealthy  0s (x3 over 40s)  kubelet            Liveness probe failed: dial tcp 172.16.125.74:800: connect: connection refused</span><br><span class="line">  Normal   Killing    0s                kubelet            Container httpd failed liveness probe, will be restarted</span><br></pre></td></tr></table></figure>

<p>可以看到，我们的pod对外提供了80端口，但是我们一直在检测800端口，所以这个pod的检测是失败的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f readiness.yml </span><br></pre></td></tr></table></figure>

<h2 id="StartupProbe"><a href="#StartupProbe" class="headerlink" title="StartupProbe"></a>StartupProbe</h2><h3 id="启动探测器"><a href="#启动探测器" class="headerlink" title="启动探测器"></a>启动探测器</h3><p>有时候，会有一些现有的应用程序在启动时需要较多的初始化时间。 要不影响对引起探测死锁的快速响应，这种情况下，设置存活探测参数是要技巧的。 技巧就是使用一个命令来设置启动探测，针对HTTP 或者 TCP 检测，可以通过设置 failureThreshold * periodSeconds 参数来保证有足够长的时间应对糟糕情况下的启动时间。<br>应用程序将会有最多 30秒(3 * 10 &#x3D; 30s) 的时间来完成它的启动。 一旦启动探测成功一次，存活探测任务就会接管对容器的探测，对容器死锁可以快速响应。 如果启动探测一直没有成功，容器会在 30 秒后被杀死，并且根据 restartPolicy 来设置 Pod 状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; startup.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: startprobe</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: httpd</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - name: webport</span></span><br><span class="line"><span class="string">        protocol: TCP</span></span><br><span class="line"><span class="string">        containerPort: 80</span></span><br><span class="line"><span class="string">    readinessProbe:</span></span><br><span class="line"><span class="string">      tcpSocket:</span></span><br><span class="line"><span class="string">        port: 80</span></span><br><span class="line"><span class="string">      initialDelaySeconds: 5</span></span><br><span class="line"><span class="string">      periodSeconds: 10</span></span><br><span class="line"><span class="string">    startupProbe:</span></span><br><span class="line"><span class="string">      httpGet:</span></span><br><span class="line"><span class="string">        path: /</span></span><br><span class="line"><span class="string">        port: 800</span></span><br><span class="line"><span class="string">      initialDelaySeconds: 5</span></span><br><span class="line"><span class="string">      failureThreshold: 3</span></span><br><span class="line"><span class="string">      periodSeconds: 10</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>Probe参数</p>
<p>Probe 有很多配置字段，可以使用这些字段精确的控制存活和就绪检测的行为：</p>
<p>1.initialDelaySeconds：容器启动后要等待多少秒后存活和就绪探测器才被初始化，默认是 0 秒，最小值是 0。</p>
<p>2.periodSeconds：执行探测的时间间隔（单位是秒）。默认是 10 秒。最小值是 1。</p>
<p>3.timeoutSeconds：探测的超时后等待多少秒。默认值是 1 秒。最小值是 1。</p>
<p>4.successThreshold：探测器在失败后，被视为成功的最小连续成功数。默认值是 1。 存活和启动探测的这个值必须是 1。最小值是 1。</p>
<p>5.failureThreshold：当探测失败时，Kubernetes 的重试次数。 存活探测情况下的放弃就意味着重新启动容器。 就绪探测情况下的放弃 Pod 会被打上未就绪的标签。默认值是 3。最小值是 1。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f startup.yml</span><br><span class="line">kubectl describe -f startup.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason     Age               From               Message</span><br><span class="line">  ----     ------     ----              ----               -------</span><br><span class="line">  Normal   Scheduled  24s               default-scheduler  Successfully assigned default/startprobe to k8s-worker2</span><br><span class="line">  Normal   Pulled     23s               kubelet            Container image <span class="string">&quot;httpd&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    23s               kubelet            Created container httpd</span><br><span class="line">  Normal   Started    23s               kubelet            Started container httpd</span><br><span class="line">  Warning  Unhealthy  3s (x2 over 13s)  kubelet            Startup probe failed: Get <span class="string">&quot;http://192.168.20.20:800/&quot;</span>: dial tcp 192.168.20.20:800: connect: connection refused</span><br></pre></td></tr></table></figure>

<p>可以发现由于我们故意写成了800端口，检测失败，容器一直无法就绪</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f startup.yml</span><br></pre></td></tr></table></figure>

<h2 id="Kubernetes-探针检测顺序与优先级"><a href="#Kubernetes-探针检测顺序与优先级" class="headerlink" title="Kubernetes 探针检测顺序与优先级"></a>Kubernetes 探针检测顺序与优先级</h2><p>在 Kubernetes 中，<code>startupProbe</code>、<code>livenessProbe</code> 和 <code>readinessProbe</code> 是用于监控和管理容器健康状况的探针，每种探针在容器生命周期中的不同阶段发挥不同的作用。以下是这三种探针的检测顺序和优先级：</p>
<h3 id="1-startupProbe"><a href="#1-startupProbe" class="headerlink" title="1. startupProbe"></a>1. <code>startupProbe</code></h3><ul>
<li><strong>检测顺序</strong>：<code>startupProbe</code> 是在容器启动时首先执行的探针。它用于判断应用是否已成功启动，并且只在启动期间运行。</li>
<li><strong>优先级</strong>：如果配置了 <code>startupProbe</code>，Kubernetes 会忽略 <code>livenessProbe</code> 和 <code>readinessProbe</code> 直到 <code>startupProbe</code> 成功。<code>startupProbe</code> 成功后，<code>livenessProbe</code> 和 <code>readinessProbe</code> 才会开始运行。</li>
<li><strong>目的</strong>：用于处理启动时间较长的应用程序，确保应用在完全启动之前不会因 <code>livenessProbe</code> 的失败而被重启。</li>
</ul>
<h3 id="2-livenessProbe"><a href="#2-livenessProbe" class="headerlink" title="2. livenessProbe"></a>2. <code>livenessProbe</code></h3><ul>
<li><strong>检测顺序</strong>：在 <code>startupProbe</code> 成功之后，<code>livenessProbe</code> 开始执行。它定期检查容器是否处于健康状态。</li>
<li><strong>优先级</strong>：如果配置了 <code>startupProbe</code>，<code>livenessProbe</code> 只有在 <code>startupProbe</code> 成功之后才开始运行。如果未配置 <code>startupProbe</code>，<code>livenessProbe</code> 在容器启动后立即开始运行。</li>
<li><strong>目的</strong>：用于检测容器是否仍然处于健康状态。如果 <code>livenessProbe</code> 失败，Kubernetes 会重启该容器。</li>
</ul>
<h3 id="3-readinessProbe"><a href="#3-readinessProbe" class="headerlink" title="3. readinessProbe"></a>3. <code>readinessProbe</code></h3><ul>
<li><strong>检测顺序</strong>：在 <code>startupProbe</code> 成功之后，<code>readinessProbe</code> 开始执行。它定期检查容器是否已准备好接收流量。</li>
<li><strong>优先级</strong>：如果配置了 <code>startupProbe</code>，<code>readinessProbe</code> 只有在 <code>startupProbe</code> 成功之后才开始运行。如果未配置 <code>startupProbe</code>，<code>readinessProbe</code> 在容器启动后立即开始运行。</li>
<li><strong>目的</strong>：用于判断容器是否可以接收请求。如果 <code>readinessProbe</code> 失败，容器将从服务的端点列表中移除，不再接收新的流量。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><strong>顺序</strong>：<code>startupProbe</code> -&gt; <code>livenessProbe</code> -&gt; <code>readinessProbe</code></li>
<li><strong>优先级</strong>：<ul>
<li><code>startupProbe</code> 优先于其他两个探针。如果配置了 <code>startupProbe</code>，必须先通过 <code>startupProbe</code> 检测，<code>livenessProbe</code> 和 <code>readinessProbe</code> 才会启动。</li>
<li><code>livenessProbe</code> 和 <code>readinessProbe</code> 在 <code>startupProbe</code> 成功后同时开始运行，没有严格的优先级区分，但它们的作用不同，<code>livenessProbe</code> 用于重启失败的容器，<code>readinessProbe</code> 用于控制流量。</li>
</ul>
</li>
</ul>
<h2 id="优雅关闭"><a href="#优雅关闭" class="headerlink" title="优雅关闭"></a>优雅关闭</h2><p>从 Kubernetes 1.22 开始，terminationGracePeriodSeconds 特性被开启，在杀死容器时，Pod停止获得新的流量。但在Pod中运行的容器不会受到影响。直到超时发生。可以在Pod级别或者容器下具体的探针级别设定，探针会优先和覆盖Pod级别</p>
<p>下面的例子中，容器将在收到结束需求是沉睡2分钟来代表业务的正常关闭，然后整个pod最多等待200秒，超过200秒，就会强制删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; grace.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: httpgrace</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 200</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: httpd</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - name: webport</span></span><br><span class="line"><span class="string">        protocol: TCP</span></span><br><span class="line"><span class="string">        containerPort: 80</span></span><br><span class="line"><span class="string">    lifecycle:</span></span><br><span class="line"><span class="string">      preStop:</span></span><br><span class="line"><span class="string">        exec:</span></span><br><span class="line"><span class="string">          command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sleep 2m&quot;]</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f grace.yml </span><br><span class="line">kubectl get -f grace.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">httpgrace    1/1     Running   0          7s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f grace.yml &amp;</span><br><span class="line">kubectl get pod</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                                        READY   STATUS        RESTARTS   AGE</span><br><span class="line">httpgrace                                       1/1     Terminating   0          18s</span><br></pre></td></tr></table></figure>

<h1 id="配置存储卷"><a href="#配置存储卷" class="headerlink" title="配置存储卷"></a>配置存储卷</h1><h2 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h2><p>当 Pod 分派到某个 Node 上时，emptyDir 卷会被创建，并且在 Pod 在该节点上运行期间，卷一直存在。 就像其名称表示的那样，卷最初是空的。 尽管 Pod 中的容器挂载 emptyDir 卷的路径可能相同也可能不同，这些容器都可以读写 emptyDir 卷中相同的文件。 当 Pod 因为某些原因被从节点上删除时，emptyDir 卷中的数据也会被永久删除。<br>容器崩溃并不会导致 Pod 被从节点上移除，因此容器崩溃期间 emptyDir 卷中的数据是安全的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; emptydir.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: emptydir</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    name: test-container</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - mountPath: /cache</span></span><br><span class="line"><span class="string">      name: cache-volume</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">  - name: cache-volume</span></span><br><span class="line"><span class="string">    emptyDir:</span></span><br><span class="line"><span class="string">      sizeLimit: 2G</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>此时sizeLimit要注意内容量的单位，如果是单位是M，那就是以1000为进制，如果是Mi就是1024进制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f emptydir.yml </span><br><span class="line">kubectl get -f emptydir.yml -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP               NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">emptydir   1/1     Running   0          29s   172.16.200.228   k8s-worker1 &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据上面的提示，在指定的机器上完成这个步骤</span></span><br><span class="line">crictl ps | grep -i test-container</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d27c066d7acc3       faed93b288591       2 minutes ago       Running             test-container            0                   6f045542048c9</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crictl inspect d27c066d7acc3 | grep cache</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;containerPath&quot;</span>: <span class="string">&quot;/cache&quot;</span>,</span><br><span class="line"><span class="string">&quot;hostPath&quot;</span>: <span class="string">&quot;/var/lib/kubelet/pods/baa08250-5800-4828-a3cd-bfcd0789af37/volumes/kubernetes.io~empty-dir/cache-volume&quot;</span>,</span><br><span class="line">  <span class="string">&quot;container_path&quot;</span>: <span class="string">&quot;/cache&quot;</span>,</span><br><span class="line">  <span class="string">&quot;host_path&quot;</span>: <span class="string">&quot;/var/lib/kubelet/pods/baa08250-5800-4828-a3cd-bfcd0789af37/volumes/kubernetes.io~empty-dir/cache-volume&quot;</span></span><br><span class="line">  <span class="string">&quot;destination&quot;</span>: <span class="string">&quot;/cache&quot;</span>,</span><br><span class="line">  <span class="string">&quot;source&quot;</span>: <span class="string">&quot;/var/lib/kubelet/pods/baa08250-5800-4828-a3cd-bfcd0789af37/volumes/kubernetes.io~empty-dir/cache-volume&quot;</span>,</span><br></pre></td></tr></table></figure>

<p>可以看到我们的数据卷被创建到了&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;baa08250-5800-4828-a3cd-bfcd0789af37&#x2F;volumes&#x2F;kubernetes.io~empty-dir&#x2F;cache-volume</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f emptydir.yml</span><br></pre></td></tr></table></figure>

<h2 id="HostPath"><a href="#HostPath" class="headerlink" title="HostPath"></a>HostPath</h2><p>hostPath 卷能将主机节点文件系统上的文件或目录挂载到你的 Pod 中，但要注意的是要尽可能避免使用这个类型的卷，会限制pod的迁移性</p>
<p>下面的例子中，我们挂载了一个目录到容器中，并通过nginx对外展示其中的index.html</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; hostpath.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: hostpathtest</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    name: hostpathpod</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - name: web</span></span><br><span class="line"><span class="string">        containerPort: 80</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - mountPath: /usr/share/nginx/html</span></span><br><span class="line"><span class="string">      name: test-volume</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">  - name: test-volume</span></span><br><span class="line"><span class="string">    hostPath:</span></span><br><span class="line"><span class="string">      path: /data</span></span><br><span class="line"><span class="string">      type: DirectoryOrCreate</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th><strong>取值</strong></th>
<th><strong>行为</strong></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>空字符串（默认）用于向后兼容，这意味着在安装 hostPath  卷之前不会执行任何检查。</td>
</tr>
<tr>
<td>DirectoryOrCreate</td>
<td>如果在给定路径上什么都不存在，那么将根据需要创建空目录，权限设置为  0755，具有与 kubelet 相同的组和属主信息。</td>
</tr>
<tr>
<td>Directory</td>
<td>在给定路径上必须存在的目录。</td>
</tr>
<tr>
<td>FileOrCreate</td>
<td>如果在给定路径上什么都不存在，那么将在那里根据需要创建空文件，权限设置为  0644，具有与 kubelet 相同的组和所有权。</td>
</tr>
<tr>
<td>File</td>
<td>在给定路径上必须存在的文件。</td>
</tr>
<tr>
<td>Socket</td>
<td>在给定路径上必须存在的 UNIX  套接字。</td>
</tr>
<tr>
<td>CharDevice</td>
<td>在给定路径上必须存在的字符设备。</td>
</tr>
<tr>
<td>BlockDevice</td>
<td>在给定路径上必须存在的块设备。</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f hostpath.yml </span><br><span class="line">kubectl get -f hostpath.yml -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP               NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">hostpathtest   1/1     Running   0          3s    172.16.200.223   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据提示，在work02上完成这个步骤</span></span><br><span class="line"><span class="built_in">echo</span> hostwrite &gt; /data/index.html</span><br><span class="line"></span><br><span class="line">curl http://172.16.200.223</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostwrite</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f hostpath.yml</span><br></pre></td></tr></table></figure>

<h2 id="持久卷概述"><a href="#持久卷概述" class="headerlink" title="持久卷概述"></a>持久卷概述</h2><p>持久卷（PersistentVolume，PV）是集群中的一块存储，可以由管理员事先供应，或者 使用存储类（Storage Class）来动态供应。 持久卷是集群资源，就像节点也是集群资源一样。PV 持久卷和普通的 Volume 一样，也是使用 卷插件来实现的，只是它们拥有独立于任何使用 PV 的 Pod 的生命周期<br>持久卷申请（PersistentVolumeClaim，PVC）表达的是用户对存储的请求。概念上与 Pod 类似。 Pod 会耗用节点资源，而 PVC 申领会耗用 PV 资源</p>
<h2 id="构建简易NFS服务器"><a href="#构建简易NFS服务器" class="headerlink" title="构建简易NFS服务器"></a>构建简易NFS服务器</h2><p>在master上模拟一个nfs服务器，将本地的&#x2F;nfsshare共享出来给所有人使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt install nfs-kernel-server -y</span><br><span class="line"><span class="built_in">mkdir</span> /nfsshare</span><br><span class="line"><span class="built_in">chmod</span> 777 /nfsshare -R</span><br><span class="line"><span class="built_in">echo</span> /nfsshare *(rw) &gt;&gt; /etc/exports</span><br><span class="line">systemctl <span class="built_in">enable</span> nfs-server --now</span><br><span class="line">exportfs -rav</span><br></pre></td></tr></table></figure>

<h2 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h2><p>创建一个名为nfspv大小为5Gi卷，并以ReadWriteOnce的方式申明，且策略为Recycle</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; pv.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: PersistentVolume</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nfspv</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    pvname: nfspv</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  capacity:</span></span><br><span class="line"><span class="string">    storage: 5Gi</span></span><br><span class="line"><span class="string">  volumeMode: Filesystem</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteOnce</span></span><br><span class="line"><span class="string">  persistentVolumeReclaimPolicy: Recycle</span></span><br><span class="line"><span class="string">  storageClassName: slow</span></span><br><span class="line"><span class="string">  mountOptions:</span></span><br><span class="line"><span class="string">    - hard</span></span><br><span class="line"><span class="string">    - nfsvers=4.1</span></span><br><span class="line"><span class="string">  nfs:</span></span><br><span class="line"><span class="string">    path: /nfsshare</span></span><br><span class="line"><span class="string">    server: 192.168.8.3</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>Kubernetes 支持两种卷模式（volumeModes）：Filesystem（文件系统） 和 Block（块），volumeMode 属性设置为 Filesystem 的卷会被 Pod 挂载（Mount） 到某个目录。 如果卷的存储来自某块设备而该设备目前为空，Kuberneretes 会在第一次挂载卷之前 在设备上创建文件系统。</p>
<table>
<thead>
<tr>
<th>访问模式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>ReadWriteOnce</td>
<td>卷可以被一个节点以读写方式挂载。 ReadWriteOnce 访问模式也允许运行在同一节点上的多个 Pod 访问卷。</td>
</tr>
<tr>
<td>ReadOnlyMany</td>
<td>卷可以被多个节点以只读方式挂载。</td>
</tr>
<tr>
<td>ReadWriteMany</td>
<td>卷可以被多个节点以读写方式挂载。</td>
</tr>
<tr>
<td>ReadWriteOncePod</td>
<td>卷可以被单个 Pod 以读写方式挂载。 如果你想确保整个集群中只有一个 Pod 可以读取或写入该 PVC， 请使用ReadWriteOncePod 访问模式。</td>
</tr>
</tbody></table>
<p>在创建pv前，需要确保在3个节点上都安装了nfs客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install nfs-common -y</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f pv.yml </span><br><span class="line">kubectl get pv</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">nfspv   5Gi        RWO            Recycle          Available           slow                    4s</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>回收策略</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Retain</td>
<td>手动回收</td>
</tr>
<tr>
<td>Recycle</td>
<td>基本擦除 (rm -rf &#x2F;thevolume&#x2F;*)</td>
</tr>
<tr>
<td>Delete</td>
<td>诸如 AWS EBS、GCE PD、Azure Disk 或 OpenStack Cinder 卷这类关联存储资产也被删除，目前，仅 NFS 和 HostPath 支持回收（Recycle）。 AWS EBS、GCE PD、Azure Disk 和 Cinder 卷都支持删除（Delete）。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>PV卷状态</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Available（可用）</td>
<td>卷是一个空闲资源，尚未绑定到任何申领；</td>
</tr>
<tr>
<td>Bound（已绑定）</td>
<td>该卷已经绑定到某申领；</td>
</tr>
<tr>
<td>Released（已释放）</td>
<td>所绑定的申领已被删除，但是资源尚未被集群回收；</td>
</tr>
<tr>
<td>Failed（失败）</td>
<td>卷的自动回收操作失败。</td>
</tr>
</tbody></table>
<h2 id="PVC"><a href="#PVC" class="headerlink" title="PVC"></a>PVC</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; pvc.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: myclaim</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteOnce</span></span><br><span class="line"><span class="string">  volumeMode: Filesystem</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">    requests:</span></span><br><span class="line"><span class="string">      storage: 1Gi</span></span><br><span class="line"><span class="string">  storageClassName: slow</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      pvname: &quot;nfspv&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f pvc.yml </span><br><span class="line">kubectl get pvc</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">myclaim   Bound    nfspv    5Gi        RWO            slow           8s</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>accessModes</td>
<td>申领在请求具有特定访问模式的存储时，使用与卷相同的访问模式约定。</td>
</tr>
<tr>
<td>volumeMode</td>
<td>申领使用与卷相同的约定来表明是将卷作为文件系统还是块设备来使用。</td>
</tr>
<tr>
<td>resources</td>
<td>申领和 Pod 一样，也可以请求特定数量的资源。</td>
</tr>
<tr>
<td>selector</td>
<td>申领可以设置标签选择算符 来进一步过滤卷集合。只有标签与选择算符相匹配的卷能够绑定到申领上。</td>
</tr>
</tbody></table>
<p>selector 参数选择：</p>
<p>matchLabels - 卷必须包含带有此值的标签<br>matchExpressions - 通过设定键（key）、值列表和操作符（operator） 来构造的需求。合法的操作符有 In、NotIn、Exists 和 DoesNotExist。<br>来自 matchLabels 和 matchExpressions 的所有需求都按逻辑与的方式组合在一起。 这些需求都必须被满足才被视为匹配。</p>
<h2 id="使用PV和PVC"><a href="#使用PV和PVC" class="headerlink" title="使用PV和PVC"></a>使用PV和PVC</h2><p>创建一个pod并尝试使用PVC</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apt install nfs-common -y</span><br><span class="line"><span class="built_in">cat</span> &gt; pvcuse.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: mypod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: myfrontend</span></span><br><span class="line"><span class="string">      image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">      ports:</span></span><br><span class="line"><span class="string">        - name: web</span></span><br><span class="line"><span class="string">          containerPort: 80</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">      - mountPath: &quot;/usr/local/apache2/htdocs&quot;</span></span><br><span class="line"><span class="string">        name: mypd</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: mypd</span></span><br><span class="line"><span class="string">      persistentVolumeClaim:</span></span><br><span class="line"><span class="string">        claimName: myclaim</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f pvcuse.yml </span><br><span class="line">kubectl get -f pvcuse.yml -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP               NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">mypod   1/1     Running   0          8s    172.16.200.225   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在NFS服务器上(192.168.8.3)创建出index.html网页</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> pvctest &gt; /nfsshare/index.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里要看一下调度到哪个机器，这个机器必须执行apt install nfs-common -y</span></span><br><span class="line"></span><br><span class="line">curl http://172.16.200.225</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pvctest</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f pvcuse.yml</span><br></pre></td></tr></table></figure>

<h1 id="配置存储类"><a href="#配置存储类" class="headerlink" title="配置存储类"></a>配置存储类</h1><h2 id="NFS外部供应"><a href="#NFS外部供应" class="headerlink" title="NFS外部供应"></a>NFS外部供应</h2><h3 id="下载外部供应代码"><a href="#下载外部供应代码" class="headerlink" title="下载外部供应代码"></a>下载外部供应代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://gitee.com/cnlxh/nfs-subdir-external-provisioner.git</span><br><span class="line"><span class="built_in">cd</span> nfs-subdir-external-provisioner</span><br></pre></td></tr></table></figure>

<p>本次采用default命名空间，如果需要别的命名空间，请执行以下替换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NS=$(kubectl config get-contexts|grep -e <span class="string">&quot;^\*&quot;</span> |awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>)</span><br><span class="line">NAMESPACE=<span class="variable">$&#123;NS:-default&#125;</span></span><br><span class="line">sed -i<span class="string">&#x27;&#x27;</span> <span class="string">&quot;s/namespace:.*/namespace: <span class="variable">$NAMESPACE</span>/g&quot;</span> ./deploy/rbac.yaml ./deploy/deployment.yaml</span><br></pre></td></tr></table></figure>

<p>如果集群采用了RBAC，请授权一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deploy/rbac.yaml</span><br></pre></td></tr></table></figure>

<h3 id="配置NFS外部供应"><a href="#配置NFS外部供应" class="headerlink" title="配置NFS外部供应"></a>配置NFS外部供应</h3><p>根据实际情况在deploy&#x2F;deployment中修改镜像、名称、nfs地址和挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deploy/deployment.yaml</span><br></pre></td></tr></table></figure>

<h2 id="部署存储类"><a href="#部署存储类" class="headerlink" title="部署存储类"></a>部署存储类</h2><p>要支持nfs挂载，所有节点都需要安装nfs-common安装包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install nfs-common -y</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; storageclassdeploy.yml &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client</span><br><span class="line">provisioner: cnlxh/nfs-storage</span><br><span class="line">allowVolumeExpansion: <span class="literal">true</span></span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br><span class="line">parameters:</span><br><span class="line">  pathPattern: <span class="string">&quot;<span class="variable">$&#123;.PVC.namespace&#125;</span>-<span class="variable">$&#123;.PVC.name&#125;</span>&quot;</span></span><br><span class="line">  onDelete: delete</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>指定存储卷的绑定模式为 WaitForFirstConsumer，这意味着 PV 的创建和绑定会在 PVC 被 Pod 引用时才进行，而不是在 PVC 创建时立即绑定。这种模式特别适用于需要考虑 Pod 调度约束的场景，例如确保 PV 创建在与 Pod 同一节点上（对于本地存储）或同一可用区（对于云存储）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f storageclassdeploy.yml</span><br></pre></td></tr></table></figure>

<h2 id="标记默认存储类"><a href="#标记默认存储类" class="headerlink" title="标记默认存储类"></a>标记默认存储类</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get storageclass</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                   PROVISIONER         RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">nfs-client           cnlxh/nfs-storage   Delete          Immediate           <span class="literal">false</span>                  22m</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch storageclass nfs-client -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="使用存储类"><a href="#使用存储类" class="headerlink" title="使用存储类"></a>使用存储类</h2><p>只需要在pvc.spec中执行storageClassName: nfs-client就可以了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deploy/test-claim.yaml -f deploy/test-pod.yaml</span><br></pre></td></tr></table></figure>

<p>打开test-pod.yaml就会发现，它向我们的pvc也就是nfs服务器写入了名为SUCCESS文件，在nfs服务器上执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /nfsshare/default-test-claim/</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SUCCESS</span><br></pre></td></tr></table></figure>

<p>删除pod和pvc，会删除我们的资源，测试一下，执行后，会删除pod、pvc、pv，再去nfs服务器查看，数据就没了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f deploy/test-pod.yaml -f deploy/test-claim.yaml</span><br></pre></td></tr></table></figure>

<h1 id="Pod调度"><a href="#Pod调度" class="headerlink" title="Pod调度"></a>Pod调度</h1><h2 id="nodeSelector"><a href="#nodeSelector" class="headerlink" title="nodeSelector"></a>nodeSelector</h2><p>给k8s-worker2节点打一个标签name&#x3D;lixiaohui</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes k8s-worker2 name=lixiaohui</span><br></pre></td></tr></table></figure>

<p>如果需要删除标签可以用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes k8s-worker2 name-</span><br></pre></td></tr></table></figure>


<p>将pod仅调度到具有name&#x3D;lixiaohui标签的节点上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; assignpod.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cnlxhtest</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: nginx</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    name: lixiaohui</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f assignpod.yml </span><br><span class="line">kubectl get pod cnlxhtest -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME        READY   STATUS    RESTARTS   AGE   IP               NODE               NOMINATED NODE   READINESS GATES</span><br><span class="line">cnlxhtest   1/1     Running   0          10s   172.16.125.120   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f assignpod.yml</span><br></pre></td></tr></table></figure>

<h2 id="nodeName"><a href="#nodeName" class="headerlink" title="nodeName"></a>nodeName</h2><p>将Pod仅调度到具有特定名称的节点上，例如仅调度到k8s-worker1上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; nodename.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: lxhnodename</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: nginx</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  nodeName:</span></span><br><span class="line"><span class="string">    k8s-worker1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nodename.yml </span><br><span class="line">kubectl get pod lxhnodename -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP             NODE               NOMINATED NODE   READINESS GATES</span><br><span class="line">lxhnodename   1/1     Running   0          9s    172.16.127.5   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f nodename.yml</span><br></pre></td></tr></table></figure>

<h2 id="tolerations"><a href="#tolerations" class="headerlink" title="tolerations"></a>tolerations</h2><p>master节点默认不参与调度的原因就是因为其上有taint，而toleration就是容忍度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe nodes k8s-master | grep -i taint</span><br></pre></td></tr></table></figure>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node-role.kubernetes.io/control-plane:NoSchedule</span><br></pre></td></tr></table></figure>

<p>添加一个磁盘类型为hdd就不调度的污点</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint <span class="keyword">node</span> <span class="title">k8s-worker2</span> <span class="attr">disktype=</span>hdd:NoSchedule</span><br></pre></td></tr></table></figure>

<p>如需删除以上污点，可用以下命令实现：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint <span class="keyword">node</span> <span class="title">k8s-worker2</span> disktype-</span><br></pre></td></tr></table></figure>

<p>创建一个可以容忍具有master taint的pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; tolerations.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: tolerations</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: nginx</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  tolerations:</span></span><br><span class="line"><span class="string">    - key: &quot;node-role.kubernetes.io/control-plane&quot;</span></span><br><span class="line"><span class="string">      operator: &quot;Exists&quot;</span></span><br><span class="line"><span class="string">      effect: &quot;NoSchedule&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f tolerations.yml </span><br><span class="line">kubectl get pod tolerations -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP              NODE               NOMINATED NODE   READINESS GATES</span><br><span class="line">tolerations   1/1     Running   0          7s    172.16.125.65   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>此时我们发现，并没有调度到k8s-master上，由此我们得出来一个结果，容忍不代表必须，如果必须要调度到k8s-master，需要用以下例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; mustassign.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: tolerationsmust</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: nginx</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  tolerations:</span></span><br><span class="line"><span class="string">    - key: &quot;node-role.kubernetes.io/control-plane&quot;</span></span><br><span class="line"><span class="string">      operator: &quot;Exists&quot;</span></span><br><span class="line"><span class="string">      effect: &quot;NoSchedule&quot;</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    node-role.kubernetes.io/control-plane: &quot;&quot; </span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f mustassign.yml </span><br><span class="line">kubectl get -f mustassign.yml -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP              NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">tolerations   1/1     Running   0          3s    172.16.119.16   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f tolerations.yml</span><br><span class="line">kubectl delete -f mustassign.yml</span><br></pre></td></tr></table></figure>

<h2 id="affinity"><a href="#affinity" class="headerlink" title="affinity"></a>affinity</h2><p>本实验展示在 Kubernetes 集群中，如何使用节点亲和性把 Kubernetes Pod 分配到特定节点</p>
<p>首先需要给节点打上一个合适的标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes k8s-worker2 disktype=ssd</span><br></pre></td></tr></table></figure>

<p>查看节点是否具有标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes --show-labels | grep -i disktype</span><br></pre></td></tr></table></figure>

<p>删除k8s-worker2上的污点，避免干扰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-worker2 disktype-</span><br></pre></td></tr></table></figure>

<p>强制调度到具有特定标签的节点上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; required.yml &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: require</span><br><span class="line">spec:</span><br><span class="line">  affinity:</span><br><span class="line">    nodeAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">        nodeSelectorTerms:</span><br><span class="line">        - matchExpressions:</span><br><span class="line">          - key: disktype</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - ssd            </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: class-docker.myk8s.cn/library/nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>可以看到的确调度到了k8s-worker2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f required.yml</span><br><span class="line">kubectl get -f required.yml -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">require   1/1     Running   0          57s   172.16.126.6   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再来试试优先但不强制的调度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; preferred.yml &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  affinity:</span><br><span class="line">    nodeAffinity:</span><br><span class="line">      preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">      - weight: 1</span><br><span class="line">        preference:</span><br><span class="line">          matchExpressions:</span><br><span class="line">          - key: disktype</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - ssd          </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: class-docker.myk8s.cn/library/nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>可以看到依旧被调度到k8s-worker2上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f preferred.yml</span><br><span class="line">kubectl get -f preferred.yml -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx   1/1     Running   0          10s   172.16.126.7   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>你可以测试一下把k8s-worker2机器关机，再从yaml中把pod改个名防止冲突，在关机后重新创建，会看到也可以调度到其他节点</p>
<h2 id="PriorityClass"><a href="#PriorityClass" class="headerlink" title="PriorityClass"></a>PriorityClass</h2><p>本实验主要是学习如何查询和创建PriorityClass，具有更高数字的PriorityClass在资源紧张时会优先获得资源，具有更低数字的PriorityClass在资源紧张时会被驱逐</p>
<p>在 Kubernetes 中，PriorityClass 的优先级范围是一个整数值，用于定义 Pod 的相对优先级。优先级值越高，表示 Pod 的优先级越高。Kubernetes 使用这些优先级值来决定在资源紧张时哪些 Pod 可以被抢占，以及在调度时哪些 Pod 应该优先调度。</p>
<p><strong>优先级范围的意义</strong></p>
<ol>
<li><p><strong>调度优先级</strong>：</p>
<ul>
<li><p>当多个 Pod 等待调度时，调度器会优先调度优先级更高的 Pod。</p>
</li>
<li><p>如果资源不足，调度器会尝试抢占优先级较低的 Pod，以满足高优先级 Pod 的资源需求。</p>
</li>
</ul>
</li>
<li><p><strong>抢占行为</strong>：</p>
<ul>
<li><p>如果高优先级的 Pod 无法找到足够的资源，调度器会尝试抢占优先级较低的 Pod。</p>
</li>
<li><p>被抢占的 Pod 会被终止，并重新调度到其他节点（如果资源允许）。</p>
</li>
</ul>
</li>
</ol>
<p>PriorityClass 还有两个可选字段：</p>
<ul>
<li><p><code>globalDefault</code> 字段表示这个 PriorityClass 的值应该用于没有 <code>priorityClassName</code> 的 Pod。 系统中只能存在一个 <code>globalDefault</code> 设置为 true 的 PriorityClass。 如果不存在设置了 <code>globalDefault</code> 的 PriorityClass， 则没有 <code>priorityClassName</code> 的 Pod 的优先级为零。</p>
</li>
<li><p><code>description</code> 字段是一个任意字符串。 它用来告诉集群用户何时应该使用此 PriorityClass。</p>
</li>
</ul>
<p>查询系统中现有的PriorityClass</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get priorityclasses</span><br><span class="line">NAME                      VALUE        GLOBAL-DEFAULT   AGE   PREEMPTIONPOLICY</span><br><span class="line">system-cluster-critical   2000000000   <span class="literal">false</span>            45h   PreemptLowerPriority</span><br><span class="line">system-node-critical      2000001000   <span class="literal">false</span>            45h   PreemptLowerPriority</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">pc.yml</span> <span class="string">&lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">scheduling.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">high-priority</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">1000000</span></span><br><span class="line"><span class="attr">globalDefault:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">&quot;此优先级类应仅用于 XYZ 服务 Pod。&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>创建并再次查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl apply -f pc.yml</span><br><span class="line">priorityclass.scheduling.k8s.io/high-priority created</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# kubectl get priorityclasses.scheduling.k8s.io</span><br><span class="line">NAME                      VALUE        GLOBAL-DEFAULT   AGE   PREEMPTIONPOLICY</span><br><span class="line">high-priority             1000000      <span class="literal">false</span>            10s   PreemptLowerPriority</span><br><span class="line">system-cluster-critical   2000000000   <span class="literal">false</span>            45h   PreemptLowerPriority</span><br><span class="line">system-node-critical      2000001000   <span class="literal">false</span>            45h   PreemptLowerPriority</span><br></pre></td></tr></table></figure>

<p>创建后可以将其应用到pod或deployment上其作用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">deployment-pc.yml</span> <span class="string">&lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">high-priority-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">high-priority</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">class-docker.myk8s.cn/library/nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>创建此deployment，并观察deployment产生的pod是否具有特定的值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl apply -f deployment-pc.yml</span><br><span class="line">deployment.apps/high-priority-test created</span><br></pre></td></tr></table></figure>

<p>查看有没有这个值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get deployments.apps high-priority-test -o yaml | grep priorityClassName:</span><br><span class="line">      priorityClassName: high-priority</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get pod</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">high-priority-test-5ddcb8559c-pskbm       1/1     Running   0          2m59s</span><br><span class="line">high-priority-test-5ddcb8559c-vlsw7       1/1     Running   0          2m59s</span><br><span class="line">high-priority-test-5ddcb8559c-wmxrl       1/1     Running   0          2m59s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@k8s-master:~# kubectl get pod high-priority-test-5ddcb8559c-pskbm -o yaml | grep priorityClassName:</span><br><span class="line">  priorityClassName: high-priority</span><br></pre></td></tr></table></figure>

<p>ok，已经成功应用了特定的priorityClass</p>
<h1 id="ConfigMaps"><a href="#ConfigMaps" class="headerlink" title="ConfigMaps"></a>ConfigMaps</h1><h2 id="YAML文件创建"><a href="#YAML文件创建" class="headerlink" title="YAML文件创建"></a>YAML文件创建</h2><p>在Data节点创建了一些键值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; cmyaml.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ConfigMap</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: game-demo</span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">  player_initial_lives: &quot;3&quot;</span></span><br><span class="line"><span class="string">  ui_properties_file_name: &quot;lixiaohui&quot;</span></span><br><span class="line"><span class="string">  game.properties: |</span></span><br><span class="line"><span class="string">    enemy.types=aliens,monsters</span></span><br><span class="line"><span class="string">    player.maximum-lives=5</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f cmyaml.yml </span><br><span class="line">kubectl get configmaps </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME               DATA   AGE</span><br><span class="line">game-demo          3      18s</span><br><span class="line">kube-root-ca.crt   1      49d</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe configmaps game-demo </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Name:         game-demo</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">game.properties:</span><br><span class="line">----</span><br><span class="line">enemy.types=aliens,monsters</span><br><span class="line">player.maximum-lives=5</span><br><span class="line"></span><br><span class="line">player_initial_lives:</span><br><span class="line">----</span><br><span class="line">3</span><br><span class="line">ui_properties_file_name:</span><br><span class="line">----</span><br><span class="line">lixiaohui</span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="命令行创建"><a href="#命令行创建" class="headerlink" title="命令行创建"></a>命令行创建</h2><p>创建了一个名为lixiaohui的键值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap lixiaohui  --from-literal=username=lixiaohui  --from-literal=age=18</span><br><span class="line">kubectl describe configmaps lixiaohui </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Name:         lixiaohui</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">age:</span><br><span class="line">----</span><br><span class="line">18</span><br><span class="line">username:</span><br><span class="line">----</span><br><span class="line">lixiaohui</span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>创建了一个index.html文件，然后用–from-file来引用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> hello world &gt; index.html</span><br><span class="line">kubectl create configmap indexcontent --from-file=index.html</span><br><span class="line">kubectl describe configmaps indexcontent </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Name:         indexcontent</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">index.html:</span><br><span class="line">----</span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Volume-挂载ConfigMap"><a href="#Volume-挂载ConfigMap" class="headerlink" title="Volume 挂载ConfigMap"></a>Volume 挂载ConfigMap</h2><p>创建一个Pod，其挂载的内容，将来自于我们的configmap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; cmvolume.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: configmapvolume</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: configmaptest</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: test</span></span><br><span class="line"><span class="string">      image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">        - name: index</span></span><br><span class="line"><span class="string">          mountPath: /usr/local/apache2/htdocs</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: index</span></span><br><span class="line"><span class="string">      configMap:</span></span><br><span class="line"><span class="string">        name: indexcontent</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f cmvolume.yml </span><br><span class="line">kubectl get -f cmvolume.yml -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME              READY   STATUS    RESTARTS   AGE   IP               NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">configmapvolume   1/1     Running   0          63s   172.16.200.237   k8s-worker1 &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://172.16.200.237</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f cmvolume.yml </span><br></pre></td></tr></table></figure>

<h2 id="环境变量ConfigMap"><a href="#环境变量ConfigMap" class="headerlink" title="环境变量ConfigMap"></a>环境变量ConfigMap</h2><p>创建一个名为mysqlpass且包含password&#x3D;ABCabc123的configmap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap mysqlpass --from-literal=password=ABCabc123</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; cmenv.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: mysql</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: mysqlname</span></span><br><span class="line"><span class="string">      image: class-docker.myk8s.cn/library/mysql</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">      env:</span></span><br><span class="line"><span class="string">        - name: MYSQL_ROOT_PASSWORD</span></span><br><span class="line"><span class="string">          valueFrom:</span></span><br><span class="line"><span class="string">            configMapKeyRef:</span></span><br><span class="line"><span class="string">              name: mysqlpass</span></span><br><span class="line"><span class="string">              key: password</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>我们用环境变量的方法引用了configmap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f cmenv.yml </span><br><span class="line">kubectl <span class="built_in">exec</span> -it mysql -- mysql -uroot -pABCabc123</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> is 9</span><br><span class="line">Server version: 8.0.28 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2022, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">exit</span></span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<p>此时我们要注意，用configMap来引用密码是不太靠谱的，通常用于配置文件等明文场景，密文应该使用下一个实验的secret，因为configMap是明文的，见如下示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe configmaps mysqlpass </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Name:         mysqlpass</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password:</span><br><span class="line">----</span><br><span class="line">ABCabc123</span><br><span class="line"></span><br><span class="line">BinaryData</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f cmenv.yml </span><br></pre></td></tr></table></figure>

<h1 id="Secrets"><a href="#Secrets" class="headerlink" title="Secrets"></a>Secrets</h1><p>刚才我们说过，用configMaps不方便存储密码类的敏感信息，此时我们可以改用Secret</p>
<h2 id="命令行创建-1"><a href="#命令行创建-1" class="headerlink" title="命令行创建"></a>命令行创建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic mysqlpass --from-literal=password=ABCabc123</span><br></pre></td></tr></table></figure>

<p>查看时，会发现已经加密</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe secrets mysqlpass </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Name:         mysqlpass</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password:  9 bytes</span><br></pre></td></tr></table></figure>

<h2 id="环境变量Secret"><a href="#环境变量Secret" class="headerlink" title="环境变量Secret"></a>环境变量Secret</h2><p>使用刚才创建的密码，创建Pod并进行尝试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; stenv.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: mysql-secret</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: mysqlname</span></span><br><span class="line"><span class="string">      image: class-docker.myk8s.cn/library/mysql</span></span><br><span class="line"><span class="string">      imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">      env:</span></span><br><span class="line"><span class="string">        - name: MYSQL_ROOT_PASSWORD</span></span><br><span class="line"><span class="string">          valueFrom:</span></span><br><span class="line"><span class="string">            secretKeyRef:</span></span><br><span class="line"><span class="string">              name: mysqlpass</span></span><br><span class="line"><span class="string">              key: password</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f stenv.yml </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it mysql-secret -- mysql -uroot -pABCabc123</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> is 8</span><br><span class="line">Server version: 8.0.28 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2022, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">exit</span>;</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f stenv.yml </span><br></pre></td></tr></table></figure>

<h1 id="资源配额"><a href="#资源配额" class="headerlink" title="资源配额"></a>资源配额</h1><h2 id="Pod-资源配额"><a href="#Pod-资源配额" class="headerlink" title="Pod 资源配额"></a>Pod 资源配额</h2><p>内存申请64Mi，CPU申请100m，上限为内存128Mi，CPU100m</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; quota.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: frontend</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    name: frontend</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: app</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    resources:</span></span><br><span class="line"><span class="string">      requests:</span></span><br><span class="line"><span class="string">        memory: &quot;64Mi&quot;</span></span><br><span class="line"><span class="string">        cpu: &quot;100m&quot;</span></span><br><span class="line"><span class="string">      limits:</span></span><br><span class="line"><span class="string">        memory: &quot;128Mi&quot;</span></span><br><span class="line"><span class="string">        cpu: &quot;100m&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>1个逻辑CPU等于1000m，如果不带单位就是核心数，可以带小数点，例如0.1。<br>内存的单位：100M等于100 * 1000，100Mi等于100 * 1024</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f quota.yml</span><br><span class="line">kubectl describe -f quota.yml | grep -A 5 Limits</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Limits:</span><br><span class="line">  cpu:     100m</span><br><span class="line">  memory:  128Mi</span><br><span class="line">Requests:</span><br><span class="line">  cpu:        100m</span><br><span class="line">  memory:     64Mi</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f quota.yml</span><br></pre></td></tr></table></figure>

<h2 id="NameSpace-资源配额"><a href="#NameSpace-资源配额" class="headerlink" title="NameSpace 资源配额"></a>NameSpace 资源配额</h2><p>新建namespace</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<p>在ResourceQuota中，requests.cpu: “1” 就代表1000m，requests.memory后面，如果只是一个数字，没有Mi等单位时，默认使用的是字节单位</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; nmquota.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ResourceQuota</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: lixiaohuiquota</span></span><br><span class="line"><span class="string">  namespace: test</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  hard:</span></span><br><span class="line"><span class="string">    pods: &quot;1&quot;</span></span><br><span class="line"><span class="string">    requests.cpu: &quot;1&quot;</span></span><br><span class="line"><span class="string">    requests.memory: &quot;1&quot;</span></span><br><span class="line"><span class="string">    limits.cpu: &quot;2&quot;</span></span><br><span class="line"><span class="string">    limits.memory: &quot;2Gi&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nmquota.yml </span><br></pre></td></tr></table></figure>

<p>新建一个Pod尝试申请资源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; nmpod.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: frontend</span></span><br><span class="line"><span class="string">  namespace: test</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: app</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/nginx</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    resources:</span></span><br><span class="line"><span class="string">      requests:</span></span><br><span class="line"><span class="string">        memory: &quot;64Mi&quot;</span></span><br><span class="line"><span class="string">        cpu: &quot;15000m&quot;</span></span><br><span class="line"><span class="string">      limits:</span></span><br><span class="line"><span class="string">        memory: &quot;128Mi&quot;</span></span><br><span class="line"><span class="string">        cpu: &quot;15000m&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>我们发现由于限制无法申请成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nmpod.yml </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error from server (Forbidden): error when creating <span class="string">&quot;nmpod.yml&quot;</span>: pods <span class="string">&quot;frontend&quot;</span> is forbidden: exceeded quota: lixiaohuiquota, requested: limits.cpu=15,requests.cpu=15,requests.memory=64Mi, used: limits.cpu=0,requests.cpu=0,requests.memory=0, limited: limits.cpu=2,requests.cpu=1,requests.memory=1</span><br></pre></td></tr></table></figure>

<h1 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h1><h2 id="ServiceAaccount"><a href="#ServiceAaccount" class="headerlink" title="ServiceAaccount"></a>ServiceAaccount</h2><p>在一个名为test的namespace中，创建一个名为lixiaohui的ServiceAccount</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace <span class="built_in">test</span></span><br><span class="line">kubectl -n <span class="built_in">test</span> create serviceaccount lixiaohui</span><br><span class="line">kubectl -n <span class="built_in">test</span> get serviceaccounts lixiaohui</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME        SECRETS   AGE</span><br><span class="line">lixiaohui   0         63s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n <span class="built_in">test</span> describe serviceaccounts lixiaohui</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Name:                lixiaohui</span><br><span class="line">Namespace:           <span class="built_in">test</span></span><br><span class="line">Labels:              &lt;none&gt;</span><br><span class="line">Annotations:         &lt;none&gt;</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   &lt;none&gt;</span><br><span class="line">Tokens:              &lt;none&gt;</span><br><span class="line">Events:              &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Role和ClusterRole"><a href="#Role和ClusterRole" class="headerlink" title="Role和ClusterRole"></a>Role和ClusterRole</h2><p>在名为test的namespace中创建一个名为test-role的角色，以及创建一个名为test-clusterrole的集群角色</p>
<p>创建一个名为test-role仅有查看pod的角色</p>
<p>命令行方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n <span class="built_in">test</span> create role --resource=pod --verb=get test-role</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n <span class="built_in">test</span> delete role test-role</span><br></pre></td></tr></table></figure>

<p>YAML 方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; role.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Role</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test-role</span></span><br><span class="line"><span class="string">  namespace: test</span></span><br><span class="line"><span class="string">rules:</span></span><br><span class="line"><span class="string">- apiGroups:</span></span><br><span class="line"><span class="string">  - &quot;&quot;</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">  - pods</span></span><br><span class="line"><span class="string">  verbs:</span></span><br><span class="line"><span class="string">  - get</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f role.yml</span><br><span class="line">kubectl describe role -n <span class="built_in">test</span> test-role</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Name:         test-role</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------  -----------------  --------------  -----</span><br><span class="line">  pods       []                 []              [get]</span><br></pre></td></tr></table></figure>

<p>将上述创建的lixiaohui服务账号和本role绑定</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n <span class="built_in">test</span> create rolebinding --role=test-role --serviceaccount=<span class="built_in">test</span>:lixiaohui lixiaohui-binding</span><br><span class="line">kubectl -n <span class="built_in">test</span> describe rolebinding lixiaohui-binding</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Name:         lixiaohui-binding</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Role:</span><br><span class="line">  Kind:  Role</span><br><span class="line">  Name:  test-role</span><br><span class="line">Subjects:</span><br><span class="line">  Kind            Name       Namespace</span><br><span class="line">  ----            ----       ---------</span><br><span class="line">  ServiceAccount  lixiaohui  <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>测试权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n <span class="built_in">test</span> auth can-i create pods --as=system:serviceaccount:<span class="built_in">test</span>:lixiaohui</span><br><span class="line">no</span><br><span class="line">kubectl -n <span class="built_in">test</span> auth can-i get pods --as=system:serviceaccount:<span class="built_in">test</span>:lixiaohui</span><br><span class="line"><span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<p>ClusterRole</p>
<p>创建一个名为test-clusterrole仅有创建pod和deployment的角色</p>
<p>命令行创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrole --resource=pod,deployment --verb=create test-clusterrole</span><br><span class="line">kubectl describe clusterrole test-clusterrole</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Name:         test-clusterrole</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources         Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------         -----------------  --------------  -----</span><br><span class="line">  pods              []                 []              [create get]</span><br><span class="line">  deployments.apps  []                 []              [create get]</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete clusterrole test-clusterrole</span><br></pre></td></tr></table></figure>

<p>YAML 文件创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; clusterrole.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: ClusterRole</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test-clusterrole</span></span><br><span class="line"><span class="string">rules:</span></span><br><span class="line"><span class="string">- apiGroups:</span></span><br><span class="line"><span class="string">  - &quot;&quot;</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">  - pods</span></span><br><span class="line"><span class="string">  verbs:</span></span><br><span class="line"><span class="string">  - create</span></span><br><span class="line"><span class="string">  - get</span></span><br><span class="line"><span class="string">- apiGroups:</span></span><br><span class="line"><span class="string">  - apps</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">  - deployments</span></span><br><span class="line"><span class="string">  verbs:</span></span><br><span class="line"><span class="string">  - create</span></span><br><span class="line"><span class="string">  - get</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f clusterrole.yml</span><br><span class="line">kubectl describe clusterrole test-clusterrole</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Name:         test-clusterrole</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources         Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------         -----------------  --------------  -----</span><br><span class="line">  pods              []                 []              [create get]</span><br><span class="line">  deployments.apps  []                 []              [create get]</span><br></pre></td></tr></table></figure>

<p>将lixiaohui用户和clusterrole绑定，并测试权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding --clusterrole=test-clusterrole --serviceaccount=<span class="built_in">test</span>:lixiaohui lixiaohui-clusterbind</span><br><span class="line">kubectl describe clusterrolebinding lixiaohui-clusterbind</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Name:         lixiaohui-clusterbind</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Role:</span><br><span class="line">  Kind:  ClusterRole</span><br><span class="line">  Name:  test-clusterrole</span><br><span class="line">Subjects:</span><br><span class="line">  Kind            Name       Namespace</span><br><span class="line">  ----            ----       ---------</span><br><span class="line">  ServiceAccount  lixiaohui  <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i get pods --as=system:serviceaccount:<span class="built_in">test</span>:lixiaohui</span><br><span class="line"><span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">kubectl auth can-i create pods --as=system:serviceaccount:<span class="built_in">test</span>:lixiaohui</span><br><span class="line"><span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">kubectl auth can-i create deployments --as=system:serviceaccount:<span class="built_in">test</span>:lixiaohui</span><br><span class="line"><span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">kubectl auth can-i create secret --as=system:serviceaccount:<span class="built_in">test</span>:lixiaohui</span><br><span class="line">no</span><br><span class="line"></span><br><span class="line">kubectl auth can-i create service --as=system:serviceaccount:<span class="built_in">test</span>:lixiaohui</span><br><span class="line">no</span><br></pre></td></tr></table></figure>

<h2 id="网络策略"><a href="#网络策略" class="headerlink" title="网络策略"></a>网络策略</h2><p>在名为zhangsan的namespace中，创建一个仅允许来自名为lixiaohui的namespace连接的网络策略</p>
<p>创建两个namesapce</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace zhangsan</span><br><span class="line">kubectl create namespace lixiaohui</span><br></pre></td></tr></table></figure>

<p>在zhangsan的namespace中，新建一个pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; nppod.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod</span></span><br><span class="line"><span class="string">  namespace: zhangsan</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: httpd</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: httpd</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - name: web</span></span><br><span class="line"><span class="string">        containerPort: 80</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nppod.yml</span><br><span class="line">kubectl get pod -n zhangsan  -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP              NODE               NOMINATED NODE   READINESS GATES</span><br><span class="line">pod    1/1     Running   0          83s   172.16.152.73   k8s-worker2        &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>在lixiaohui的namespace中，新建一个pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; nppod1.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod1</span></span><br><span class="line"><span class="string">  namespace: lixiaohui</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: httpd</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/httpd</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - name: web</span></span><br><span class="line"><span class="string">        containerPort: 80</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nppod1.yml</span><br><span class="line">kubectl get pod -n lixiaohui -o wide</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP              NODE               NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1   1/1     Running   0          14s   172.16.152.74   k8s-worker2          &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>新建网络策略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; np.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: networking.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: NetworkPolicy</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: allow-from-namesapce-lixiaohui</span></span><br><span class="line"><span class="string">  namespace: zhangsan</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  podSelector: &#123;&#125;</span></span><br><span class="line"><span class="string">  policyTypes:</span></span><br><span class="line"><span class="string">  - Ingress</span></span><br><span class="line"><span class="string">  ingress:</span></span><br><span class="line"><span class="string">  - from:</span></span><br><span class="line"><span class="string">    - namespaceSelector:</span></span><br><span class="line"><span class="string">        matchLabels:</span></span><br><span class="line"><span class="string">          kubernetes.io/metadata.name: lixiaohui</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - protocol: TCP</span></span><br><span class="line"><span class="string">      port: 80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f np.yml</span><br></pre></td></tr></table></figure>

<p>测试效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; nptest.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod-default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: busybox</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">      - /bin/sh</span></span><br><span class="line"><span class="string">      - -c</span></span><br><span class="line"><span class="string">      - &quot;sleep 10m&quot;</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl create -f nptest.yml</span><br></pre></td></tr></table></figure>

<p>从default namespace中访问没有被网络策略选中的pod，发现成功访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it pod-default -- wget 172.16.152.74</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Connecting to 172.16.152.74 (172.16.152.74:80)</span><br><span class="line">saving to <span class="string">&#x27;index.html&#x27;</span></span><br><span class="line">index.html           100% |********************************|    45  0:00:00 ETA</span><br><span class="line"><span class="string">&#x27;index.html&#x27;</span> saved</span><br></pre></td></tr></table></figure>

<p>从default namespace中访问被网络策略选中的pod，发现无法访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it pod-default -- wget 172.16.152.73</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connecting to 172.16.152.73 (172.16.152.73:80)</span><br></pre></td></tr></table></figure>
<p>新建一个lixiaohui namespace的pod，测试是否可以访问被隔离的pod，由于网络策略的原因，一定是可以访问的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; nplixiaohuitest.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod-lixiaohui-test</span></span><br><span class="line"><span class="string">  namespace: lixiaohui</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: busybox</span></span><br><span class="line"><span class="string">    image: class-docker.myk8s.cn/library/busybox</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">      - /bin/sh</span></span><br><span class="line"><span class="string">      - -c</span></span><br><span class="line"><span class="string">      - &quot;sleep 10m&quot;</span></span><br><span class="line"><span class="string">  restartPolicy: OnFailure</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl create -f nplixiaohuitest.yml</span><br></pre></td></tr></table></figure>

<p>以下测试中，发现可以正常访问zhangsan namesapce中的pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n lixiaohui <span class="built_in">exec</span> -it pod-lixiaohui-test -- wget 172.16.152.73</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">saving to <span class="string">&#x27;index.html&#x27;</span></span><br><span class="line">index.html           100% |********************************|    45  0:00:00 ETA</span><br><span class="line"><span class="string">&#x27;index.html&#x27;</span> saved</span><br></pre></td></tr></table></figure>

<h1 id="Helm-概念与实践"><a href="#Helm-概念与实践" class="headerlink" title="Helm 概念与实践"></a>Helm 概念与实践</h1><h2 id="Helm基本概念"><a href="#Helm基本概念" class="headerlink" title="Helm基本概念"></a>Helm基本概念</h2><p>Helm 是 Kubernetes 的包管理工具，它能够简化 Kubernetes 应用程序的部署和管理。在 Kubernetes 中，一个应用程序可能由多个资源组成，比如 Deployment、Service、ConfigMap、Ingress 等。Helm 可以将这些资源打包成一个 Helm Chart（包），方便用户进行安装、升级、回滚和删除等操作，就和系统里的YUM&#x2F;DNF&#x2F;APT非常的类似。</p>
<h2 id="主要组件"><a href="#主要组件" class="headerlink" title="主要组件"></a>主要组件</h2><ol>
<li><p><strong>Helm Client</strong></p>
<ul>
<li>这是用户与 Helm 交互的客户端工具。用户通过在本地机器上运行 Helm 命令来操作 Helm Chart，例如安装、升级、查询等操作。它会直接与 Kubernetes API 服务器交互，客户端可以直接从它的官方GitHub下载，地址是：<a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a></li>
</ul>
</li>
<li><p><strong>Helm Chart</strong></p>
<ul>
<li><p>Helm Chart 是一个打包的 Kubernetes 应用程序，包含所有必要的资源定义和配置文件。它类似于软件包管理工具中的“包”，用于简化 Kubernetes 应用的部署和管理。一个 Helm Chart 包含以下部分：</p>
<ul>
<li><p><strong>Chart.yaml</strong>：</p>
<ul>
<li><p>定义：这是 Helm Chart 的元数据文件，包含 Chart 的基本信息。大概内容：</p>
<ul>
<li>name：Chart 的名称。</li>
<li>version：Chart 的版本号（遵循语义化版本规范）。</li>
<li>description：Chart 的简要描述。</li>
<li>dependencies：依赖的其他 Chart（可选）。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>values.yaml</strong>：它是 Chart 的默认配置文件。用户可以通过修改这个文件或者在安装时覆盖其中的值来定制 Chart 的行为。比如，它可能包含应用的副本数量、镜像版本、资源限制等配置项。</p>
</li>
<li><p><strong>templates&#x2F;</strong>：包含 Kubernetes 资源的模板文件，这些模板文件在安装或升级时会被渲染成实际的 Kubernetes 资源，渲染的时候，将用values.yaml里的值替换掉templates模板里的变量，例如，一个 Deployment 的模板文件可以根据 values.yaml 中定义的副本数量和镜像版本来生成对应的 Deployment 资源，具体渲染的命令是：<code>helm template</code>，可以用–help等方式获取语法，不过需要注意的是，这会渲染出实际的 Kubernetes 资源文件，但不会实际部署到集群中。</p>
</li>
<li><p><strong>charts&#x2F;</strong>：如果当前 Chart 依赖其他 Chart，这些依赖的 Chart 会存放在这个目录下。这样可以实现 Chart 之间的组合和复用。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Helm Repository（仓库）</strong></p>
<ul>
<li>它是一个存储 Helm Chart 的仓库，可以是本地的，也可以是远程的。远程仓库通常是一个 HTTP 服务器，用户可以从仓库中搜索、下载和更新 Helm Chart。例如，Helm 官方维护了一个默认的公共仓库，里面包含了许多常用的 Helm Chart，用户可以通过 Helm 命令将这些 Chart 添加到本地的 Chart 仓库列表中，然后进行安装等操作。</li>
</ul>
</li>
</ol>
<p>官方网址 <a target="_blank" rel="noopener" href="http://helm.sh/">http://helm.sh</a></p>
<h2 id="Helm安装"><a href="#Helm安装" class="headerlink" title="Helm安装"></a>Helm安装</h2><p>下载安装Helm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v3.17.3-linux-amd64.tar.gz</span><br><span class="line">tar xf helm-v3.17.3-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">mv</span> linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">helm completion bash &gt; /etc/bash_completion.d/helm</span><br></pre></td></tr></table></figure>

<p>默认情况下，helm内置了一个hub，用于软件搜索和安装，搜索软件是否可被安装，用以下格式命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search hub Packages</span><br></pre></td></tr></table></figure>

<p>命令行显示有点奇怪，也不够丰富，可以考虑用浏览器打开搜索：<a target="_blank" rel="noopener" href="https://hub.helm.sh/">https://hub.helm.sh</a></p>
<h2 id="添加仓库"><a href="#添加仓库" class="headerlink" title="添加仓库"></a>添加仓库</h2><p>官方仓库网速慢，可以考虑一下以下仓库或自己部署仓库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure>

<p>添加方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add azurerepo http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure>

<h2 id="Helm-实验案例"><a href="#Helm-实验案例" class="headerlink" title="Helm 实验案例"></a>Helm 实验案例</h2><h3 id="wordpress安装"><a href="#wordpress安装" class="headerlink" title="wordpress安装"></a>wordpress安装</h3><h4 id="手工定制安装"><a href="#手工定制安装" class="headerlink" title="手工定制安装"></a>手工定制安装</h4><p>本次安装一个wordpress</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search repo wordpress</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                    CHART VERSION   APP VERSION     DESCRIPTION</span><br><span class="line">azurerepo/wordpress     9.0.3           5.3.2           DEPRECATED Web publishing platform <span class="keyword">for</span> building...</span><br></pre></td></tr></table></figure>

<p>ok，发现一个wordpress包，那这个包里有什么？把包下出来研究研究</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# helm pull azurerepo/wordpress</span><br><span class="line">root@k8s-master:~# <span class="built_in">ls</span></span><br><span class="line">wordpress-9.0.3.tgz</span><br></pre></td></tr></table></figure>

<p>下完是一个压缩包，解压看看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# tar xf wordpress-9.0.3.tgz</span><br><span class="line">root@k8s-master:~# <span class="built_in">ls</span></span><br><span class="line">wordpress  wordpress-9.0.3.tgz</span><br><span class="line">root@k8s-master:~# <span class="built_in">cd</span> wordpress/</span><br><span class="line">root@k8s-master:~/wordpress# <span class="built_in">ls</span></span><br><span class="line">charts  Chart.yaml  README.md  requirements.lock  requirements.yaml  templates  values.schema.json  values.yaml</span><br></pre></td></tr></table></figure>

<p>果然看到了<code>Chart.yaml</code> <code>templates</code>  <code>values.yaml</code></p>
<p>看看都有哪些模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/wordpress# <span class="built_in">ls</span> templates/</span><br><span class="line">deployment.yaml  externaldb-secrets.yaml  _helpers.tpl  ingress.yaml  NOTES.txt  pvc.yaml  secrets.yaml  servicemonitor.yaml  svc.yaml  tests  tls-secrets.yaml</span><br></pre></td></tr></table></figure>

<p>模板里面都是各种变量，稍后需要用values.yml来填充</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/wordpress# <span class="built_in">head</span> templates/deployment.yaml</span><br><span class="line">apiVersion: &#123;&#123; template <span class="string">&quot;wordpress.deployment.apiVersion&quot;</span> . &#125;&#125;</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; template <span class="string">&quot;wordpress.fullname&quot;</span> . &#125;&#125;</span><br><span class="line">  labels: &#123;&#123;- include <span class="string">&quot;wordpress.labels&quot;</span> . | nindent 4 &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: &#123;&#123;- include <span class="string">&quot;wordpress.matchLabels&quot;</span> . | nindent 6 &#125;&#125;</span><br><span class="line">  &#123;&#123;- <span class="keyword">if</span> .Values.updateStrategy &#125;&#125;</span><br><span class="line">  strategy: &#123;&#123; toYaml .Values.updateStrategy | nindent 4 &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>ok，模板看到了，我们试试用values.yml里的变量来渲染模板，生成最终的yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/wordpress# helm template --version 9.0.3 azurerepo/wordpress</span><br></pre></td></tr></table></figure>

<p>从仓库中读出values.yml，将templates目录里的模板渲染成功</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: wordpress/charts/mariadb/templates/secrets.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">release-name-mariadb</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&quot;mariadb&quot;</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">&quot;mariadb-7.3.12&quot;</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">&quot;release-name&quot;</span></span><br><span class="line">    <span class="attr">heritage:</span> <span class="string">&quot;Helm&quot;</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">mariadb-root-password:</span> <span class="string">&quot;QmhiblBvMXJmZQ==&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mariadb-password:</span> <span class="string">&quot;VWZxWm5CbnVicA==&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: wordpress/templates/secrets.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br></pre></td></tr></table></figure>

<p>如果有一个值不满意怎么办？可以手工指定某一个参数，或者干脆用本地的values.yaml</p>
<p>先试试手工指定，我们看了一下仓库里的value，要用这个镜像，那我来随便改一个看看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/wordpress# helm show values azurerepo/wordpress | grep ^image: -A 10</span><br><span class="line">image:</span><br><span class="line">  registry: docker.io</span><br><span class="line">  repository: bitnami/wordpress</span><br><span class="line">  tag: 5.3.2-debian-10-r32</span><br><span class="line">  <span class="comment">## Specify a imagePullPolicy</span></span><br><span class="line">  <span class="comment">## Defaults to &#x27;Always&#x27; if image tag is &#x27;latest&#x27;, else set to &#x27;IfNotPresent&#x27;</span></span><br><span class="line">  <span class="comment">## ref: http://kubernetes.io/docs/user-guide/images/#pre-pulling-images</span></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  <span class="comment">## Optionally specify an array of imagePullSecrets.</span></span><br><span class="line">  <span class="comment">## Secrets must be manually created in the namespace.</span></span><br></pre></td></tr></table></figure>

<p>渲染时手工指定某个参数，比如替换一个镜像的registry</p>
<p>我通过–set参数指定了镜像的registry，并且生成了模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/wordpress# helm template --version 9.0.3 azurerepo/wordpress --<span class="built_in">set</span> image.registry=linuxcenter.cn &gt; custom.yml</span><br><span class="line">WARNING: This chart is deprecated</span><br><span class="line">root@k8s-master:~/wordpress# grep linuxcenter custom.yml</span><br><span class="line">          image: linuxcenter.cn/bitnami/wordpress:5.3.2-debian-10-r32</span><br><span class="line">      image: linuxcenter.cn/bitnami/wordpress:5.3.2-debian-10-r32</span><br></pre></td></tr></table></figure>

<p>当然，我上面的set是瞎写的，镜像仓库不存在，只是为了演示参数而已</p>
<p>我们重新用默认参数渲染出最终的yaml，然后向集群部署</p>
<p><strong>这一步将安装mariadb和wordpress，我们这里用的是存储章节设置的默认存储类，所以会自动创建pv以及pvc，你要是还没有默认存储类，往上翻，重新做一下存储类并标记为默认即可</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/wordpress# helm template --version 9.0.3 azurerepo/wordpress &gt; lixiaohui.yml</span><br><span class="line">WARNING: This chart is deprecated</span><br><span class="line">root@k8s-master:~/wordpress# kubectl apply -f lixiaohui.yml</span><br><span class="line">secret/release-name-mariadb created</span><br><span class="line">secret/release-name-wordpress created</span><br><span class="line">configmap/release-name-mariadb created</span><br><span class="line">configmap/release-name-mariadb-tests created</span><br><span class="line">persistentvolumeclaim/release-name-wordpress created</span><br><span class="line">service/release-name-mariadb created</span><br><span class="line">service/release-name-wordpress created</span><br><span class="line">deployment.apps/release-name-wordpress created</span><br><span class="line">statefulset.apps/release-name-mariadb created</span><br><span class="line">pod/release-name-mariadb-test-8u7uw created</span><br><span class="line">pod/release-name-credentials-test created</span><br></pre></td></tr></table></figure>

<p>不需要看到pod工作正常，我们只研究helm自身，如果你需要它工作正常，需要搞定镜像、机器内存需要再加一下，不然数据库起不来</p>
<p>以上就是研究的过程，其实一般来说，不用这么麻烦，比如我们最后实际上就是用的默认value，如果默认value你就满意，可以用下面的方法直接让helm来管理，我们不用改东西，如果你并不是用的<code>helm install</code>，后面就不受helm管理，因为当你使用 <code>helm template</code> 命令生成 Kubernetes 资源清单文件并手动将其部署到集群中时，这些资源不会被 Helm 的生命周期管理所跟踪。因此，当你运行 <code>helm list</code> 命令时，不会看到任何相关的 Helm Release，因为 Helm 的 Release 管理机制没有被触发。</p>
<h4 id="helm仓库直接安装"><a href="#helm仓库直接安装" class="headerlink" title="helm仓库直接安装"></a>helm仓库直接安装</h4><p>这一步将安装mariadb和wordpress，我们这里用的是存储章节设置的默认存储类，所以会自动创建pv以及pvc，你要是还没有默认存储类，往上翻，重新做一下存储类并标记为默认即可</p>
<p><code>helm install</code> 也是只是<code>--set</code>参数的，不一定非要用默认的值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/wordpress# helm install wordpress azurerepo/wordpress</span><br><span class="line">WARNING: This chart is deprecated</span><br><span class="line">NAME: wordpress</span><br><span class="line">LAST DEPLOYED: Thu Apr 24 13:10:09 2025</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/wordpress# helm list</span><br><span class="line">NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION</span><br><span class="line">wordpress       default         1               2025-04-24 13:10:09.708968227 +0800 CST deployed        wordpress-9.0.3 5.3.2</span><br></pre></td></tr></table></figure>

<p>ok，安装完毕，现在来看看这个服务怎么样了</p>
<p>查询服务端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">wordpress           LoadBalancer   10.102.156.226   &lt;pending&gt;     80:31194/TCP,443:30386/TCP   3m42s</span><br><span class="line">wordpress-mariadb   ClusterIP      10.106.8.85      &lt;none&gt;        3306/TCP                     3m42s</span><br></pre></td></tr></table></figure>

<p>查询pod所在节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get pod -o wide</span><br></pre></td></tr></table></figure>

<p>不需要看到pod工作正常，我们只研究helm自身，如果你需要它工作正常，需要搞定镜像、机器内存需要再加一下，不然数据库起不来</p>
<h3 id="k8s-Dashboard安装"><a href="#k8s-Dashboard安装" class="headerlink" title="k8s Dashboard安装"></a>k8s Dashboard安装</h3><p><strong>这是可选实验，不管你这个实验做的怎么样，为了安全，都不要在任何生产环境中使用dashboard</strong></p>
<p>添加helm仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span></span><br><span class="line">helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/</span><br></pre></td></tr></table></figure>

<p>不过你够呛能连上，用我的仓库加个速吧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span></span><br><span class="line">helm repo add kubernetes-dashboard https://oss.linuxcenter.cn/files/cka/helm</span><br></pre></td></tr></table></figure>

<p>部署dashboard</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --create-namespace --namespace kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Release &quot;kubernetes-dashboard&quot; does not exist. Installing it now.</span><br><span class="line">NAME: kubernetes-dashboard</span><br><span class="line">LAST DEPLOYED: Tue Apr 22 17:06:51 2025</span><br><span class="line">NAMESPACE: kubernetes-dashboard</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">*************************************************************************************************</span><br><span class="line">*** PLEASE BE PATIENT: Kubernetes Dashboard may need a few minutes to get up and become ready ***</span><br><span class="line">*************************************************************************************************</span><br><span class="line"></span><br><span class="line">Congratulations! You have just installed Kubernetes Dashboard in your cluster.</span><br><span class="line"></span><br><span class="line">To access Dashboard run:</span><br><span class="line">  kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy 8443:443</span><br><span class="line"></span><br><span class="line">NOTE: In case port-forward command does not work, make sure that kong service name is correct.</span><br><span class="line">      Check the services in Kubernetes Dashboard namespace using:</span><br><span class="line">        kubectl -n kubernetes-dashboard get svc</span><br><span class="line"></span><br><span class="line">Dashboard will be available at:</span><br><span class="line">  https://localhost:8443</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看看都部署了什么东西？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get all -n kubernetes-dashboard</span><br><span class="line">NAME                                                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/kubernetes-dashboard-api-57fff658db-v78ls               0/1     ContainerCreating   0          14s</span><br><span class="line">pod/kubernetes-dashboard-auth-6d58f47489-dt82g              0/1     ContainerCreating   0          14s</span><br><span class="line">pod/kubernetes-dashboard-kong-79867c9c48-hhxjs              0/1     Init:0/1            0          14s</span><br><span class="line">pod/kubernetes-dashboard-metrics-scraper-76df4956c4-5jhhw   0/1     ContainerCreating   0          14s</span><br><span class="line">pod/kubernetes-dashboard-web-56df7655d9-zgd5m               0/1     ContainerCreating   0          14s</span><br><span class="line"></span><br><span class="line">NAME                                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/kubernetes-dashboard-api               ClusterIP   10.96.72.242     &lt;none&gt;        8000/TCP   14s</span><br><span class="line">service/kubernetes-dashboard-auth              ClusterIP   10.110.166.42    &lt;none&gt;        8000/TCP   14s</span><br><span class="line">service/kubernetes-dashboard-kong-proxy        ClusterIP   10.105.29.218    &lt;none&gt;        443/TCP    14s</span><br><span class="line">service/kubernetes-dashboard-metrics-scraper   ClusterIP   10.100.78.233    &lt;none&gt;        8000/TCP   14s</span><br><span class="line">service/kubernetes-dashboard-web               ClusterIP   10.103.183.178   &lt;none&gt;        8000/TCP   14s</span><br><span class="line"></span><br><span class="line">NAME                                                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/kubernetes-dashboard-api               0/1     1            0           14s</span><br><span class="line">deployment.apps/kubernetes-dashboard-auth              0/1     1            0           14s</span><br><span class="line">deployment.apps/kubernetes-dashboard-kong              0/1     1            0           14s</span><br><span class="line">deployment.apps/kubernetes-dashboard-metrics-scraper   0/1     1            0           14s</span><br><span class="line">deployment.apps/kubernetes-dashboard-web               0/1     1            0           14s</span><br><span class="line"></span><br><span class="line">NAME                                                              DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/kubernetes-dashboard-api-57fff658db               1         1         0       14s</span><br><span class="line">replicaset.apps/kubernetes-dashboard-auth-6d58f47489              1         1         0       14s</span><br><span class="line">replicaset.apps/kubernetes-dashboard-kong-79867c9c48              1         1         0       14s</span><br><span class="line">replicaset.apps/kubernetes-dashboard-metrics-scraper-76df4956c4   1         1         0       14s</span><br><span class="line">replicaset.apps/kubernetes-dashboard-web-56df7655d9               1         1         0       14s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>好好好，在中国又遇到了镜像无法下载的坑，看看都有哪些镜像？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get deployments.apps -n kubernetes-dashboard -o yaml | grep image:</span><br><span class="line">          image: docker.io/kubernetesui/dashboard-api:1.12.0</span><br><span class="line">          image: docker.io/kubernetesui/dashboard-auth:1.2.4</span><br><span class="line">          image: kong:3.8</span><br><span class="line">          image: kong:3.8</span><br><span class="line">          image: docker.io/kubernetesui/dashboard-metrics-scraper:1.2.2</span><br><span class="line">          image: docker.io/kubernetesui/dashboard-web:1.6.2</span><br></pre></td></tr></table></figure>

<p>在所有的节点上都准备一下镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">docker pull class-docker.myk8s.cn/kubernetesui/dashboard-api:1.12.0</span><br><span class="line">docker pull class-docker.myk8s.cn/kubernetesui/dashboard-auth:1.2.4</span><br><span class="line">docker pull class-docker.myk8s.cn/library/kong:3.8</span><br><span class="line">docker pull class-docker.myk8s.cn/kubernetesui/dashboard-metrics-scraper:1.2.2</span><br><span class="line">docker pull class-docker.myk8s.cn/kubernetesui/dashboard-web:1.6.2</span><br><span class="line"></span><br><span class="line">docker tag class-docker.myk8s.cn/kubernetesui/dashboard-api:1.12.0 docker.io/kubernetesui/dashboard-api:1.12.0</span><br><span class="line">docker tag class-docker.myk8s.cn/kubernetesui/dashboard-auth:1.2.4 docker.io/kubernetesui/dashboard-auth:1.2.4</span><br><span class="line">docker tag class-docker.myk8s.cn/library/kong:3.8 kong:3.8</span><br><span class="line">docker tag class-docker.myk8s.cn/kubernetesui/dashboard-metrics-scraper:1.2.2 docker.io/kubernetesui/dashboard-metrics-scraper:1.2.2</span><br><span class="line">docker tag class-docker.myk8s.cn/kubernetesui/dashboard-web:1.6.2 docker.io/kubernetesui/dashboard-web:1.6.2</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">docker rmi class-docker.myk8s.cn/kubernetesui/dashboard-api:1.12.0</span><br><span class="line">docker rmi class-docker.myk8s.cn/kubernetesui/dashboard-auth:1.2.4</span><br><span class="line">docker rmi class-docker.myk8s.cn/library/kong:3.8</span><br><span class="line">docker rmi class-docker.myk8s.cn/kubernetesui/dashboard-metrics-scraper:1.2.2</span><br><span class="line">docker rmi class-docker.myk8s.cn/kubernetesui/dashboard-web:1.6.2</span><br></pre></td></tr></table></figure>

<p>重启deployment</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get deployments.apps -n kubernetes-dashboard -o name | xargs kubectl rollout restart -n kubernetes-dashboard</span><br><span class="line">deployment.apps/kubernetes-dashboard-api restarted</span><br><span class="line">deployment.apps/kubernetes-dashboard-auth restarted</span><br><span class="line">deployment.apps/kubernetes-dashboard-kong restarted</span><br><span class="line">deployment.apps/kubernetes-dashboard-metrics-scraper restarted</span><br><span class="line">deployment.apps/kubernetes-dashboard-web restarted</span><br></pre></td></tr></table></figure>

<p>看看pod状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get pod -n kubernetes-dashboard</span><br><span class="line">NAME                                                    READY   STATUS        RESTARTS   AGE</span><br><span class="line">kubernetes-dashboard-api-55bdb6859-s6fzw                1/1     Running       0          9m38s</span><br><span class="line">kubernetes-dashboard-auth-5ffbf7cb46-bqj6c              1/1     Running       0          9m38s</span><br><span class="line">kubernetes-dashboard-kong-5bd569b997-74klx              1/1     Running       0          9m37s</span><br><span class="line">kubernetes-dashboard-metrics-scraper-7cfccb7644-5t9rt   1/1     Running       0          9m37s</span><br><span class="line">kubernetes-dashboard-web-6c67987c9f-c7ssl               1/1     Running       0          9m37s</span><br></pre></td></tr></table></figure>

<p>看到kong-proxy是ClusterIP，不方便查看，直接改为nodeport，就可以用任何节点的ip打开查看了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl edit service -n kubernetes-dashboard kubernetes-dashboard-kong-proxy</span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br></pre></td></tr></table></figure>

<p>看看我们的端口多少？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl get service -n kubernetes-dashboard</span><br><span class="line">NAME                                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard-api               ClusterIP   10.96.72.242     &lt;none&gt;        8000/TCP        17m</span><br><span class="line">kubernetes-dashboard-auth              ClusterIP   10.110.166.42    &lt;none&gt;        8000/TCP        17m</span><br><span class="line">kubernetes-dashboard-kong-proxy        NodePort    10.105.29.218    &lt;none&gt;        443:31000/TCP   17m</span><br><span class="line">kubernetes-dashboard-metrics-scraper   ClusterIP   10.100.78.233    &lt;none&gt;        8000/TCP        17m</span><br><span class="line">kubernetes-dashboard-web               ClusterIP   10.103.183.178   &lt;none&gt;        8000/TCP        17m</span><br></pre></td></tr></table></figure>

<p>比如我在浏览器输入<a target="_blank" rel="noopener" href="https://192.168.8.3:31000/">https://192.168.8.3:31000</a></p>
<p><img src="/files/cka/images/k8s/dashboard/dashboard-login.png"></p>
<p>创建一个用户登录的超级用户，并创建长期有效的token</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">create-dash-user.yml</span> <span class="string">&lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lxh-dash</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lxh-dash-cluster-admin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lxh-dash</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lxh-dash-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/service-account.name:</span> <span class="string">&quot;lxh-dash&quot;</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/service-account-token</span></span><br><span class="line"></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f create-dash-user.yml</span><br></pre></td></tr></table></figure>

<p>获取登录token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret lxh-dash-secret -n kubernetes-dashboard -o jsonpath=&#123;<span class="string">&quot;.data.token&quot;</span>&#125; | <span class="built_in">base64</span> -d</span><br></pre></td></tr></table></figure>

<p>除了bash的root@master:~#提示符之外，把所有的内容复制一下，然后粘贴到登录框里并点击登录</p>
<p><img src="/files/cka/images/k8s/dashboard/dashboard-logined.png"></p>
<h1 id="监控与升级"><a href="#监控与升级" class="headerlink" title="监控与升级"></a>监控与升级</h1><h2 id="部署Metrics"><a href="#部署Metrics" class="headerlink" title="部署Metrics"></a>部署Metrics</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://www.linuxcenter.cn/files/cka/cka-yaml/metrics-components.yaml</span><br></pre></td></tr></table></figure>

<p>也需要解决镜像的问题，记得在所有机器上都准备一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployments.apps -n kube-system metrics-server -o yaml | grep image:</span><br><span class="line">        image: registry.k8s.io/metrics-server/metrics-server:v0.7.2</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull class-docker.myk8s.cn/metrics-server/metrics-server:v0.7.2</span><br><span class="line">docker tag class-docker.myk8s.cn/metrics-server/metrics-server:v0.7.2 registry.k8s.io/metrics-server/metrics-server:v0.7.2</span><br><span class="line">docker rmi class-docker.myk8s.cn/metrics-server/metrics-server:v0.7.2</span><br></pre></td></tr></table></figure>

<p>重启deployment触发部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl rollout restart deployment -n kube-system metrics-server</span><br><span class="line">deployment.apps/metrics-server restarted</span><br></pre></td></tr></table></figure>

<p>部署好之后，执行kubectl top 命令时就会返回结果了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl top nodes</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                    CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-master              142m         3%     1725Mi          45%       </span><br><span class="line">k8s-worker1             150m         3%     1024Mi          27%       </span><br><span class="line">k8s-worker2             53m          1%     995Mi           26%       </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl top pod</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                               CPU(cores)   MEMORY(bytes)   </span><br><span class="line">lixiaohui-mq4sp                    0m           0Mi             </span><br><span class="line">lixiaohui-qjlwt                    0m           0Mi             </span><br><span class="line">lixiaohui-sm6pp                    0m           0Mi             </span><br></pre></td></tr></table></figure>

<h2 id="HPA-自动扩容"><a href="#HPA-自动扩容" class="headerlink" title="HPA 自动扩容"></a>HPA 自动扩容</h2><p>在部署了<code>metrics server</code>后，可以给HPA提供自动扩容的资源用量指标，帮助HPA快速识别用量，并完成自动扩容</p>
<p>先创建一个deployment以及上层的访问service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">hpatest.yml</span> <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">class-docker.myk8s.cn/hpa-example</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>根据以上代码，deployment创建了一个pod副本，service提供了一个名为php-apache的访问点</p>
<p>先在所有机器上下载一下镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull class-docker.myk8s.cn/hpa-example</span><br></pre></td></tr></table></figure>

<p>创建后，来测试一下pod和service本身是否可以访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f hpatest.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployments.apps</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   1/1     1            1           21s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   25d</span><br><span class="line">php-apache   ClusterIP   10.110.249.4   &lt;none&gt;        80/TCP    53m</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -o wide</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">php-apache-5db7b77785-6j9lj   1/1     Running   0          53m   172.16.194.66   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl 172.16.194.66</span><br><span class="line">OK!</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 10.110.249.4</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OK!</span><br></pre></td></tr></table></figure>

<p>经过测试，pod和service都可以访问，现在来做一个CPU利用率大于50，就扩容的例子</p>
<p>需要注意的是，我们这里为了规避瞬时高峰的波动，给扩容和缩容设置了稳定的时间窗口</p>
<ol>
<li><p><strong>扩容场景</strong>：</p>
<ul>
<li><p>当 CPU 使用率超过目标值（50%）时，HPA 会检测到需要扩容。</p>
</li>
<li><p>但因为设置了 <code>stabilizationWindowSeconds: 10</code>，HPA 会等待 10 秒，观察这段时间内的 CPU 使用率是否持续高于目标值。</p>
</li>
<li><p>如果在这 10 秒内，CPU 使用率一直高于 50%，HPA 会执行扩容操作。</p>
</li>
<li><p>如果在这 10 秒内，CPU 使用率恢复正常（低于 50%），HPA 则不会执行扩容操作。</p>
</li>
</ul>
</li>
<li><p><strong>缩容场景</strong>：</p>
<ul>
<li><p>当 CPU 使用率低于目标值（50%）时，HPA 会检测到需要缩容。</p>
</li>
<li><p>但因为设置了 <code>stabilizationWindowSeconds: 30</code>，HPA 会等待 30 秒，观察这段时间内的 CPU 使用率是否持续低于目标值。</p>
</li>
<li><p>如果在这 30 秒内，CPU 使用率一直低于 50%，HPA 会执行缩容操作。</p>
</li>
<li><p>如果在这 30 秒内，CPU 使用率恢复正常（高于 50%），HPA 则不会执行缩容操作。</p>
</li>
</ul>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">hpa.yml</span> <span class="string">&lt;&lt;-&#x27;EOF&#x27;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">50</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">behavior:</span></span><br><span class="line">    <span class="attr">scaleUp:</span></span><br><span class="line">      <span class="attr">stabilizationWindowSeconds:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">scaleDown:</span></span><br><span class="line">      <span class="attr">stabilizationWindowSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl apply -f hpa.yml</span><br></pre></td></tr></table></figure>

<p>稍等一分钟，执行以下命令查看实时CPU利用率和目标的差距，并观察副本数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get hpa</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME         REFERENCE               TARGETS       MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   cpu: 0%/50%   1         10        1          31s</span><br></pre></td></tr></table></figure>

<p>启动一个不同的 Pod 作为客户端。 客户端 Pod 中的容器在无限循环中运行，向 php-apache 服务发送查询。</p>
<p>不断的访问，将产生压力，压力大了，hpa就会扩容</p>
<p>需要注意的是，需要先在所有节点上下载busybox镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -i --<span class="built_in">tty</span> load-generator --<span class="built_in">rm</span> --image=class-docker.myk8s.cn/library/busybox:1.28 --restart=Never -- /bin/sh -c <span class="string">&quot;while sleep 0.01; do wget -q -O- http://php-apache; done&quot;</span></span><br></pre></td></tr></table></figure>

<p>运行后会不断的输出ok，<code>不要结束输出</code>，开一个新的ssh会话，运行以下命令，观察hpa收集到的信息以及pod的扩容情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get hpa php-apache --watch</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">NAME</span>         REFERENCE               TARGETS         MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line"><span class="attribute">php</span>-apache   Deployment/php-apache   cpu: <span class="number">231</span>%/<span class="number">50</span>%   <span class="number">1</span>         <span class="number">10</span>        <span class="number">1</span>          <span class="number">10</span>m</span><br><span class="line"><span class="attribute">php</span>-apache   Deployment/php-apache   cpu: <span class="number">250</span>%/<span class="number">50</span>%   <span class="number">1</span>         <span class="number">10</span>        <span class="number">4</span>          <span class="number">10</span>m</span><br></pre></td></tr></table></figure>

<p>此时按下<code>CTRL C结束</code>ok的输出，再次观察target的利用率下降</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get hpa php-apache --watch</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NAME         REFERENCE               TARGETS         MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   cpu: 231%/50%   1         10        1          10m</span><br><span class="line">php-apache   Deployment/php-apache   cpu: 250%/50%   1         10        4          10m</span><br><span class="line">php-apache   Deployment/php-apache   cpu: 144%/50%   1         10        5          10m</span><br><span class="line">php-apache   Deployment/php-apache   cpu: 72%/50%    1         10        5          11m</span><br><span class="line">php-apache   Deployment/php-apache   cpu: 68%/50%    1         10        5          11m</span><br><span class="line">php-apache   Deployment/php-apache   cpu: 67%/50%    1         10        7          11m</span><br><span class="line">php-apache   Deployment/php-apache   cpu: 30%/50%    1         10        7          11m</span><br><span class="line">php-apache   Deployment/php-apache   cpu: 0%/50%     1         10        7          12m</span><br></pre></td></tr></table></figure>

<h2 id="部署Prometheus"><a href="#部署Prometheus" class="headerlink" title="部署Prometheus"></a>部署Prometheus</h2><p>手工部署较为复杂，我们采用operator进行部署，先克隆它的operator，本次采用的是0.14.0版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.linuxcenter.cn/files/cka/kube-prometheus-0.14.0.tar</span><br><span class="line">tar xf kube-prometheus-0.14.0.tar</span><br><span class="line"><span class="built_in">cd</span> kube-prometheus-0.14.0</span><br><span class="line">kubectl create -f manifests/setup/</span><br></pre></td></tr></table></figure>

<p>测试是否符合条件，如果上一步全部成功，这里会显示全部符合</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">wait</span> --<span class="keyword">for</span> condition=Established --all CustomResourceDefinition --namespace=monitoring</span><br></pre></td></tr></table></figure>

<p>在master上自动给所有节点准备容器镜像，此处会产生大量网络流量，需要较长时间，请耐心等待</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; dockerimage &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> sshcmd &#123;</span><br><span class="line">  sshpass -p vagrant ssh root@<span class="variable">$1</span> <span class="variable">$2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> Pulling images on $(hostname)</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">docker pull class-docker.myk8s.cn/prometheus/alertmanager:v0.27.0</span><br><span class="line">docker pull class-docker.myk8s.cn/prometheus/blackbox-exporter:v0.25.0</span><br><span class="line">docker pull class-docker.myk8s.cn/jimmidyson/configmap-reload:v0.13.1</span><br><span class="line">docker pull class-docker.myk8s.cn/brancz/kube-rbac-proxy:v0.18.1</span><br><span class="line">docker pull class-docker.myk8s.cn/grafana/grafana:11.2.0</span><br><span class="line">docker pull class-docker.myk8s.cn/kube-state-metrics/kube-state-metrics:v2.13.0</span><br><span class="line">docker pull class-docker.myk8s.cn/prometheus/node-exporter:v1.8.2</span><br><span class="line">docker pull class-docker.myk8s.cn/prometheus-adapter/prometheus-adapter:v0.12.0</span><br><span class="line">docker pull class-docker.myk8s.cn/prometheus-operator/prometheus-operator:v0.76.2</span><br><span class="line">docker pull class-docker.myk8s.cn/prometheus/prometheus:v2.54.1</span><br><span class="line"></span><br><span class="line">docker tag class-docker.myk8s.cn/prometheus/alertmanager:v0.27.0 quay.io/prometheus/alertmanager:v0.27.0</span><br><span class="line">docker tag class-docker.myk8s.cn/prometheus/blackbox-exporter:v0.25.0 quay.io/prometheus/blackbox-exporter:v0.25.0</span><br><span class="line">docker tag class-docker.myk8s.cn/jimmidyson/configmap-reload:v0.13.1 ghcr.io/jimmidyson/configmap-reload:v0.13.1</span><br><span class="line">docker tag class-docker.myk8s.cn/brancz/kube-rbac-proxy:v0.18.1 quay.io/brancz/kube-rbac-proxy:v0.18.1</span><br><span class="line">docker tag class-docker.myk8s.cn/grafana/grafana:11.2.0 grafana/grafana:11.2.0</span><br><span class="line">docker tag class-docker.myk8s.cn/kube-state-metrics/kube-state-metrics:v2.13.0 registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.13.0</span><br><span class="line">docker tag class-docker.myk8s.cn/prometheus/node-exporter:v1.8.2 quay.io/prometheus/node-exporter:v1.8.2</span><br><span class="line">docker tag class-docker.myk8s.cn/prometheus-adapter/prometheus-adapter:v0.12.0 registry.k8s.io/prometheus-adapter/prometheus-adapter:v0.12.0</span><br><span class="line">docker tag class-docker.myk8s.cn/prometheus-operator/prometheus-operator:v0.76.2 quay.io/prometheus-operator/prometheus-operator:v0.76.2</span><br><span class="line">docker tag class-docker.myk8s.cn/prometheus/prometheus:v2.54.1 quay.io/prometheus/prometheus:v2.54.1</span><br><span class="line"></span><br><span class="line">docker rmi class-docker.myk8s.cn/prometheus/alertmanager:v0.27.0</span><br><span class="line">docker rmi class-docker.myk8s.cn/prometheus/blackbox-exporter:v0.25.0</span><br><span class="line">docker rmi class-docker.myk8s.cn/jimmidyson/configmap-reload:v0.13.1</span><br><span class="line">docker rmi class-docker.myk8s.cn/brancz/kube-rbac-proxy:v0.18.1</span><br><span class="line">docker rmi class-docker.myk8s.cn/grafana/grafana:11.2.0</span><br><span class="line">docker rmi class-docker.myk8s.cn/kube-state-metrics/kube-state-metrics:v2.13.0</span><br><span class="line">docker rmi class-docker.myk8s.cn/prometheus/node-exporter:v1.8.2</span><br><span class="line">docker rmi class-docker.myk8s.cn/prometheus-adapter/prometheus-adapter:v0.12.0</span><br><span class="line">docker rmi class-docker.myk8s.cn/prometheus-operator/prometheus-operator:v0.76.2</span><br><span class="line">docker rmi class-docker.myk8s.cn/prometheus/prometheus:v2.54.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> Saving images to file</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">docker save -o alertmanager.tar quay.io/prometheus/alertmanager:v0.27.0</span><br><span class="line">docker save -o blackbox-exporter.tar quay.io/prometheus/blackbox-exporter:v0.25.0</span><br><span class="line">docker save -o configmap-reload.tar ghcr.io/jimmidyson/configmap-reload:v0.13.1</span><br><span class="line">docker save -o kube-rbac-proxy.tar quay.io/brancz/kube-rbac-proxy:v0.18.1</span><br><span class="line">docker save -o grafana.tar grafana/grafana:11.2.0</span><br><span class="line">docker save -o kube-state-metrics.tar registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.13.0</span><br><span class="line">docker save -o node-exporter.tar quay.io/prometheus/node-exporter:v1.8.2</span><br><span class="line">docker save -o prometheus-adapter.tar registry.k8s.io/prometheus-adapter/prometheus-adapter:v0.12.0</span><br><span class="line">docker save -o prometheus-operator.tar quay.io/prometheus-operator/prometheus-operator:v0.76.2</span><br><span class="line">docker save -o prometheus.tar quay.io/prometheus/prometheus:v2.54.1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> Copying images file to k8s-worker1 and import it</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">scp alertmanager.tar root@k8s-worker1:/root</span><br><span class="line">scp blackbox-exporter.tar root@k8s-worker1:/root</span><br><span class="line">scp configmap-reload.tar root@k8s-worker1:/root</span><br><span class="line">scp kube-rbac-proxy.tar root@k8s-worker1:/root</span><br><span class="line">scp grafana.tar root@k8s-worker1:/root</span><br><span class="line">scp kube-state-metrics.tar root@k8s-worker1:/root</span><br><span class="line">scp node-exporter.tar root@k8s-worker1:/root</span><br><span class="line">scp prometheus-adapter.tar root@k8s-worker1:/root</span><br><span class="line">scp prometheus-operator.tar root@k8s-worker1:/root</span><br><span class="line">scp prometheus.tar root@k8s-worker1:/root</span><br><span class="line"></span><br><span class="line">sshcmd k8s-worker1 <span class="string">&#x27;docker load -i /root/alertmanager.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker1 <span class="string">&#x27;docker load -i /root/blackbox-exporter.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker1 <span class="string">&#x27;docker load -i /root/configmap-reload.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker1 <span class="string">&#x27;docker load -i /root/kube-rbac-proxy.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker1 <span class="string">&#x27;docker load -i /root/grafana.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker1 <span class="string">&#x27;docker load -i /root/kube-state-metrics.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker1 <span class="string">&#x27;docker load -i /root/node-exporter.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker1 <span class="string">&#x27;docker load -i /root/prometheus-adapter.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker1 <span class="string">&#x27;docker load -i /root/prometheus-operator.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker1 <span class="string">&#x27;docker load -i /root/prometheus.tar&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> Copying images file to k8s-worker2 and import it</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">scp alertmanager.tar root@k8s-worker2:/root</span><br><span class="line">scp blackbox-exporter.tar root@k8s-worker2:/root</span><br><span class="line">scp configmap-reload.tar root@k8s-worker2:/root</span><br><span class="line">scp kube-rbac-proxy.tar root@k8s-worker2:/root</span><br><span class="line">scp grafana.tar root@k8s-worker2:/root</span><br><span class="line">scp kube-state-metrics.tar root@k8s-worker2:/root</span><br><span class="line">scp node-exporter.tar root@k8s-worker2:/root</span><br><span class="line">scp prometheus-adapter.tar root@k8s-worker2:/root</span><br><span class="line">scp prometheus-operator.tar root@k8s-worker2:/root</span><br><span class="line">scp prometheus.tar root@k8s-worker2:/root</span><br><span class="line"></span><br><span class="line">sshcmd k8s-worker2 <span class="string">&#x27;docker load -i /root/alertmanager.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker2 <span class="string">&#x27;docker load -i /root/blackbox-exporter.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker2 <span class="string">&#x27;docker load -i /root/configmap-reload.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker2 <span class="string">&#x27;docker load -i /root/kube-rbac-proxy.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker2 <span class="string">&#x27;docker load -i /root/grafana.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker2 <span class="string">&#x27;docker load -i /root/kube-state-metrics.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker2 <span class="string">&#x27;docker load -i /root/node-exporter.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker2 <span class="string">&#x27;docker load -i /root/prometheus-adapter.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker2 <span class="string">&#x27;docker load -i /root/prometheus-operator.tar&#x27;</span></span><br><span class="line">sshcmd k8s-worker2 <span class="string">&#x27;docker load -i /root/prometheus.tar&#x27;</span></span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">bash dockerimage</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>默认情况下，grafana等各个组件都提供了网络策略，无法被外部访问，我们先删除grafana的策略，并修改它的服务暴露方式为NodePort，因为我们要从外部访问它的图表面板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf manifests/grafana-networkPolicy.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/spec:/a\  type: NodePort&#x27;</span> manifests/grafana-service.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/targetPort/a\    nodePort: 32000&#x27;</span> manifests/grafana-service.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/        image: /a\        imagePullPolicy: IfNotPresent&#x27;</span> manifests/nodeExporter-daemonset.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/        image: /a\        imagePullPolicy: IfNotPresent&#x27;</span> manifests/blackboxExporter-deployment.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/        image: /a\        imagePullPolicy: IfNotPresent&#x27;</span> manifests/grafana-deployment.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/        image: /a\        imagePullPolicy: IfNotPresent&#x27;</span> manifests/kubeStateMetrics-deployment.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/        image: /a\        imagePullPolicy: IfNotPresent&#x27;</span> manifests/prometheusAdapter-deployment.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/        image: /a\        imagePullPolicy: IfNotPresent&#x27;</span> manifests/prometheusOperator-deployment.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/        image: /a\        imagePullPolicy: IfNotPresent&#x27;</span> manifests/alertmanager-alertmanager.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/        image: /a\        imagePullPolicy: IfNotPresent&#x27;</span> manifests/prometheus-prometheus.yaml</span><br><span class="line"></span><br><span class="line">kubectl apply -f manifests/</span><br></pre></td></tr></table></figure>

<p>确定grafana已经定义了32000端口，直接在浏览器打开任意节点的IP地址访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get service -n monitoring grafana</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">grafana   NodePort   10.99.168.64   &lt;none&gt;        3000:32000/TCP   30m</span><br></pre></td></tr></table></figure>

<p>配置好解析后，在浏览器中打开 <code>http://k8s-worker1:32000</code> ，或者不配置解析用IP也可以</p>
<p>用户名和密码都是admin，点击login之后会让你修改新密码，进行修改后点击submit或直接点击skip不修改</p>
<p><img src="/files/cka/images/Prometheus/grafana-login.png"></p>
<p>点击左侧或右上角的+号，选择import导入k8s模板</p>
<p><img src="/files/cka/images/Prometheus/grafana-index.png"></p>
<p>点击 [模板链接](<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/">Dashboards | Grafana Labs</a>) 选一个模板，把ID填进来，点击load即可</p>
<p>category选择Docker，Data Source选择Prometheus可以更好的筛选<br><img src="/files/cka/images/Prometheus/grafana-template.png"></p>
<p>自己可以挑选喜欢的模板，点击进去可以看到图示，选好之后点击Copy ID，填到我们的系统中即可</p>
<p><img src="/files/cka/images/Prometheus/grafana-template-id.png"></p>
<p>填好ID之后，点击ID后侧的load按钮进行加载，在最下侧的Prometheus处，选择Prometheus，然后点击import</p>
<p><img src="/files/cka/images/Prometheus/grafana-template-import.png"></p>
<p><img src="/files/cka/images/Prometheus/grafana-monitor.png"></p>
<h2 id="升级控制平面"><a href="#升级控制平面" class="headerlink" title="升级控制平面"></a>升级控制平面</h2><p>先确定要升级的版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt list kubeadm -a</span><br></pre></td></tr></table></figure>

<p>这里的升级以具体课程时的版本为准，只需要参考步骤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm/unknown 1.32.4-1.1 amd64 [upgradable from: 1.32.0-1.1]</span><br><span class="line">kubeadm/unknown 1.32.3-1.1 amd64</span><br><span class="line">kubeadm/unknown 1.32.2-1.1 amd64</span><br><span class="line">kubeadm/unknown 1.32.1-1.1 amd64</span><br><span class="line">kubeadm/unknown,now 1.32.0-1.1 amd64 [installed,upgradable to: 1.32.4-1.1]</span><br></pre></td></tr></table></figure>

<p>在上一步可以看到一个可用的列表，假设我们要升级的目标为1.32.4-1.1的版本</p>
<p>禁止Master节点接收新调度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl cordon k8s-master</span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME          STATUS                     ROLES           AGE   VERSION</span><br><span class="line">k8s-master    Ready,SchedulingDisabled   control-plane   17d   v1.32.0</span><br><span class="line">k8s-worker1   Ready                      worker          17d   v1.32.0</span><br><span class="line">k8s-worker2   Ready                      worker          17d   v1.32.0</span><br></pre></td></tr></table></figure>

<p>驱逐Master节点上的现有任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain k8s-master --ignore-daemonsets --delete-emptydir-data</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">node/k8s-master already cordoned</span><br><span class="line">Warning: ignoring DaemonSet-managed Pods: kube-system/calico-node-gd44x, kube-system/kube-proxy-zxxgg, monitoring/node-exporter-x7h7l</span><br><span class="line">evicting pod kube-system/coredns-7c445c467-prx7f</span><br><span class="line">evicting pod kube-system/calico-kube-controllers-5b9b456c66-mf6r4</span><br><span class="line">evicting pod kube-system/coredns-7c445c467-k6njz</span><br><span class="line">pod/calico-kube-controllers-5b9b456c66-mf6r4 evicted</span><br><span class="line">pod/coredns-7c445c467-prx7f evicted</span><br><span class="line">pod/coredns-7c445c467-k6njz evicted</span><br><span class="line">node/k8s-master drained</span><br></pre></td></tr></table></figure>

<p>安装目标的kubeadm、kubelet、kubectl</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubelet=1.32.4-1.1 kubeadm=1.32.4-1.1 kubectl=1.32.4-1.1</span><br></pre></td></tr></table></figure>

<p>查看可升级的列表并升级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm upgrade plan</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[preflight] Running pre-flight checks.</span><br><span class="line">[upgrade/config] Reading configuration from the &quot;kubeadm-config&quot; ConfigMap in namespace &quot;kube-system&quot;...</span><br><span class="line">[upgrade/config] Use &#x27;kubeadm init phase upload-config --config your-config.yaml&#x27; to re-upload it.</span><br><span class="line">[upgrade] Running cluster health checks</span><br><span class="line">[upgrade] Fetching available versions to upgrade to</span><br><span class="line">[upgrade/versions] Cluster version: 1.32.0</span><br><span class="line">[upgrade/versions] kubeadm version: v1.32.4</span><br><span class="line">I0426 12:44:49.188198   14629 version.go:261] remote version is much newer: v1.33.0; falling back to: stable-1.32</span><br><span class="line">[upgrade/versions] Target version: v1.32.4</span><br><span class="line">[upgrade/versions] Latest version in the v1.32 series: v1.32.4</span><br><span class="line"></span><br><span class="line">Components that must be upgraded manually after you have upgraded the control plane with &#x27;kubeadm upgrade apply&#x27;:</span><br><span class="line">COMPONENT   NODE          CURRENT   TARGET</span><br><span class="line">kubelet     k8s-worker1   v1.32.0   v1.32.4</span><br><span class="line">kubelet     k8s-worker2   v1.32.0   v1.32.4</span><br><span class="line">kubelet     k8s-master    v1.32.4   v1.32.4</span><br><span class="line"></span><br><span class="line">Upgrade to the latest version in the v1.32 series:</span><br><span class="line"></span><br><span class="line">COMPONENT                 NODE         CURRENT    TARGET</span><br><span class="line">kube-apiserver            k8s-master   v1.32.0    v1.32.4</span><br><span class="line">kube-controller-manager   k8s-master   v1.32.0    v1.32.4</span><br><span class="line">kube-scheduler            k8s-master   v1.32.0    v1.32.4</span><br><span class="line">kube-proxy                             1.32.0     v1.32.4</span><br><span class="line">CoreDNS                                v1.11.3    v1.11.3</span><br><span class="line">etcd                      k8s-master   3.5.16-0   3.5.16-0</span><br><span class="line"></span><br><span class="line">You can now apply the upgrade by executing the following command:</span><br><span class="line"></span><br><span class="line">        kubeadm upgrade apply v1.32.4</span><br><span class="line"></span><br><span class="line">_____________________________________________________________________</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">The table below shows the current state of component configs as understood by this version of kubeadm.</span><br><span class="line">Configs that have a &quot;yes&quot; mark in the &quot;MANUAL UPGRADE REQUIRED&quot; column require manual config upgrade or</span><br><span class="line">resetting to kubeadm defaults before a successful upgrade can be performed. The version to manually</span><br><span class="line">upgrade to is denoted in the &quot;PREFERRED VERSION&quot; column.</span><br><span class="line"></span><br><span class="line">API GROUP                 CURRENT VERSION   PREFERRED VERSION   MANUAL UPGRADE REQUIRED</span><br><span class="line">kubeproxy.config.k8s.io   v1alpha1          v1alpha1            no</span><br><span class="line">kubelet.config.k8s.io     v1beta1           v1beta1             no</span><br><span class="line">_____________________________________________________________________</span><br></pre></td></tr></table></figure>

<p>看完之后来升级，一般数据库不升级，或者先备份好再升级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm upgrade apply v1.32.4 --etcd-upgrade=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[upgrade] Reading configuration from the <span class="string">&quot;kubeadm-config&quot;</span> ConfigMap <span class="keyword">in</span> namespace <span class="string">&quot;kube-system&quot;</span>...</span><br><span class="line">[upgrade] Use <span class="string">&#x27;kubeadm init phase upload-config --config your-config.yaml&#x27;</span> to re-upload it.</span><br><span class="line">[upgrade/preflight] Running preflight checks</span><br><span class="line">[upgrade] Running cluster health checks</span><br><span class="line">[upgrade/preflight] You have chosen to upgrade the cluster version to <span class="string">&quot;v1.32.4&quot;</span></span><br><span class="line">[upgrade/versions] Cluster version: v1.32.0</span><br><span class="line">[upgrade/versions] kubeadm version: v1.32.4</span><br><span class="line">[upgrade] Are you sure you want to proceed? [y/N]: y</span><br><span class="line">...</span><br><span class="line">[upgrade] SUCCESS! A control plane node of your cluster was upgraded to <span class="string">&quot;v1.32.4&quot;</span>.</span><br><span class="line"></span><br><span class="line">[upgrade] Now please proceed with upgrading the rest of the nodes by following the right order.</span><br></pre></td></tr></table></figure>

<p>恢复Master节点的调度能力</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet</span><br><span class="line">kubectl uncordon k8s-master</span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME          STATUS   ROLES           AGE   VERSION</span><br><span class="line">k8s-master    Ready    control-plane   17d   v1.32.4</span><br><span class="line">k8s-worker1   Ready    worker          17d   v1.32.0</span><br><span class="line">k8s-worker2   Ready    worker          17d   v1.32.0</span><br></pre></td></tr></table></figure>

<h1 id="ETCD-备份与恢复"><a href="#ETCD-备份与恢复" class="headerlink" title="ETCD 备份与恢复"></a>ETCD 备份与恢复</h1><h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><p>先安装etcd客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install etcd-client -y</span><br></pre></td></tr></table></figure>

<p>备份成文件并查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl \</span><br><span class="line">--endpoints=https://127.0.0.1:2379 \</span><br><span class="line">--cacert=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert=/etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">--key=/etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">snapshot save etcdbackupfile.db</span><br></pre></td></tr></table></figure>

<h2 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先停止服务</span></span><br><span class="line"><span class="built_in">mv</span> /etc/kubernetes/manifests /etc/kubernetes/manifests.bak</span><br><span class="line"><span class="built_in">sleep</span> 1m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除现有ETCD，并恢复数据</span></span><br><span class="line"><span class="built_in">mv</span> /var/lib/etcd /var/lib/etcd.bak</span><br><span class="line">ETCDCTL_API=3 etcdctl \</span><br><span class="line">--endpoints=https://127.0.0.1:2379 \</span><br><span class="line">--cacert=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert=/etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">--key=/etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">--data-dir /var/lib/etcd \</span><br><span class="line">snapshot restore etcdbackupfile.db</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;ts&quot;</span>:1745474079.1192722,<span class="string">&quot;caller&quot;</span>:<span class="string">&quot;snapshot/v3_snapshot.go:306&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;restoring snapshot&quot;</span>,<span class="string">&quot;path&quot;</span>:<span class="string">&quot;etcdbackupfile.db&quot;</span>,<span class="string">&quot;wal-dir&quot;</span>:<span class="string">&quot;/var/lib/etcd/member/wal&quot;</span>,<span class="string">&quot;data-dir&quot;</span>:<span class="string">&quot;/var/lib/etcd&quot;</span>,<span class="string">&quot;snap-dir&quot;</span>:<span class="string">&quot;/var/lib/etcd/member/snap&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;ts&quot;</span>:1745474079.1459239,<span class="string">&quot;caller&quot;</span>:<span class="string">&quot;mvcc/kvstore.go:388&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;restored last compact revision&quot;</span>,<span class="string">&quot;meta-bucket-name&quot;</span>:<span class="string">&quot;meta&quot;</span>,<span class="string">&quot;meta-bucket-name-key&quot;</span>:<span class="string">&quot;finishedCompactRev&quot;</span>,<span class="string">&quot;restored-compact-revision&quot;</span>:12097&#125;</span><br><span class="line">&#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;ts&quot;</span>:1745474079.1544638,<span class="string">&quot;caller&quot;</span>:<span class="string">&quot;membership/cluster.go:392&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;added member&quot;</span>,<span class="string">&quot;cluster-id&quot;</span>:<span class="string">&quot;cdf818194e3a8c32&quot;</span>,<span class="string">&quot;local-member-id&quot;</span>:<span class="string">&quot;0&quot;</span>,<span class="string">&quot;added-peer-id&quot;</span>:<span class="string">&quot;8e9e05c52164694d&quot;</span>,<span class="string">&quot;added-peer-peer-urls&quot;</span>:[<span class="string">&quot;http://localhost:2380&quot;</span>]&#125;</span><br><span class="line">&#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;ts&quot;</span>:1745474079.1581106,<span class="string">&quot;caller&quot;</span>:<span class="string">&quot;snapshot/v3_snapshot.go:326&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;restored snapshot&quot;</span>,<span class="string">&quot;path&quot;</span>:<span class="string">&quot;etcdbackupfile.db&quot;</span>,<span class="string">&quot;wal-dir&quot;</span>:<span class="string">&quot;/var/lib/etcd/member/wal&quot;</span>,<span class="string">&quot;data-dir&quot;</span>:<span class="string">&quot;/var/lib/etcd&quot;</span>,<span class="string">&quot;snap-dir&quot;</span>:<span class="string">&quot;/var/lib/etcd/member/snap&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 恢复服务</span></span><br><span class="line"><span class="built_in">mv</span> /etc/kubernetes/manifests.bak /etc/kubernetes/manifests</span><br><span class="line"></span><br><span class="line">systemctl restart kubelet.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证数据已经恢复</span></span><br><span class="line"></span><br><span class="line">kubectl get pod</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>检查etcd是否健康</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --endpoints=https://192.168.8.3:2379 \</span><br><span class="line">--cacert=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert=/etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">--key=/etc/kubernetes/pki/etcd/server.key endpoint health</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://127.0.0.1:2379 is healthy: successfully committed proposal: took = 883.786µs</span><br></pre></td></tr></table></figure>

<h1 id="Kustomize-管理"><a href="#Kustomize-管理" class="headerlink" title="Kustomize 管理"></a>Kustomize 管理</h1><p><strong>这部分不作为课堂学习需要掌握的内容，这部分是课下挑战所用，加油哦</strong></p>
<h2 id="Kustomize-概念"><a href="#Kustomize-概念" class="headerlink" title="Kustomize 概念"></a>Kustomize 概念</h2><p>Kustomize 是 Kubernetes 的原生配置管理工具，它允许用户通过定义资源和它们之间的依赖关系来描述 Kubernetes 应用程序的配置。</p>
<p>Kustomize 的核心概念大概包括：</p>
<p><strong>Kustomization 文件</strong>：这是 Kustomize 配置的核心，它是一个 YAML 文件，定义了 Kubernetes 资源和如何定制它们。它可以用来指定要包含的资源、应用补丁、设置标签和注解、生成configmap和secret等</p>
<p><strong>资源（Resources）</strong>：在 kustomization.yaml 文件中定义的 Kubernetes 资源列表，可以是文件、目录或者远程仓库中的资源。</p>
<p><strong>生成器（Generators）</strong>：如 configMapGenerator 和 secretGenerator，它们可以根据文件或字面值生成 ConfigMap 或 Secret。</p>
<p><strong>补丁（Patches）</strong>：用于修改现有资源的字段。Kustomize 支持策略性合并补丁（patchesStrategicMerge）和 JSON 补丁（patchesJson6902）。</p>
<p><strong>基准（Bases）</strong>：包含 kustomization.yaml 文件的目录，定义了一组资源及其定制。</p>
<p><strong>覆盖（Overlays）</strong>：也是一个目录，它引用基准目录作为基础，并且可以包含额外的定制。覆盖可以用来创建特定环境的配置，如开发、测试和生产环境。</p>
<p>Kustomize 的工作流程通常包括定义基准和覆盖，然后在覆盖中应用补丁和生成器来定制基准资源。这种方式使得用户可以轻松地为不同环境创建和管理 Kubernetes 资源配置。</p>
<h2 id="Kustomize-实验"><a href="#Kustomize-实验" class="headerlink" title="Kustomize 实验"></a>Kustomize 实验</h2><h3 id="实验概述"><a href="#实验概述" class="headerlink" title="实验概述"></a>实验概述</h3><p>本实验旨在通过实际操作，让大家掌握 Kustomize 的使用，以便能够根据不同的环境需求（如开发、测试和生产环境）定制和管理 Kubernetes 应用的配置。</p>
<h3 id="实验目标"><a href="#实验目标" class="headerlink" title="实验目标"></a>实验目标</h3><p><strong>理解 Kustomize 的作用和优势:</strong></p>
<ul>
<li>理解 Kustomize 如何简化 Kubernetes 应用的配置管理。</li>
</ul>
<p><strong>创建和管理 Base 目录:</strong></p>
<ul>
<li>学会创建包含通用资源定义的 Base 目录。</li>
<li>编写 kustomization.yaml 文件来声明资源、生成器和补丁。</li>
</ul>
<p><strong>定制 Overlay 配置:</strong></p>
<ul>
<li>学会创建 Overlay 目录以适应特定环境的配置需求。</li>
<li>应用 patchesStrategicMerge 和 patchesJson6902 来定制 Deployment 资源。</li>
</ul>
<p><strong>生成 ConfigMap 和 Secret:</strong></p>
<ul>
<li>使用 configMapGenerator 和 secretGenerator 来生成环境特定的配置和敏感信息。</li>
</ul>
<p><strong>应用环境标签和注解:</strong></p>
<ul>
<li>在资源上添加环境特定的标签（如 env: dev）和注解。</li>
</ul>
<p><strong>禁用名称后缀哈希:</strong></p>
<ul>
<li>配置 generatorOptions 以禁用资源名称的哈希后缀，以保持资源名称的一致性。</li>
</ul>
<p><strong>验证 Overlay 配置:</strong></p>
<ul>
<li>使用 kubectl kustomize 命令来验证 Overlay 目录的最终 Kubernetes 资源配置。</li>
</ul>
<p><strong>部署到 Kubernetes 集群:</strong></p>
<ul>
<li>使用 kubectl apply -k 命令将定制的 Overlay 配置应用到 Kubernetes 集群。</li>
</ul>
<p><strong>清理和维护:</strong></p>
<ul>
<li>学会如何清理实验中创建的资源，包括 Namespace 和各种 Kubernetes 资源。</li>
</ul>
<h3 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h3><h4 id="准备Base目录"><a href="#准备Base目录" class="headerlink" title="准备Base目录"></a>准备Base目录</h4><p>先在base目录中创建一些通用的yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> base</span><br><span class="line"><span class="built_in">cd</span> base</span><br></pre></td></tr></table></figure>

<p>在base目录中，创建一个secret，稍后可以在overlay目录中打补丁或者不打，secret文件如下：</p>
<p>这个密码是ABCabc123</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">Secret.yml</span> <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">QUJDYWJjMTIz</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysqlpass</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
<p>在base目录中，创建一个Deployment，replicas是3，标签为app: nginx, Deployment文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">Deployment.yml</span> <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysqlname</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">class-docker.myk8s.cn/library/mysql</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">mysqlpass</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
<p>在base目录中，创建一个Service，Service文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">Service.yml</span> <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nodeservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31788</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>最后生成kustomization.yaml，在这个文件中，我们包含上我们刚创建的3个资源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">kustomization.yaml</span> <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lxh-base-kustomization</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Secret.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Deployment.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Service.yml</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>查看现在文件列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install tree -y</span><br><span class="line">tree .</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Deployment.yml</span><br><span class="line">├── kustomization.yaml</span><br><span class="line">├── Secret.yml</span><br><span class="line">└── Service.yml</span><br><span class="line"></span><br><span class="line">0 directories, 4 files</span><br></pre></td></tr></table></figure>

<p>以上在base目录中的文件将用于生成：</p>
<ol>
<li><p>一个名为mysqlpass的机密</p>
</li>
<li><p>一个名为nginx-deployment的部署，此部署的pod将具有app: nginx标签，并引用mysqlpass机密作为密码，密码值为ABCabc123</p>
</li>
<li><p>一个名为nodeservice的服务，监听在8000端口，收到请求后，转发给具有app: nginx标签的pod，并启用了31788的nodePort</p>
</li>
</ol>
<h4 id="准备Overlay目录"><a href="#准备Overlay目录" class="headerlink" title="准备Overlay目录"></a>准备Overlay目录</h4><p><strong>创建开发环境</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span></span><br><span class="line"><span class="built_in">mkdir</span> -p overlays/development</span><br><span class="line"><span class="built_in">cd</span> overlays/development</span><br></pre></td></tr></table></figure>

<p>创建开发环境的kustomization.yaml 文件：</p>
<p>Kustomize 功能特性列表参阅：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#kustomize-feature-list</span><br></pre></td></tr></table></figure>

<ol>
<li>patchesStrategicMerge补丁将会更新nginx-deployment这个Deployment</li>
<li>patchesJson6902补丁也会更新nginx-deployment这个Deployment</li>
<li>overlay的对象是刚创建的base目录下的内容</li>
<li>全体对象添加env: dev</li>
<li>禁止添加hash后缀</li>
<li>产生两个新的configmap和secret</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">kustomization.yaml</span> <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">lxh-dev</span></span><br><span class="line"><span class="attr">patches:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">patchesStrategicMerge-demo.yaml</span></span><br><span class="line">    <span class="attr">target:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">allowNameChange:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">patchesJson6902-demo.yaml</span></span><br><span class="line">    <span class="attr">target:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">allowNameChange:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">../../base</span></span><br><span class="line"><span class="attr">commonLabels:</span></span><br><span class="line">  <span class="attr">env:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">generatorOptions:</span></span><br><span class="line">  <span class="attr">disableNameSuffixHash:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">configMapGenerator:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmusername</span></span><br><span class="line">  <span class="attr">files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">configmap-1.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmage</span></span><br><span class="line">  <span class="attr">literals:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cmage=18</span></span><br><span class="line"><span class="attr">secretGenerator:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">username</span></span><br><span class="line">  <span class="attr">files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">secret-1.yml</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secrettest</span></span><br><span class="line">  <span class="attr">literals:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">password=LiXiaoHui</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="生成器Generator"><a href="#生成器Generator" class="headerlink" title="生成器Generator"></a>生成器Generator</h4><p>在kustomization.yaml，如果用文件来生成configmap和secret，会将文件名也作为数据的一部分，建议用literals</p>
<p>生成configmap和secret的文件</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; configmap-1.yml &lt;&lt;-EOF</span><br><span class="line">username=lixiaohui</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; secret-1.yml &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">username=admin</span></span><br><span class="line"><span class="string">password=secret</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="策略性合并与JSON补丁"><a href="#策略性合并与JSON补丁" class="headerlink" title="策略性合并与JSON补丁"></a>策略性合并与JSON补丁</h4><p>在 Kustomize 中，patchesStrategicMerge 和 patchesJson6902 都用于修改现有的 Kubernetes 资源。</p>
<ol>
<li><p>patchesStrategicMerge补丁方式使用 YAML 文件来定义，它允许你直接编辑资源的 YAML 结构，就像编辑原始资源文件一样。这种方式直观且易于理解，特别是对于那些熟悉 Kubernetes 资源配置的人来说。</p>
</li>
<li><p>patchesJson6902 使用的是 JSON 补丁（JSON Patch）的方式，这是一种更为灵活和强大的补丁应用方式。JSON 补丁遵循 JSON Patch 规范（RFC 6902），允许执行更复杂的操作，如添加、删除、替换、测试等。这种方式使用 JSON 格式定义，可能在处理复杂的修改时更加强大。</p>
</li>
</ol>
<p><strong>生成策略性合并补丁</strong></p>
<p>这里的名字一定要和已有的资源的名称一致</p>
<p>更新deployment的replicas为4</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">patchesStrategicMerge-demo.yaml</span> <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p><strong>生成JSON补丁</strong></p>
<p>新增deployment下的pod标签为dev: release1</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; patchesJson6902-demo.yaml &lt;&lt;-EOF</span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;add&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/spec/template/metadata/labels/dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;release1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>目前的文件列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/overlays/development# tree .</span><br><span class="line">.</span><br><span class="line">├── configmap-1.yml</span><br><span class="line">├── kustomization.yaml</span><br><span class="line">├── patchesJson6902-demo.yaml</span><br><span class="line">├── patchesStrategicMerge-demo.yaml</span><br><span class="line">└── secret-1.yml</span><br><span class="line"></span><br><span class="line">0 directories, 5 files</span><br></pre></td></tr></table></figure>

<h4 id="验证overlay最终成果"><a href="#验证overlay最终成果" class="headerlink" title="验证overlay最终成果"></a>验证overlay最终成果</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/overlays/development# kubectl kustomize ./</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  cmage: &quot;18&quot;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    env: dev</span><br><span class="line">  name: cmage</span><br><span class="line">  namespace: lxh-dev</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  configmap-1.yml: |</span><br><span class="line">    username=lixiaohui</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    env: dev</span><br><span class="line">  name: cmusername</span><br><span class="line">  namespace: lxh-dev</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  password: QUJDYWJjMTIz</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    env: dev</span><br><span class="line">  name: mysqlpass</span><br><span class="line">  namespace: lxh-dev</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  password: TGlYaWFvSHVp</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    env: dev</span><br><span class="line">  name: secrettest</span><br><span class="line">  namespace: lxh-dev</span><br><span class="line">type: Opaque</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  secret-1.yml: dXNlcm5hbWU9YWRtaW4KcGFzc3dvcmQ9c2VjcmV0Cg==</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    env: dev</span><br><span class="line">  name: username</span><br><span class="line">  namespace: lxh-dev</span><br><span class="line">type: Opaque</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    env: dev</span><br><span class="line">  name: nodeservice</span><br><span class="line">  namespace: lxh-dev</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - nodePort: 31788</span><br><span class="line">    port: 8000</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">    env: dev</span><br><span class="line">  type: NodePort</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">    env: dev</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  namespace: lxh-dev</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">      env: dev</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: new-label</span><br><span class="line">        env: dev</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - env:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              key: password</span><br><span class="line">              name: mysqlpass</span><br><span class="line">        image: class-docker.myk8s.cn/library/mysql</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: mysqlname</span><br></pre></td></tr></table></figure>

<h4 id="发布开发环境"><a href="#发布开发环境" class="headerlink" title="发布开发环境"></a>发布开发环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/overlays/development/</span><br><span class="line">kubectl create namespace lxh-dev</span><br><span class="line">kubectl apply -k .</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">configmap/cmage created</span><br><span class="line">configmap/cmusername created</span><br><span class="line">secret/mysqlpass created</span><br><span class="line">secret/secrettest created</span><br><span class="line">secret/username created</span><br><span class="line">service/nodeservice created</span><br><span class="line">deployment.apps/nginx-deployment created</span><br></pre></td></tr></table></figure>

<p>查询创建的内容</p>
<p>发现我们新configmap和secret已经生效，两个补丁也都生效了，一个补丁将deployment的pod数量该为4，一个补丁添加了dev&#x3D;release1的标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~/overlays/development# kubectl get configmaps -n lxh-dev</span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">cmage              1      41s</span><br><span class="line">cmusername         1      41s</span><br><span class="line">kube-root-ca.crt   1      11m</span><br><span class="line">root@k8s-master:~/overlays/development# kubectl get secrets -n lxh-dev</span><br><span class="line">NAME         TYPE     DATA   AGE</span><br><span class="line">mysqlpass    Opaque   1      47s</span><br><span class="line">secrettest   Opaque   1      47s</span><br><span class="line">username     Opaque   1      47s</span><br><span class="line"></span><br><span class="line">root@k8s-master:~/overlays/development# kubectl get service -n lxh-dev</span><br><span class="line">NAME          TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">nodeservice   NodePort   10.106.128.145   &lt;none&gt;        8000:31788/TCP   51s</span><br><span class="line"></span><br><span class="line">root@k8s-master:~/overlays/development# kubectl get deployments.apps -n lxh-dev</span><br><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   4/4     4            4           55s</span><br><span class="line"></span><br><span class="line">root@k8s-master:~/overlays/development# kubectl get pod --show-labels  -n lxh-dev</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">nginx-deployment-6f86fd678b-bv688   1/1     Running   0          64s   app=nginx,dev=release1,<span class="built_in">env</span>=dev,pod-template-hash=6f86fd678b</span><br><span class="line">nginx-deployment-6f86fd678b-wpk49   1/1     Running   0          64s   app=nginx,dev=release1,<span class="built_in">env</span>=dev,pod-template-hash=6f86fd678b</span><br><span class="line">nginx-deployment-6f86fd678b-wr94h   1/1     Running   0          64s   app=nginx,dev=release1,<span class="built_in">env</span>=dev,pod-template-hash=6f86fd678b</span><br><span class="line">nginx-deployment-6f86fd678b-xxkbw   1/1     Running   0          64s   app=nginx,dev=release1,<span class="built_in">env</span>=dev,pod-template-hash=6f86fd678b</span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>CKA笔记</p><p><a href="http://example.com/2025/05/10/CKA认证/CKA笔记/">http://example.com/2025/05/10/CKA认证/CKA笔记/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="http://example.com"><p>罗宇</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2025-05-10 13:12:42</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-05-11 15:30:59</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2025/05/10/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/Shell%E8%84%9A%E6%9C%AC/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Shell脚本</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/04/22/%E5%AE%B9%E5%99%A8/podman%E5%AE%B9%E5%99%A8/"><span class="level-item">podman容器</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#1-准备DNS解析"><span>1 准备DNS解析</span></a></li><li><a class="is-flex is-mobile" href="#2-Docker-CE-部署"><span>2 Docker CE 部署</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#2-1-添加Docker仓库"><span>2.1 添加Docker仓库</span></a></li><li><a class="is-flex is-mobile" href="#2-2-安装Docker-CE"><span>2.2 安装Docker CE</span></a></li><li><a class="is-flex is-mobile" href="#2-3-CRI-Docker-部署"><span>2.3 CRI-Docker 部署</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#2-3-1-将镜像指引到国内"><span>2.3.1 将镜像指引到国内</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#3-Containerd-部署"><span>3 Containerd 部署</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#3-1-安装Containerd"><span>3.1 安装Containerd</span></a></li><li><a class="is-flex is-mobile" href="#3-2-生成配置文件"><span>3.2 生成配置文件</span></a></li><li><a class="is-flex is-mobile" href="#3-3-使用镜像加速器"><span>3.3 使用镜像加速器</span></a></li><li><a class="is-flex is-mobile" href="#3-4-启动Containerd服务"><span>3.4 启动Containerd服务</span></a></li><li><a class="is-flex is-mobile" href="#3-5-nerdctl命令自动补齐"><span>3.5 nerdctl命令自动补齐</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#4-创建第一个容器"><span>4 创建第一个容器</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#4-1-运行容器"><span>4.1 运行容器</span></a></li><li><a class="is-flex is-mobile" href="#4-2-进入容器"><span>4.2 进入容器</span></a></li><li><a class="is-flex is-mobile" href="#4-3-访问容器内容"><span>4.3 访问容器内容</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#5-镜像相关操作"><span>5 镜像相关操作</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#5-1-Commit-构建"><span>5.1 Commit 构建</span></a></li><li><a class="is-flex is-mobile" href="#5-2-使用Commit镜像"><span>5.2 使用Commit镜像</span></a></li><li><a class="is-flex is-mobile" href="#5-3-Dockerfile构建"><span>5.3 Dockerfile构建</span></a></li><li><a class="is-flex is-mobile" href="#5-4-使用Dockerfile镜像"><span>5.4 使用Dockerfile镜像</span></a></li><li><a class="is-flex is-mobile" href="#5-5-删除容器"><span>5.5 删除容器</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#6-构建私有仓库"><span>6 构建私有仓库</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#6-1-生成root证书信息"><span>6.1 生成root证书信息</span></a></li><li><a class="is-flex is-mobile" href="#6-2-生成服务器私钥以及证书请求文件"><span>6.2 生成服务器私钥以及证书请求文件</span></a></li><li><a class="is-flex is-mobile" href="#6-3-生成openssl-cnf扩展文件"><span>6.3 生成openssl cnf扩展文件</span></a></li><li><a class="is-flex is-mobile" href="#6-4-签发证书"><span>6.4 签发证书</span></a></li><li><a class="is-flex is-mobile" href="#6-5-信任根证书"><span>6.5 信任根证书</span></a></li><li><a class="is-flex is-mobile" href="#6-6-部署Harbor仓库"><span>6.6 部署Harbor仓库</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#6-6-1-部署Docker-CE"><span>6.6.1 部署Docker CE</span></a></li><li><a class="is-flex is-mobile" href="#6-6-2-添加Docker镜像加速器"><span>6.6.2 添加Docker镜像加速器</span></a></li><li><a class="is-flex is-mobile" href="#6-6-3-Compose支持"><span>6.6.3 Compose支持</span></a></li><li><a class="is-flex is-mobile" href="#6-6-4-修改harbor-yml"><span>6.6.4 修改harbor.yml</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#6-7-生成服务文件"><span>6.7 生成服务文件</span></a></li><li><a class="is-flex is-mobile" href="#6-8-上传镜像到本地仓库"><span>6.8 上传镜像到本地仓库</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#7-Kubernetes部署"><span>7 Kubernetes部署</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#7-1-关闭swap分区"><span>7.1 关闭swap分区</span></a></li><li><a class="is-flex is-mobile" href="#7-2-允许iptables检查桥接流量"><span>7.2 允许iptables检查桥接流量</span></a></li><li><a class="is-flex is-mobile" href="#7-3-安装kubeadm"><span>7.3 安装kubeadm</span></a></li><li><a class="is-flex is-mobile" href="#7-4-添加命令自动补齐"><span>7.4 添加命令自动补齐</span></a></li><li><a class="is-flex is-mobile" href="#7-5-集成CRI-Docker"><span>7.5 集成CRI-Docker</span></a></li><li><a class="is-flex is-mobile" href="#7-6-集成containerd"><span>7.6 集成containerd</span></a></li><li><a class="is-flex is-mobile" href="#7-7-集群部署"><span>7.7 集群部署</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#7-7-1-初始化配置修改"><span>7.7.1 初始化配置修改</span></a></li><li><a class="is-flex is-mobile" href="#7-7-2-集群初始化"><span>7.7.2 集群初始化</span></a></li><li><a class="is-flex is-mobile" href="#7-7-3-授权管理权限"><span>7.7.3 授权管理权限</span></a></li><li><a class="is-flex is-mobile" href="#7-7-4-查看集群状态"><span>7.7.4 查看集群状态</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#7-8-部署Calico网络插件"><span>7.8 部署Calico网络插件</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#7-8-1-安装calico组件"><span>7.8.1 安装calico组件</span></a></li><li><a class="is-flex is-mobile" href="#7-8-2-设置calico在集群的网段"><span>7.8.2 设置calico在集群的网段</span></a></li><li><a class="is-flex is-mobile" href="#7-8-3-确认资源的地址"><span>7.8.3 确认资源的地址</span></a></li><li><a class="is-flex is-mobile" href="#7-8-4-自定义资源发布到集群"><span>7.8.4 自定义资源发布到集群</span></a></li><li><a class="is-flex is-mobile" href="#7-8-5查询集群组件状态"><span>7.8.5查询集群组件状态</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#7-9-加入Worker节点"><span>7.9 加入Worker节点</span></a></li><li><a class="is-flex is-mobile" href="#7-10-重置集群"><span>7.10 重置集群</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#8-Namespace"><span>8 Namespace</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#8-1-命令行创建"><span>8.1 命令行创建</span></a></li><li><a class="is-flex is-mobile" href="#8-2-YAML文件创建"><span>8.2 YAML文件创建</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#CRD自定义资源"><span>CRD自定义资源</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#CRD-介绍"><span>CRD 介绍</span></a></li><li><a class="is-flex is-mobile" href="#查询CRD以及API资源"><span>查询CRD以及API资源</span></a></li><li><a class="is-flex is-mobile" href="#创建CRD以及API资源"><span>创建CRD以及API资源</span></a></li><li><a class="is-flex is-mobile" href="#查询API资源结构与参数"><span>查询API资源结构与参数</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Pod"><span>Pod</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Pod创建"><span>Pod创建</span></a></li><li><a class="is-flex is-mobile" href="#修改Pod"><span>修改Pod</span></a></li><li><a class="is-flex is-mobile" href="#Init类型容器"><span>Init类型容器</span></a></li><li><a class="is-flex is-mobile" href="#Sidecar类型容器"><span>Sidecar类型容器</span></a></li><li><a class="is-flex is-mobile" href="#Static-Pod"><span>Static Pod</span></a></li><li><a class="is-flex is-mobile" href="#Pod-删除"><span>Pod 删除</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#kubernetes-控制器"><span>kubernetes 控制器</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Replica-Set"><span>Replica Set</span></a></li><li><a class="is-flex is-mobile" href="#Deployment"><span>Deployment</span></a></li><li><a class="is-flex is-mobile" href="#更新Deployment"><span>更新Deployment</span></a></li><li><a class="is-flex is-mobile" href="#回滚-Deployment"><span>回滚 Deployment</span></a></li><li><a class="is-flex is-mobile" href="#伸缩-Deployment"><span>伸缩 Deployment</span></a></li><li><a class="is-flex is-mobile" href="#DaemonSet"><span>DaemonSet</span></a></li><li><a class="is-flex is-mobile" href="#StatefulSet"><span>StatefulSet</span></a></li><li><a class="is-flex is-mobile" href="#Job与CronJob"><span>Job与CronJob</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Job"><span>Job</span></a></li><li><a class="is-flex is-mobile" href="#CronJob"><span>CronJob</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#Service-服务发现"><span>Service 服务发现</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#ClusterIP类型的Service"><span>ClusterIP类型的Service</span></a></li><li><a class="is-flex is-mobile" href="#NodePort类型的Service"><span>NodePort类型的Service</span></a></li><li><a class="is-flex is-mobile" href="#Headless类型的Service"><span>Headless类型的Service</span></a></li><li><a class="is-flex is-mobile" href="#LoadBalancer类型的Service"><span>LoadBalancer类型的Service</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#部署metallb负载均衡"><span>部署metallb负载均衡</span></a></li><li><a class="is-flex is-mobile" href="#部署LoadBalancer-服务"><span>部署LoadBalancer 服务</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Ingress"><span>Ingress</span></a></li><li><a class="is-flex is-mobile" href="#Gateway-API"><span>Gateway API</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Gateway-API-基本介绍"><span>Gateway API 基本介绍</span></a></li><li><a class="is-flex is-mobile" href="#Gateway-API实验"><span>Gateway API实验</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#健康检查"><span>健康检查</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Liveness-Probes"><span>Liveness Probes</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#文件存活检测"><span>文件存活检测</span></a></li><li><a class="is-flex is-mobile" href="#HTTP存活检测"><span>HTTP存活检测</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#ReadinessProbe"><span>ReadinessProbe</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#TCP存活检测"><span>TCP存活检测</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#StartupProbe"><span>StartupProbe</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#启动探测器"><span>启动探测器</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Kubernetes-探针检测顺序与优先级"><span>Kubernetes 探针检测顺序与优先级</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#1-startupProbe"><span>1. startupProbe</span></a></li><li><a class="is-flex is-mobile" href="#2-livenessProbe"><span>2. livenessProbe</span></a></li><li><a class="is-flex is-mobile" href="#3-readinessProbe"><span>3. readinessProbe</span></a></li><li><a class="is-flex is-mobile" href="#总结"><span>总结</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#优雅关闭"><span>优雅关闭</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#配置存储卷"><span>配置存储卷</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#emptyDir"><span>emptyDir</span></a></li><li><a class="is-flex is-mobile" href="#HostPath"><span>HostPath</span></a></li><li><a class="is-flex is-mobile" href="#持久卷概述"><span>持久卷概述</span></a></li><li><a class="is-flex is-mobile" href="#构建简易NFS服务器"><span>构建简易NFS服务器</span></a></li><li><a class="is-flex is-mobile" href="#PV"><span>PV</span></a></li><li><a class="is-flex is-mobile" href="#PVC"><span>PVC</span></a></li><li><a class="is-flex is-mobile" href="#使用PV和PVC"><span>使用PV和PVC</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#配置存储类"><span>配置存储类</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#NFS外部供应"><span>NFS外部供应</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#下载外部供应代码"><span>下载外部供应代码</span></a></li><li><a class="is-flex is-mobile" href="#配置NFS外部供应"><span>配置NFS外部供应</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#部署存储类"><span>部署存储类</span></a></li><li><a class="is-flex is-mobile" href="#标记默认存储类"><span>标记默认存储类</span></a></li><li><a class="is-flex is-mobile" href="#使用存储类"><span>使用存储类</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Pod调度"><span>Pod调度</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#nodeSelector"><span>nodeSelector</span></a></li><li><a class="is-flex is-mobile" href="#nodeName"><span>nodeName</span></a></li><li><a class="is-flex is-mobile" href="#tolerations"><span>tolerations</span></a></li><li><a class="is-flex is-mobile" href="#affinity"><span>affinity</span></a></li><li><a class="is-flex is-mobile" href="#PriorityClass"><span>PriorityClass</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#ConfigMaps"><span>ConfigMaps</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#YAML文件创建"><span>YAML文件创建</span></a></li><li><a class="is-flex is-mobile" href="#命令行创建"><span>命令行创建</span></a></li><li><a class="is-flex is-mobile" href="#Volume-挂载ConfigMap"><span>Volume 挂载ConfigMap</span></a></li><li><a class="is-flex is-mobile" href="#环境变量ConfigMap"><span>环境变量ConfigMap</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Secrets"><span>Secrets</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#命令行创建-1"><span>命令行创建</span></a></li><li><a class="is-flex is-mobile" href="#环境变量Secret"><span>环境变量Secret</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#资源配额"><span>资源配额</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Pod-资源配额"><span>Pod 资源配额</span></a></li><li><a class="is-flex is-mobile" href="#NameSpace-资源配额"><span>NameSpace 资源配额</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#访问控制"><span>访问控制</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#ServiceAaccount"><span>ServiceAaccount</span></a></li><li><a class="is-flex is-mobile" href="#Role和ClusterRole"><span>Role和ClusterRole</span></a></li><li><a class="is-flex is-mobile" href="#网络策略"><span>网络策略</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Helm-概念与实践"><span>Helm 概念与实践</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Helm基本概念"><span>Helm基本概念</span></a></li><li><a class="is-flex is-mobile" href="#主要组件"><span>主要组件</span></a></li><li><a class="is-flex is-mobile" href="#Helm安装"><span>Helm安装</span></a></li><li><a class="is-flex is-mobile" href="#添加仓库"><span>添加仓库</span></a></li><li><a class="is-flex is-mobile" href="#Helm-实验案例"><span>Helm 实验案例</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#helm仓库直接安装"><span>helm仓库直接安装</span></a></li><li><a class="is-flex is-mobile" href="#k8s-Dashboard安装"><span>k8s Dashboard安装</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#监控与升级"><span>监控与升级</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#部署Metrics"><span>部署Metrics</span></a></li><li><a class="is-flex is-mobile" href="#HPA-自动扩容"><span>HPA 自动扩容</span></a></li><li><a class="is-flex is-mobile" href="#部署Prometheus"><span>部署Prometheus</span></a></li><li><a class="is-flex is-mobile" href="#升级控制平面"><span>升级控制平面</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#ETCD-备份与恢复"><span>ETCD 备份与恢复</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#备份"><span>备份</span></a></li><li><a class="is-flex is-mobile" href="#恢复"><span>恢复</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#Kustomize-管理"><span>Kustomize 管理</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Kustomize-概念"><span>Kustomize 概念</span></a></li><li><a class="is-flex is-mobile" href="#Kustomize-实验"><span>Kustomize 实验</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#实验概述"><span>实验概述</span></a></li><li><a class="is-flex is-mobile" href="#实验目标"><span>实验目标</span></a></li><li><a class="is-flex is-mobile" href="#发布开发环境"><span>发布开发环境</span></a></li></ul></li></ul></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="罗宇"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">罗宇</p><p class="is-size-6 is-block">用开放的思维，解决封闭的问题</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国-四川-成都</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives/"><p class="title">11</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories/"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags/"><p class="title">11</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://luovip.github.io" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.linuxcenter.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">李晓辉的技术博客</span></span><span class="level-right"><span class="level-item tag">www.linuxcenter.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.iloveimg.com/zh-cn/compress-image" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">图片压缩</span></span><span class="level-right"><span class="level-item tag">www.iloveimg.com</span></span></a></li><li><a class="level is-mobile" href="https://mirrors.nju.edu.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">南京大学镜像站</span></span><span class="level-right"><span class="level-item tag">mirrors.nju.edu.cn</span></span></a></li><li><a class="level is-mobile" href="https://developer.aliyun.com/mirror/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">阿里云镜像站</span></span><span class="level-right"><span class="level-item tag">developer.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://docs.docker.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">docker官网</span></span><span class="level-right"><span class="level-item tag">docs.docker.com</span></span></a></li><li><a class="level is-mobile" href="https://hub.docker.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">docker官方仓库</span></span><span class="level-right"><span class="level-item tag">hub.docker.com</span></span></a></li><li><a class="level is-mobile" href="https://kubernetes.io/zh-cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">kubernetes官网</span></span><span class="level-right"><span class="level-item tag">kubernetes.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2025/05/10/Kubernetes/Kubernetes%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"><img src="/img/K8S.jpg" alt="Kubernetes网络系统原理"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-10T11:29:42.000Z">2025-05-10 19:29:42</time></p><p class="title"><a href="/2025/05/10/Kubernetes/Kubernetes%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/">Kubernetes网络系统原理</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/10/Kubernetes/Kubernetes%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%BF%90%E7%BB%B4/"><img src="/img/K8S.jpg" alt="Kubernetes企业级运维"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-10T11:28:42.000Z">2025-05-10 19:28:42</time></p><p class="title"><a href="/2025/05/10/Kubernetes/Kubernetes%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%BF%90%E7%BB%B4/">Kubernetes企业级运维</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/SQL%E8%AF%AD%E5%8F%A5%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1/"><img src="/img/sql.jpg" alt="MySQL数据库"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-10T09:55:42.000Z">2025-05-10 17:55:42</time></p><p class="title"><a href="/2025/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/SQL%E8%AF%AD%E5%8F%A5%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1/">MySQL数据库</a></p><p class="categories"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/10/%E5%AE%B9%E5%99%A8/Docker&amp;Kubernetes/"><img src="/img/docker&amp;k8s.jpg" alt="Docker&amp;K8S"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-10T09:55:42.000Z">2025-05-10 17:55:42</time></p><p class="title"><a href="/2025/05/10/%E5%AE%B9%E5%99%A8/Docker&amp;Kubernetes/">Docker&amp;K8S</a></p><p class="categories"><a href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/">容器技术</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/10/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/Shell%E8%84%9A%E6%9C%AC/"><img src="/img/shell.jpg" alt="Shell脚本"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-10T09:55:42.000Z">2025-05-10 17:55:42</time></p><p class="title"><a href="/2025/05/10/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/Shell%E8%84%9A%E6%9C%AC/">Shell脚本</a></p><p class="categories"><a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/">自动化运维</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/CKA%E8%AE%A4%E8%AF%81/"><span class="level-start"><span class="level-item">CKA认证</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Kubernetes/"><span class="level-start"><span class="level-item">Kubernetes</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/"><span class="level-start"><span class="level-item">容器技术</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="level-start"><span class="level-item">数据库</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"><span class="level-start"><span class="level-item">自动化运维</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/05/"><span class="level-start"><span class="level-item">五月 2025</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/04/"><span class="level-start"><span class="level-item">四月 2025</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Ansible%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"><span class="tag">Ansible的基本使用</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CKA%E7%AC%94%E8%AE%B0/"><span class="tag">CKA笔记</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker-K8S/"><span class="tag">Docker&amp;K8S</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kubernetes%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%BF%90%E7%BB%B4/"><span class="tag">Kubernetes企业级运维</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kubernetes%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"><span class="tag">Kubernetes网络系统原理</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"><span class="tag">Linux的基本使用</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux%E7%9A%84%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"><span class="tag">Linux的基础服务</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux%E8%BF%9B%E9%98%B6/"><span class="tag">Linux进阶</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">MySQL数据库</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell%E8%84%9A%E6%9C%AC/"><span class="tag">Shell脚本</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/podman%E5%AE%B9%E5%99%A8/"><span class="tag">podman容器</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Linux技术博客</a><p class="size-small"><span>&copy; 2021-2025</span>  Powered by 罗宇 <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">川ICP备88888888号</a><br></span><span>© 版权说明:本网站所有内容均自己创作,方便用于技术交流和日常总结!<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/12/17 00:00:00')", 250,"");</script><br></span></p></div><div class="level-end"></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(false){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('undefined','undefined','undefined','undefined',undefined);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>