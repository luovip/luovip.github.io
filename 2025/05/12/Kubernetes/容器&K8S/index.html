<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>容器&amp;K8S - Linux技术博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Linux技术博客"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Linux技术博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1 微服务"><meta property="og:type" content="blog"><meta property="og:title" content="罗宇"><meta property="og:url" content="https://luovip.github.io/"><meta property="og:site_name" content="罗宇"><meta property="og:description" content="1 微服务"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://luovip.github.io/img/avatar.png"><meta property="article:published_time" content="2025-05-12T07:21:42.000Z"><meta property="article:modified_time" content="2025-05-17T04:07:05.635Z"><meta property="article:author" content="removeif"><meta property="article:tag" content="容器&amp;K8S"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://luovip.github.io/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2025/05/12/Kubernetes/%E5%AE%B9%E5%99%A8&K8S/"},"headline":"Linux技术博客","image":["http://example.com/img/docker&k8s.jpg"],"datePublished":"2025-05-12T07:21:42.000Z","dateModified":"2025-05-17T04:07:05.635Z","author":{"@type":"Person","name":"罗宇"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject"}},"description":"1 微服务"}</script><link rel="canonical" href="http://example.com/2025/05/12/Kubernetes/%E5%AE%B9%E5%99%A8&amp;K8S/"><link rel="icon" href="/img/favicon.svg"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/6.0.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark-reasonable.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/css/cyberpunk.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdnjs.loli.net/ajax/libs/pace/1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Linux技术博客</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">音乐</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/about">关于我</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/img/docker&amp;k8s.jpg" alt="容器&amp;K8S"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2025-05-12 15:21:42  <span class="level-item"> 罗宇 </span><a class="commentCountImg" href="/2025/05/12/Kubernetes/%E5%AE%B9%E5%99%A8&amp;K8S/#comment-container"><span class="display-none-class">/2025/05/12/Kubernetes/容器&amp;K8S/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="4c3953c05261a2c206c3b3b0d761cc70">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>10.4 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">容器&amp;K8S</h1><div class="content"><h1 id="1-微服务"><a href="#1-微服务" class="headerlink" title="1 微服务"></a>1 微服务</h1><span id="more"></span>

<p>&emsp;&emsp;把一个庞大的应用拆成几个小的独立的服务，再把独立的服务串起来的一种架构设计:内聚更强，更加敏捷</p>
<p><img src="/images/%E5%BE%AE%E6%9C%8D%E5%8A%A1.png" title="微服务"></p>
<h2 id="1-1-应用架构的发展"><a href="#1-1-应用架构的发展" class="headerlink" title="1.1 应用架构的发展"></a>1.1 应用架构的发展</h2><p><img src="/images/%E5%BA%94%E7%94%A8%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8F%91%E5%B1%95.png" title="应用架构的发展"></p>
<h2 id="1-2-传统单体架构vs微服务软件架构"><a href="#1-2-传统单体架构vs微服务软件架构" class="headerlink" title="1.2 传统单体架构vs微服务软件架构"></a>1.2 传统单体架构vs微服务软件架构</h2><p>&emsp;&emsp;不同于微服务，传统的项目会包含很多功能，是一个大而全的“超级”工程</p>
<p>&emsp;&emsp;例如：以普通架构方式实现的电商平台包含：登录、权限、会员、商品库存、订单、收藏、关注、购物车等功能的多个单一项目。随着项目业务越来越复杂、开发人员越来越多，相应开发、编译、部署、技术扩展、水平扩展都会受到限制</p>
<p><img src="/images/%E4%BC%A0%E7%BB%9F%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84vs%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png" title="传统单体架构vs微服务架构"></p>
<h2 id="1-3-基于微服务的系统架构"><a href="#1-3-基于微服务的系统架构" class="headerlink" title="1.3 基于微服务的系统架构"></a>1.3 基于微服务的系统架构</h2><p><img src="/images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png" title="微服务系统架构"></p>
<p>&emsp;&emsp;核心思路是拆分</p>
<p>&emsp;&emsp;单体项目的问题，通过把项目拆分成一个个小项目就可以解决</p>
<h2 id="1-4-微服务的特征"><a href="#1-4-微服务的特征" class="headerlink" title="1.4 微服务的特征"></a>1.4 微服务的特征</h2><p><img src="/images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%89%B9%E5%BE%81.png" title="微服务的特征"></p>
<h2 id="1-5-单体架构"><a href="#1-5-单体架构" class="headerlink" title="1.5 单体架构"></a>1.5 单体架构</h2><p>&emsp;&emsp;紧耦合面临的问题：</p>
<p>&emsp;&emsp;&emsp;1.故障影响范围大</p>
<p>&emsp;&emsp;&emsp;2.变更成本高</p>
<p>&emsp;&emsp;&emsp;3.无法支持大规模计算</p>
<p><img src="/images/%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84.png" title="单体架构"></p>
<p>&emsp;&emsp;如果需要加入模块C，需要更改模块A、B的代码，需要各个系统人员协调处理</p>
<h2 id="1-6-解耦架构"><a href="#1-6-解耦架构" class="headerlink" title="1.6 解耦架构"></a>1.6 解耦架构</h2><p><img src="/images/%E8%A7%A3%E8%80%A6%E6%9E%B6%E6%9E%84.png" title="解耦架构"></p>
<p>&emsp;&emsp;解耦架构的优势：</p>
<p>&emsp;&emsp;&emsp;1.模块化，缩小故障范围</p>
<p>&emsp;&emsp;&emsp;2.降低变更成本，插入新模块不影响其他模块</p>
<p>&emsp;&emsp;&emsp;3.开发人员协作更简单</p>
<p>&emsp;&emsp;&emsp;4.易于扩展</p>
<h2 id="1-7-消息队列"><a href="#1-7-消息队列" class="headerlink" title="1.7 消息队列"></a>1.7 消息队列</h2><h3 id="1-7-1-传统架构"><a href="#1-7-1-传统架构" class="headerlink" title="1.7.1 传统架构"></a>1.7.1 传统架构</h3><p><img src="/images/%E4%BC%A0%E7%BB%9F%E6%9E%B6%E6%9E%84.png" title="传统架构"></p>
<h3 id="1-7-2-消息队列架构"><a href="#1-7-2-消息队列架构" class="headerlink" title="1.7.2 消息队列架构"></a>1.7.2 消息队列架构</h3><p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9E%B6%E6%9E%84.png" title="消息队列架构"></p>
<h2 id="1-8-微服务面临的挑战"><a href="#1-8-微服务面临的挑战" class="headerlink" title="1.8 微服务面临的挑战"></a>1.8 微服务面临的挑战</h2><table>
<thead>
<tr>
<th></th>
<th>单体架构</th>
<th>微服务架构</th>
</tr>
</thead>
<tbody><tr>
<td>迭代速度</td>
<td>较慢</td>
<td>快</td>
</tr>
<tr>
<td>部署频率</td>
<td>不经常部署</td>
<td>经常发布</td>
</tr>
<tr>
<td>系统性能</td>
<td>吞吐量小</td>
<td>吞吐量大</td>
</tr>
<tr>
<td>系统扩展性</td>
<td>扩展性差</td>
<td>扩展性好</td>
</tr>
<tr>
<td>技术栈多样性</td>
<td>单一、封闭</td>
<td>多样、开放</td>
</tr>
<tr>
<td>运维</td>
<td>简单</td>
<td>运维复杂</td>
</tr>
<tr>
<td>部署难度</td>
<td>容易部署</td>
<td>较难部署</td>
</tr>
<tr>
<td>架构复杂度</td>
<td>较小</td>
<td>复杂度高</td>
</tr>
<tr>
<td>查错</td>
<td>简单</td>
<td>定位问题较难</td>
</tr>
<tr>
<td>管理成本</td>
<td>主要在于开发成本</td>
<td>服务治理、运维</td>
</tr>
</tbody></table>
<h2 id="1-9-虚拟机与容器的比较"><a href="#1-9-虚拟机与容器的比较" class="headerlink" title="1.9 虚拟机与容器的比较"></a>1.9 虚拟机与容器的比较</h2><p><img src="/images/%E8%99%9A%E6%8B%9F%E6%9C%BAvs%E5%AE%B9%E5%99%A8.png" title="虚拟机vs容器"></p>
<table>
<thead>
<tr>
<th>对比模块</th>
<th>虚拟机</th>
<th>容器</th>
</tr>
</thead>
<tbody><tr>
<td>占用空间</td>
<td>非常大，GB级别</td>
<td>小，MB&#x2F;KB级别</td>
</tr>
<tr>
<td>启用速度</td>
<td>慢，分钟级</td>
<td>快，秒级</td>
</tr>
<tr>
<td>运行形态</td>
<td>运行于Hypervisor</td>
<td>直接运行在宿主机内核上</td>
</tr>
<tr>
<td>并发性</td>
<td>一台宿主机上十几个，最多几 十个</td>
<td>上百个，甚至数百个</td>
</tr>
<tr>
<td>性能</td>
<td>低于宿主机</td>
<td>接近于宿主机本地进程</td>
</tr>
<tr>
<td>资源利用率</td>
<td>低</td>
<td>高</td>
</tr>
</tbody></table>
<h1 id="2-容器的基本使用"><a href="#2-容器的基本使用" class="headerlink" title="2 容器的基本使用"></a>2 容器的基本使用</h1><h2 id="2-1-容器介绍"><a href="#2-1-容器介绍" class="headerlink" title="2.1 容器介绍"></a>2.1 容器介绍</h2><p>&emsp;&emsp;容器是一个可以在共享的操作系统上将应用程序以指定格式打包并运行在一个与操作系统相关联的环境中的方法</p>
<p>&emsp;&emsp;和虚拟机相比，容器并不会打包整个操作系统，而只是打包应用程序所必须的库和设置，这将使得容器具备高效率、轻量化、系统隔离性，以上特性将会确保无论在何处部署，容器每次运行都会完全一致</p>
<p>&emsp;&emsp;容器工具：Rkt、Containerd、Docker、Podman</p>
<h2 id="2-2-部署Docker"><a href="#2-2-部署Docker" class="headerlink" title="2.2 部署Docker"></a>2.2 部署Docker</h2><p>从南京大学开源镜像站在Ubuntu上安装docker</p>
<p><img src="/images/docker%E5%AE%89%E8%A3%85.png" title="docker安装"></p>
<h3 id="2-2-1-安装依赖"><a href="#2-2-1-安装依赖" class="headerlink" title="2.2.1 安装依赖"></a>2.2.1 安装依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测系统是否安装了docker</span></span><br><span class="line">root@k8s-master:~# <span class="keyword">for</span> pkg <span class="keyword">in</span> docker.io docker-doc docker-compose podman-docker containerd runc; <span class="keyword">do</span> <span class="built_in">sudo</span> apt-get remove <span class="variable">$pkg</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> apt-get update</span><br><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> apt-get install ca-certificates curl gnupg</span><br></pre></td></tr></table></figure>

<h3 id="2-2-2-安装GPG公钥"><a href="#2-2-2-安装GPG公钥" class="headerlink" title="2.2.2 安装GPG公钥"></a>2.2.2 安装GPG公钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">root@k8s-master:~# curl -fsSL https://mirror.nju.edu.cn/docker-ce/linux/ubuntu/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> <span class="built_in">chmod</span> a+r /etc/apt/keyrings/docker.gpg</span><br></pre></td></tr></table></figure>

<h3 id="2-2-3-添加Docker仓库"><a href="#2-2-3-添加Docker仓库" class="headerlink" title="2.2.3 添加Docker仓库"></a>2.2.3 添加Docker仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# <span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://mirror.nju.edu.cn/docker-ce/linux/ubuntu \</span></span><br><span class="line"><span class="string">  &quot;</span>$(. /etc/os-release &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$VERSION_CODENAME</span>&quot;</span>)<span class="string">&quot; stable&quot;</span> | \</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br></pre></td></tr></table></figure>

<h3 id="2-2-4-安装Docker"><a href="#2-2-4-安装Docker" class="headerlink" title="2.2.4 安装Docker"></a>2.2.4 安装Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> apt-get update</span><br><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取失败，因此在中国需要加速器</span></span><br><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> docker run hello-world</span><br><span class="line">Unable to find image <span class="string">&#x27;hello-world:latest&#x27;</span> locally</span><br><span class="line">docker: Error response from daemon: Get <span class="string">&quot;https://registry-1.docker.io/v2/&quot;</span>: context deadline exceeded (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</span><br><span class="line"></span><br><span class="line">Run <span class="string">&#x27;docker run --help&#x27;</span> <span class="keyword">for</span> more information</span><br></pre></td></tr></table></figure>

<h3 id="2-2-5-Docker镜像加速器"><a href="#2-2-5-Docker镜像加速器" class="headerlink" title="2.2.5 Docker镜像加速器"></a>2.2.5 Docker镜像加速器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">root@k8s-master:~# <span class="built_in">cd</span> /etc/docker</span><br><span class="line">root@k8s-master:/etc/docker# vim daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.baidubce.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.ccs.tencentyun.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.nju.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.sjtug.sjtu.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.gcr.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.registry.cyou&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker-cf.registry.cyou&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dockercf.jsdelivr.fyi&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.jsdelivr.fyi&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dockertest.jsdelivr.fyi&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.aliyuncs.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dockerproxy.com&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">root@k8s-master:~# systemctl daemon-reload</span><br><span class="line">root@k8s-master:~# systemctl restart docker</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# <span class="built_in">sudo</span> docker pull hello-world</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">Digest: sha256:c41088499908a59aae84b0a49c70e86f4731e588a737f1637e73c8c09d995654</span><br><span class="line">Status: Image is up to <span class="built_in">date</span> <span class="keyword">for</span> hello-world:latest</span><br><span class="line">docker.io/library/hello-world:latest</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# docker images</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">hello-world   latest    74cc54e27dc4   3 months ago   10.1kB</span><br></pre></td></tr></table></figure>

<h3 id="2-2-6-重启Docker服务"><a href="#2-2-6-重启Docker服务" class="headerlink" title="2.2.6 重启Docker服务"></a>2.2.6 重启Docker服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# systemctl restart docker</span><br><span class="line">root@k8s-master:~# docker info</span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:    28.1.1</span><br><span class="line"> Context:    default</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Plugins:</span><br><span class="line">  buildx: Docker Buildx (Docker Inc.)</span><br><span class="line">    Version:  v0.23.0</span><br><span class="line">    Path:     /usr/libexec/docker/cli-plugins/docker-buildx</span><br><span class="line">  compose: Docker Compose (Docker Inc.)</span><br><span class="line">    Version:  v2.35.1</span><br><span class="line">    Path:     /usr/libexec/docker/cli-plugins/docker-compose</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 2</span><br><span class="line">  Running: 1</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 1</span><br><span class="line"> Images: 2</span><br><span class="line"> Server Version: 28.1.1</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">  Backing Filesystem: extfs</span><br><span class="line">  Supports d_type: <span class="literal">true</span></span><br><span class="line">  Using metacopy: <span class="literal">false</span></span><br><span class="line">  Native Overlay Diff: <span class="literal">true</span></span><br><span class="line">  userxattr: <span class="literal">false</span></span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: systemd</span><br><span class="line"> Cgroup Version: 2</span><br><span class="line"> Plugins:</span><br><span class="line">  Volume: <span class="built_in">local</span></span><br><span class="line">  Network: bridge host ipvlan macvlan null overlay</span><br><span class="line">  Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> splunk syslog</span><br><span class="line"> Swarm: inactive</span><br><span class="line"> Runtimes: io.containerd.runc.v2 runc</span><br><span class="line"> Default Runtime: runc</span><br><span class="line"> Init Binary: docker-init</span><br><span class="line"> containerd version: 05044ec0a9a75232cad458027ca83437aae3f4da</span><br><span class="line"> runc version: v1.2.5-0-g59923ef</span><br><span class="line"> init version: de40ad0</span><br><span class="line"> Security Options:</span><br><span class="line">  apparmor</span><br><span class="line">  seccomp</span><br><span class="line">   Profile: <span class="built_in">builtin</span></span><br><span class="line">  cgroupns</span><br><span class="line"> Kernel Version: 6.8.0-53-generic</span><br><span class="line"> Operating System: Ubuntu 24.04.2 LTS</span><br><span class="line"> OSType: linux</span><br><span class="line"> Architecture: x86_64</span><br><span class="line"> CPUs: 2</span><br><span class="line"> Total Memory: 3.777GiB</span><br><span class="line"> Name: k8s-master</span><br><span class="line"> ID: 6c5b4dc6-423d-47e6-a687-e75062cf4fd9</span><br><span class="line"> Docker Root Dir: /var/lib/docker</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Experimental: <span class="literal">false</span></span><br><span class="line"> Insecure Registries:</span><br><span class="line">  ::1/128</span><br><span class="line">  127.0.0.0/8</span><br><span class="line"> Registry Mirrors:</span><br><span class="line">  https://docker.mirrors.ustc.edu.cn/</span><br><span class="line">  https://mirror.baidubce.com/</span><br><span class="line">  https://docker.m.daocloud.io/</span><br><span class="line">  https://mirror.ccs.tencentyun.com/</span><br><span class="line">  https://docker.nju.edu.cn/</span><br><span class="line">  https://docker.mirrors.sjtug.sjtu.edu.cn/</span><br><span class="line">  https://mirror.gcr.io/</span><br><span class="line">  https://docker.registry.cyou/</span><br><span class="line">  https://docker-cf.registry.cyou/</span><br><span class="line">  https://dockercf.jsdelivr.fyi/</span><br><span class="line">  https://docker.jsdelivr.fyi/</span><br><span class="line">  https://dockertest.jsdelivr.fyi/</span><br><span class="line">  https://mirror.aliyuncs.com/</span><br><span class="line">  https://dockerproxy.com/</span><br></pre></td></tr></table></figure>

<h2 id="2-3-操作容器"><a href="#2-3-操作容器" class="headerlink" title="2.3 操作容器"></a>2.3 操作容器</h2><h3 id="2-3-1-创建持续运行的容器"><a href="#2-3-1-创建持续运行的容器" class="headerlink" title="2.3.1 创建持续运行的容器"></a>2.3.1 创建持续运行的容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# docker run -d --name nginxtest nginx</span><br><span class="line">root@k8s-master:~# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED              STATUS              PORTS     NAMES</span><br><span class="line">b68184fd3b9b   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   About a minute ago   Up About a minute   80/tcp  nginxtest</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE    COMMAND                  CREATED              STATUS               PORTS     NAMES</span><br><span class="line">b68184fd3b9b   nginx    <span class="string">&quot;/docker-entrypoint.…&quot;</span>   About a minute ago   Up About a minute     80/tcp  nginxtest</span><br><span class="line">8ea8394296ac   hello-world   <span class="string">&quot;/hello&quot;</span>            22 minutes ago    Exited (0) 22 minutes ago   goofy_brattain</span><br></pre></td></tr></table></figure>

<h3 id="2-3-2-进入容器"><a href="#2-3-2-进入容器" class="headerlink" title="2.3.2 进入容器"></a>2.3.2 进入容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# docker <span class="built_in">exec</span> -it nginxtest /bin/bash</span><br><span class="line">root@b68184fd3b9b:/# <span class="built_in">cat</span> /etc/nginx/nginx.conf</span><br><span class="line">root@b68184fd3b9b:/# <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">root@k8s-master:~#</span><br><span class="line"></span><br><span class="line"><span class="comment"># @后的主机名在exec后发生了变化，这就是进入容器内的标志</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-3-删除容器"><a href="#2-3-3-删除容器" class="headerlink" title="2.3.3 删除容器"></a>2.3.3 删除容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# docker ps</span><br><span class="line">CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS        PORTS       NAMES</span><br><span class="line">260028d6b4a2   httpd:v1   <span class="string">&quot;httpd-foreground&quot;</span>       5 seconds ago   Up 4 seconds   0.0.0.0:4000-&gt;80/tcp, [::]:4000-&gt;80/tcp   luoyudockerfile</span><br><span class="line">b68184fd3b9b   nginx      <span class="string">&quot;/docker-entrypoint.…&quot;</span>   12 hours ago    Up 12 hours    80/tcp    nginxtest</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# docker <span class="built_in">rm</span> -f nginxtest luoyudockerfile</span><br><span class="line">nginxtest</span><br><span class="line">luoyudockerfile</span><br><span class="line">root@k8s-master:~# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br></pre></td></tr></table></figure>

<h2 id="2-4-构建-使用镜像"><a href="#2-4-构建-使用镜像" class="headerlink" title="2.4 构建&amp;使用镜像"></a>2.4 构建&amp;使用镜像</h2><h3 id="2-4-1-镜像概述"><a href="#2-4-1-镜像概述" class="headerlink" title="2.4.1 镜像概述"></a>2.4.1 镜像概述</h3><p>&emsp;&emsp;镜像是一个用于创建容器的只读模板，通常来讲，包含一些额外的自定义，比如说，可以构建一个基于centos的镜像，在镜像构建时，直接包含一些应用程序，比如Apache或者其他程序，构建完成后，可以直接基于这个镜像启动容器，快速获得期望的业务<br>&emsp;&emsp;镜像可以来自公共的仓库，也可通过Dockerfile等定义文件来构建，并且把自己的镜像推送到仓库中，以备在任何地方任何时间下载使用</p>
<h3 id="2-4-2-公共镜像仓库"><a href="#2-4-2-公共镜像仓库" class="headerlink" title="2.4.2 公共镜像仓库"></a>2.4.2 公共镜像仓库</h3><p>&emsp;&emsp;Docker公共镜像仓库：<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com</a></p>
<p>&emsp;&emsp;Docker Hub是一个基于云端的registry服务，这个服务允许我们连接仓库代码、建立镜像、 推送镜像等功能，提供了一个集中式的容器资源管理平台，包含了各式各样的官方镜像，例如Apache、Centos以及各种企业级应用镜像，还以星级和评分来确保镜像的可靠性和适用性</p>
<p><img src="/images/%E5%85%AC%E5%85%B1%E9%95%9C%E5%83%8F%E5%BA%93.png" title="公共镜像库"></p>
<p>&emsp;&emsp;打开<a target="_blank" rel="noopener" href="https://hub.docker.com,注册一个docker/">https://hub.docker.com，注册一个Docker</a> ID，登陆后浏览各项功能</p>
<h3 id="2-4-3-镜像分层技术"><a href="#2-4-3-镜像分层技术" class="headerlink" title="2.4.3 镜像分层技术"></a>2.4.3 镜像分层技术</h3><p><img src="/images/%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82.png" title="镜像分层技术"></p>
<h3 id="2-4-4-构建镜像的方法"><a href="#2-4-4-构建镜像的方法" class="headerlink" title="2.4.4 构建镜像的方法"></a>2.4.4 构建镜像的方法</h3><p>1.docker commit<br>&emsp;&emsp;使用容器中发生更改的部分生成一个新的镜像，通常的使用场景为，基于普通镜像启动了容器，在容器内部署了所需的业务后，把当前的状态重新生成镜像，以便以当前状态快速部署业务所用</p>
<p>2.Dockerfile 创建镜像<br>&emsp;&emsp;从零开始构建自己所需的镜像，在创建镜像之初把所需的各种设置和所需要的各种应用程序包含进去，生成的镜像可直接用于业务部署</p>
<p>3.Dockerfile高频指令集</p>
<p><img src="/images/dockerfile%E6%8C%87%E4%BB%A4.png" title="dockerfile指令"></p>
<h3 id="2-4-5-Dockerfile-image"><a href="#2-4-5-Dockerfile-image" class="headerlink" title="2.4.5 Dockerfile image"></a>2.4.5 Dockerfile image</h3><p>&emsp;&emsp;在设计Dockerfile时应考虑以下事项：</p>
<p>&emsp;&emsp;&emsp;1.容器应该是暂时的</p>
<p>&emsp;&emsp;&emsp;2.避免安装不必要的软件包</p>
<p>&emsp;&emsp;&emsp;3.每个容器只应该有一个用途</p>
<p>&emsp;&emsp;&emsp;4.避免容器有过多的层</p>
<p>&emsp;&emsp;&emsp;5.多行排序</p>
<p>&emsp;&emsp;&emsp;6.建立缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建dockerfile文件</span></span><br><span class="line">root@k8s-master:~# <span class="built_in">cat</span> &gt; dockerfile &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">FROM httpd</span></span><br><span class="line"><span class="string">MAINTAINER luovipyu@163.com</span></span><br><span class="line"><span class="string">RUN echo hello luoyu dockerfile container &gt; /usr/local/apache2/htdocs/index.html</span></span><br><span class="line"><span class="string">EXPOSE 80</span></span><br><span class="line"><span class="string">WORKDIR /usr/local/apache2/htdocs/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始构建镜像</span></span><br><span class="line">root@k8s-master:~# docker build -t httpd:v1 -f dockerfile .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看docker镜像</span></span><br><span class="line">root@k8s-master:~# docker images</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">httpd         v1        d6d24a446dd4   25 seconds ago   148MB</span><br><span class="line">nginx         latest    a830707172e8   3 weeks ago      192MB</span><br><span class="line">hello-world   latest    74cc54e27dc4   3 months ago     10.1kB</span><br><span class="line"></span><br><span class="line">注明：如果文件名是Dockerfile时可不指定</span><br><span class="line">docker build -t web:v1 .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果用的是containerd，dockerfile方式构建容器镜像的命令就是下面这样的</span></span><br><span class="line">nerdctl build  -t httpd:v1 -f dockerfile .</span><br><span class="line">nerdctl images</span><br></pre></td></tr></table></figure>

<h3 id="2-4-6-使用Dockerfile镜像"><a href="#2-4-6-使用Dockerfile镜像" class="headerlink" title="2.4.6 使用Dockerfile镜像"></a>2.4.6 使用Dockerfile镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用httpd:v1的镜像在本机4000端口上提供一个名为luoyudockerfile的容器</span></span><br><span class="line">root@k8s-master:~# docker run -d -p 4000:80 --name luoyudockerfile httpd:v1</span><br><span class="line">260028d6b4a2b11cd2cfca9ab6ae9d406cc8fa9afd33131db03c880cc235e68f</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# docker ps</span><br><span class="line">CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS        PORTS       NAMES</span><br><span class="line">260028d6b4a2   httpd:v1   <span class="string">&quot;httpd-foreground&quot;</span>       5 seconds ago   Up 4 seconds   0.0.0.0:4000-&gt;80/tcp, [::]:4000-&gt;80/tcp   luoyudockerfile</span><br><span class="line">b68184fd3b9b   nginx      <span class="string">&quot;/docker-entrypoint.…&quot;</span>   12 hours ago    Up 12 hours    80/tcp    nginxtest</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# curl http://127.0.0.1:4000</span><br><span class="line">hello luoyu dockerfile container</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果用的是containerd，dockerfile方式构建容器镜像的使用命令就是下面这样的</span></span><br><span class="line">nerdctl run -d -p 4000:80 --name luoyudockerfile httpd:v1</span><br><span class="line">nerdctl ps</span><br></pre></td></tr></table></figure>

<h3 id="2-4-7-关于镜像命名"><a href="#2-4-7-关于镜像命名" class="headerlink" title="2.4.7 关于镜像命名"></a>2.4.7 关于镜像命名</h3><p>1.镜像命名格式：REPOSITORY+TAG，使用版本号作为命名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# docker images</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">httpd         v1        d6d24a446dd4   11 hours ago   148MB</span><br><span class="line">nginx         latest    a830707172e8   3 weeks ago    192MB</span><br><span class="line">hello-world   latest    74cc54e27dc4   3 months ago   10.1kB</span><br></pre></td></tr></table></figure>

<p>2.关于latest tag的说明</p>
<p>&emsp;&emsp;如果在建立镜像时没有指定Tag，会使用默认值latest，所以，当看到一个镜像的Tag处显示latest的时候，并不一定意味着此版本是最新版，而只意味着在建立镜像的时候，没有指定Tag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# docker build -t web .</span><br><span class="line">root@k8s-master:~# docker images</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">httpd         v1        d6d24a446dd4   11 hours ago   148MB</span><br><span class="line">web           latest    d6d24a446dd4   11 hours ago   148MB</span><br><span class="line">nginx         latest    a830707172e8   3 weeks ago    192MB</span><br><span class="line">hello-world   latest    74cc54e27dc4   3 months ago   10.1kB</span><br></pre></td></tr></table></figure>

<h3 id="2-4-8-删除镜像"><a href="#2-4-8-删除镜像" class="headerlink" title="2.4.8 删除镜像"></a>2.4.8 删除镜像</h3><p>&emsp;&emsp;删除一个特定的镜像，需要知道该镜像的ID或者标签(repository:tag)。或者，如果只记得镜像的部分ID，可以使用这个ID来删除镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# docker images</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">httpd         v1        d6d24a446dd4   11 hours ago   148MB</span><br><span class="line">web           latest    d6d24a446dd4   11 hours ago   148MB</span><br><span class="line">nginx         latest    a830707172e8   3 weeks ago    192MB</span><br><span class="line">hello-world   latest    74cc54e27dc4   3 months ago   10.1kB</span><br><span class="line">root@k8s-master:~# docker rmi web:latest</span><br><span class="line">Untagged: web:latest</span><br><span class="line">root@k8s-master:~# docker rmi 74cc54e27dc4</span><br><span class="line">Error response from daemon: conflict: unable to delete 74cc54e27dc4 (must be forced) - image is being used by stopped container 8ea8394296ac</span><br><span class="line">root@k8s-master:~# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE         COMMAND    CREATED        STATUS                    PORTS     NAMES</span><br><span class="line">8ea8394296ac   hello-world   <span class="string">&quot;/hello&quot;</span>   13 hours ago   Exited (0) 13 hours ago             goofy_brattain</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# docker <span class="built_in">rm</span> 8ea8394296ac</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# docker rmi 74cc54e27dc4</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# docker images</span><br><span class="line">\REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">httpd        v1        d6d24a446dd4   11 hours ago   148MB</span><br><span class="line">nginx        latest    a830707172e8   3 weeks ago    192MB</span><br></pre></td></tr></table></figure>

<h3 id="2-4-9-私有镜像仓库"><a href="#2-4-9-私有镜像仓库" class="headerlink" title="2.4.9 私有镜像仓库"></a>2.4.9 私有镜像仓库</h3><p>&emsp;&emsp;构建私有镜像存储考虑：</p>
<p>&emsp;&emsp;&emsp;1.交付时效，例如，下载并运行镜像，需要消耗带宽和时间</p>
<p>&emsp;&emsp;&emsp;2.机房不允许接入外网</p>
<p>&emsp;&emsp;&emsp;3.镜像私密，不允许将数据放到外网</p>
<p>&emsp;&emsp;&emsp;4.内网速率更高</p>
<p>1.什么是Registry？</p>
<p>&emsp;&emsp;Registry是一个无状态、高度可扩展的服务，可以存储和分发镜像</p>
<p>&emsp;&emsp;Registry是一个基于Apache License许可的开源服务<br>2.为什么使用Registry？</p>
<p>&emsp;&emsp;严格控制映像存储位置</p>
<p>&emsp;&emsp;拥有完全属于自己的镜像分发渠道</p>
<p>&emsp;&emsp;将镜像存储和分布紧密集成到内部开发工作流程中</p>
<p>3.部署Registry步骤如下：如果选用Harbor，请参考Gitee文档</p>
<p>&emsp;&emsp;下载Docker官方最新版的Registry镜像 2、启动Registry容器</p>
<p>&emsp;&emsp;下载测试镜像</p>
<p>&emsp;&emsp;将测试镜像上传至自己的私有仓库</p>
<p>&emsp;&emsp;验证从自有仓库下载并启动容器</p>
<h1 id="3-部署Harbor私有仓库"><a href="#3-部署Harbor私有仓库" class="headerlink" title="3 部署Harbor私有仓库"></a>3 部署Harbor私有仓库</h1><p>&emsp;&emsp;在现代软件开发中，容器化应用已经成为主流，而容器镜像仓库则是确保容器镜像安全、管理和分发的重要工具。Harbor作为一款开源的企业级容器镜像仓库管理工具，不仅支持多种认证方式，还提供镜像复制、漏洞扫描和用户访问控制等功能，为企业提供了一个安全、高效的镜像管理方案</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP</th>
<th>VMware网络类型</th>
<th>用户名</th>
<th>密码</th>
<th>系统</th>
</tr>
</thead>
<tbody><tr>
<td>harbor</td>
<td>Harbor主机</td>
<td>192.168.8.52</td>
<td>NAT</td>
<td>root</td>
<td>harbor</td>
<td>RHEL-9.5</td>
</tr>
</tbody></table>
<h2 id="3-1-RedHat9镜像源配置"><a href="#3-1-RedHat9镜像源配置" class="headerlink" title="3.1 RedHat9镜像源配置"></a>3.1 RedHat9镜像源配置</h2><h3 id="3-1-1-国内镜像源"><a href="#3-1-1-国内镜像源" class="headerlink" title="3.1.1 国内镜像源"></a>3.1.1 国内镜像源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]# <span class="built_in">cd</span> /etc/yum.repos.d</span><br><span class="line">[root@harbor yum.repos.d]# ll</span><br><span class="line">-rw-r--r--. 1 root root 358 May 14 11:25 redhat.repo</span><br><span class="line"></span><br><span class="line">[root@harbor yum.repos.d]# vim aliyun_yum.repo</span><br><span class="line">[ali_baseos]</span><br><span class="line">name=ali_baseos</span><br><span class="line">baseurl=https://mirrors.aliyun.com/centos-stream/9-stream/BaseOS/x86_64/os/</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[ali_appstream]</span><br><span class="line">name=ali_appstream</span><br><span class="line">baseurl=https://mirrors.aliyun.com/centos-stream/9-stream/AppStream/x86_64/os/</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[root@harbor yum.repos.d]# yum makecache</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据需要选择是否更新yum源</span></span><br><span class="line">[root@harbor yum.repos.d]# yum -y update</span><br></pre></td></tr></table></figure>

<h3 id="3-1-2-本地yum源配置"><a href="#3-1-2-本地yum源配置" class="headerlink" title="3.1.2 本地yum源配置"></a>3.1.2 本地yum源配置</h3><p>&emsp;&emsp;配置本地yum源可以创建一个本地的软件包存储库，以便更快地安装、更新和管理软件包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建文件夹并将光盘挂载到新建的文件中</span></span><br><span class="line">[root@harbor ~]# <span class="built_in">mkdir</span> -p /GuaZai/Iso</span><br><span class="line">[root@harbor ~]# mount /dev/sr0 /GuaZai/Iso</span><br><span class="line">mount: /GuaZai/Iso: WARNING: <span class="built_in">source</span> write-protected, mounted read-only.</span><br><span class="line"></span><br><span class="line">[root@harbor ~]# <span class="built_in">cd</span> /GuaZai/Iso</span><br><span class="line">[root@harbor Iso]# <span class="built_in">ls</span></span><br><span class="line">AppStream  BaseOS  EFI  EULA  extra_files.json  GPL  images  isolinux  media.repo  RPM-GPG-KEY-redhat-beta  RPM-GPG-KEY-redhat-release</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置yum文件</span></span><br><span class="line">[root@harbor ~]# vim /etc/yum.repos.d/rhel9.repo</span><br><span class="line">[BaseOS]</span><br><span class="line">name=rhel9-BaseOS</span><br><span class="line">baseurl=file:///GuaZai/Iso/BaseOS</span><br><span class="line">gpgcheck=0</span><br><span class="line">[Appstream]</span><br><span class="line">name=rhel9-Appstream</span><br><span class="line">baseurl=file:///GuaZai/Iso/AppStream</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看仓库序列</span></span><br><span class="line">[root@harbor ~]# yum repolist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成yum缓存</span></span><br><span class="line">[root@harbor ~]# yum makecache</span><br></pre></td></tr></table></figure>

<h2 id="3-2-主机名和IP地址映射"><a href="#3-2-主机名和IP地址映射" class="headerlink" title="3.2 主机名和IP地址映射"></a>3.2 主机名和IP地址映射</h2><p>&emsp;&emsp;配置Harbor主机的主机名和IP地址映射，映射文件“&#x2F;etc&#x2F;hosts”加入如下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]# vim /etc/hosts</span><br><span class="line">192.168.8.52 registry.luovip.cn</span><br></pre></td></tr></table></figure>

<h2 id="3-3-部署Docker-CE"><a href="#3-3-部署Docker-CE" class="headerlink" title="3.3 部署Docker CE"></a>3.3 部署Docker CE</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测系统是否安装了docker并卸载旧版本的容器</span></span><br><span class="line">[root@harbor ~]# <span class="built_in">sudo</span> dnf remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine \</span><br><span class="line">                  podman \</span><br><span class="line">                  runc</span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">[root@harbor ~]# <span class="built_in">sudo</span> yum install -y yum-utils</span><br><span class="line">[root@harbor ~]# <span class="built_in">sudo</span> dnf -y install dnf-plugins-core</span><br><span class="line">[root@harbor ~]# <span class="built_in">sudo</span> dnf config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装docker</span></span><br><span class="line">[root@harbor ~]# <span class="built_in">sudo</span> sed -i <span class="string">&#x27;s+https://download.docker.com+https://mirror.nju.edu.cn/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">[root@harbor ~]# <span class="built_in">sudo</span> yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看docker状态</span></span><br><span class="line">[root@harbor ~]# <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now docker</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /usr/lib/systemd/system/docker.service.</span><br><span class="line">[root@harbor ~]# <span class="built_in">sudo</span> systemctl status docker</span><br><span class="line">[root@harbor ~]# docker info                         </span><br></pre></td></tr></table></figure>

<h2 id="3-4-Docker镜像加速器"><a href="#3-4-Docker镜像加速器" class="headerlink" title="3.4 Docker镜像加速器"></a>3.4 Docker镜像加速器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]# <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">[root@harbor ~]# <span class="built_in">cd</span> /etc/docker</span><br><span class="line">[root@harbor docker]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.baidubce.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.ccs.tencentyun.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.nju.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.sjtug.sjtu.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.gcr.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.registry.cyou&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker-cf.registry.cyou&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dockercf.jsdelivr.fyi&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.jsdelivr.fyi&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dockertest.jsdelivr.fyi&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.aliyuncs.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dockerproxy.com&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;data-root&quot;</span>: <span class="string">&quot;/data/docker&quot;</span>   <span class="comment"># 自定义Docker的镜像存储路径</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@harbor ~]# <span class="built_in">mkdir</span> -p /data/docker</span><br><span class="line">[root@harbor ~]# <span class="built_in">cp</span> -a /var/lib/docker/* /data/docker/</span><br><span class="line"></span><br><span class="line">[root@harbor ~]# systemctl daemon-reload</span><br><span class="line">[root@harbor ~]# systemctl restart docker</span><br><span class="line">[root@harbor ~]# docker info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">[root@harbor ~]# docker pull nginx</span><br><span class="line">[root@harbor ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">nginx        latest    a830707172e8   3 weeks ago   192MB</span><br></pre></td></tr></table></figure>

<h2 id="3-5-Compose支持"><a href="#3-5-Compose支持" class="headerlink" title="3.5 Compose支持"></a>3.5 Compose支持</h2><p>&emsp;&emsp;添加Compose支持，并启动Docker服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载docker-compose并放在/usr/local/bin下</span></span><br><span class="line">curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/v2.36.0/docker-compose-linux-x86_64&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">[root@harbor ~]# docker-compose version</span><br><span class="line">Docker Compose version v2.36.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注明：github可能会访问不了，故先从github下载到本地，再上传到服务器</span></span><br><span class="line">https://github.com/docker/compose/releases</span><br></pre></td></tr></table></figure>

<h2 id="3-6-下载Harbor"><a href="#3-6-下载Harbor" class="headerlink" title="3.6 下载Harbor"></a>3.6 下载Harbor</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]# wget https://github.com/goharbor/harbor/releases/download/v2.13.0/harbor-offline-installer-v2.13.0.tgz</span><br><span class="line"></span><br><span class="line">[root@harbor ~]# tar xf harbor-offline-installer-v2.13.0.tgz -C /usr/local/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用docker load命令将解压后的tar文件加载为Docker镜像</span></span><br><span class="line">[root@harbor ~]# <span class="built_in">cd</span> /usr/local/bin</span><br><span class="line">[root@harbor bin]# ll</span><br><span class="line">total 72004</span><br><span class="line">-rwxr-xr-x. 1 root root 73731911 May 14 14:25 docker-compose</span><br><span class="line">drwxr-xr-x. 2 root root      123 May 14 16:33 harbor</span><br><span class="line">[root@harbor bin]# <span class="built_in">cd</span> harbor</span><br><span class="line">[root@harbor harbor]# docker load -i harbor.v2.13.0.tar.gz</span><br></pre></td></tr></table></figure>

<h2 id="3-7-修改harbor-yml文件"><a href="#3-7-修改harbor-yml文件" class="headerlink" title="3.7 修改harbor.yml文件"></a>3.7 修改harbor.yml文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> harbor.yml.tmpl harbor.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份harbor.yml文件</span></span><br><span class="line"><span class="built_in">cp</span> harbor.yml harbor.yml.bak</span><br><span class="line"></span><br><span class="line">[root@harbor ~]# vim /usr/local/bin/harbor/harbor.yml</span><br><span class="line">1.修改hostname为192.168.8.52</span><br><span class="line">2.修改http的端口为82</span><br><span class="line">3.修改harbor_admin_password为admin</span><br><span class="line"><span class="comment"># 如果不启用https就注释掉12行-20行</span></span><br></pre></td></tr></table></figure>

<h2 id="3-8-安装Harbor"><a href="#3-8-安装Harbor" class="headerlink" title="3.8 安装Harbor"></a>3.8 安装Harbor</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载配置并安装</span></span><br><span class="line">[root@harbor harbor]# ./prepare</span><br><span class="line">[root@harbor harbor]# ./install.sh</span><br><span class="line">...</span><br><span class="line">[Step 5]: starting Harbor ...</span><br><span class="line">[+] Running 10/10</span><br><span class="line"> ✔ Network harbor_harbor        Created    0.0s                                                    </span><br><span class="line"> ✔ Container harbor-log         Started    0.3s                                                      </span><br><span class="line"> ✔ Container registryctl        Started    0.8s                                                    </span><br><span class="line"> ✔ Container harbor-db          Started    1.2s                                                     </span><br><span class="line"> ✔ Container redis              Started    1.2s                                                 </span><br><span class="line"> ✔ Container harbor-portal      Started    1.2s                                                          </span><br><span class="line"> ✔ Container registry           Started    1.3s                                                 </span><br><span class="line"> ✔ Container harbor-core        Started    1.4s                                              </span><br><span class="line"> ✔ Container harbor-jobservice  Started    2.0s                                               </span><br><span class="line"> ✔ Container nginx              Started    2.0s                                           </span><br><span class="line">✔ ----Harbor has been installed and started successfully.----</span><br></pre></td></tr></table></figure>

<h2 id="3-9-重启Harbor"><a href="#3-9-重启Harbor" class="headerlink" title="3.9 重启Harbor"></a>3.9 重启Harbor</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor harbor]# docker-compose down</span><br><span class="line">[root@harbor harbor]# ./prepare</span><br><span class="line">[root@harbor harbor]# docker-compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器访问Harbor   http://192.168.8.52:82  用户名/密码:admin/admin</span></span><br></pre></td></tr></table></figure>

<h2 id="3-10-生成服务文件"><a href="#3-10-生成服务文件" class="headerlink" title="3.10 生成服务文件"></a>3.10 生成服务文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/harbor.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Harbor</span></span><br><span class="line"><span class="string">After=docker.service systemd-networkd.service systemd-resolved.service</span></span><br><span class="line"><span class="string">Requires=docker.service</span></span><br><span class="line"><span class="string">Documentation=http://github.com/vmware/harbor</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=5</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/docker-compose -f /usr/local/bin/harbor/docker-compose.yml up</span></span><br><span class="line"><span class="string">ExecStop=/usr/local/bin/docker-compose -f /usr/local/bin/harbor/docker-compose.yml down</span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">[root@harbor ~]# systemctl daemon-reload</span><br><span class="line">[root@harbor ~]# systemctl <span class="built_in">enable</span> harbor --now</span><br><span class="line">[root@harbor ~]# systemctl stop harbor</span><br><span class="line">[root@harbor ~]# systemctl status harbor</span><br><span class="line">[root@harbor ~]# systemctl start harbor</span><br><span class="line">[root@harbor ~]# systemctl restart harbor</span><br></pre></td></tr></table></figure>

<h2 id="3-11-推送镜像到Harbor"><a href="#3-11-推送镜像到Harbor" class="headerlink" title="3.11 推送镜像到Harbor"></a>3.11 推送镜像到Harbor</h2><p>&emsp;&emsp;将registry.luovip.cn以及其对应的IP添加到&#x2F;etc&#x2F;hosts，然后将上述实验中的httpd:v1镜像，改名为带上IP:PORT形式，上传的镜像到本地仓库</p>
<p>1.添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@docker ~]# vim /etc/hosts</span><br><span class="line">192.168.8.52 registry.luovip.cn</span><br></pre></td></tr></table></figure>

<p>2.编辑文件“&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker.service”，输入以下内容。其中，my.harbor.com是Harbor主机的主机名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@docker ~]# vim /usr/lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd --insecure-registry registry.luovip.cn</span><br></pre></td></tr></table></figure>

<p>3.编辑“&#x2F;etc&#x2F;docker&#x2F;daemon.json”文件，在该文件中指定私有镜像仓库地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@docker ~]# vim /etc/docker/daemon.json</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;192.168.8.52:82&quot;</span></span><br><span class="line">  ]</span><br><span class="line">[root@docker ~]# systemctl daemon-reload</span><br><span class="line">[root@docker ~]# systemctl restart docker.service</span><br></pre></td></tr></table></figure>

<p>4.推送的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker推送命令:</span></span><br><span class="line">1.在项目中标记镜像:</span><br><span class="line">docker tag SOURCE_IMAGE[:TAG] 192.168.8.52:82/library/REPOSITORY[:TAG]</span><br><span class="line">2.推送镜像到当前项目：</span><br><span class="line">docker push 192.168.8.52:82/library/REPOSITORY[:TAG]</span><br><span class="line"></span><br><span class="line">Podman推送命令：</span><br><span class="line">1.推送镜像到当前项目：</span><br><span class="line">podman push IMAGE_ID 192.168.8.52:82/library/REPOSITORY[:TAG]</span><br></pre></td></tr></table></figure>

<p>5.推送镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@docker ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">tomcat       latest    c6c6349a7df2   47 hours ago   468MB</span><br><span class="line">nginx        latest    a830707172e8   4 weeks ago    192MB</span><br><span class="line"></span><br><span class="line">[root@docker ~]# docker login 192.168.8.52:82</span><br><span class="line"></span><br><span class="line">[root@docker ~]# docker tag c6c6349a7df2 192.168.8.52:82/library/tomcat:v2</span><br><span class="line">[root@docker ~]# docekr images</span><br><span class="line">-bash: docekr: <span class="built_in">command</span> not found</span><br><span class="line">[root@docker ~]# docker images</span><br><span class="line">REPOSITORY                       TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">192.168.8.52:82/library/tomcat   v2        c6c6349a7df2   47 hours ago   468MB</span><br><span class="line">tomcat                           latest    c6c6349a7df2   47 hours ago   468MB</span><br><span class="line">nginx                            latest    a830707172e8   4 weeks ago    192MB</span><br><span class="line"></span><br><span class="line">[root@docker ~]# docker push 192.168.8.52:82/library/tomcat:v2</span><br><span class="line"></span><br><span class="line">[root@docker ~]# docker pull 192.168.8.52:82/library/tomcat:v2</span><br></pre></td></tr></table></figure>

<h1 id="4-管理容器的资源"><a href="#4-管理容器的资源" class="headerlink" title="4 管理容器的资源"></a>4 管理容器的资源</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建容器并观察内存量</span></span><br><span class="line">[root@docker ~]# docker run -d --name=httpd_server httpd</span><br><span class="line">[root@docker ~]# docker run -d --name=httpd_tomcat tomcat</span><br><span class="line"></span><br><span class="line">[root@docker ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND              CREATED         STATUS         PORTS      NAMES</span><br><span class="line">796227a2aac7   tomcat    <span class="string">&quot;catalina.sh run&quot;</span>    2 minutes ago   Up 2 minutes   8080/tcp   httpd_tomcat</span><br><span class="line">b025ca41d951   httpd     <span class="string">&quot;httpd-foreground&quot;</span>   3 minutes ago   Up 3 minutes   80/tcp     httpd_server</span><br><span class="line"></span><br><span class="line">[root@docker ~]# docker <span class="built_in">exec</span> -it httpd_server grep MemTotal /proc/meminfo</span><br><span class="line">MemTotal:        3974748 kB</span><br><span class="line">[root@docker ~]# docker <span class="built_in">exec</span> -it httpd_tomcat grep MemTotal /proc/meminfo</span><br><span class="line">MemTotal:        3974748 kB</span><br></pre></td></tr></table></figure>

<h2 id="4-1-容器的内存配额"><a href="#4-1-容器的内存配额" class="headerlink" title="4.1 容器的内存配额"></a>4.1 容器的内存配额</h2><p>&emsp;&emsp;根据以上得出结论，每个容器的内存量，全部等于物理宿主机的内存总量，这意味这更好的性能，但同时也意味着一旦业务需求上升，将有可能发生资源争用，这通常在运维规划时，应当极力避免</p>
<p>&emsp;&emsp;容器可使用的内存：物理内存和交换空间(Swap)</p>
<p>&emsp;&emsp;Docker默认没有设置内存限制。可以通过相关选项限制设置：</p>
<p>&emsp;&emsp;&emsp;1.-m(–memory)：设置容器可用的最大内存，该值最低为4MB</p>
<p>&emsp;&emsp;&emsp;2.–memory-swap：允许容器置入磁盘交换空间中的内存大小</p>
<h3 id="4-1-1-用户内存限制"><a href="#4-1-1-用户内存限制" class="headerlink" title="4.1.1 用户内存限制"></a>4.1.1 用户内存限制</h3><p>Docker提供4种方式设置容器的用户内存使用:</p>
<p>1.对容器内存使用无限制（两个选项都不使用）</p>
<p>2.设置内存限制并取消<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4&spm=1001.2101.3001.7020">交换空间</a>内存限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用300内存和尽可能多的交换空间</span></span><br><span class="line">[root@docker ~]# docker run -it -m 300M --memory-swap -1 ubuntu /bin/bash</span><br></pre></td></tr></table></figure>

<p>3.只设置内存限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 300MB的内存和300MB的交换空间</span></span><br><span class="line"> <span class="comment"># 默认情况下虚拟内存总量将设置为内存大小的两倍，因此容器能使用300M的交换空间</span></span><br><span class="line">[root@docker ~]# docker run -it -m 300M ubuntu /bin/bash</span><br></pre></td></tr></table></figure>

<p>4.同时设置内存和交换空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 300MB的内存和700MB的交换空间</span></span><br><span class="line">[root@docker ~]# docker run -it -m 300M --memory-swap 700m ubuntu /bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="4-1-2-内核内存限制"><a href="#4-1-2-内核内存限制" class="headerlink" title="4.1.2 内核内存限制"></a>4.1.2 内核内存限制</h3><p>&emsp;&emsp;内核内存不能交换到磁盘中，无法使用交换空间，消耗过多可能导致其阻塞系统服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在500MB的内存中，可以使用最高50MB的内核内存</span></span><br><span class="line">[root@docker ~]# docker run -it -m 500M --kernel-memory 50M ubuntu /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只可以使用50MB的内核内存</span></span><br><span class="line">[root@docker ~]# docker run -it --kernel-memory 50M ubuntu /bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="4-1-3-内存预留实现软限制"><a href="#4-1-3-内存预留实现软限制" class="headerlink" title="4.1.3 内存预留实现软限制"></a>4.1.3 内存预留实现软限制</h3><p>&emsp;&emsp;使用–memory-reservation选项设置内存预留，它是一种内存软限制，允许更多的内存共享。设置后，Docker将检测内存争用或内存不足，并强制容器将其内存消耗限制为预留值。</p>
<p>&emsp;&emsp;内存预留值应当始终低于硬限制，作为一个软限制功能，内存预留并不能保证不会超过限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制内存为500MB，内存预留值(软限制)为200MB。</span></span><br><span class="line"><span class="comment"># 当容器消耗内存大于200MB、小于500MB时，下一次系统内存回收将尝试将容器内存缩减到200MB以下</span></span><br><span class="line">[root@docker ~]# docker run -it -m 500M --memory-reservation 200M ubuntu /bin/bash</span><br><span class="line">docker run –it –m 500M --memory-reservation 200M ubuntu /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置内存软限制为1GB</span></span><br><span class="line">[root@docker ~]# docker run -it —-memory-reservation 1G ubuntu /bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="4-2-容器的CPU配额"><a href="#4-2-容器的CPU配额" class="headerlink" title="4.2 容器的CPU配额"></a>4.2 容器的CPU配额</h2><p>&emsp;&emsp;默认情况下，所有容器都可以使用相同的CPU资源，并且没有任何限制，这和内存问题一样，一旦CPU需求业务上升，同样会引起CPU资源的争用，但是和内存指定绝对量的不同，CPU是通过指定相对权重值来进行的配额</p>
<p>&emsp;&emsp;使用–cpu-shares参数对CPU来进行配额分配，默认情况下，这个值为1024</p>
<p>&emsp;&emsp;当前容器中的业务空闲时，其他的容器有权利使用其空闲的CPU周期，这将确保业务的性能</p>
<p>&emsp;&emsp;CPU限额的分配，只有在物理机资源不足的时候才会生效，并且是根据不同的优先级进行的，当其他容器空闲时，忙碌的容器可以获得全部可用的CPU资源</p>
<h3 id="4-2-1-CPU份额限制"><a href="#4-2-1-CPU份额限制" class="headerlink" title="4.2.1 CPU份额限制"></a>4.2.1 CPU份额限制</h3><p>&emsp;&emsp;-c(–cpu-shares)选项将CPU份额权重设置为指定的值</p>
<p>&emsp;&emsp;默认值为1024，如果设置为0，系统将忽略该值并使用默认值1024</p>
<h3 id="4-2-2-CPU周期限制"><a href="#4-2-2-CPU周期限制" class="headerlink" title="4.2.2 CPU周期限制"></a>4.2.2 CPU周期限制</h3><p>&emsp;&emsp;–cpu-period选项(以μs为单位)设置CPU周期以限制容器CPU资源的使用</p>
<p>&emsp;&emsp;默认的CFS(完全公平调度器)周期为100ms(100000μs)</p>
<p>&emsp;&emsp;通常将–cpu-period与–cpu-quota这两个选项配合使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果只有1个CPU，则容器可以每50ms(50000μs)获得50%(25000/50000)的CPU运行时间</span></span><br><span class="line">[root@docker ~]# docker run -it --cpu-period=50000 --cpu-quota=25000 ubuntu /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可用--cpus选项指定容器的可用CPU资源来达到同样的目的</span></span><br><span class="line"><span class="comment"># --cpus选项值是一个浮点数，默认值为0.000，表示不受限制</span></span><br><span class="line"><span class="comment"># 上述可改为</span></span><br><span class="line">[root@docker ~]# docker run -it --cpus=0.5 ubuntu /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># --cpu-period和--cpu-quota选项都是以1个CPU为基准</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-3-CPU放置限制"><a href="#4-2-3-CPU放置限制" class="headerlink" title="4.2.3 CPU放置限制"></a>4.2.3 CPU放置限制</h3><p>&emsp;&emsp;–cpuset-cpus选项限制容器进程在指定的CPU上执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 容器中的进程可以在cpu1和cpu3上执行</span></span><br><span class="line">[root@docker ~]# docker run -it --cpuset-cpus=<span class="string">&quot;1,3&quot;</span> ubuntu:14.04 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器中的进程可以在cpu0、cpu1和cpu 2上执行</span></span><br><span class="line">[root@docker ~]# docker run -it --cpuset-cpus=<span class="string">&quot;0-2&quot;</span> ubuntu:14.04 /bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="4-2-4-CPU配额限制"><a href="#4-2-4-CPU配额限制" class="headerlink" title="4.2.4 CPU配额限制"></a>4.2.4 CPU配额限制</h3><p>&emsp;&emsp;–cpu-quota选项限制容器的CPU配额，默认值为0表示容器占用100%的CPU资源个CPU</p>
<p>&emsp;&emsp;CFS用于处理进程执行的资源分配，是由内核使用的默认Linux调度程序。将此值设置50000意味着限制容器至多使用CPU资源的50%。对于多个CPU而言，调整–cpu-quota选项必要的</p>
<h2 id="4-3-容器的I-O配额"><a href="#4-3-容器的I-O配额" class="headerlink" title="4.3 容器的I&#x2F;O配额"></a>4.3 容器的I&#x2F;O配额</h2><p>&emsp;&emsp;默认情况下，所有容器都可以使用相同的I&#x2F;O资源(500权重)，并且没有任何限制，这和内存、 CPU问题一样，一旦I&#x2F;O需求业务上升，硬盘读写会变得非常迟缓，所以为了更好的提供服务，也应该对容器使用硬盘方面进行调整</p>
<p>&emsp;&emsp;块I&#x2F;O带宽(Block I&#x2F;O Bandwidth，Blkio)是另一种可以限制容器使用的资源</p>
<p>&emsp;&emsp;块I&#x2F;O指磁盘的写，Docker可通过设置权重限制每秒字节数(B&#x2F;s)和每秒I&#x2F;O次数(IO&#x2F;s)的方式控制容器读写盘的带宽</p>
<h3 id="4-3-1-设置块I-O权重"><a href="#4-3-1-设置块I-O权重" class="headerlink" title="4.3.1 设置块I&#x2F;O权重"></a>4.3.1 设置块I&#x2F;O权重</h3><p>&emsp;&emsp;–blkio-weight选项更改比例(原默认为500)，设置相对于所有其他正在运行的容器的块I&#x2F;O带宽权重</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建两个有不同块I/O带宽权重的容器</span></span><br><span class="line">[root@docker ~]# docker run -it --name c1 --blkio-weight 300 ubuntu /bin/bash</span><br><span class="line"></span><br><span class="line">[root@docker ~]# docker run -it --name c2 --blkio-weight 600 ubuntu /bin/bash</span><br><span class="line"></span><br><span class="line">在以下案例中，权重为600的容器将比300的在I/O能力方面多出两倍:</span><br><span class="line"></span><br><span class="line">[root@docker ~]# docker run -d --name 300io --blkio-weight 300 httpd</span><br><span class="line"></span><br><span class="line">[root@docker ~]# docker run -d --name 600io --blkio-weight 600 httpd</span><br><span class="line"></span><br><span class="line">命令测试I/O性能:</span><br><span class="line">[root@docker ~]# <span class="keyword">time</span> <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=test.out bs=1M count=1024</span><br><span class="line">1024+0 records <span class="keyword">in</span></span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB, 1.0 GiB) copied, 4.05265 s, 265 MB/s</span><br><span class="line"></span><br><span class="line">real    0m4.055s</span><br><span class="line">user    0m0.000s</span><br><span class="line">sys     0m4.036s</span><br><span class="line"></span><br><span class="line">注：此设定在I/O争用时，才会体现</span><br></pre></td></tr></table></figure>

<h3 id="4-3-2-限制设备读写速率"><a href="#4-3-2-限制设备读写速率" class="headerlink" title="4.3.2 限制设备读写速率"></a>4.3.2 限制设备读写速率</h3><p>&emsp;&emsp;Docker根据两类指标限制容器的设备读写速率：一类是每秒字节数，另一类是每秒I&#x2F;O次数</p>
<p>&emsp;&emsp;1.限制每秒字节数</p>
<p>&emsp;&emsp;&emsp;–device-read-bps选项限制指定设备的读取速率，即每秒读取的字节数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个容器，并限制对/dev/mapper/rhel-swap设备的读取速率为每秒1MB</span></span><br><span class="line">[root@docker ~]# docker run -it --device-read-bps /dev/mapper/rhel-swap:1mb ubuntu</span><br><span class="line">docker run -it --device-read-bps /dev/sda:1mb ubuntu</span><br><span class="line"></span><br><span class="line"><span class="comment"># 类似地，可使用--device-write-bps选项限制指定设备的写入速率。格式： &lt;设备&gt;:&lt;速率值&gt;[单位]</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;2.限制每秒I&#x2F;O次数</p>
<p>&emsp;&emsp;&emsp;–device-read-iops和–device-write-iops选项制指定设备的读取和写入速率，用每秒I&#x2F;O次数表示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个容器，限制它对/dev/mapper/rhel-swap设备的读取速率为每秒1000次</span></span><br><span class="line">[root@docker ~]# docker run -it --device-read-iops /dev/mapper/rhel-swap:1000 ubuntu</span><br></pre></td></tr></table></figure>

<h2 id="4-4-容器底层技术实现"><a href="#4-4-容器底层技术实现" class="headerlink" title="4.4 容器底层技术实现"></a>4.4 容器底层技术实现</h2><p>&emsp;&emsp;对容器使用的内存、CPU和块I&#x2F;O带宽资源的限制具体是由控制组(Cgroup)的相应子系统来实现的。</p>
<p>&emsp;&emsp;&emsp;1.memory子系统设置控制组中的住务所使用的内存限制</p>
<p>&emsp;&emsp;&emsp;2.cpu子系统通过调度程序提供对CPU的控制组任务的访问</p>
<p>&emsp;&emsp;&emsp;3.blkio子系统为块设备(如磁盘、固态硬盘、USB等)设置输入和输出限制</p>
<p>&emsp;&emsp;在docker run命令中使用–cpu-shares、–memory、–device-read-bps等选项实际上就是在配置控制组，相关的配置文件保存在&#x2F;sys&#x2F;fs&#x2F;cgroup目录中</p>
<h3 id="4-4-1-资源限制的底层实现"><a href="#4-4-1-资源限制的底层实现" class="headerlink" title="4.4.1 资源限制的底层实现"></a>4.4.1 资源限制的底层实现</h3><p>&emsp;&emsp;Linux通过cgroup来分配进程使用的CPU、memory、I&#x2F;O资源的配额，可以通过&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;下面的设定来查看容器的配额部分</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动一个容器，设置内存限额为300MB，CPU权重为512</span></span><br><span class="line">[root@docker ~]# docker run --<span class="built_in">rm</span> -d -p 8080:80 -m 300M --cpu-shares=512 httpd</span><br><span class="line">1dc9a3907b6b82521addd810d52d2514c6ab5fed1e274f03a90e5a1454d16a49</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态更改容器的资源限制</span></span><br><span class="line"><span class="comment"># docker update命令可以动态地更新容器配置，其语法：docker update [选项] 容器 [容器...]</span></span><br><span class="line">[root@docker ~]# docker update -m 500M --cpu-shares=10245 1dc9a3907b6b82521addd810d52d2514c6ab5fed1e274f03a90e5a1454d16a49</span><br><span class="line">1dc9a3907b6b82521addd810d52d2514c6ab5fed1e274f03a90e5a1454d16a49</span><br></pre></td></tr></table></figure>

<h3 id="4-4-2-容器的隔离底层实现"><a href="#4-4-2-容器的隔离底层实现" class="headerlink" title="4.4.2 容器的隔离底层实现"></a>4.4.2 容器的隔离底层实现</h3><p>&emsp;&emsp;每个容器貌似都有自己独立的根目录以及&#x2F;etc、&#x2F;var等目录，而且貌似都有自己的独立网卡，但事实上物理宿主机只有一个网卡，那么容器之间是怎么实现的“独立性”的呢？<br>&emsp;&emsp;Linux使用namespace技术来实现了容器间的资源隔离，namespace管理着宿主机中的全局唯一资源，并且可以让每个容器都会认为自己拥有且只有自己在使用资源，namespace一共有6种，分别为：mount、UTS、IPC、PID、Network、User</p>
<h3 id="4-4-3-namespace"><a href="#4-4-3-namespace" class="headerlink" title="4.4.3 namespace"></a>4.4.3 namespace</h3><p>&emsp;&emsp;Mount namespace让容器看上去拥有整个文件系统，容器有自己的根目录</p>
<p>&emsp;&emsp;UTS namespace可以让容器有自己的主机名，默认情况下，容器的主机名是它本身的短ID，可通过-h或者–hostname设置主机名</p>
<p>&emsp;&emsp;IPC namespace可以让容器拥有自己的共享内存和信号量来实现进程间通信 </p>
<p>&emsp;&emsp;PID namespace让容器拥有自己的进程树，可以在容器中执行ps命令查看</p>
<p>&emsp;&emsp;Network namespace可以让容器拥有自己独立的网卡、IP、路由等资源</p>
<p>&emsp;&emsp;User namespace 让容器能够管理自己的用户，而不是和宿主机公用&#x2F;etc&#x2F;passwd</p>
<h1 id="5-容器原生网络与存储"><a href="#5-容器原生网络与存储" class="headerlink" title="5 容器原生网络与存储"></a>5 容器原生网络与存储</h1><h2 id="5-1-容器原生网络"><a href="#5-1-容器原生网络" class="headerlink" title="5.1 容器原生网络"></a>5.1 容器原生网络</h2><p>&emsp;&emsp;docker原生提供了以下几种网络，如果对原生网络不满意，还可以创建自定义网络<br>&emsp;&emsp;原生网络分为：none、bridge、host，这些网络在docker安装的时候会自动创建，可以通过以下命令来查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@docker ~]# docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">f85881372579   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">668aba04b5b0   host      host      <span class="built_in">local</span></span><br><span class="line">3fa8ef65ab94   none      null      <span class="built_in">local</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;如果容器使用的是none网络，那么此容器将不具备常规理解上的网卡，只具备lo网络，如果要使用这个网络，在创建容器时，指定–network&#x3D;none即可</p>
<p>&emsp;&emsp;None网络是比较封闭的网络，对一些安全要求比较高并且不需要联网的场景，可以用none网络，比如手机上接收的验证码、随机数生成等场景，就可以放在none网络中以避免被窃取</p>
<p>&emsp;&emsp;Host网络是一个共享宿主机网络栈的一个容器共享网络，可以通过–network&#x3D;host在创建容器 的时候指定host网络，处于host网络模式的容器，网络配置和宿主机是完全一样的，也就是说，在容器中可以看到宿主机的所有网卡，并且主机名也是宿主机的，这最大的好处就是性能很高，传输速率特别好，但是宿主机上已经使用的端口，容器就不可以使用</p>
<h2 id="5-2-容器和层"><a href="#5-2-容器和层" class="headerlink" title="5.2 容器和层"></a>5.2 容器和层</h2><p>&emsp;&emsp;容器和镜像最大的不同在于最顶上的可写层，所有在容器中的数据写入和修改都会直接存储到这个可写层中，这就意味着，当容器被删除时，可写层中的数据就丢失了，虽然每个容器都有自己不同的可写层，但是容器底层的镜像却是可以同时共享的</p>
<p><img src="/images/%E5%AE%B9%E5%99%A8%E5%92%8C%E5%B1%82.png" title="容器和层"></p>
<h2 id="5-3-主流存储驱动"><a href="#5-3-主流存储驱动" class="headerlink" title="5.3 主流存储驱动"></a>5.3 主流存储驱动</h2><p>&emsp;&emsp;在容器设计和使用的时候，在容器的可写层中写入的数据是非常少的，但在运维中大部分数据是必须要具备持久化保存的能力，所以在容器中引入了多种的存储驱动来解决上面说的可写层数据的易失性</p>
<p>&emsp;&emsp;目前主流受支持的存储驱动有：</p>
<p><img src="/images/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8.png" title="存储驱动"></p>
<h2 id="5-4-Copy-on-write策略"><a href="#5-4-Copy-on-write策略" class="headerlink" title="5.4 Copy-on-write策略"></a>5.4 Copy-on-write策略</h2><p><img src="/images/Copy-on-write.png" title="Copy-on-write"></p>
<h2 id="5-5-容器数据管理"><a href="#5-5-容器数据管理" class="headerlink" title="5.5 容器数据管理"></a>5.5 容器数据管理</h2><p>&emsp;&emsp;容器中持久化数据一般采用两种存储方式：</p>
<p>&emsp;&emsp;&emsp;1.volume</p>
<p>&emsp;&emsp;&emsp;2.bind mount</p>
<p><img src="/images/%E6%8C%81%E4%B9%85%E5%8C%96%E6%95%B0%E6%8D%AE.png" title="持久化数据"></p>
<h1 id="6-Kubernetes"><a href="#6-Kubernetes" class="headerlink" title="6 Kubernetes"></a>6 Kubernetes</h1><h2 id="6-1-K8S的概念"><a href="#6-1-K8S的概念" class="headerlink" title="6.1 K8S的概念"></a>6.1 K8S的概念</h2><p>&emsp;&emsp;Kubernetes是一个可移植的、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化</p>
<p>&emsp;&emsp;Kubernetes拥有一个庞大且快速增长的生态系统。Kubernetes 的服务、支持和工具广泛可用</p>
<p><img src="/images/k8s.png" title="k8s的概念"></p>
<h2 id="6-2-K8S的特点"><a href="#6-2-K8S的特点" class="headerlink" title="6.2 K8S的特点"></a>6.2 K8S的特点</h2><p>&emsp;&emsp;Kubernetes具有以下几个特点：</p>
<p>&emsp;&emsp;&emsp;1.可移植: 支持公有云、私有云、混合云、多重云（multi-cloud）</p>
<p>&emsp;&emsp;&emsp;2.可扩展: 模块化、插件化、可挂载、可组合</p>
<p>&emsp;&emsp;&emsp;3.自动化:  自动部署、自动重启、自动复制、自动伸缩&#x2F;扩展</p>
<h2 id="6-3-K8S的作用"><a href="#6-3-K8S的作用" class="headerlink" title="6.3 K8S的作用"></a>6.3 K8S的作用</h2><p>&emsp;&emsp;Kubernetes的主要职责是容器编排(Container Orchestration)，即在一组服务器上启动、 监控、回收容器，在满足排程的同时，保证容器可以健康的运行</p>
<p><img src="/images/k8s%E7%9A%84%E4%BD%9C%E7%94%A8.png" title="k8s的作用"></p>
<h2 id="6-4-K8S的整体架构"><a href="#6-4-K8S的整体架构" class="headerlink" title="6.4 K8S的整体架构"></a>6.4 K8S的整体架构</h2><p><img src="/images/k8s%E7%9A%84%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84.png" title="k8s的整体架构"></p>
<h3 id="6-4-1-Master节点"><a href="#6-4-1-Master节点" class="headerlink" title="6.4.1 Master节点"></a>6.4.1 Master节点</h3><p>1.kube-apiserver</p>
<p>&emsp;&emsp;API服务器是Kubernetes控制面的前端</p>
<p>&emsp;&emsp;Kubernetes API服务器的主要实现是kube-apiserver</p>
<p>&emsp;&emsp;kube-apiserver设计上考虑了水平伸缩，可通过部署多个实例进行伸缩。 可以运行kube-apiserver的多个实例，并在这些实例之间平衡流</p>
<p>2.etcd</p>
<p>&emsp;&emsp;etcd是兼具一致性和高可用性的键值数据库，可以作为保存Kubernetes所有集群数据的后台数据库</p>
<p>3.cloud-controller-manager</p>
<p>&emsp;&emsp;cloud-controller-manager仅运行特定于云平台的控制回路</p>
<p>&emsp;&emsp;如果在自己的环境中运行Kubernetes，或者在本地计算机中运行学习环境， 所部署的环境中不需要云控制器管理器</p>
<p>4.kube-scheduler</p>
<p>&emsp;&emsp;控制平面组件，负责监视新创建的、未指定运行节点（node）的 Pods，选择节点让 Pod 在上面运行</p>
<p>5.kube-controller-manager</p>
<p>&emsp;&emsp;这些控制器包括:</p>
<p>&emsp;&emsp;节点控制器（Node Controller）: 负责在节点出现故障时进行通知和响应</p>
<p>&emsp;&emsp;任务控制器（Job controller）: 监测代表一次性任务的Job对象，然后创建Pods来运行这些任务直至完成</p>
<p>&emsp;&emsp;端点控制器（Endpoints Controller）: 填充端点(Endpoints)对象(即加入 Service 与 Pod)</p>
<p>&emsp;&emsp;服务帐户和令牌控制器（Service Account &amp; Token Controllers）: 为新的命名空间创建默认帐户和API访问令牌</p>
<h3 id="6-4-2-Node节点"><a href="#6-4-2-Node节点" class="headerlink" title="6.4.2 Node节点"></a>6.4.2 Node节点</h3><p>1.kubelet</p>
<p>&emsp;&emsp;一个在集群中每个节点（node）上运行的代理，保证容器（containers）都运行在Pod中</p>
<p>2.kube-proxy</p>
<p>&emsp;&emsp;kube-proxy是集群中每个节点上运行的网络代理， 实现Kubernetes服务(Service)概念的一部分</p>
<p>&emsp;&emsp;kube-proxy 维护节点上的网络规则。这些网络规则允许从集群内部或外部的网络会话与Pod进行网络通信</p>
<p>&emsp;&emsp;如果操作系统提供了数据包过滤层并可用的话，kube-proxy会通过它来实现网络规则。否则， kube-proxy仅转发流量本身</p>
<p>3.容器运行时（Container Runtime）</p>
<p>&emsp;&emsp;Kubernetes支持多个容器运行环境: Docker、 containerd、CRI-O以及任何实现Kubernetes CRI (容器运行环境接口)</p>
<h3 id="6-4-3-插件-Addons"><a href="#6-4-3-插件-Addons" class="headerlink" title="6.4.3 插件(Addons)"></a>6.4.3 插件(Addons)</h3><p>&emsp;&emsp;插件使用Kubernetes资源（DaemonSet、 Deployment等）实现集群功能。 因为这些插件提供集群级别的功能，插件中命名空间域的资源属于kube-system命名空间</p>
<p>&emsp;&emsp;1.Core-dns：为整个集群提供DNS服务</p>
<p>&emsp;&emsp;2.Ingress Controller：为service提供外网访问入口</p>
<p>&emsp;&emsp;3.Dashboard: 提供图形化管理界面</p>
<p>&emsp;&emsp;4.Flannel&#x2F; Calico ：为kubernetes提供方便的网络规划服务</p>
<h1 id="7-Kubernetes集群部署"><a href="#7-Kubernetes集群部署" class="headerlink" title="7 Kubernetes集群部署"></a>7 Kubernetes集群部署</h1><h2 id="7-1-Kubernetes的安装流程"><a href="#7-1-Kubernetes的安装流程" class="headerlink" title="7.1 Kubernetes的安装流程"></a>7.1 Kubernetes的安装流程</h2><h3 id="7-1-1-先决条件"><a href="#7-1-1-先决条件" class="headerlink" title="7.1.1 先决条件"></a>7.1.1 先决条件</h3><p>&emsp;&emsp;1.最小配置：2G内存2核CPU</p>
<p>&emsp;&emsp;2.集群中的所有机器的网络彼此均能相互连接(公网和内网都可以)</p>
<p>&emsp;&emsp;3.节点之中不可以有重复的主机名、MAC 地址或product_uuid</p>
<p>&emsp;&emsp;4.禁用交换分区</p>
<p>&emsp;&emsp;5.开启机器上的某些端口</p>
<h3 id="7-1-2-安装runtime"><a href="#7-1-2-安装runtime" class="headerlink" title="7.1.2 安装runtime"></a>7.1.2 安装runtime</h3><p>&emsp;&emsp;默认情况下，Kubernetes使用容器运行时接口（Container Runtime Interface，CRI） 与所选择的容器运行时交互</p>
<p>&emsp;&emsp;如果不指定运行时，则kubeadm会自动尝试检测到系统上已经安装的运行时， 方法是扫描一组众所周知的Unix域套接字，docker启用shim来对接K8S</p>
<p>&emsp;&emsp;运行时的域套接字：<br>&emsp;&emsp;Docker           unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;cri-dockerd.sock </p>
<p>&emsp;&emsp;containerd	&#x2F;run&#x2F;containerd&#x2F;containerd.sock</p>
<p>&emsp;&emsp;CRI-O             &#x2F;var&#x2F;run&#x2F;crio&#x2F;crio.sock</p>
<h3 id="7-1-3-安装kubeadm、kubelet和kubectl"><a href="#7-1-3-安装kubeadm、kubelet和kubectl" class="headerlink" title="7.1.3 安装kubeadm、kubelet和kubectl"></a>7.1.3 安装kubeadm、kubelet和kubectl</h3><p>&emsp;&emsp;需要在每台机器上安装以下软件包：</p>
<p>&emsp;&emsp;kubeadm：用来初始化集群的指令     </p>
<p>&emsp;&emsp;kubelet：在集群中的每个节点上用来启动Pod和容器等</p>
<p>&emsp;&emsp;kubectl：用来与集群通信的命令行工具</p>
<p>&emsp;&emsp;确保它们与通过kubeadm安装的控制平面的版本相匹配。 不然可能会导致一些预料之外的错误和问题。 然而，控制平面与kubelet间的相差一个次要版本不一致是支持的，但kubelet的版本不可以超过API服务器的版本。 例如，1.7.0 版本的kubelet可以完全兼容1.8.0版本的API 服务器，反之则不可以</p>
<h3 id="7-1-4-检查所需端口"><a href="#7-1-4-检查所需端口" class="headerlink" title="7.1.4 检查所需端口"></a>7.1.4 检查所需端口</h3><p>1.控制平面</p>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>入站</td>
<td>6443</td>
<td>Kubernetes API服务器</td>
<td>所有组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>2379-2380</td>
<td>etcd服务器客户端API</td>
<td>kube-apiserver,etcd</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
<td>kubelet自身、控制平面组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10251</td>
<td>kube-scheduler</td>
<td>kube-scheduler自身</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10252</td>
<td>kube-controller-manager</td>
<td>kube-controller-manager自身</td>
</tr>
</tbody></table>
<p>2.工作节点</p>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
<td>kubelet自身、控制平面组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>30000-32767</td>
<td>NodePort服务</td>
<td>所有组件</td>
</tr>
</tbody></table>
<h3 id="7-1-5-Iptables桥接流量"><a href="#7-1-5-Iptables桥接流量" class="headerlink" title="7.1.5 Iptables桥接流量"></a>7.1.5 Iptables桥接流量</h3><p>&emsp;&emsp;为了让Linux节点上的iptables能够正确地查看桥接流量，需要确保sysctl配置中将net.bridge.bridge-nf-call-iptables设置为1</p>
<p><img src="/images/iptables.png" title="iptables桥接流量"></p>
<h3 id="7-1-6-环境准备"><a href="#7-1-6-环境准备" class="headerlink" title="7.1.6 环境准备"></a>7.1.6 环境准备</h3><p>本K8S集群使用3台机器(ubuntu)进行部署，各节点信息如下表：</p>
<p>注明：使用的容器为Docker</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP</th>
<th>VMware网络类型</th>
<th>用户名</th>
<th>密码</th>
<th>互联网连接</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master</td>
<td>控制平面</td>
<td>192.168.8.3</td>
<td>NAT</td>
<td>vagrant<br>root</td>
<td>vagrant<br/>vargrant</td>
<td>是</td>
</tr>
<tr>
<td>k8s-worker1</td>
<td>数据平面</td>
<td>192.168.8.4</td>
<td>NAT</td>
<td>vagrant<br/>root</td>
<td>vagrant<br/>vargrant</td>
<td>是</td>
</tr>
<tr>
<td>k8s-worker2</td>
<td>数据平面</td>
<td>192.168.8.5</td>
<td>NAT</td>
<td>vagrant<br/>root</td>
<td>vagrant<br/>vargrant</td>
<td>是</td>
</tr>
</tbody></table>
<p>准备DNS解析：</p>
<p>&emsp;&emsp;这一步需要在所有机器上完成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这一步需要在所有机器上完成</span></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.8.3 k8s-master</span></span><br><span class="line"><span class="string">192.168.8.4 k8s-worker1</span></span><br><span class="line"><span class="string">192.168.8.5 k8s-worker2</span></span><br><span class="line"><span class="string">192.168.30.133 registry.xiaohui.cn</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="7-2-Docker-CE-部署"><a href="#7-2-Docker-CE-部署" class="headerlink" title="7.2 Docker CE 部署"></a>7.2 Docker CE 部署</h2><h3 id="7-2-1-添加Docker仓库"><a href="#7-2-1-添加Docker仓库" class="headerlink" title="7.2.1 添加Docker仓库"></a>7.2.1 添加Docker仓库</h3><p>这一步要在所有机器上完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y ca-certificates curl gnupg lsb-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加公钥到系统</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://mirrors.nju.edu.cn/docker-ce/linux/ubuntu/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加仓库到系统</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://mirrors.nju.edu.cn/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断仓库是否已做好</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br></pre></td></tr></table></figure>

<h3 id="7-2-2-安装Docker-CE"><a href="#7-2-2-安装Docker-CE" class="headerlink" title="7.2.2 安装Docker CE"></a>7.2.2 安装Docker CE</h3><p>这一步要在所有机器上完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"><span class="comment"># 部署完Docker CE之后，还需要cri-docker shim才可以和Kubernetes集成</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-3-CRI-Docker部署"><a href="#7-2-3-CRI-Docker部署" class="headerlink" title="7.2.3 CRI-Docker部署"></a>7.2.3 CRI-Docker部署</h3><p>这一步要在所有机器上完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载cri-docker</span></span><br><span class="line">wget http://hub.gitmirror.com/https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.17/cri-dockerd_0.3.17.3-0.ubuntu-jammy_amd64.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装cri-docker</span></span><br><span class="line">dpkg -i cri-dockerd_0.3.17.3-0.ubuntu-jammy_amd64.deb</span><br></pre></td></tr></table></figure>

<h3 id="7-2-4-Docker镜像加速器"><a href="#7-2-4-Docker镜像加速器" class="headerlink" title="7.2.4 Docker镜像加速器"></a>7.2.4 Docker镜像加速器</h3><p>这一步要在所有机器上完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.baidubce.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.ccs.tencentyun.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.nju.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.sjtug.sjtu.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.gcr.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.registry.cyou&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker-cf.registry.cyou&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dockercf.jsdelivr.fyi&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.jsdelivr.fyi&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dockertest.jsdelivr.fyi&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.aliyuncs.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://dockerproxy.com&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="7-2-5-将镜像指引到国内"><a href="#7-2-5-将镜像指引到国内" class="headerlink" title="7.2.5 将镜像指引到国内"></a>7.2.5 将镜像指引到国内</h3><p>这一步要在所有机器上完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /lib/systemd/system/cri-docker.service /etc/systemd/system/cri-docker.service</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;s/ExecStart=.*/ExecStart=\/usr\/bin\/cri-dockerd --container-runtime-endpoint fd:\/\/ --network-plugin=cni --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com\/google_containers\/pause:3.10/&#x27;</span> /etc/systemd/system/cri-docker.service</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart cri-docker.service</span><br><span class="line">systemctl <span class="built_in">enable</span> cri-docker.service</span><br></pre></td></tr></table></figure>

<h2 id="7-3-Kubernetes部署"><a href="#7-3-Kubernetes部署" class="headerlink" title="7.3 Kubernetes部署"></a>7.3 Kubernetes部署</h2><h3 id="7-3-1-关闭swap分区"><a href="#7-3-1-关闭swap分区" class="headerlink" title="7.3.1 关闭swap分区"></a>7.3.1 关闭swap分区</h3><p>这一步要在所有机器上完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实时关闭</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line">sed -i <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure>

<h3 id="7-3-2-允许iptables检查桥接流量"><a href="#7-3-2-允许iptables检查桥接流量" class="headerlink" title="7.3.2 允许iptables检查桥接流量"></a>7.3.2 允许iptables检查桥接流量</h3><p>这一步要在所有机器上完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> sysctl --system</span><br></pre></td></tr></table></figure>

<h3 id="7-3-3-安装kubeadm"><a href="#7-3-3-安装kubeadm" class="headerlink" title="7.3.3 安装kubeadm"></a>7.3.3 安装kubeadm</h3><p>这一步要在所有机器上完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">apt-get update &amp;&amp; apt-get install -y apt-transport-https curl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装K8S软件包仓库-阿里云</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/apt/sources.list.d/k8s.list &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">deb https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/deb /</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装软件包仓库的公钥</span></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/deb/Release.key | apt-key add -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新软件包的仓库索引</span></span><br><span class="line">apt-get update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始安装</span></span><br><span class="line">apt-get install -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 操作系统所有软件包升级时将忽略kubelet、kubeadm、kubectl</span></span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>

<h3 id="7-3-4-添加命令自动补齐"><a href="#7-3-4-添加命令自动补齐" class="headerlink" title="7.3.4 添加命令自动补齐"></a>7.3.4 添加命令自动补齐</h3><p>这一步要在所有机器上完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl completion bash &gt; /etc/bash_completion.d/kubectl</span><br><span class="line">kubeadm completion bash &gt; /etc/bash_completion.d/kubeadm</span><br><span class="line"><span class="built_in">source</span> /etc/bash_completion.d/kubectl</span><br><span class="line"><span class="built_in">source</span> /etc/bash_completion.d/kubeadm</span><br></pre></td></tr></table></figure>

<h3 id="7-3-5-集成CRI-Docker"><a href="#7-3-5-集成CRI-Docker" class="headerlink" title="7.3.5 集成CRI-Docker"></a>7.3.5 集成CRI-Docker</h3><p>这一步要在所有机器上完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crictl config --<span class="built_in">set</span> runtime-endpoint unix:///run/cri-dockerd.sock</span><br><span class="line">crictl images</span><br></pre></td></tr></table></figure>

<h3 id="7-3-6-集群部署"><a href="#7-3-6-集群部署" class="headerlink" title="7.3.6 集群部署"></a>7.3.6 集群部署</h3><p>&emsp;&emsp;kubeadm.yaml中name字段必须在网络中可被解析，也可以将解析记录添加到集群中所有机器的&#x2F;etc&#x2F;hosts中</p>
<p>&emsp;&emsp;初始化集群部署的操作只能在k8s-master上执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化配置</span></span><br><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm.yaml</span><br><span class="line">sed -i <span class="string">&#x27;s/.*advert.*/  advertiseAddress: 192.168.8.3/g&#x27;</span> kubeadm.yaml</span><br><span class="line">sed -i <span class="string">&#x27;s/.*name.*/  name: k8s-master/g&#x27;</span> kubeadm.yaml</span><br><span class="line">sed -i <span class="string">&#x27;s|imageRepo.*|imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers|g&#x27;</span> kubeadm.yaml</span><br><span class="line">sed -i <span class="string">&quot;/^\\s*networking:/a\\  podSubnet: 172.16.0.0/16&quot;</span> kubeadm.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意下面的替换，只有在集成的是CRI-Docker时才需要执行，Containerd不需要</span></span><br><span class="line">sed -i <span class="string">&#x27;s/  criSocket.*/  criSocket: unix:\/\/\/run\/cri-dockerd.sock/&#x27;</span> kubeadm.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块加载</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 集群初始化</span></span><br><span class="line">kubeadm init --config kubeadm.yaml</span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line">......</span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.8.3:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:c2546a856290440a8ccaf9223c14fd1c2098ac74f4a584acf5f3c5a373005207</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment"># 授权管理权限</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line">root@k8s-master:~# kubectl get nodes</span><br><span class="line">NAME         STATUS     ROLES           AGE   VERSION</span><br><span class="line">k8s-master   NotReady   control-plane   62m   v1.32.5</span><br></pre></td></tr></table></figure>

<h3 id="7-3-7-部署Calico网络插件"><a href="#7-3-7-部署Calico网络插件" class="headerlink" title="7.3.7 部署Calico网络插件"></a>7.3.7 部署Calico网络插件</h3><p>&emsp;&emsp;Calico网络插件部署的操作在所有节点上执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用operator安装calico组件-可能会失败</span></span><br><span class="line"><span class="comment"># 以下为github的地址，可能会失败</span></span><br><span class="line">root@k8s-master:~# kubectl create -f https://raw.gitmirror.com/projectcalico/calico/refs/tags/v3.29.3/manifests/tigera-operator.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决办法：</span></span><br><span class="line"><span class="comment"># 1.获取Calico images到本地</span></span><br><span class="line">    见Calico.txt</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 2.发布本地的yaml到集群-master</span></span><br><span class="line">kubectl create -f https://www.linuxcenter.cn/files/cka/cka-yaml/tigera-operator-calico-3.29.3.yaml</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# kubectl get pod -A</span><br><span class="line">NAMESPACE         NAME                                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system       coredns-76fccbbb6b-l7jq9             0/1     Pending   0          163m</span><br><span class="line">kube-system       coredns-76fccbbb6b-nd68g             0/1     Pending   0          163m</span><br><span class="line">kube-system       etcd-k8s-master                      1/1     Running   0          163m</span><br><span class="line">kube-system       kube-apiserver-k8s-master            1/1     Running   0          163m</span><br><span class="line">kube-system       kube-controller-manager-k8s-master   1/1     Running   0          163m</span><br><span class="line">kube-system       kube-proxy-mcwv7                     1/1     Running   0          163m</span><br><span class="line">kube-system       kube-scheduler-k8s-master            1/1     Running   0          163m</span><br><span class="line">tigera-operator   tigera-operator-75b4cd596c-9hjml     1/1     Running   0          7m5s</span><br></pre></td></tr></table></figure>

<h3 id="7-3-8-设置calico在集群的网段"><a href="#7-3-8-设置calico在集群的网段" class="headerlink" title="7.3.8 设置calico在集群的网段"></a>7.3.8 设置calico在集群的网段</h3><p>&emsp;&emsp;这一步在k8s-master上执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用下面的自定义资源设置一下calico在集群中的网段</span></span><br><span class="line"><span class="comment"># 以下为github的地址，可能会失败</span></span><br><span class="line">root@k8s-master:~# wget https://raw.gitmirror.com/projectcalico/calico/refs/tags/v3.29.3/manifests/custom-resources.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.使用下面的地址执行</span></span><br><span class="line">root@k8s-master:~# wget https://www.linuxcenter.cn/files/cka/cka-yaml/custom-resources-calico-3.29.3.yaml</span><br><span class="line">root@k8s-master:~# <span class="built_in">mv</span> custom-resources-calico-3.29.3.yaml custom-resources.yaml</span><br></pre></td></tr></table></figure>

<h3 id="7-3-9-确认资源的地址"><a href="#7-3-9-确认资源的地址" class="headerlink" title="7.3.9 确认资源的地址"></a>7.3.9 确认资源的地址</h3><p>&emsp;&emsp;这一步在k8s-master上执行</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@k8s-master:~#</span> <span class="string">vim</span> <span class="string">custom-resources.yaml</span></span><br><span class="line"><span class="comment"># This section includes base Calico installation configuration.</span></span><br><span class="line"><span class="comment"># For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.Installation</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.tigera.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Installation</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># Configures Calico networking.</span></span><br><span class="line">  <span class="attr">calicoNetwork:</span></span><br><span class="line">    <span class="attr">ipPools:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-ipv4-ippool</span></span><br><span class="line">      <span class="attr">blockSize:</span> <span class="number">26</span></span><br><span class="line">      <span class="attr">cidr:</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span>      <span class="comment">#这里换成上面规定好的172.16.0.0/16</span></span><br><span class="line">      <span class="attr">encapsulation:</span> <span class="string">VXLANCrossSubnet</span></span><br><span class="line">      <span class="attr">natOutgoing:</span> <span class="string">Enabled</span></span><br><span class="line">      <span class="attr">nodeSelector:</span> <span class="string">all()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># This section configures the Calico API server.</span></span><br><span class="line"><span class="comment"># For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.APIServer</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.tigera.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIServer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-10-自定义资源发布到集群"><a href="#7-3-10-自定义资源发布到集群" class="headerlink" title="7.3.10 自定义资源发布到集群"></a>7.3.10 自定义资源发布到集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl apply -f custom-resources.yaml</span><br><span class="line">root@k8s-master:~# kubectl get nodes</span><br><span class="line">NAME         STATUS   ROLES           AGE    VERSION</span><br><span class="line">k8s-master   Ready    control-plane   173m   v1.32.5</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# kubectl get pod -A</span><br><span class="line">NAMESPACE          NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-apiserver   calico-apiserver-6499c768c8-wvrnt          1/1     Running   0          60s</span><br><span class="line">calico-apiserver   calico-apiserver-6499c768c8-zmvh6          1/1     Running   0          60s</span><br><span class="line">calico-system      calico-kube-controllers-85fb6564b7-gtsfr   1/1     Running   0          60s</span><br><span class="line">calico-system      calico-node-4mqfj                          1/1     Running   0          60s</span><br><span class="line">calico-system      calico-typha-65d47d7478-ttzx6              1/1     Running   0          60s</span><br><span class="line">calico-system      csi-node-driver-7j8pf                      2/2     Running   0          60s</span><br><span class="line">kube-system        coredns-76fccbbb6b-l7jq9                   1/1     Running   0          172m</span><br><span class="line">kube-system        coredns-76fccbbb6b-nd68g                   1/1     Running   0          172m</span><br><span class="line">kube-system        etcd-k8s-master                            1/1     Running   0          172m</span><br><span class="line">kube-system        kube-apiserver-k8s-master                  1/1     Running   0          172m</span><br><span class="line">kube-system        kube-controller-manager-k8s-master         1/1     Running   0          172m</span><br><span class="line">kube-system        kube-proxy-mcwv7                           1/1     Running   0          172m</span><br><span class="line">kube-system        kube-scheduler-k8s-master                  1/1     Running   0          172m</span><br><span class="line">tigera-operator    tigera-operator-75b4cd596c-9hjml           1/1     Running   0          16m</span><br></pre></td></tr></table></figure>

<h3 id="7-3-11-加入Worker节点"><a href="#7-3-11-加入Worker节点" class="headerlink" title="7.3.11 加入Worker节点"></a>7.3.11 加入Worker节点</h3><p>&emsp;&emsp;加入节点操作需在所有的worker节点完成，这里要注意，Worker节点需要完成以下先决条件才能执行kubeadm join</p>
<p>&emsp;&emsp;&emsp;1.Docker、CRI-Docker 部署</p>
<p>&emsp;&emsp;&emsp;2.Swap分区关闭</p>
<p>&emsp;&emsp;&emsp;3.iptables桥接流量的允许</p>
<p>&emsp;&emsp;&emsp;4.安装kubeadm等软件</p>
<p>&emsp;&emsp;&emsp;5.集成CRI-Docker</p>
<p>&emsp;&emsp;&emsp;6.所有节点的&#x2F;etc&#x2F;hosts中互相添加对方的解析</p>
<p>&emsp;&emsp;如果时间长忘记了join参数，可以在master节点上用以下方法重新生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubeadm token create --print-join-command</span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.8.3:6443 --token 5mffg7.lq7ujh6vot0jzrci --discovery-token-ca-cert-hash sha256:c2546a856290440a8ccaf9223c14fd1c2098ac74f4a584acf5f3c5a373005207</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;如果有多个CRI对象，在worker节点上执行以下命令加入节点时，指定CRI对象，案例如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-worker1:~# kubeadm token create --print-join-command</span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.8.3:6443 --token 5mffg7.lq7ujh6vot0jzrci --discovery-token-ca-cert-hash sha256:c2546a856290440a8ccaf9223c14fd1c2098ac74f4a584acf5f3c5a373005207</span><br><span class="line">failed to load admin kubeconfig: open /root/.kube/config: no such file or directory</span><br><span class="line">To see the stack trace of this error execute with --v=5 or higher</span><br><span class="line">found multiple CRI endpoints on the host. Please define <span class="built_in">which</span> one <span class="keyword">do</span> you wish to use by setting the <span class="string">&#x27;criSocket&#x27;</span> field <span class="keyword">in</span> the kubeadm configuration file: unix:///var/run/containerd/containerd.sock, unix:///var/run/cri-dockerd.sock</span><br><span class="line">To see the stack trace of this error execute with --v=5 or higher</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入两个节点</span></span><br><span class="line">1.节点worker1</span><br><span class="line">root@k8s-worker1:~# kubeadm <span class="built_in">join</span> 192.168.8.3:6443 --token 5mffg7.lq7ujh6vot0jzrci --discovery-token-ca-cert-hash sha256:c2546a856290440a8ccaf9223c14fd1c2098ac74f4a584acf5f3c5a373005207 --cri-socket=unix:///var/run/cri-dockerd.sock</span><br><span class="line"></span><br><span class="line">2.节点worker2</span><br><span class="line">root@k8s-worker2:~#  kubeadm <span class="built_in">join</span> 192.168.8.3:6443 --token 5mffg7.lq7ujh6vot0jzrci --discovery-token-ca-cert-hash sha256:c2546a856290440a8ccaf9223c14fd1c2098ac74f4a584acf5f3c5a373005207 --cri-socket=unix:///var/run/cri-dockerd.sock</span><br><span class="line"></span><br><span class="line">3.查看各节点状态</span><br><span class="line">root@k8s-master:~# kubectl get nodes</span><br><span class="line">NAME          STATUS   ROLES           AGE     VERSION</span><br><span class="line">k8s-master    Ready    control-plane   3h28m   v1.32.5</span><br><span class="line">k8s-worker1   Ready    &lt;none&gt;          2m2s    v1.32.5</span><br><span class="line">k8s-worker2   Ready    &lt;none&gt;          2m2s    v1.32.5</span><br><span class="line"></span><br><span class="line">4.查看pod信息</span><br><span class="line">root@k8s-master:~# kubectl get pod -A</span><br><span class="line">NAMESPACE          NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-apiserver   calico-apiserver-6499c768c8-wvrnt          1/1     Running   0          37m</span><br><span class="line">calico-apiserver   calico-apiserver-6499c768c8-zmvh6          1/1     Running   0          37m</span><br><span class="line">calico-system      calico-kube-controllers-85fb6564b7-gtsfr   1/1     Running   0          37m</span><br><span class="line">calico-system      calico-node-4mqfj                          1/1     Running   0          37m</span><br><span class="line">calico-system      calico-node-rkd6k                          1/1     Running   0          3m37s</span><br><span class="line">calico-system      calico-node-vxflh                          1/1     Running   0          3m37s</span><br><span class="line">calico-system      calico-typha-65d47d7478-cmrtt              1/1     Running   0          3m28s</span><br><span class="line">calico-system      calico-typha-65d47d7478-ttzx6              1/1     Running   0          37m</span><br><span class="line">calico-system      csi-node-driver-7j8pf                      2/2     Running   0          37m</span><br><span class="line">calico-system      csi-node-driver-nhg4c                      2/2     Running   0          3m37s</span><br><span class="line">calico-system      csi-node-driver-z6p7p                      2/2     Running   0          3m37s</span><br><span class="line">kube-system        coredns-76fccbbb6b-l7jq9                   1/1     Running   0          3h29m</span><br><span class="line">kube-system        coredns-76fccbbb6b-nd68g                   1/1     Running   0          3h29m</span><br><span class="line">kube-system        etcd-k8s-master                            1/1     Running   0          3h29m</span><br><span class="line">kube-system        kube-apiserver-k8s-master                  1/1     Running   0          3h29m</span><br><span class="line">kube-system        kube-controller-manager-k8s-master         1/1     Running   0          3h29m</span><br><span class="line">kube-system        kube-proxy-8n6x5                           1/1     Running   0          3m37s</span><br><span class="line">kube-system        kube-proxy-mcwv7                           1/1     Running   0          3h29m</span><br><span class="line">kube-system        kube-proxy-xk4h4                           1/1     Running   0          3m37s</span><br><span class="line">kube-system        kube-scheduler-k8s-master                  1/1     Running   0          3h29m</span><br><span class="line">tigera-operator    tigera-operator-75b4cd596c-9hjml           1/1     Running   0          52m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;注意上描述命令最后的–cri-socket参数，在系统中部署了docker和cri-docker时，必须明确指明此参数，并将此参数指向我们的cri-docker，不然命令会报告有两个重复的CRI的错误</p>
<p>&emsp;&emsp;在k8s-master机器上执行以下内容给节点打上角色标签，k8s-worker1和k8s-worker2分别打上了worker1和worker2的标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubectl label nodes k8s-worker1 node-role.kubernetes.io/worker1=</span><br><span class="line">node/k8s-worker1 labeled</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# kubectl label nodes k8s-worker2 node-role.kubernetes.io/worker2=</span><br><span class="line">node/k8s-worker2 labeled</span><br><span class="line"></span><br><span class="line">root@k8s-master:~# kubectl get nodes</span><br><span class="line">NAME          STATUS   ROLES           AGE     VERSION</span><br><span class="line">k8s-master    Ready    control-plane   3h33m   v1.32.5</span><br><span class="line">k8s-worker1   Ready    worker1         7m37s   v1.32.5</span><br><span class="line">k8s-worker2   Ready    worker2         7m37s   v1.32.5</span><br></pre></td></tr></table></figure>

<h3 id="7-3-12-重置集群"><a href="#7-3-12-重置集群" class="headerlink" title="7.3.12 重置集群"></a>7.3.12 重置集群</h3><p>&emsp;&emsp;如果在安装好集群的情况下，想重复练习初始化集群，或者包括初始化集群报错在内的任何原因，想重新初始化集群时，可以用下面的方法重置集群，重置后，集群就会被删除，可以用于重新部署，一般来说，这个命令仅用于k8s-master这个节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~# kubeadm reset --cri-socket=unix:///var/run/cri-dockerd.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据提示，手工完成文件和规则的清理   清理后就可以重新部署集群了</span></span><br><span class="line">root@k8s-master:~# <span class="built_in">rm</span> -rf /etc/cni/net.d</span><br><span class="line">root@k8s-master:~# iptables -F</span><br><span class="line">root@k8s-master:~# <span class="built_in">rm</span> -rf <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>









</div><div class="article-licensing box"><div class="licensing-title"><p>容器&amp;K8S</p><p><a href="http://example.com/2025/05/12/Kubernetes/容器&amp;K8S/">http://example.com/2025/05/12/Kubernetes/容器&amp;K8S/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="http://example.com"><p>罗宇</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2025-05-12 15:21:42</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-05-17 12:07:05</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># 相关文章</span><br><span>  1.<a class="is-size-6" href="/2025/05/10/Kubernetes/Kubernetes%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/" target="_blank">Kubernetes网络系统原理</a><br></span><span>  2.<a class="is-size-6" href="/2025/05/10/Kubernetes/Kubernetes%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%BF%90%E7%BB%B4/" target="_blank">Kubernetes企业级运维</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/05/11/Linux/Linux%E5%91%BD%E4%BB%A4/"><span class="level-item">Linux命令</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#1-微服务"><span>1 微服务</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#1-1-应用架构的发展"><span>1.1 应用架构的发展</span></a></li><li><a class="is-flex is-mobile" href="#1-2-传统单体架构vs微服务软件架构"><span>1.2 传统单体架构vs微服务软件架构</span></a></li><li><a class="is-flex is-mobile" href="#1-3-基于微服务的系统架构"><span>1.3 基于微服务的系统架构</span></a></li><li><a class="is-flex is-mobile" href="#1-4-微服务的特征"><span>1.4 微服务的特征</span></a></li><li><a class="is-flex is-mobile" href="#1-5-单体架构"><span>1.5 单体架构</span></a></li><li><a class="is-flex is-mobile" href="#1-6-解耦架构"><span>1.6 解耦架构</span></a></li><li><a class="is-flex is-mobile" href="#1-7-消息队列"><span>1.7 消息队列</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#1-7-1-传统架构"><span>1.7.1 传统架构</span></a></li><li><a class="is-flex is-mobile" href="#1-7-2-消息队列架构"><span>1.7.2 消息队列架构</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#1-8-微服务面临的挑战"><span>1.8 微服务面临的挑战</span></a></li><li><a class="is-flex is-mobile" href="#1-9-虚拟机与容器的比较"><span>1.9 虚拟机与容器的比较</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#2-容器的基本使用"><span>2 容器的基本使用</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#2-1-容器介绍"><span>2.1 容器介绍</span></a></li><li><a class="is-flex is-mobile" href="#2-2-部署Docker"><span>2.2 部署Docker</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#2-2-1-安装依赖"><span>2.2.1 安装依赖</span></a></li><li><a class="is-flex is-mobile" href="#2-2-2-安装GPG公钥"><span>2.2.2 安装GPG公钥</span></a></li><li><a class="is-flex is-mobile" href="#2-2-3-添加Docker仓库"><span>2.2.3 添加Docker仓库</span></a></li><li><a class="is-flex is-mobile" href="#2-2-4-安装Docker"><span>2.2.4 安装Docker</span></a></li><li><a class="is-flex is-mobile" href="#2-2-5-Docker镜像加速器"><span>2.2.5 Docker镜像加速器</span></a></li><li><a class="is-flex is-mobile" href="#2-2-6-重启Docker服务"><span>2.2.6 重启Docker服务</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#2-3-操作容器"><span>2.3 操作容器</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#2-3-1-创建持续运行的容器"><span>2.3.1 创建持续运行的容器</span></a></li><li><a class="is-flex is-mobile" href="#2-3-2-进入容器"><span>2.3.2 进入容器</span></a></li><li><a class="is-flex is-mobile" href="#2-3-3-删除容器"><span>2.3.3 删除容器</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#2-4-构建-使用镜像"><span>2.4 构建&amp;使用镜像</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#2-4-1-镜像概述"><span>2.4.1 镜像概述</span></a></li><li><a class="is-flex is-mobile" href="#2-4-2-公共镜像仓库"><span>2.4.2 公共镜像仓库</span></a></li><li><a class="is-flex is-mobile" href="#2-4-3-镜像分层技术"><span>2.4.3 镜像分层技术</span></a></li><li><a class="is-flex is-mobile" href="#2-4-4-构建镜像的方法"><span>2.4.4 构建镜像的方法</span></a></li><li><a class="is-flex is-mobile" href="#2-4-5-Dockerfile-image"><span>2.4.5 Dockerfile image</span></a></li><li><a class="is-flex is-mobile" href="#2-4-6-使用Dockerfile镜像"><span>2.4.6 使用Dockerfile镜像</span></a></li><li><a class="is-flex is-mobile" href="#2-4-7-关于镜像命名"><span>2.4.7 关于镜像命名</span></a></li><li><a class="is-flex is-mobile" href="#2-4-8-删除镜像"><span>2.4.8 删除镜像</span></a></li><li><a class="is-flex is-mobile" href="#2-4-9-私有镜像仓库"><span>2.4.9 私有镜像仓库</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#3-部署Harbor私有仓库"><span>3 部署Harbor私有仓库</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#3-1-RedHat9镜像源配置"><span>3.1 RedHat9镜像源配置</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#3-1-1-国内镜像源"><span>3.1.1 国内镜像源</span></a></li><li><a class="is-flex is-mobile" href="#3-1-2-本地yum源配置"><span>3.1.2 本地yum源配置</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#3-2-主机名和IP地址映射"><span>3.2 主机名和IP地址映射</span></a></li><li><a class="is-flex is-mobile" href="#3-3-部署Docker-CE"><span>3.3 部署Docker CE</span></a></li><li><a class="is-flex is-mobile" href="#3-4-Docker镜像加速器"><span>3.4 Docker镜像加速器</span></a></li><li><a class="is-flex is-mobile" href="#3-5-Compose支持"><span>3.5 Compose支持</span></a></li><li><a class="is-flex is-mobile" href="#3-6-下载Harbor"><span>3.6 下载Harbor</span></a></li><li><a class="is-flex is-mobile" href="#3-7-修改harbor-yml文件"><span>3.7 修改harbor.yml文件</span></a></li><li><a class="is-flex is-mobile" href="#3-8-安装Harbor"><span>3.8 安装Harbor</span></a></li><li><a class="is-flex is-mobile" href="#3-9-重启Harbor"><span>3.9 重启Harbor</span></a></li><li><a class="is-flex is-mobile" href="#3-10-生成服务文件"><span>3.10 生成服务文件</span></a></li><li><a class="is-flex is-mobile" href="#3-11-推送镜像到Harbor"><span>3.11 推送镜像到Harbor</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#4-管理容器的资源"><span>4 管理容器的资源</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#4-1-容器的内存配额"><span>4.1 容器的内存配额</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#4-1-1-用户内存限制"><span>4.1.1 用户内存限制</span></a></li><li><a class="is-flex is-mobile" href="#4-1-2-内核内存限制"><span>4.1.2 内核内存限制</span></a></li><li><a class="is-flex is-mobile" href="#4-1-3-内存预留实现软限制"><span>4.1.3 内存预留实现软限制</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#4-2-容器的CPU配额"><span>4.2 容器的CPU配额</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#4-2-1-CPU份额限制"><span>4.2.1 CPU份额限制</span></a></li><li><a class="is-flex is-mobile" href="#4-2-2-CPU周期限制"><span>4.2.2 CPU周期限制</span></a></li><li><a class="is-flex is-mobile" href="#4-2-3-CPU放置限制"><span>4.2.3 CPU放置限制</span></a></li><li><a class="is-flex is-mobile" href="#4-2-4-CPU配额限制"><span>4.2.4 CPU配额限制</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#4-3-容器的I-O配额"><span>4.3 容器的I/O配额</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#4-3-1-设置块I-O权重"><span>4.3.1 设置块I/O权重</span></a></li><li><a class="is-flex is-mobile" href="#4-3-2-限制设备读写速率"><span>4.3.2 限制设备读写速率</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#4-4-容器底层技术实现"><span>4.4 容器底层技术实现</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#4-4-1-资源限制的底层实现"><span>4.4.1 资源限制的底层实现</span></a></li><li><a class="is-flex is-mobile" href="#4-4-2-容器的隔离底层实现"><span>4.4.2 容器的隔离底层实现</span></a></li><li><a class="is-flex is-mobile" href="#4-4-3-namespace"><span>4.4.3 namespace</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#5-容器原生网络与存储"><span>5 容器原生网络与存储</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#5-1-容器原生网络"><span>5.1 容器原生网络</span></a></li><li><a class="is-flex is-mobile" href="#5-2-容器和层"><span>5.2 容器和层</span></a></li><li><a class="is-flex is-mobile" href="#5-3-主流存储驱动"><span>5.3 主流存储驱动</span></a></li><li><a class="is-flex is-mobile" href="#5-4-Copy-on-write策略"><span>5.4 Copy-on-write策略</span></a></li><li><a class="is-flex is-mobile" href="#5-5-容器数据管理"><span>5.5 容器数据管理</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#6-Kubernetes"><span>6 Kubernetes</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#6-1-K8S的概念"><span>6.1 K8S的概念</span></a></li><li><a class="is-flex is-mobile" href="#6-2-K8S的特点"><span>6.2 K8S的特点</span></a></li><li><a class="is-flex is-mobile" href="#6-3-K8S的作用"><span>6.3 K8S的作用</span></a></li><li><a class="is-flex is-mobile" href="#6-4-K8S的整体架构"><span>6.4 K8S的整体架构</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#6-4-1-Master节点"><span>6.4.1 Master节点</span></a></li><li><a class="is-flex is-mobile" href="#6-4-2-Node节点"><span>6.4.2 Node节点</span></a></li><li><a class="is-flex is-mobile" href="#6-4-3-插件-Addons"><span>6.4.3 插件(Addons)</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#7-Kubernetes集群部署"><span>7 Kubernetes集群部署</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#7-1-Kubernetes的安装流程"><span>7.1 Kubernetes的安装流程</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#7-1-1-先决条件"><span>7.1.1 先决条件</span></a></li><li><a class="is-flex is-mobile" href="#7-1-2-安装runtime"><span>7.1.2 安装runtime</span></a></li><li><a class="is-flex is-mobile" href="#7-1-3-安装kubeadm、kubelet和kubectl"><span>7.1.3 安装kubeadm、kubelet和kubectl</span></a></li><li><a class="is-flex is-mobile" href="#7-1-4-检查所需端口"><span>7.1.4 检查所需端口</span></a></li><li><a class="is-flex is-mobile" href="#7-1-5-Iptables桥接流量"><span>7.1.5 Iptables桥接流量</span></a></li><li><a class="is-flex is-mobile" href="#7-1-6-环境准备"><span>7.1.6 环境准备</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#7-2-Docker-CE-部署"><span>7.2 Docker CE 部署</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#7-2-1-添加Docker仓库"><span>7.2.1 添加Docker仓库</span></a></li><li><a class="is-flex is-mobile" href="#7-2-2-安装Docker-CE"><span>7.2.2 安装Docker CE</span></a></li><li><a class="is-flex is-mobile" href="#7-2-3-CRI-Docker部署"><span>7.2.3 CRI-Docker部署</span></a></li><li><a class="is-flex is-mobile" href="#7-2-4-Docker镜像加速器"><span>7.2.4 Docker镜像加速器</span></a></li><li><a class="is-flex is-mobile" href="#7-2-5-将镜像指引到国内"><span>7.2.5 将镜像指引到国内</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#7-3-Kubernetes部署"><span>7.3 Kubernetes部署</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#7-3-1-关闭swap分区"><span>7.3.1 关闭swap分区</span></a></li><li><a class="is-flex is-mobile" href="#7-3-2-允许iptables检查桥接流量"><span>7.3.2 允许iptables检查桥接流量</span></a></li><li><a class="is-flex is-mobile" href="#7-3-3-安装kubeadm"><span>7.3.3 安装kubeadm</span></a></li><li><a class="is-flex is-mobile" href="#7-3-4-添加命令自动补齐"><span>7.3.4 添加命令自动补齐</span></a></li><li><a class="is-flex is-mobile" href="#7-3-5-集成CRI-Docker"><span>7.3.5 集成CRI-Docker</span></a></li><li><a class="is-flex is-mobile" href="#7-3-6-集群部署"><span>7.3.6 集群部署</span></a></li><li><a class="is-flex is-mobile" href="#7-3-7-部署Calico网络插件"><span>7.3.7 部署Calico网络插件</span></a></li><li><a class="is-flex is-mobile" href="#7-3-8-设置calico在集群的网段"><span>7.3.8 设置calico在集群的网段</span></a></li><li><a class="is-flex is-mobile" href="#7-3-9-确认资源的地址"><span>7.3.9 确认资源的地址</span></a></li><li><a class="is-flex is-mobile" href="#7-3-10-自定义资源发布到集群"><span>7.3.10 自定义资源发布到集群</span></a></li><li><a class="is-flex is-mobile" href="#7-3-11-加入Worker节点"><span>7.3.11 加入Worker节点</span></a></li><li><a class="is-flex is-mobile" href="#7-3-12-重置集群"><span>7.3.12 重置集群</span></a></li></ul></li></ul></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="罗宇"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">罗宇</p><p class="is-size-6 is-block">用开放的思维，解决封闭的问题</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国-四川-成都</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives/"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories/"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags/"><p class="title">12</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://luovip.github.io" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.iloveimg.com/zh-cn/compress-image" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">图片压缩</span></span><span class="level-right"><span class="level-item tag">www.iloveimg.com</span></span></a></li><li><a class="level is-mobile" href="https://mirrors.nju.edu.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">南京大学镜像站</span></span><span class="level-right"><span class="level-item tag">mirrors.nju.edu.cn</span></span></a></li><li><a class="level is-mobile" href="https://developer.aliyun.com/mirror/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">阿里云镜像站</span></span><span class="level-right"><span class="level-item tag">developer.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://docs.docker.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">docker官网</span></span><span class="level-right"><span class="level-item tag">docs.docker.com</span></span></a></li><li><a class="level is-mobile" href="https://hub.docker.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">docker官方仓库</span></span><span class="level-right"><span class="level-item tag">hub.docker.com</span></span></a></li><li><a class="level is-mobile" href="https://containerd.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">containerd官网</span></span><span class="level-right"><span class="level-item tag">containerd.io</span></span></a></li><li><a class="level is-mobile" href="https://goharbor.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">harbor官网</span></span><span class="level-right"><span class="level-item tag">goharbor.io</span></span></a></li><li><a class="level is-mobile" href="https://kubernetes.io/zh-cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">kubernetes官网</span></span><span class="level-right"><span class="level-item tag">kubernetes.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2025/05/12/Kubernetes/%E5%AE%B9%E5%99%A8&amp;K8S/"><img src="/img/docker&amp;k8s.jpg" alt="容器&amp;K8S"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-12T07:21:42.000Z">2025-05-12 15:21:42</time></p><p class="title"><a href="/2025/05/12/Kubernetes/%E5%AE%B9%E5%99%A8&amp;K8S/">容器&amp;K8S</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/11/Linux/Linux%E5%91%BD%E4%BB%A4/"><img src="/img/Linux.jpg" alt="Linux命令"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-11T14:36:42.000Z">2025-05-11 22:36:42</time></p><p class="title"><a href="/2025/05/11/Linux/Linux%E5%91%BD%E4%BB%A4/">Linux命令</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/10/Kubernetes/Kubernetes%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"><img src="/img/K8S.jpg" alt="Kubernetes网络系统原理"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-10T11:29:42.000Z">2025-05-10 19:29:42</time></p><p class="title"><a href="/2025/05/10/Kubernetes/Kubernetes%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/">Kubernetes网络系统原理</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/10/Kubernetes/Kubernetes%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%BF%90%E7%BB%B4/"><img src="/img/K8S.jpg" alt="Kubernetes企业级运维"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-10T11:28:42.000Z">2025-05-10 19:28:42</time></p><p class="title"><a href="/2025/05/10/Kubernetes/Kubernetes%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%BF%90%E7%BB%B4/">Kubernetes企业级运维</a></p><p class="categories"><a href="/categories/Kubernetes/">Kubernetes</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/SQL%E8%AF%AD%E5%8F%A5%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1/"><img src="/img/sql.jpg" alt="MySQL数据库"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-10T09:55:42.000Z">2025-05-10 17:55:42</time></p><p class="title"><a href="/2025/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/SQL%E8%AF%AD%E5%8F%A5%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1/">MySQL数据库</a></p><p class="categories"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/CKA%E8%AE%A4%E8%AF%81/"><span class="level-start"><span class="level-item">CKA认证</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Kubernetes/"><span class="level-start"><span class="level-item">Kubernetes</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/"><span class="level-start"><span class="level-item">容器技术</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="level-start"><span class="level-item">数据库</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"><span class="level-start"><span class="level-item">自动化运维</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/05/"><span class="level-start"><span class="level-item">五月 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/04/"><span class="level-start"><span class="level-item">四月 2025</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Ansible%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"><span class="tag">Ansible的基本使用</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CKA%E7%AC%94%E8%AE%B0/"><span class="tag">CKA笔记</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kubernetes%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%BF%90%E7%BB%B4/"><span class="tag">Kubernetes企业级运维</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kubernetes%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"><span class="tag">Kubernetes网络系统原理</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux%E5%91%BD%E4%BB%A4/"><span class="tag">Linux命令</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"><span class="tag">Linux的基本使用</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux%E7%9A%84%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"><span class="tag">Linux的基础服务</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux%E8%BF%9B%E9%98%B6/"><span class="tag">Linux进阶</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">MySQL数据库</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell%E8%84%9A%E6%9C%AC/"><span class="tag">Shell脚本</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/podman%E5%AE%B9%E5%99%A8/"><span class="tag">podman容器</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8-K8S/"><span class="tag">容器&amp;K8S</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Linux技术博客</a><p class="size-small"><span>&copy; 2021-2025</span>  Powered by 罗宇 <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">川ICP备88888888号</a><br></span><span>© 版权说明:本网站所有内容均自己创作,方便用于技术交流和日常总结!<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2021/12/17 00:00:00')", 250,"");</script><br></span></p></div><div class="level-end"></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(false){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('undefined','undefined','undefined','undefined',undefined);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>