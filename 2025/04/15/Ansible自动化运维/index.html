<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Ansible的基本使用 - 墨香笔记@技术博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="墨香笔记@技术博客"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="墨香笔记@技术博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1 介绍Ansible"><meta property="og:type" content="blog"><meta property="og:title" content="罗宇"><meta property="og:url" content="https://luovip.github.io/"><meta property="og:site_name" content="罗宇"><meta property="og:description" content="1 介绍Ansible"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://luovip.github.io/img/avatar.png"><meta property="article:published_time" content="2025-04-15T05:50:42.000Z"><meta property="article:modified_time" content="2025-04-21T05:54:03.027Z"><meta property="article:author" content="removeif"><meta property="article:tag" content="Ansible"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://luovip.github.io/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2025/04/15/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"},"headline":"墨香笔记@技术博客","image":["http://example.com/img/ansible-cover.jpg"],"datePublished":"2025-04-15T05:50:42.000Z","dateModified":"2025-04-21T05:54:03.027Z","author":{"@type":"Person","name":"罗宇"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject"}},"description":"1 介绍Ansible"}</script><link rel="canonical" href="http://example.com/2025/04/15/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/6.0.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdnjs.loli.net/ajax/libs/pace/1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="墨香笔记@技术博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/media">音乐</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/about">关于我</a></div><div class="navbar-end"><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/img/ansible-cover.jpg" alt="Ansible的基本使用"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2025-04-15  <a class="commentCountImg" href="/2025/04/15/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/#comment-container"><span class="display-none-class">/2025/04/15/Ansible自动化运维/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="858ac14d44e0d6e01ac7fec9df14ab12">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>3 小时  <i class="fas fa-pencil-alt"> </i>23.3 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Ansible的基本使用</h1><div class="content"><p><img src="/%E7%BA%A2%E5%B8%BD-Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4.assets/%E7%8E%AF%E5%A2%83%E5%86%85%E4%B8%BB%E6%9C%BA.png"></p>
<h1 id="1-介绍Ansible"><a href="#1-介绍Ansible" class="headerlink" title="1 介绍Ansible"></a>1 介绍Ansible</h1><span id="more"></span>

<p>​      Ansible是python开发的、开源的批量自动化运维工具</p>
<p>​      官方网站:<a target="_blank" rel="noopener" href="https://www.ansible.com/">https://www.ansible.com</a>   <a target="_blank" rel="noopener" href="https://docs.ansible.com/">https://docs.ansible.com/</a><br><img src="/%E7%BA%A2%E5%B8%BD-Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4.assets/%E4%BB%80%E4%B9%88%E6%98%AFansible.png"></p>
<h2 id="1-1-Ansible的概念和架构"><a href="#1-1-Ansible的概念和架构" class="headerlink" title="1.1 Ansible的概念和架构"></a>1.1 Ansible的概念和架构</h2><p>​       通过inventor定义Managed node，并由SSH与python进行连通</p>
<p>​       1.管理机上管理被管机</p>
<p>​       2.inventory(清单)分组被管机</p>
<p>​          基于SSH、PowerShell进行PUSH ad-hoc或基于YML文件Playbook </p>
<p>​           Python模块、插件、API</p>
<p><img src="/%E7%BA%A2%E5%B8%BD-Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4.assets/ansible%E7%9A%84%E6%9E%B6%E6%9E%84.png"></p>
<h2 id="1-2-Absible的优势"><a href="#1-2-Absible的优势" class="headerlink" title="1.2 Absible的优势"></a>1.2 Absible的优势</h2><p>​       **简单明了:**Ansible playbook，更好的对任务进行排序编写<br>​       **功能强大:**3000多个模块，配置管理、工作流自动化、网络自动化<br>​       **无需代理:**通过SSH管理，而puppet、saltstack需要装客户端<br>​       <strong>与其他系统轻松集成</strong>，如jenkins<br>​       **跨平台支持:**win、linux、unix、网络设备，虚拟机、物理机、云主机、容器</p>
<h2 id="1-3-在控制节点上安装Ansible"><a href="#1-3-在控制节点上安装Ansible" class="headerlink" title="1.3 在控制节点上安装Ansible"></a>1.3 在控制节点上安装Ansible</h2><p>​        <strong>1.Ansible自动化平台2概述-Ansible Core</strong><br>​           <strong>红帽Ansible自动化平台2包含多个不同的组件，共同提供了一整套集成的自动化工具和资源</strong>**<br>​          <strong>Ansible Core</strong>提供用于运行Ansible Playbook的基本功能。</p>
<p>​          定义了用于在YAML文本文件中编写Ansible Playbook的自动化语言</p>
<p>​          提供了自动化代码所需的关键功能，如循环、条件和其他Ansible命令</p>
<p>​          提供了驱动自动化所需的框架和基本命令行工具<br>​          <strong>红帽Ansible自动化平台2</strong>在ansible-core RPM软件包及其ee-minimal-rhel8和ee-supported-rhel8自动化执行环境中提供Ansible Core 2.13</p>
<p>​       <strong>2.Ansible自动化平台2概述-Ansible内容集合</strong><br>​          在过去，Ansible提供了大量模块作为核心软件包的一部分;这种方法在Ansible社区中被称为“自带电池”。Ansible中包含的模块数量呈指数级增长。这导致了支持方面的一些挑战，特别是因为用户有时希望使用比Ansible特定版本中附带模块版本更早或更高的模块<br>​         上游开发人员决定将大多数模块重新整理为单独的Ansible collection(内容集合)，这些资源collection相关的模块角色和插件构成，由同一组开发人员提供支持。</p>
<p>​         Ansible Core本身仅限于由ansible.builtin、Ansible collection(内容集合)提供的一小组模块，该集合始终是Ansible Core的一部分<br>​         订阅红帽Ansible自动化平台2后，可获得红帽提供的120多个认证内容集合的访问权限，另外还可通过AnsibleGalaxy获得很多受社区支持的集合</p>
<p>​      <strong>3.Ansible自动化平台2概述-自动化内容导航器</strong><br>​         红帽Ansible自动化平台2还可提供新的顶级工具(自动化内容导航(ansble-navigator))来开发和测试Ansible Playbook。该工具可取代并扩展多个命令行实用程序的功能，包括ansible-playbook、ansible-inventory、ansible-config<br>​        通过在容器中运行playbook，将运行Ansible的控制节点与运行它的自动化执行环境分隔开来。这样一来，可以更轻松地为自动化代码提供完整的工作环境，以部署到生产环境中</p>
<p>​      <strong>4.Ansible自动化平台2概述-自动化执行环境</strong><br>​         自动化执行环境是一种容器镜像，包含Ansible Core、Ansible内容集合以及运行playbook所需的任何Python库、可执行文件或其他依赖项<br>​         使用ansible-navigator运行playbook时，可选择用于运行该playbook的自动化执行环境</p>
<p>​         当代码运行时，可以向自动化控制器提供playbook和自动化执行环境，并且也知道其具有正确运行playbook所需的一切</p>
<p><img src="/%E7%BA%A2%E5%B8%BD-Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4.assets/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83.png"></p>
<p>​      <strong>5.Ansible自动化平台2概述-准备控制节点</strong><br>​         要运行Ansible Playbook，需在控制节点安装自动化内容导航器(ansible-navigator)，然后下载执行环境</p>
<p>​         由Ansible托管的主机无需安装ansible-navigator，该工具只需安装在运行Ansible Playbook的控制节点</p>
<p>​         安装ansible-core软件包前，先要在控制节点上安装Python3.8或更高版本<br>​         需要有效的红帽Ansible自动化平台订阅，才能在控制节点上安装自动化内容导航器</p>
<p>​         如果已在红帽客户门户中为您的组织激活了简单内容访问，则您无需再将订阅连接到系统</p>
<p>​      <strong>7.Ansible自动化平台2概述-安装Ansible</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#登录workstation后默认为student普通用户，根据实际使用和考试结合建议使用普通用户操作。以下本课程所有操作均为普通用户操作。</span></span><br><span class="line">方法1:</span><br><span class="line">[kiosk@foundation0 ~]$ ssh student@workstation</span><br><span class="line"></span><br><span class="line">方法2:--考试推荐使用</span><br><span class="line">[kiosk@foundation0 ~]$ ssh root@workstation</span><br><span class="line">[root@workstation ~]$ ssh student@localhost</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在控制节点上安装自动化内容导航器</span></span><br><span class="line">- workstation</span><br><span class="line">[student@workstation ~]$ lab start intro-install</span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ <span class="built_in">sudo</span> dnf search ansible   <span class="comment">#搜索ansible关键字的软件包，方便查找ansible的软件</span></span><br><span class="line">[<span class="built_in">sudo</span>] password <span class="keyword">for</span> student:</span><br><span class="line">ansible-navigator.noarch : Red Hat Ansible Automation Platform CLI</span><br><span class="line">ansible-core.x86_64 : SSH-based configuration management, deployment, and task execution system</span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ <span class="built_in">sudo</span> dnf -y install ansible-navigator.noarch ansible-core.x86_64</span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ rpm -q ansible-navigator</span><br><span class="line">ansible-navigator-2.1.0-1.el9ap.noarch</span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ rpm -q ansible-core</span><br><span class="line">ansible-core-2.13.0-2.el9ap.x86_64</span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ rpm -qc ansible-core</span><br><span class="line">/etc/ansible/ansible.cfg</span><br><span class="line">/etc/ansible/hosts</span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ rpm -qc ansible-navigator</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#检查ansible的版本</span></span><br><span class="line">[student@workstation ~]$ ansible --version</span><br><span class="line">ansible [core 2.13.0]</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [<span class="string">&#x27;/home/student/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /usr/lib/python3.9/site-packages/ansible</span><br><span class="line">  ansible collection location = /home/student/.ansible/collections:/usr/share/ansible/collections</span><br><span class="line">  executable location = /bin/ansible</span><br><span class="line">  python version = 3.9.10 (main, Feb  9 2022, 00:00:00) [GCC 11.2.1 20220127 (Red Hat 11.2.1-9)]</span><br><span class="line">  jinja version = 3.0.3</span><br><span class="line">  libyaml = True</span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ ansible-navigator --version</span><br><span class="line">ansible-navigator 2.1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装ansible后会提供导航器配置文件</span></span><br><span class="line">[student@workstation ~]$ <span class="built_in">ls</span> -a</span><br><span class="line">.   .ansible               .ansible-navigator.yml  .bash_logout   .bashrc  .config  Documents  .grading  .jupyter  Music  Pictures  .ssh       .venv</span><br><span class="line">..  ansible-navigator.log  .bash_history           .bash_profile  .cache   Desktop  Downloads  .ipython  .<span class="built_in">local</span>    .npm   Public    Templates  Videos</span><br><span class="line">[student@workstation ~]$ <span class="built_in">cat</span> .ansible-navigator.yml</span><br><span class="line">---</span><br><span class="line">ansible-navigator:</span><br><span class="line">  execution-environment:</span><br><span class="line">    image: utility.lab.example.com/ee-supported-rhel8:latest</span><br><span class="line">    pull:</span><br><span class="line">      policy: missing</span><br></pre></td></tr></table></figure>

<p>   <strong>8.Ansible自动化平台2概述-登录镜像仓库</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置镜像仓库不进行https验证,可以使用全局或个人的，考试已设置好。</span></span><br><span class="line">[student@workstation ~]$ <span class="built_in">mkdir</span> ~/.config/containers     <span class="comment">#~/.config/containers等价于/home/student/.config/containers</span></span><br><span class="line">[student@workstation ~]$ <span class="built_in">cp</span> /etc/containers/registries.conf ~/.config/containers</span><br><span class="line">[student@workstation ~]$ vim ~/.config/containers/registries.conf</span><br><span class="line"><span class="comment"># 22行</span></span><br><span class="line">unqualified-search-registries = [<span class="string">&quot;utility.lab.example.com&quot;</span>]</span><br><span class="line"><span class="comment"># 24行</span></span><br><span class="line">[[registry]]</span><br><span class="line"><span class="comment"># 37行</span></span><br><span class="line">insecure = <span class="literal">true</span></span><br><span class="line"><span class="comment"># 40行</span></span><br><span class="line">blocked = <span class="literal">false</span></span><br><span class="line"><span class="comment"># 56行</span></span><br><span class="line">location = <span class="string">&quot;utility.lab.example.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#登录容器镜像服务器，为下载自动化执行环境容器镜像做准备</span></span><br><span class="line">[student@workstation ~]$ podman --version</span><br><span class="line">podman version 4.0.2</span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ ping utility</span><br><span class="line">PING utility.lab.example.com (172.25.250.220) 56(84) bytes of data.</span><br><span class="line">64 bytes from utility.lab.example.com (172.25.250.220): icmp_seq=1 ttl=64 <span class="keyword">time</span>=0.496 ms</span><br><span class="line">64 bytes from utility.lab.example.com (172.25.250.220): icmp_seq=2 ttl=64 <span class="keyword">time</span>=0.456 ms</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ podman login -u admin -p redhat utility.lab.example.com</span><br><span class="line">Login Succeeded!</span><br><span class="line"></span><br><span class="line"><span class="comment">#下载自动化内容导航器或使用ansible-navigator命令自动下载</span></span><br><span class="line">[student@workstation ~]$ ansible-navigator collections    <span class="comment">#如果发现镜像服务器登录失败，可重置一下utility服务器</span></span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ ansible-navigator images   <span class="comment">#查看下载的镜像环境</span></span><br><span class="line">esc退出</span><br></pre></td></tr></table></figure>

<h1 id="2-部署Ansible"><a href="#2-部署Ansible" class="headerlink" title="2 部署Ansible"></a>2 部署Ansible</h1><h2 id="2-1-构建Ansible清单"><a href="#2-1-构建Ansible清单" class="headerlink" title="2.1 构建Ansible清单"></a>2.1 构建Ansible清单</h2><h3 id="系统默认的清单文件"><a href="#系统默认的清单文件" class="headerlink" title="系统默认的清单文件"></a>系统默认的清单文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清单定义Ansible管理的主机集合。这些主机也可以分配到组中，以进行集中管理。组可以包含子组，主机也可以是多个组的成员</span></span><br><span class="line"><span class="comment"># 清单还可以设置应用到它所定义的主机和组的变量</span></span><br><span class="line"><span class="comment"># 定义主机清单可采用两种方式:</span></span><br><span class="line">  1.使用文本文件定义静态主机清单</span><br><span class="line">  2.通过外部信息提供程序，使用Ansible插件按需生成动态主机清单</span><br><span class="line"><span class="comment"># 系统默认清单在/etc/ansibile/hosts</span></span><br><span class="line"><span class="comment"># 举例1:</span></span><br><span class="line">[<span class="built_in">test</span>]    <span class="comment">#组名</span></span><br><span class="line">172.25.250.10</span><br><span class="line">servera</span><br><span class="line">servera.lab.exaple.com</span><br><span class="line"></span><br><span class="line">[web]</span><br><span class="line">servera.example.com</span><br><span class="line">serverb.example.com</span><br><span class="line"></span><br><span class="line">[webservers]</span><br><span class="line">web[1:50].example.com   <span class="comment">#表示从web1到web50，共计50台主机</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 举例2:</span></span><br><span class="line"><span class="comment"># [嵌套组名:children]，嵌套组内只能包含组，不包含主机</span></span><br><span class="line">[<span class="built_in">test</span>]</span><br><span class="line">172.25.250.10</span><br><span class="line">servera</span><br><span class="line">servera.lab.exaple.com</span><br><span class="line"></span><br><span class="line">[web]</span><br><span class="line">servera.example.com</span><br><span class="line">serverb.example.com</span><br><span class="line"></span><br><span class="line">[servers:children]  <span class="comment">#表示servers组是一个超级组，包含test和web两个组(嵌套)</span></span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定清单范围格式：通配符或正则表达式的方法</span></span><br><span class="line">[START:END]  			   <span class="comment">#开始:结束范围</span></span><br><span class="line">192.168.[0:15].[0:255]      <span class="comment">#表示   192.168.0.0-192.168.15.255</span></span><br><span class="line">server[a:c].example.com     <span class="comment">#表示   a-c</span></span><br><span class="line">server[01:15].example.com   <span class="comment">#表示   server01.example.com-server15.example.com</span></span><br><span class="line">all： 					 <span class="comment">#表示   所有主机</span></span><br><span class="line">ungrouped: 		           <span class="comment">#表示   指定组/未分配组的主机</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ~]$ rpm -q ansible-core</span><br><span class="line">ansible-core-2.13.0-2.el9ap.x86_64</span><br><span class="line">[student@workstation ~]$ rpm -qc ansible-core</span><br><span class="line">/etc/ansible/ansible.cfg     <span class="comment">#默认全局配置文件</span></span><br><span class="line">/etc/ansible/hosts           <span class="comment">#默认全局清单文件</span></span><br></pre></td></tr></table></figure>

<h3 id="自定义清单文件"><a href="#自定义清单文件" class="headerlink" title="自定义清单文件"></a>自定义清单文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当使用特权用户管理Ansible时，可以在家目录中为其创建工作目录，目录名称可以根据业务自定义名称,今后的所有文件都放到此目录，包括配置文件、清单文件、playbook等</span></span><br><span class="line">1.创建工作目录</span><br><span class="line">[student@workstation ~]$ <span class="built_in">mkdir</span> ~/ansible</span><br><span class="line">[student@workstation ~]$ <span class="built_in">cd</span> ~/ansible/</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看清单实例文件</span></span><br><span class="line">[student@workstation ansible]$ ansible-doc -t inventory -l</span><br><span class="line">[student@workstation ansible]$ ansible-doc -t inventory ini</span><br><span class="line">[student@workstation ~]$ ansible-navigator doc -t inventory ini</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2.编辑清自定义单文件+嵌套组</span><br><span class="line">[student@workstation ansible]$ vim inventory</span><br><span class="line">servera                    <span class="comment">#未在组内的主机</span></span><br><span class="line"></span><br><span class="line">[web]                      <span class="comment">#主机组，主机组名称需要使用中括号括起来[]，web是组名称</span></span><br><span class="line">server[b:c]                <span class="comment">#主机组成员，web组内的主机 表示两个主机serverb至serverc</span></span><br><span class="line">172.25.250:[10:15]</span><br><span class="line"></span><br><span class="line">[db]</span><br><span class="line">server[d:z].lab.example.com</span><br><span class="line"></span><br><span class="line">[servers:children]  <span class="comment">#嵌套组名servers是自定义的，但是:children是固定语法，表示web、db在servers组中，嵌套组成员应为组，不应为主机</span></span><br><span class="line">web</span><br><span class="line">db</span><br><span class="line"><span class="comment">#注意：不要在清单里书写无用的符号，及一些特殊符号。主机名称不要和主机组冲突，组名尽量不要用数字开头。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">3.验证清单：</span><br><span class="line">  <span class="comment">#使用ansible-navigator或ansible-inventory命令验证计算机是否存在于清单中</span></span><br><span class="line">  1.ansible-navigator inventory以stdout模式运行</span><br><span class="line">  2.第一条传统Ansible的验证方式，第二条使用Ansible自动化平台2的方式</span><br><span class="line">-RHEL8 &amp; 9</span><br><span class="line">-i inventory  <span class="comment">#指定清单文件的位置</span></span><br><span class="line">--list-hosts  <span class="comment">#列出清单中的主机  </span></span><br><span class="line">--graph       <span class="comment">#通过ansible-inventory命令列出清单整个pattern</span></span><br><span class="line">$ ansible all -i inventory --list-hosts</span><br><span class="line">*$ ansible-inventory --graph -i inventory  <span class="comment">#推荐，RHEL9考试可用</span></span><br><span class="line">[student@workstation ansible]$ ansible-inventory --graph -i /home/student/ansible/inventory</span><br><span class="line"></span><br><span class="line">-RHEL 9</span><br><span class="line">$ ansible-navigator inventory -i inventory  -m stdout --list</span><br><span class="line">$ ansible-navigator inventory -i inventory  -m stdout --graph</span><br><span class="line">$ ansible-navigator inventory -i inventory  -m stdout --graph webservers</span><br><span class="line"></span><br><span class="line">重要：清单中含有名称相同的主机和主机组，ansible命令显示警告并以主机作为其目标，组被忽略</span><br></pre></td></tr></table></figure>

<h3 id="覆盖清单位置"><a href="#覆盖清单位置" class="headerlink" title="覆盖清单位置"></a>覆盖清单位置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装ansible软件后，在/etc/ansible/hosts位置提供一个默认主机清单，属于全局管理范围</span></span><br><span class="line"><span class="comment">#特权用户管理时可以为其在工作目录中创建清单，在工作目录中使用ansible时，且优先度最高</span></span><br><span class="line">/home/student/ansible/inventory 优   <span class="comment">#用于针对某个用户设置清单(考试使用)</span></span><br><span class="line">/etc/ansible/hosts 劣    		    <span class="comment">#用于全局设置</span></span><br><span class="line">[student@workstation /]$ ansible-inventory --graph</span><br><span class="line">@all:</span><br><span class="line">  |--@ungrouped:</span><br><span class="line">[student@workstation /]$ <span class="built_in">pwd</span></span><br><span class="line">/</span><br><span class="line">[student@workstation ansible]$ ansible-inventory --graph</span><br><span class="line">@all:</span><br><span class="line">  |--@ungrouped:</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br></pre></td></tr></table></figure>

<h3 id="多清单"><a href="#多清单" class="headerlink" title="多清单"></a>多清单</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#一个用户可以有一个或多个清单文件，若同时使用，可将多个清单文件放置清单目录中，清单目录需自行创建，名称自定义</span></span><br><span class="line">[student@workstation ansible]$ vim inventory</span><br><span class="line">servera</span><br><span class="line"></span><br><span class="line">[web]</span><br><span class="line">serverb</span><br><span class="line">serverc</span><br><span class="line"></span><br><span class="line">[db]</span><br><span class="line">serverd</span><br><span class="line"></span><br><span class="line">[servers:children]</span><br><span class="line">web</span><br><span class="line">db</span><br><span class="line">[student@workstation ansible]$ ansible-inventory --graph -i inventory</span><br><span class="line">@all:</span><br><span class="line">  |--@servers:</span><br><span class="line">  |  |--@db:</span><br><span class="line">  |  |  |--serverd</span><br><span class="line">  |  |--@web:</span><br><span class="line">  |  |  |--serverb</span><br><span class="line">  |  |  |--serverc</span><br><span class="line">  |--@ungrouped:</span><br><span class="line">  |  |--servera</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">cp</span> inventory inventory2     <span class="comment">#额外创建一份清单名为inventory2</span></span><br><span class="line"><span class="comment"># [student@workstation ansible]$ echo servere &gt; inventory2   #inventory2内指定一个主机servere</span></span><br><span class="line">[student@workstation ansible]$ vim inventory2                <span class="comment">#inventory2内指定一个主机servere</span></span><br><span class="line">servere</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">mkdir</span> invdir                   <span class="comment">#创建清单存储目录，名称自定义</span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">mv</span> inv* invdir/                <span class="comment">#将所有清单移动至清单存储目录</span></span><br><span class="line"><span class="built_in">mv</span>: cannot move <span class="string">&#x27;invdir&#x27;</span> to a subdirectory of itself, <span class="string">&#x27;invdir/invdir&#x27;</span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">ls</span> invdir/</span><br><span class="line">inventory  inventory2</span><br><span class="line">[student@workstation ansible]$ ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x. 2 student student 41 Mar  8 00:05 invdir</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ tree</span><br><span class="line">.</span><br><span class="line">└── invdir</span><br><span class="line">    ├── inventory</span><br><span class="line">    └── inventory2</span><br><span class="line"></span><br><span class="line">1 directory, 2 files</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-inventory --graph -i invdir/  <span class="comment">#查看主机模式结构</span></span><br><span class="line">@all:</span><br><span class="line">  |--@servers:</span><br><span class="line">  |  |--@db:</span><br><span class="line">  |  |  |--serverd</span><br><span class="line">  |  |--@web:</span><br><span class="line">  |  |  |--serverb</span><br><span class="line">  |  |  |--serverc</span><br><span class="line">  |--@ungrouped:</span><br><span class="line">  |  |--servera</span><br><span class="line">  |  |--servere</span><br></pre></td></tr></table></figure>

<h2 id="2-2-管理Ansible配置文件"><a href="#2-2-管理Ansible配置文件" class="headerlink" title="2.2 管理Ansible配置文件"></a>2.2 管理Ansible配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 还原清单文件</span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">mv</span> invdir/inventory .</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">ls</span></span><br><span class="line">invdir  inventory</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">rm</span> -rf inv</span><br><span class="line">invdir/    inventory</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">rm</span> -rf invdir/</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">ls</span></span><br><span class="line">inventory</span><br><span class="line">[student@workstation ansible]$ ansible-inventory --graph -i inventory</span><br><span class="line">@all:</span><br><span class="line">  |--@servers:</span><br><span class="line">  |  |--@db:</span><br><span class="line">  |  |  |--serverd</span><br><span class="line">  |  |--@web:</span><br><span class="line">  |  |  |--serverb</span><br><span class="line">  |  |  |--serverc</span><br><span class="line">  |--@ungrouped:</span><br><span class="line">  |  |--servera</span><br></pre></td></tr></table></figure>

<h3 id="配置Ansible"><a href="#配置Ansible" class="headerlink" title="配置Ansible"></a>配置Ansible</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ansible的配置文件作用是指导ansible工具的功能设置</span></span><br><span class="line"><span class="comment"># 安装Ansible软件后，自动生成配置文件</span></span><br><span class="line">   /etc/ansible/ansible.cfg  用于配置多个Ansible工具的行为</span><br><span class="line">   ~/.ansible-navigator.yml  用于更改ansible-navigator命令默认选项</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ rpm -qc ansible-core</span><br><span class="line">/etc/ansible/ansible.cfg</span><br><span class="line">/etc/ansible/hosts</span><br><span class="line">[student@workstation ~]$ <span class="built_in">ls</span> -a</span><br><span class="line">.         ansible                 .bash_history  .bashrc  Desktop    .grading  .lesshst  .npm      .ssh       Videos</span><br><span class="line">..        ansible-navigator.log   .bash_logout   .cache   Documents  .ipython  .<span class="built_in">local</span>    Pictures  Templates  .viminfo</span><br><span class="line">.ansible  .ansible-navigator.yml  .bash_profile  .config  Downloads  .jupyter  Music     Public    .venv</span><br><span class="line">[student@workstation ~]$ <span class="built_in">ls</span> -a ~/.ansible-navigator.yml</span><br><span class="line">/home/student/.ansible-navigator.yml</span><br></pre></td></tr></table></figure>

<h3 id="管理Ansible设置"><a href="#管理Ansible设置" class="headerlink" title="管理Ansible设置"></a>管理Ansible设置</h3><table>
<thead>
<tr>
<th>指令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>inventory</td>
<td>指定清单文件的路径。</td>
</tr>
<tr>
<td>remote_user</td>
<td>指定Ansible用于连接受管主机的用户名。如果未指定，则使用当前用户的名称。(在由ansible-navigator 运行的基于容器的自动化执行环境中，始终为 root。)</td>
</tr>
<tr>
<td>ask_pass</td>
<td>指示是否提示输入SSH 密码。 (可以是 false，如果使用SSH公钥身份验证，则此为默认值。)</td>
</tr>
<tr>
<td>become</td>
<td>指定连接后是否在受管主机上自动切换用户(一般切换为root)。这也可以通过play来指定</td>
</tr>
<tr>
<td>become_method</td>
<td>指定如何切换用户(通常为 sudo，此为默认值，但也可选择su)</td>
</tr>
<tr>
<td>become_user</td>
<td>指定要在受管主机上切换到哪个用户(通常为 root，此为默认值)</td>
</tr>
<tr>
<td>become_ask_pass</td>
<td>指示是否提示输入become_method参数密码。默认为false</td>
</tr>
</tbody></table>
<h3 id="自定义配置文件"><a href="#自定义配置文件" class="headerlink" title="自定义配置文件"></a>自定义配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">1.普通用户身份远程 <span class="comment">#重点掌握，考点</span></span><br><span class="line">  <span class="comment"># 在工作目录中生成ansible的配置文件</span></span><br><span class="line">[student@workstation ~]$ <span class="built_in">cat</span> /etc/ansible/ansible.cfg | grep ansible.cfg</span><br><span class="line"><span class="comment">#               $ ansible-config init --disabled &gt; ansible.cfg</span></span><br><span class="line"><span class="comment"># ansible-config init --disabled -t all &gt; ansible.cfg</span></span><br><span class="line"><span class="comment"># for example, for 2.9: https://github.com/ansible/ansible/blob/stable-2.9/examples/ansible.cfg</span></span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ ansible-config init --disabled &gt; /home/student/ansible/ansible.cfg</span><br><span class="line">[student@workstation ~]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student</span><br><span class="line">[student@workstation ~]$ <span class="built_in">cd</span> /home/student/ansible/</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">ls</span></span><br><span class="line">ansible.cfg  inventory</span><br><span class="line"> </span><br><span class="line">[student@workstation ansible]$ ansible --version</span><br><span class="line">ansible [core 2.13.0]</span><br><span class="line">  config file = /home/student/ansible/ansible.cfg</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">cd</span> /</span><br><span class="line">[student@workstation /]$ ansible --version</span><br><span class="line">ansible [core 2.13.0]</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  </span><br><span class="line">[student@workstation /]$ <span class="built_in">cp</span> /home/student/ansible/ansible.cfg ~/.ansible.cfg</span><br><span class="line">[student@workstation /]$ ansible --version</span><br><span class="line">ansible [core 2.13.0]</span><br><span class="line">  config file = /home/student/.ansible.cfg</span><br><span class="line">  </span><br><span class="line"><span class="comment"># Ansible的配置文件/etc/ansible/ansible.cfg，由几个部分组成，每一部分含有以键值对形式定义的设置。部分的标题以方括号括起。对于基本操作，请使用以下两部分:</span></span><br><span class="line">1.[defaults]---用于设置Ansible操作的默认值</span><br><span class="line">2.[privilege_escalation]---用于配置Ansible如何在受管主机上执行特权升级</span><br><span class="line">    </span><br><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br><span class="line">[student@workstation ansible]$ vim ansible.cfg</span><br><span class="line">[defaults]</span><br><span class="line">inventory=/home/student/ansible/inventory    <span class="comment">#139行  工作目录清单位置</span></span><br><span class="line">remote_user=student						   <span class="comment">#222行  远程用户可选root或普通用户 </span></span><br><span class="line">host_key_checking=<span class="literal">false</span>					   <span class="comment">#318行  不进行公钥记录</span></span><br><span class="line"></span><br><span class="line">[privilege_escalation]    					<span class="comment">#搜/become，n向下查找 或 输入:430</span></span><br><span class="line">become=<span class="literal">true</span>								   <span class="comment">#430行  开启特权功能，</span></span><br><span class="line"><span class="comment">#become_ask_pass=False						#433行  远程免特权密码，需要对端添加sudo免密	</span></span><br><span class="line"><span class="comment">#become_method=sudo							#442行  远程功能启用sudo</span></span><br><span class="line"><span class="comment">#become_user=root							#445行  特权用户为root</span></span><br><span class="line"></span><br><span class="line">备注:剪切操作 <span class="built_in">dd</span>+p</span><br><span class="line"><span class="comment"># 验证配置文件是否书写正确</span></span><br><span class="line">[student@workstation ansible]$ ansible-inventory --graph   <span class="comment"># 取消对清单的指定</span></span><br><span class="line">@all:</span><br><span class="line">  |--@servers:</span><br><span class="line">  |  |--@db:</span><br><span class="line">  |  |  |--serverd</span><br><span class="line">  |  |--@web:</span><br><span class="line">  |  |  |--serverb</span><br><span class="line">  |  |  |--serverc</span><br><span class="line">  |--@ungrouped:</span><br><span class="line">  |  |--servera</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">[student@workstation ansible]$ ansible -m ping all</span><br><span class="line">servera | FAILED! =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Missing sudo password&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">serverd | FAILED! =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Missing sudo password&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">serverc | FAILED! =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Missing sudo password&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">serverb | FAILED! =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Missing sudo password&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#练习环境默认student远程免密，所以不用做。</span></span><br><span class="line"><span class="comment">#但是student未做sudo免密，以下命令为servera~d设置sudo免密。</span></span><br><span class="line">[workstation]</span><br><span class="line">[student@workstation ansible]$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;a..d&#125;;<span class="keyword">do</span> ssh root@server<span class="variable">$i</span> <span class="string">&#x27;sed -i s/^%wheel.*$/&quot;%wheel  ALL=(ALL) NOPASSWD: ALL&quot;/ /etc/sudoers&#x27;</span>;<span class="keyword">done</span></span><br><span class="line">[student@workstation ansible]$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;a..d&#125;;<span class="keyword">do</span> ssh root@server<span class="variable">$i</span> <span class="string">&#x27;grep ^%wheel /etc/sudoers&#x27;</span>;<span class="keyword">done</span></span><br><span class="line">%wheel  ALL=(ALL) NOPASSWD: ALL</span><br><span class="line">%wheel  ALL=(ALL) NOPASSWD: ALL</span><br><span class="line">%wheel  ALL=(ALL) NOPASSWD: ALL</span><br><span class="line">%wheel  ALL=(ALL) NOPASSWD: ALL</span><br><span class="line"><span class="comment"># 测试远程部署</span></span><br><span class="line">[student@workstation ansible]$ ansible all -m ping</span><br><span class="line">serverd | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">serverc | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">servera | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">serverb | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2.# ansible配置文件可以存在于不同位置其中包括：</span><br><span class="line">$ /etc/ansible/ansible.cfg          <span class="comment">#默认路径</span></span><br><span class="line">$ ~/.ansible.cfg  		            <span class="comment">#家目录</span></span><br><span class="line">$ ~/ansible/ansible.cfg              <span class="comment">#ansible为工作目录(练习和考试时使用)</span></span><br><span class="line">$ grep  ANSIBLE_CONFIG /etc/profile <span class="comment">#环境变量</span></span><br><span class="line"><span class="built_in">export</span>  ANSIBLE_CONFIG=/opt/ansible.cfg   （此时/opt下需要有ansible.cfg配置文件）</span><br><span class="line"><span class="built_in">source</span> /etc/profile   加载</span><br><span class="line"></span><br><span class="line">优先级 ：变量＞当前目录＞用户家目录＞/etc</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">3.# 其他指定远程用户及密码的方法，以root用户身份远程</span><br><span class="line">方法一：</span><br><span class="line">ansible.cfg</span><br><span class="line">remote_user=root</span><br><span class="line">inventory</span><br><span class="line">[all:vars]</span><br><span class="line">ansible_password=redhat</span><br><span class="line"></span><br><span class="line">方法二：</span><br><span class="line">inventory</span><br><span class="line">[all:vars]</span><br><span class="line">ansible_user=root</span><br><span class="line">ansible_password=redhat</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">4.# 练习</span><br><span class="line">根据以上笔记将清单路径记录至inventory=后，要求远程用户为普通用户，并查看清单主机模式结构。</span><br><span class="line">1.创建工作目录，创建并完善清单</span><br><span class="line">2.在工作目录中制作配置文件，并完善</span><br><span class="line">3.保证远程和<span class="built_in">sudo</span>都免密</span><br><span class="line"><span class="comment">#练习环境默认student远程免密，所以不用做。</span></span><br><span class="line"><span class="comment">#但是student未做sudo免密，以下命令为servera~d设置sudo免密。</span></span><br><span class="line">[workstation]</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;a..d&#125;;<span class="keyword">do</span> ssh root@server<span class="variable">$i</span> <span class="string">&#x27;sed -i s/^%wheel.*$/&quot;%wheel  ALL=(ALL) NOPASSWD: ALL&quot;/ /etc/sudoers&#x27;</span>;<span class="keyword">done</span></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;a..d&#125;;<span class="keyword">do</span> ssh root@server<span class="variable">$i</span> <span class="string">&#x27;grep ^%wheel /etc/sudoers&#x27;</span>;<span class="keyword">done</span></span><br><span class="line">4.测试远程部署</span><br><span class="line">$ ansible all -m ping</span><br><span class="line">servera | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/libexec/platform-python&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="管理自动化内容导航器的设置"><a href="#管理自动化内容导航器的设置" class="headerlink" title="管理自动化内容导航器的设置"></a>管理自动化内容导航器的设置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">#可以为ansible-navigator创建配置文件(或设置文件)，以覆盖其配置设置的默认值</span></span><br><span class="line">   <span class="comment">#配置文件可以采用JSON(json)或YAML(yml或yam)格式。本项讨论主要采用YAML格式</span></span><br><span class="line">   <span class="comment">#自动化内容导航器按以下顺序查找配置文件，并使用它找到的第一个文件:</span></span><br><span class="line">    1.如果设置了ANSIBLE NAVIGATOR_CONFIG环境变量，则使用所指定位置处的配置文件</span><br><span class="line">    2.当前Ansible项目目录中的ansible-navigator.yml文件</span><br><span class="line">    3.~/.ansible-navigator.yml文件(主目录中)。请注意，其文件名开头有一个“点”</span><br><span class="line">   <span class="comment">#与Ansible配置文件一样，每个项目都可以有自己的自动化内容导航器设置文件。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建导航器配置文件</span></span><br><span class="line">[student@workstation ~]$ rpm -ql ansible-navigator | grep temp</span><br><span class="line">/usr/lib/python3.9/site-packages/ansible_navigator/actions/__pycache__/template.cpython-39.opt-1.pyc</span><br><span class="line">/usr/lib/python3.9/site-packages/ansible_navigator/actions/__pycache__/template.cpython-39.pyc</span><br><span class="line">/usr/lib/python3.9/site-packages/ansible_navigator/actions/template.py</span><br><span class="line">/usr/lib/python3.9/site-packages/ansible_navigator/package_data/settings-sample.template.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ~]$ vim /usr/lib/python3.9/site-packages/ansible_navigator/package_data/settings-sample.template.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ~]$ vim ~/.ansible-navigator.yml</span><br><span class="line">---</span><br><span class="line">ansible-navigator:</span><br><span class="line">  execution-environment:</span><br><span class="line">    image: utility.lab.example.com/ee-supported-rhel8:latest</span><br><span class="line">    pull:</span><br><span class="line">      policy: missing    <span class="comment"># 容器镜像下载策略 missing系统里有就不下载，否则下载</span></span><br><span class="line"></span><br><span class="line">$ vim ~/.ansible-navigator.yml </span><br><span class="line">  ---</span><br><span class="line">ansible-navigator:</span><br><span class="line">  execution-environment:</span><br><span class="line">    image: utility.lab.example.com/ee-supported-rhel8:latest</span><br><span class="line">    pull:</span><br><span class="line">      arguments:</span><br><span class="line">      - <span class="string">&quot;--tls-verify=false&quot;</span></span><br><span class="line">      policy: missing</span><br><span class="line">  playbook-artifact:</span><br><span class="line">    <span class="built_in">enable</span>: <span class="literal">false</span>   <span class="comment">#关闭运行playbook时生成日志 执行剧本所产生的日志，执行一次记录一次</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#anisble远程连接时的必要条件</span></span><br><span class="line">1.配置链接：</span><br><span class="line">如何选择远程的用户</span><br><span class="line">2.清单位置：</span><br><span class="line">相对路径、绝对路径、多清单等。</span><br><span class="line">3.链接设置</span><br><span class="line">remote_user= ，~/.ansible-navigator.yml中playbook-artifact：</span><br><span class="line">4.ssh免密</span><br><span class="line">ssh-key-gen，ssh-copy-id</span><br><span class="line">5.升级特权</span><br><span class="line">visudo，/etc/sudoers</span><br></pre></td></tr></table></figure>

<h2 id="2-3-编写和运行Playbook"><a href="#2-3-编写和运行Playbook" class="headerlink" title="2.3  编写和运行Playbook"></a>2.3  编写和运行Playbook</h2><p>​         Play是针对清单中选定的主机运行的一组有序任务</p>
<p>​         Playbook是一个文本文件，其中包含由一个或多个按特定顺序运行的play组成的列表</p>
<p>​         临时命令可以作为一次性命令对一组目标主机运行一项简单的任务</p>
<p>​         Playbook可以通过轻松重复的方式对一组目标主机执行多项复杂的任务</p>
<p><img src="/%E7%BA%A2%E5%B8%BD-Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4.assets/Playbook.png"></p>
<h3 id="Playbook-yaml语法"><a href="#Playbook-yaml语法" class="headerlink" title="Playbook-yaml语法"></a>Playbook-yaml语法</h3><p> 1.playbook是使用YAML语法编写的文本文件，格式为.yml</p>
<p> 2.严格缩进，空格<br> 3.YAML文件以—开头，…. 结束，可以省略</p>
<p> 4.使用”-“(减号加一个或多个空格)作为列表项</p>
<p> 5.#注释</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-doc -l | grep yum</span><br><span class="line">$ ansible-doc yum  						<span class="comment">#进入之后，搜索/EXAMPLE</span></span><br><span class="line">$ vim ~/ansible/web.yml</span><br><span class="line">---									   <span class="comment">#yaml语法，---开头</span></span><br><span class="line">- name: install httpd					<span class="comment">#play任务的描述：描述部分name字段是可选的选项</span></span><br><span class="line">  hosts: servera					    <span class="comment">#主机模式：任务目标主机</span></span><br><span class="line">  tasks:							   <span class="comment">#任务列表：下面通常为任务模块，有两格缩进</span></span><br><span class="line">  - name: Install Apache				<span class="comment">#任务模块：注意和tasks有两格缩进，name是可选字段，模块描述</span></span><br><span class="line">    ansible.builtin.yum:				<span class="comment">#模块名称：</span></span><br><span class="line">      name: httpd					    <span class="comment">#模块选项1</span></span><br><span class="line">      state: latest						<span class="comment">#模块选项2</span></span><br></pre></td></tr></table></figure>

<p>练习：写一个在servera上部署整套httpd服务的剧本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ~]$ <span class="built_in">cd</span> ansible</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br><span class="line">[student@workstation ansible]$ vim inventory</span><br><span class="line">[dev]</span><br><span class="line">servera</span><br><span class="line">serverb</span><br><span class="line"></span><br><span class="line">[<span class="built_in">test</span>]</span><br><span class="line">serverc</span><br><span class="line">serverd</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-inventory --graph</span><br><span class="line">@all:</span><br><span class="line">  |--@dev:</span><br><span class="line">  |  |--servera</span><br><span class="line">  |  |--serverb</span><br><span class="line">  |--@<span class="built_in">test</span>:</span><br><span class="line">  |  |--serverc</span><br><span class="line">  |  |--serverd</span><br><span class="line">  |--@ungrouped:</span><br><span class="line">[student@workstation ansible]$ vim soft.yml</span><br><span class="line">---</span><br><span class="line">- name: install web server</span><br><span class="line">  hosts: servera</span><br><span class="line">  tasks:</span><br><span class="line">  <span class="comment">#写模块时格式可以参考帮助ansible-doc -l | grep yum发现yum模块后，ansible-doc yum查看帮互助，/EX  找到例子复制到剧本中，再进行修改</span></span><br><span class="line">  - name: Install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: latest</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">cd</span> /home/student/ansible</span><br><span class="line">[student@workstation ansible]$ ansible-navigator run web.yml --syntax-check -m stdout   <span class="comment">#执行前进行语法检查</span></span><br><span class="line">playbook: /home/student/ansible/web.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run soft.yml -m stdout</span><br></pre></td></tr></table></figure>

<h3 id="关闭运行playbook时生成的日志"><a href="#关闭运行playbook时生成的日志" class="headerlink" title="关闭运行playbook时生成的日志"></a>关闭运行playbook时生成的日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ vim ~/.ansible-navigator.yml</span><br><span class="line">---</span><br><span class="line">ansible-navigator:</span><br><span class="line">  execution-environment:</span><br><span class="line">    image: utility.lab.example.com/ee-supported-rhel8:latest</span><br><span class="line">    pull:</span><br><span class="line">      policy: missing</span><br><span class="line">  playbook-artifact:</span><br><span class="line">    <span class="built_in">enable</span>: <span class="literal">false</span>  <span class="comment">#关闭playbook时生成的日志</span></span><br></pre></td></tr></table></figure>

<h3 id="调整tab键缩进"><a href="#调整tab键缩进" class="headerlink" title="调整tab键缩进"></a>调整tab键缩进</h3><p><img src="/RHEL-294%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0-new.assets/%E5%89%A7%E6%9C%AC%E7%BC%A9%E8%BF%9B%E7%9A%84%E4%BD%BF%E7%94%A8.png"></p>
<p>   1.为了方便后期编写剧本，建议调节缩进(可选)</p>
<p>   2.整体缩进–方便对齐yaml语法文本缩进(必选)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.vimrc</span><br><span class="line"><span class="built_in">set</span> tabstop=2   <span class="comment">#将vim的tab键缩进调至两格</span></span><br><span class="line"><span class="built_in">set</span> nu			<span class="comment">#设置行号</span></span><br><span class="line"><span class="built_in">set</span> autoindent  <span class="comment">#回车时调整至上一行文本缩进  </span></span><br><span class="line"><span class="built_in">set</span> cursorcolumn <span class="comment">#设置竖坐标线 简写set cuc</span></span><br><span class="line"><span class="built_in">set</span> cursorline   <span class="comment">#设置横坐标线 简写set cul</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">:<span class="built_in">set</span> all        <span class="comment">#末行模式下set all 查看所有环境设置帮助</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#整体缩进 视图模式</span></span><br><span class="line">ctrl+v ， jjj(+G) ，I，(空格、空格)，esc</span><br><span class="line"></span><br><span class="line">分解：</span><br><span class="line">1.光标放在需要调节的行上</span><br><span class="line">2.按ctrl+v，用方向键或G选定需要调节的列</span><br><span class="line">3.输入I进入插入模式</span><br><span class="line">4.空格空格，调节需要的缩进</span><br><span class="line">5.按esc同步所有列</span><br></pre></td></tr></table></figure>

<h3 id="查找用于任务的模块"><a href="#查找用于任务的模块" class="headerlink" title="查找用于任务的模块"></a>查找用于任务的模块</h3><p>用Ansible进行部署任务时，可针对管理员任务需求，选择对应功能模块，通过以下方法可以查询模块帮助，以便编写临时命令及playbook</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">-RHEL&lt;=8</span><br><span class="line">[student@workstation ansible]$ ansible-doc -l</span><br><span class="line">[student@workstation ansible]$ ansible-doc -l | grep yum</span><br><span class="line">yum                                            Manages packages with the `y...</span><br><span class="line">yum_repository                                 Add or remove YUM repositori...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看某个模块的帮助</span></span><br><span class="line">[student@workstation ansible]$ ansible-doc yum</span><br><span class="line"></span><br><span class="line">-RHEL=9</span><br><span class="line">$ ansible-navigator collections</span><br><span class="line">$ ansible-navigator doc ansible.posix.firewalld</span><br><span class="line">$ ansible-navigator doc ansible.posix.firewalld -m stdout</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator collections -m stdout | grep firewalld</span><br><span class="line">- full_name: ansible.posix.firewalld</span><br><span class="line">      path: /usr/share/ansible/collections/ansible_collections/ansible/posix/plugins/modules/firewalld.py</span><br><span class="line">      short_description: Manage arbitrary ports/services with firewalld</span><br><span class="line">    - full_name: ansible.posix.firewalld_info</span><br><span class="line">      path: /usr/share/ansible/collections/ansible_collections/ansible/posix/plugins/modules/firewalld_info.py</span><br><span class="line">      short_description: Gather information about firewalld</span><br><span class="line">[student@workstation ansible]$ ansible-navigator doc ansible.posix.firewalld -m stdout</span><br><span class="line"></span><br><span class="line"><span class="comment">#两个考试都可用，推荐优先用RHEL8版本的，用法方便。</span></span><br><span class="line"><span class="comment">#找不到模块时就需要用RHEL9版本的，怕麻烦可以选择统一都用RHEL9版本的方法，省事</span></span><br></pre></td></tr></table></figure>

<h3 id="运行Playbook"><a href="#运行Playbook" class="headerlink" title="运行Playbook"></a>运行Playbook</h3><p>运行前建议使用语法检查验证语法错误:ansible-navigator run web.yml –syntax-check file.yml</p>
<p>或执行空运行ansible-navigator run web.yml -C</p>
<p>通常直接运行ansible-navigator run web.yml进入交互模式，或添加-m stdout可将任务打印到标准输出</p>
<p><img src="/RHEL-294%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0-new.assets/%E8%BF%90%E8%A1%8CPlaybook.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#上节实验做了多清单实验，恢复为最初配置</span></span><br><span class="line">$ <span class="built_in">cd</span>  ~/ansible</span><br><span class="line">$ <span class="built_in">mv</span> invdir/inventory .     </span><br><span class="line">$ <span class="built_in">rm</span> -rf invdir</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#运行playbook</span></span><br><span class="line">$ ansible-navigator run web.yml    <span class="comment"># 交互式</span></span><br><span class="line">$ ansible-navigator run web.yml -m stdout  <span class="comment"># 非交互式</span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">ls</span></span><br><span class="line">ansible.cfg  ansible-navigator.log  inventory  soft.yml</span><br><span class="line">[student@workstation ansible]$ ansible-navigator run soft.yml -m stdout</span><br></pre></td></tr></table></figure>

<h2 id="2-4-实施多个Play"><a href="#2-4-实施多个Play" class="headerlink" title="2.4 实施多个Play"></a>2.4 实施多个Play</h2><p>​         Playbook是一个YAML文件，含有由一个或多个play组成的列表</p>
<p>​         如果一个playbook中含有多个 play，每个play可以将其任务应用到单独的一组主机</p>
<p>​         在编排可能涉及对不同主机执行不同任务的复杂部署时，这会大有帮助</p>
<p>​         可以这样编写playbook：对一组主机运行一个play，完成后再对另一组主机运行另一个play</p>
<p>​         编写包含多个play的playbook非常简单</p>
<p>​         Playbook中的各个play编写为playbook中的顶级列表项</p>
<h3 id="编写多个Play"><a href="#编写多个Play" class="headerlink" title="编写多个Play"></a>编写多个Play</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ vim install_yum.yml</span><br><span class="line">---</span><br><span class="line">- name: install yum repo</span><br><span class="line">  hosts: servera,serverb</span><br><span class="line">  tasks:</span><br><span class="line">  - name: BaseOS_REPO</span><br><span class="line">    ansible.builtin.yum_repository:</span><br><span class="line">      name: Red Hat Enterprise Linux 9 <span class="keyword">for</span> x86_64 - BaseOS (RPMs)</span><br><span class="line">      description: BaseOS</span><br><span class="line">      file: rhel_BaseOS</span><br><span class="line">      baseurl: http://content.example.com/rhel9.0/x86_64/dvd/BaseOS</span><br><span class="line">      gpgcheck: no</span><br><span class="line"></span><br><span class="line">  - name: AppStream_REPO</span><br><span class="line">    ansible.builtin.yum_repository:</span><br><span class="line">      name: Red Hat Enterprise Linux 9 <span class="keyword">for</span> x86_64 - AppStream (RPMs)</span><br><span class="line">      description: AppStream</span><br><span class="line">      file: rhel_AppStream</span><br><span class="line">      baseurl: http://content.example.com/rhel9.0/x86_64/dvd/AppStream</span><br><span class="line">      gpgcheck: no</span><br><span class="line"></span><br><span class="line">- name: install yum repo</span><br><span class="line">  hosts: serverc</span><br><span class="line">  tasks:</span><br><span class="line">  - name: BaseOS_REPO</span><br><span class="line">    ansible.builtin.yum_repository:</span><br><span class="line">      name: Red Hat Enterprise Linux 9 <span class="keyword">for</span> x86_64 - BaseOS (RPMs)</span><br><span class="line">      description: BaseOS</span><br><span class="line">      file: rhel_BaseOS</span><br><span class="line">      baseurl: http://content.example.com/rhel9.0/x86_64/dvd/BaseOS</span><br><span class="line">      gpgcheck: no      </span><br><span class="line">      </span><br><span class="line"><span class="comment">#ansible-navigator collections,ansible-navigator doc  ansible.posix.firewalld -m stdout</span></span><br><span class="line">[student@workstation ansible]$ ansible-navigator collections -m stdout | grep firewalld</span><br><span class="line">    - full_name: ansible.posix.firewalld</span><br><span class="line">      path: /usr/share/ansible/collections/ansible_collections/ansible/posix/plugins/modules/firewalld.py</span><br><span class="line">      short_description: Manage arbitrary ports/services with firewalld</span><br><span class="line">    - full_name: ansible.posix.firewalld_info</span><br><span class="line">      path: /usr/share/ansible/collections/ansible_collections/ansible/posix/plugins/modules/firewalld_info.py</span><br><span class="line">      short_description: Gather information about firewalld</span><br><span class="line">[student@workstation ansible]$ ansible-navigator doc ansible.posix.firewalld -m stdout</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--syntax-check  </span><br><span class="line">[student@workstation ansible]$ ansible-navigator run install_yum.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/install_yum.yml</span><br><span class="line"></span><br><span class="line">-v -vv -vvv</span><br><span class="line">[student@workstation ansible]$ ansible-navigator run install_yum.yml -m stdout --syntax-check -v</span><br><span class="line">Using /home/student/ansible/ansible.cfg as config file</span><br><span class="line">playbook: /home/student/ansible/install_yum.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run install_yum.yml -m stdout</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试运行剧本后的结果</span></span><br><span class="line">[student@workstation ansible]$ ansible -m shell all -a <span class="string">&#x27;yun -y install ftp&#x27;</span></span><br><span class="line">[student@workstation ansible]$ ansible all -m shell -a <span class="string">&#x27;rpm -q ftp&#x27;</span></span><br><span class="line">serverd | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ftp-0.17-89.el9.x86_64</span><br><span class="line">serverc | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ftp-0.17-89.el9.x86_64</span><br><span class="line">serverb | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ftp-0.17-89.el9.x86_64</span><br><span class="line">servera | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">ftp-0.17-89.el9.x86_64</span><br><span class="line"></span><br><span class="line">以上实验，用ansible-doc 查询课程中的所有模块</span><br><span class="line">yum        安装软件</span><br><span class="line">service    管理服务</span><br><span class="line">shell模块  管理防火墙</span><br><span class="line">copy       拷贝，1有拷贝功能，2 可以将一段文本，复制到某个文件中，如文件不存在，则生成文件。</span><br><span class="line">uri        网站连接测试</span><br></pre></td></tr></table></figure>

<h3 id="选择模块"><a href="#选择模块" class="headerlink" title="选择模块"></a>选择模块</h3><table>
<thead>
<tr>
<th>类别</th>
<th>模块</th>
</tr>
</thead>
<tbody><tr>
<td>文件</td>
<td>ansible.builtin.copy:              将本地文件复制到受管主机<br/>ansible.builtin.file:                 设置文件的权限和其他属性<br/>ansible.builtin.lineinfile:       确保特定行是否在文件中<br/>ansible.posix.synchronize:  使用rsync 同步内容</td>
</tr>
<tr>
<td>软件</td>
<td>ansible.builtin.package:       使用操作系统自带的自动检测软件包管理器管理软件包。<br/>ansible.builtin.dnf:                使用DNF软件包管理器管理软件包<br/>ansible.builtin.apt:                使用APT 软件包管理器管理软件包<br/>ansible.builtin.pip:                 从PyPI管理Python 软件包。</td>
</tr>
<tr>
<td>系统</td>
<td>ansible.posix.firewalld:         使用firewalld 管理任意端口和服务<br/>ansible.builtin.reboot:          重新启动计算机。<br/>ansible.builtin.service:          管理服务<br/>ansible.builtin.user:               添加、删除和管理用户帐户</td>
</tr>
<tr>
<td>网络工具</td>
<td>ansible.builtin.get_url:           通过HTTP、HTTPS或FTP 下载文件<br/>ansible.builtin.uri:                  与Web 服务交互</td>
</tr>
</tbody></table>
<h1 id="3-管理变量和事实"><a href="#3-管理变量和事实" class="headerlink" title="3 管理变量和事实"></a>3 管理变量和事实</h1><h2 id="3-1-管理变量"><a href="#3-1-管理变量" class="headerlink" title="3.1 管理变量"></a>3.1 管理变量</h2><h3 id="Ansible变量简介"><a href="#Ansible变量简介" class="headerlink" title="Ansible变量简介"></a>Ansible变量简介</h3><p>​      Ansible支持利用变量来存储值，并在Ansible项目的所有文件中重复使用这些值</p>
<p>​     可以简化项目的创建和维护，并减少错误的数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#key：vaule  </span></span><br><span class="line">变量可以重复的应用到项目中，简化管理，应用对象可以是：</span><br><span class="line">1.要创建的用户</span><br><span class="line">2.要安装的软件包</span><br><span class="line">3.要重新启动的服务</span><br><span class="line">4.要删除的文件</span><br><span class="line">5.互联网的文档等</span><br></pre></td></tr></table></figure>

<h3 id="命名变量"><a href="#命名变量" class="headerlink" title="命名变量"></a>命名变量</h3><p>​      变量的名称必须以字母开头，并且只能含有字母、数字和下划线</p>
<table>
<thead>
<tr>
<th>无效变量名称</th>
<th>有效变量名称</th>
</tr>
</thead>
<tbody><tr>
<td>web server</td>
<td>web_server</td>
</tr>
<tr>
<td>remote.file</td>
<td>remote_file</td>
</tr>
<tr>
<td>1st  file</td>
<td>file_1，file1</td>
</tr>
<tr>
<td>remoteserver $1</td>
<td>remote_server_1,remote_server1</td>
</tr>
</tbody></table>
<h3 id="定义变量"><a href="#定义变量" class="headerlink" title="定义变量"></a>定义变量</h3><p>​     可在Ansible项目中的多个位置定义变量</p>
<p>​     如果在两个位置设置了同名变量，并且变量值不同，则通过优先级来决定要使用哪个值<br>​     可以设置会影响一组主机的变量，也可以设置只会影响个别主机的变量</p>
<p>​     有些变量是Ansible可以根据系统配置来设置的事实</p>
<p>​     有些变量可在playbook中设置，然后影响该playbook中的一个play，或者仅影响该play中的一项任务</p>
<p>​      可通过–extra-vars或-e选项并指定变量值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Ansible的变量可以定义在不同位置，根据需要设定，其中也有优先度</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>应用场景</th>
<th>描述</th>
<th>优先度</th>
</tr>
</thead>
<tbody><tr>
<td>全局范围</td>
<td>命令行执行临时命令时指定的变量 -e key&#x3D;vaule</td>
<td>高</td>
</tr>
<tr>
<td>play范围</td>
<td>playbook的Play部分或模块内部指定变量信息key: vaule</td>
<td>中</td>
</tr>
<tr>
<td>主机范围</td>
<td>清单中主机或主机组指定变量（主机 优先 主机组）</td>
<td>低</td>
</tr>
</tbody></table>
<h4 id="1-全局范围-命令行"><a href="#1-全局范围-命令行" class="headerlink" title="1.全局范围-命令行"></a>1.全局范围-命令行</h4><p>​       清单变量可被playbook中设置的变量覆盖，这两种变量又可通过在命令行中传递参数到ansible-navigatorrun 命令来覆盖</p>
<p>​       在命令行上设置的变量称为额外变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#命令行使用变量优先级最高</span></span><br><span class="line">[student@workstation ansible]$ ansible servera -m shell -a <span class="built_in">whoami</span> -e ansible_user=root -e ansible_password=redhat</span><br><span class="line">servera | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">root</span><br><span class="line"></span><br><span class="line"><span class="comment">#在执行playbook时指定变量</span></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run install_yum.yml -m stdout -e ansible_user=root -e ansible_password=redhat</span><br></pre></td></tr></table></figure>

<h4 id="2-PlAY范围-Playbook"><a href="#2-PlAY范围-Playbook" class="headerlink" title="2.PlAY范围-Playbook"></a>2.PlAY范围-Playbook</h4><p>​        变量在Ansible Playbook中发挥着重要作用，可以简化playbook中变量数据的管理</p>
<p>​       编写play时，可以定义自己的变量，然后在任务中调用这些值</p>
<p>​       例如，可以使用值httpd来定义名为web_package的变量。然后，任务可以使用ansible.builtin.dnf模块调用该变量来安装httpd软件包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#playbook中可以在play位置使用vars直接定义变量，也可以通过vars_files加载包含变量的文件。</span></span><br><span class="line"><span class="comment">#1.在playbook的play部分使用vars直接定义变量</span></span><br><span class="line">-vars</span><br><span class="line">[student@workstation ansible]$ vim web.yml</span><br><span class="line">---</span><br><span class="line">- name: PLAY1</span><br><span class="line">  hosts: servera</span><br><span class="line">  vars: 			  		<span class="comment">#vars关键字就是在playbook中设置自定义变量</span></span><br><span class="line">  - package: httpd    		 <span class="comment">#key：vaule    键值间：冒号隔开，冒号后有一个空格</span></span><br><span class="line">  tasks:</span><br><span class="line">  - name: install &#123;&#123; package &#125;&#125;</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; package &#125;&#125;&quot;</span> <span class="comment">#使用变量时，变量两边有空格，并且用双大括号括起来，变量开头要加“”双引号，非变量开头不用加双引号</span></span><br><span class="line">      state: latest   </span><br><span class="line">      </span><br><span class="line">[student@workstation ansible]$ ansible-navigator run web.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/web.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run web.yml -m stdout</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.生成变量文件</span></span><br><span class="line">-vars_files  </span><br><span class="line">[student@workstation ansible]$ vim /home/student/ansible/var.yml   </span><br><span class="line">---</span><br><span class="line">package: httpd   <span class="comment">#定义变量</span></span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ vim /home/student/ansible/httpd.yml</span><br><span class="line">---</span><br><span class="line">- name: PLAY2</span><br><span class="line">  hosts: serverb</span><br><span class="line">  vars_files:</span><br><span class="line">  - /home/student/ansible/var.yml    <span class="comment">#vars_files 加载变量文件到剧本中</span></span><br><span class="line">  tasks:</span><br><span class="line">  - name: install &#123;&#123; package &#125;&#125;</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; package &#125;&#125;&quot;</span></span><br><span class="line">      state: latest</span><br><span class="line">      </span><br><span class="line">[student@workstation ansible]$ ansible-navigator run httpd.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/httpd.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run httpd.yml -m stdout</span><br></pre></td></tr></table></figure>

<h4 id="3-主机范围-清单中-主机变量和组变量"><a href="#3-主机范围-清单中-主机变量和组变量" class="headerlink" title="3.主机范围-清单中(主机变量和组变量)"></a>3.主机范围-清单中(主机变量和组变量)</h4><p>​      直接应用于主机的清单变量分为两大类:</p>
<p>​     1.主机变量，应用于特定主机</p>
<p>​     2.组变量，应用于一个主机组或组主机组中的所有主机。</p>
<p>​         主机变量优先于组变量，但playbook中定义的变量的优先级比这两者更高</p>
<p>​     若要定义主机变量和组变量，一种方法是直接在清单文件中定义</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ vim /home/student/ansible/inventory</span><br><span class="line">172.25.250.9   ansible_password=redhat     <span class="comment">#给主机定义变量  #模拟考试环境中密码是flectrag</span></span><br><span class="line"></span><br><span class="line">[<span class="built_in">test</span>]</span><br><span class="line">172.25.250.10 </span><br><span class="line"></span><br><span class="line">[<span class="built_in">test</span>:vars]               <span class="comment">#主机组变量中vars是固定语法</span></span><br><span class="line">ansible_password=redhat                    <span class="comment">#给主机组定义变量   #模拟考试环境中密码是flectrag</span></span><br><span class="line"></span><br><span class="line">[prod]</span><br><span class="line">172.25.250.[11:12]</span><br><span class="line"></span><br><span class="line">[balancers]</span><br><span class="line">172.25.250.13</span><br><span class="line"></span><br><span class="line">[all:vars]   <span class="comment">#给所有主机和主机组组定义变量</span></span><br><span class="line">ansible_user=root</span><br><span class="line">ansible_password=redhat   <span class="comment">#模拟考试环境中密码是flectrag</span></span><br></pre></td></tr></table></figure>

<h4 id="4-使用目录填充主机和组变量"><a href="#4-使用目录填充主机和组变量" class="headerlink" title="4.使用目录填充主机和组变量"></a>4.使用目录填充主机和组变量</h4><p>​      定义主机和主机组变量的首选做法是在清单文件或目录相同的工作目录中，创建group_vars和host_vars两个目录。这两个目录分别包含用于定义组变量和主机变量文件</p>
<p>​      建议在host_vars和group_vars目录定义清单变量，而不是直接在清单文件中定义他们</p>
<p><img src="/%E7%BA%A2%E5%B8%BD-Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4.assets/%E4%BD%BF%E7%94%A8%E7%9B%AE%E5%BD%95%E5%A1%AB%E5%85%85%E4%B8%BB%E6%9C%BA%E5%92%8C%E7%BB%84%E5%8F%98%E9%87%8F.png"></p>
<h3 id="字典形式表示变量"><a href="#字典形式表示变量" class="headerlink" title="字典形式表示变量"></a>字典形式表示变量</h3><p>​     除了将与同一元素相关的配置数据分配到多个变量外，管理员也可以使用字典</p>
<p>​     字典是一个包含键值对的数据结构，其中的值也可以是字典</p>
<h4 id="1-同一元素相关变量的键值关系"><a href="#1-同一元素相关变量的键值关系" class="headerlink" title="1.同一元素相关变量的键值关系"></a>1.同一元素相关变量的键值关系</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user1_A_name:</span> <span class="string">zhang</span></span><br><span class="line"><span class="attr">user1_B_name:</span> <span class="string">san</span></span><br><span class="line"><span class="attr">user1_C_name:</span> <span class="string">/home/zhangsan</span></span><br><span class="line"><span class="attr">user2_A_name:</span> <span class="string">li</span></span><br><span class="line"><span class="attr">user2_B_name:</span> <span class="string">si</span></span><br><span class="line"><span class="attr">user2_C_name:</span> <span class="string">/home/lisi</span> </span><br></pre></td></tr></table></figure>

<h4 id="2-字典形式"><a href="#2-字典形式" class="headerlink" title="2.字典形式"></a>2.字典形式</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">vari.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line">  <span class="attr">user1:</span></span><br><span class="line">    <span class="attr">A_name:</span> <span class="string">zhang</span></span><br><span class="line">    <span class="attr">B_name:</span> <span class="string">san</span></span><br><span class="line">    <span class="attr">C_name:</span> <span class="string">/home/zhangsan</span></span><br><span class="line">  <span class="attr">user2:</span></span><br><span class="line">    <span class="attr">A_name:</span> <span class="string">li</span></span><br><span class="line">    <span class="attr">B_name:</span> <span class="string">si</span></span><br><span class="line">    <span class="attr">C_name:</span> <span class="string">/home/lisi</span> </span><br></pre></td></tr></table></figure>

<h4 id="3-调用变量"><a href="#3-调用变量" class="headerlink" title="3.调用变量"></a>3.调用变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">例子：调用数组</span><br><span class="line"></span><br><span class="line"><span class="comment">#调用变量方法1：</span></span><br><span class="line">  users.user1.A_name</span><br><span class="line">  users.user2.B_name</span><br><span class="line"></span><br><span class="line"><span class="comment">#调用变量方法2：</span></span><br><span class="line">  应用方法2：python字典</span><br><span class="line">  <span class="built_in">users</span>[<span class="string">&#x27;user1&#x27;</span>][<span class="string">&#x27;A_name&#x27;</span>]</span><br><span class="line">   </span><br><span class="line"><span class="comment"># [student@bastion ansible]$ vim user.yml</span></span><br><span class="line">---</span><br><span class="line">- name: useradd</span><br><span class="line">  hosts: dev</span><br><span class="line">  vars_files:</span><br><span class="line">  - vari.yml</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Add the user</span><br><span class="line">    ansible.builtin.user:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; users.user1.A_name &#125;&#125;&#123;&#123; users.user1.B_name &#125;&#125;&quot;</span></span><br><span class="line">      home: <span class="string">&quot;&#123;&#123; users[&#x27;user1&#x27;][&#x27;C_name&#x27;] &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用已注册变量捕获命令输出"><a href="#使用已注册变量捕获命令输出" class="headerlink" title="使用已注册变量捕获命令输出"></a>使用已注册变量捕获命令输出</h3><p>​     register用来捕获命令输出或有关模块执行的其他信息。输出会保存至一个变量中，稍后可用于调试或其他目的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ vim register.yml</span><br><span class="line">---</span><br><span class="line">- name: install a packages</span><br><span class="line">  hosts: servera</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: latest</span><br><span class="line">    register: install_result  <span class="comment">#register字段负责收集变量 install_result自定义变量名被收集变量名</span></span><br><span class="line">  - name:  message</span><br><span class="line">    ansible.builtin.debug:			</span><br><span class="line">      var: install_result     <span class="comment">#debug模块var选项打印register获取install_result变量值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">$ ansible-navigator run -m stdout register.yml </span><br></pre></td></tr></table></figure>

<h2 id="3-2-管理机密-vault"><a href="#3-2-管理机密-vault" class="headerlink" title="3.2 管理机密-vault"></a>3.2 管理机密-vault</h2><h3 id="介绍Ansible-vault"><a href="#介绍Ansible-vault" class="headerlink" title="介绍Ansible-vault"></a>介绍Ansible-vault</h3><p>​      Ansible可能需要访问密码或API密钥等敏感数据，以配置受管主机。通常，此信息会以纯文本形式存储在清单变量或其他Ansible文件中。但若如此，任何有权访问Ansible文件的用户或存储这些Ansible文件的版本控制系统都能够访问此敏感数据。这显然存在安全风险</p>
<p>​     使用Ansible随附的Ansible Vaut可以加密和解密任何由Ansible使用的数据文件。若要使用Ansible Vaut，可通过一个名为ansible-vault的命令行工具创建、编辑、加密、解密和查看文件</p>
<p>​     Ansible Vault可以加密任何由Ansible使用的数据文件。这可能包括清单变量、playbook中含有的变量文件、在执行playbook时作为参数传递的变量文件，或者Ansible角色中定义的变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ~]$ ansible-vault --<span class="built_in">help</span></span><br><span class="line">usage: ansible-vault [-h] [--version] [-v] &#123;create,decrypt,edit,view,encrypt,encrypt_string,rekey&#125; ...</span><br><span class="line">encryption/decryption utility <span class="keyword">for</span> Ansible data files</span><br><span class="line">positional arguments:</span><br><span class="line">  &#123;create,decrypt,edit,view,encrypt,encrypt_string,rekey&#125;</span><br><span class="line">    create              Create new vault encrypted file     <span class="comment">#创建密码文件</span></span><br><span class="line">    decrypt             Decrypt vault encrypted file        <span class="comment">#解密现有密码文件</span></span><br><span class="line">    edit                Edit vault encrypted file           <span class="comment">#编辑现有密码文件</span></span><br><span class="line">    view                View vault encrypted file           <span class="comment">#查看加密文件</span></span><br><span class="line">    encrypt             Encrypt YAML file                   <span class="comment">#加密现有文件</span></span><br><span class="line">    encrypt_string      Encrypt a string</span><br><span class="line">    rekey               Re-key a vault encrypted file       <span class="comment">#更改加密文件的密码</span></span><br></pre></td></tr></table></figure>

<h4 id="1-创建与查看加密文件"><a href="#1-创建与查看加密文件" class="headerlink" title="1 创建与查看加密文件"></a>1 创建与查看加密文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建加密文件-create</span></span><br><span class="line">[student@workstation ansible]$ ansible-vault create sec1.txt   <span class="comment">#默认sec1.txt不存在，通过该命令生成</span></span><br><span class="line">New Vault password: redhat</span><br><span class="line">Confirm New Vault password: redhat</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">cat</span> sec1.txt</span><br><span class="line"><span class="variable">$ANSIBLE_VAULT</span>;1.1;AES256</span><br><span class="line">35333131363436363836626431336230353532613437623862316361313130646338613163393266</span><br><span class="line">6234663835643533336635323435313064386363303337650a663261613334653066373463663230</span><br><span class="line">31643332636435383063353535626166626632313034636335643766326638343134356663653761</span><br><span class="line">6330663638613335340a663337636132663362646531653537626665363064323864613936386136</span><br><span class="line">32323636366431666130386333346236643033373062303938303937383436326232</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看加密文件-view</span></span><br><span class="line">[student@workstation ansible]$ ansible-vault view sec1.txt</span><br><span class="line">Vault password: redhat</span><br><span class="line">---</span><br><span class="line">This is a encrypted file!</span><br></pre></td></tr></table></figure>

<h4 id="2-编辑现有的加密文件"><a href="#2-编辑现有的加密文件" class="headerlink" title="2 编辑现有的加密文件"></a>2 编辑现有的加密文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编辑加密文件-edit</span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-vault edit sec1.txt</span><br><span class="line">Vault password:</span><br><span class="line">[student@workstation ansible]$ ansible-vault view sec1.txt</span><br><span class="line">Vault password:</span><br><span class="line">---</span><br><span class="line">This is a encrypted file!</span><br><span class="line">password: redhat321</span><br></pre></td></tr></table></figure>

<h4 id="3-加密现有的文件"><a href="#3-加密现有的文件" class="headerlink" title="3 加密现有的文件"></a>3 加密现有的文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">echo</span> China &gt; sec2.txt   <span class="comment">#创建文件</span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">cat</span> sec2.txt       </span><br><span class="line">China</span><br><span class="line"></span><br><span class="line"><span class="comment">#加密现有文件-encrypt</span></span><br><span class="line">[student@workstation ansible]$ ansible-vault encrypt sec2.txt   </span><br><span class="line">New Vault password: redhat</span><br><span class="line">Confirm New Vault password: redhat</span><br><span class="line">Encryption successful</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">cat</span> sec2.txt</span><br><span class="line"><span class="variable">$ANSIBLE_VAULT</span>;1.1;AES256</span><br><span class="line">39333163613564343437353466356536666437633937616533623231633561313537346633363630</span><br><span class="line">6535653834383263356261623737376131333237643330610a313134373235336430316139623035</span><br><span class="line">63323935356565313536383164343938366639663036323264666636353962343133636534396635</span><br><span class="line">6566656361323462650a343139653263386230393938346565626634303335313262626639653737</span><br><span class="line">3562</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-vault view sec2.txt</span><br><span class="line">Vault password:</span><br><span class="line">China</span><br></pre></td></tr></table></figure>

<h4 id="4-解密现有的文件"><a href="#4-解密现有的文件" class="headerlink" title="4 解密现有的文件"></a>4 解密现有的文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解密现有的文件-decrypt</span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br><span class="line">[student@workstation ansible]$ ansible-vault decrypt sec2.txt</span><br><span class="line">Vault password: redhat</span><br><span class="line">Decryption successful</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">cat</span> sec2.txt</span><br><span class="line">China</span><br></pre></td></tr></table></figure>

<h4 id="5-更改加密文件的密码"><a href="#5-更改加密文件的密码" class="headerlink" title="5 更改加密文件的密码"></a>5 更改加密文件的密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#更改加密文件的密码-rekey</span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-vault rekey sec1.txt</span><br><span class="line">Vault password: redhat                  <span class="comment">#旧密码 redhat</span></span><br><span class="line">New Vault password: redhat321           <span class="comment">#新密码 redhat321                   </span></span><br><span class="line">Confirm New Vault password: redhat321   <span class="comment">#重复新密码 redhat321</span></span><br><span class="line">Rekey successful</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-vault view sec1.txt</span><br><span class="line">Vault password: redhat321</span><br><span class="line">---</span><br><span class="line">This is a encrypted file!</span><br><span class="line">password: redhat321</span><br></pre></td></tr></table></figure>

<h4 id="6-使用密码文件"><a href="#6-使用密码文件" class="headerlink" title="6 使用密码文件"></a>6 使用密码文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-vault view sec1.txt --<span class="built_in">help</span></span><br><span class="line">---省略---</span><br><span class="line">  --vault-id VAULT_IDS  the vault identity to use</span><br><span class="line">  --ask-vault-password, --ask-vault-pass  ask <span class="keyword">for</span> vault password</span><br><span class="line">  --vault-password-file VAULT_PASSWORD_FILES, --vault-pass-file VAULT_PASSWORD_FILES</span><br><span class="line">                        vault password file</span><br><span class="line">---省略---</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">echo</span> redhat321 &gt; secret.txt  <span class="comment">#创建密码文件</span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">cat</span> secret.txt</span><br><span class="line">redhat321</span><br><span class="line">[student@workstation ansible]$ ansible-vault view sec1.txt --vault-id=secret.txt   <span class="comment">#通过变量文件指定密码</span></span><br><span class="line">---</span><br><span class="line">This is a encrypted file!</span><br><span class="line">password: redhat321                     </span><br></pre></td></tr></table></figure>

<h4 id="7-密码文件记录到ansible-cfg配置文件中"><a href="#7-密码文件记录到ansible-cfg配置文件中" class="headerlink" title="7 密码文件记录到ansible.cfg配置文件中"></a>7 密码文件记录到ansible.cfg配置文件中</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">密码文件记录在ansible.cfg配置文件中的好处是，当执行一个使用了加密文件的playbook时，不必手工指定加密文件密码。</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ vim ansible.cfg          <span class="comment">#第一次填写vault路径时，搜索`vault`关键字找该选项</span></span><br><span class="line">vault_password_file=/home/student/ansible/secret.txt    <span class="comment">#配置文件中指定密码文件位置</span></span><br><span class="line"> </span><br><span class="line">[student@workstation ansible]$ ansible-vault view sec1.txt    <span class="comment">#自动调用配置文件中密码文件</span></span><br><span class="line">---</span><br><span class="line">This is a encrypted file!</span><br><span class="line">password: redhat321</span><br><span class="line"></span><br><span class="line"><span class="comment">#密码文件记录在配置文件中后</span></span><br><span class="line">1.加密现有文件时会直接引用</span><br><span class="line">[student@workstation ansible]$ ansible-vault encrypt sec2.txt</span><br><span class="line">Encryption successful</span><br><span class="line"></span><br><span class="line">2.更改密码时会直接覆盖</span><br><span class="line">[student@workstation ansible]$ ansible-vault rekey sec2.txt</span><br><span class="line">Rekey successful</span><br><span class="line"></span><br><span class="line">3.更改密码需使用--ask-vault-password参数指定</span><br><span class="line">[student@workstation ansible]$ ansible-vault rekey sec2.txt --ask-vault-password</span><br><span class="line">Vault password: redhat</span><br><span class="line">New Vault password: redhat</span><br><span class="line">Confirm New Vault password: redhat</span><br><span class="line">Rekey successful</span><br></pre></td></tr></table></figure>

<h2 id="3-3-管理事实facts"><a href="#3-3-管理事实facts" class="headerlink" title="3.3 管理事实facts"></a>3.3 管理事实facts</h2><p>​        Ansible事实是Ansible在受管主机上自动检测到的变量。事实中含有与主机相关的信息，可以像play中的常规变量、条件、循环或依赖于从受管主机收集的值的任何其他语句那样使用。<br>​       为受管主机收集的一些事实可能包括:<br>​       主机名称、内核版本、网络接口名称、网络接口IP地址、操作系统版本、CPU数量提供的或可用的内存、存储设备的大小和可用空间</p>
<p>​       借助事实，可以方便地检索受管主机的状态，并根据该状态确定要执行的操作。例如:</p>
<p>​       1.根据含有受管主机当前内核版本的事实运行条件任务，以此来重新启动服务器</p>
<p>​       2.根据通过事实报告的可用内存来定义MySQL配置文件<br>​       3.根据事实的值设置配置文件中使用的IPv4地址<br>​       通常，每个play在执行第一个任务之前会先自动运行setup模块来收集事实。这在Ansible2.3中报告为GatheringFacts任务，或者更早版本中报告为setup。默认情况下，无需具有在play中运行setup的任务，通常会自动运行<br>​       查看受管主机收集的事实的方式是:</p>
<p>​       1.使用ad-hoc命令运行setup模块</p>
<p>​       2.使用playbook运行debug模块并提取变量var: ansible facts</p>
<h3 id="收集事实"><a href="#收集事实" class="headerlink" title="收集事实"></a>收集事实</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#收集事实常用两种手段常用是临时命令ad-hoc及Playbook，事实以josn语法格式列出。收集时要找ansible_开头的事实名称</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果变量值为散列/字典，则可以用两种语法来检索该值:</span></span><br><span class="line">ansible_default_ipv4.hostname</span><br><span class="line">ansible_default_ipv4.[ <span class="string">&#x27;hostname&#x27;</span> ]</span><br></pre></td></tr></table></figure>

<h4 id="1-临时命令-ad-hoc"><a href="#1-临时命令-ad-hoc" class="headerlink" title="1 临时命令 ad-hoc"></a>1 临时命令 ad-hoc</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">1.使用ad-hoc方式收集事实</span><br><span class="line">[student@workstation ansible]$ ansible -m setup all  <span class="comment">#收集清单中所有主机的事实</span></span><br><span class="line">[student@workstation ansible]$ ansible -m setup servera</span><br><span class="line">[student@workstation ansible]$ ansible -m setup servera -a filter=ansible_nodename  <span class="comment">#过滤</span></span><br><span class="line">servera | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ansible_nodename&quot;</span>: <span class="string">&quot;servera.lab.example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">[student@workstation ansible]$ ansible -m setup serverc -a filter=*ipv4*    <span class="comment">#过滤&amp;模糊匹配</span></span><br><span class="line">serverc | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_facts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ansible_all_ipv4_addresses&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;172.25.250.12&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;ansible_default_ipv4&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;172.25.250.12&quot;</span>,</span><br><span class="line">            <span class="string">&quot;alias&quot;</span>: <span class="string">&quot;eth0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;broadcast&quot;</span>: <span class="string">&quot;172.25.250.255&quot;</span>,</span><br><span class="line">            <span class="string">&quot;gateway&quot;</span>: <span class="string">&quot;172.25.250.254&quot;</span>,</span><br><span class="line">            <span class="string">&quot;interface&quot;</span>: <span class="string">&quot;eth0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;macaddress&quot;</span>: <span class="string">&quot;52:54:00:00:fa:0c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mtu&quot;</span>: 1500,</span><br><span class="line">            <span class="string">&quot;netmask&quot;</span>: <span class="string">&quot;255.255.255.0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;network&quot;</span>: <span class="string">&quot;172.25.250.0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;prefix&quot;</span>: <span class="string">&quot;24&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;ether&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;discovered_interpreter_python&quot;</span>: <span class="string">&quot;/usr/bin/python3&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible -m setup serverc &gt; fact.txt   <span class="comment">#将事实记录到fact.txt文件中，方便后期查找事实</span></span><br><span class="line">[student@workstation ansible]$ ll fact.txt</span><br><span class="line">-rw-r--r--. 1 student student 25988 Mar 11 01:55 fact.txt</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span></span><br><span class="line">/home/student/ansible</span><br></pre></td></tr></table></figure>

<h4 id="2-PLAYBOOK-收集事实"><a href="#2-PLAYBOOK-收集事实" class="headerlink" title="2 PLAYBOOK 收集事实"></a>2 PLAYBOOK 收集事实</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ vim debug.yml</span><br><span class="line">---</span><br><span class="line">- name: debug</span><br><span class="line">  hosts: servera</span><br><span class="line">  tasks:</span><br><span class="line">  - ansible.builtin.debug:</span><br><span class="line">      msg: servera ip address <span class="string">&quot;&#123;&#123; ansible_default_ipv4.address &#125;&#125;&quot;</span>    <span class="comment">#简化后可将ansible_facts去掉，二级变量开头，要保留ansible_,如：ansible_default_ipv4.address</span></span><br><span class="line">  - ansible.builtin.debug:</span><br><span class="line">      var: ansible_hostname </span><br><span class="line">[student@workstation ansible]$ ansible-navigator run debug.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/debug.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run debug.yml -m stdout</span><br><span class="line"></span><br><span class="line">PLAY [debug] ************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************************</span><br><span class="line">ok: [servera]</span><br><span class="line"></span><br><span class="line">TASK [ansible.builtin.debug] ********************************************************************************************************************************</span><br><span class="line">ok: [servera] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;servera ip address \&quot;172.25.250.10\&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [ansible.builtin.debug] ********************************************************************************************************************************</span><br><span class="line">ok: [servera] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;ansible_hostname&quot;</span>: <span class="string">&quot;servera&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************************</span><br><span class="line">servera                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h4 id="3-关闭事实"><a href="#3-关闭事实" class="headerlink" title="3 关闭事实"></a>3 关闭事实</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">vim</span> <span class="string">debug.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug</span> <span class="string">message</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="string">on/off</span>  <span class="literal">true</span><span class="string">/false</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ansible_facts.default_ipv4.address &#125;&#125;</span>&quot;</span></span><br><span class="line">      </span><br><span class="line">[<span class="string">greg@bastion</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">debug.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果playbook内容和事实收集没有关系，关闭可以大量减少playbook执行时间。</span></span><br><span class="line"><span class="comment">#备注:RHCE考试时不要关闭</span></span><br></pre></td></tr></table></figure>

<h3 id="魔法变量"><a href="#魔法变量" class="headerlink" title="魔法变量"></a>魔法变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#实时变量通常收集的是受管节点的信息，而魔法变量收集的是本机的变量值，先了解课上的4个魔法变量功能，后面再看使用场景。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#inventory_hostname  列出组在清单中的主机名</span></span><br><span class="line">[student@workstation ansible]$ ansible web -m debug -a var=inventory_hostname</span><br><span class="line">serverb | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;inventory_hostname&quot;</span>: <span class="string">&quot;serverb&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">serverc | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;inventory_hostname&quot;</span>: <span class="string">&quot;serverc&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#group_names     列出当前主机归属于哪个组</span></span><br><span class="line">[student@workstation ansible]$ ansible serverd -m debug -a var=group_names</span><br><span class="line">serverd | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;group_names&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;db&quot;</span>,</span><br><span class="line">        <span class="string">&quot;servers&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#groups    列出清单中的所有主机名称。以及所在组</span></span><br><span class="line">[student@workstation ansible]$ ansible all -m debug -a var=<span class="built_in">groups</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#hostvars  列出系统中所有魔法变量及所有事实变量</span></span><br><span class="line">[student@workstation ansible]$ ansible all -m debug -a var=hostvars</span><br><span class="line"></span><br><span class="line">$ https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html  <span class="comment">#官网文档</span></span><br><span class="line"><span class="comment"># dosc.ansible.com中搜索magic或facts</span></span><br></pre></td></tr></table></figure>

<h4 id="1-临时命令收集魔法变量值-ad-hoc"><a href="#1-临时命令收集魔法变量值-ad-hoc" class="headerlink" title="1 临时命令收集魔法变量值 ad-hoc"></a>1 临时命令收集魔法变量值 ad-hoc</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ansible  servera -m debug -a var=inventory_hostname</span><br><span class="line">ansible  servera -m debug -a var=<span class="built_in">groups</span></span><br><span class="line">ansible  all -m debug -a var=group_names</span><br><span class="line">ansible  all -m debug -a var=hostvars</span><br><span class="line">ansible  servera -m debug -a var=groups.all</span><br></pre></td></tr></table></figure>

<h4 id="2-PLAYBOOK收集事实-魔法变量"><a href="#2-PLAYBOOK收集事实-魔法变量" class="headerlink" title="2 PLAYBOOK收集事实+魔法变量"></a>2 PLAYBOOK收集事实+魔法变量</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">vim</span> <span class="string">hoc_debug.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">servera</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="string">on</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">     <span class="attr">var:</span> <span class="string">hostvars</span></span><br><span class="line"></span><br><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">ansible-navigator</span> <span class="string">run</span> <span class="string">hoc_debug.yml</span> <span class="string">-m</span> <span class="string">stdout</span> <span class="string">--syntax-check</span></span><br><span class="line"><span class="attr">playbook:</span> <span class="string">/home/student/ansible/hoc_debug.yml</span></span><br><span class="line"></span><br><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">ansible-navigator</span> <span class="string">run</span> <span class="string">hoc_debug.yml</span> <span class="string">-m</span> <span class="string">stdout</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重定向到文件中的意义是方便在hoc_fact.txt文件中搜索需要的值</span></span><br><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">ansible-navigator</span> <span class="string">run</span> <span class="string">hoc_debug.yml</span> <span class="string">-m</span> <span class="string">stdout</span> <span class="string">&gt;</span> <span class="string">hoc_fact.txt</span>   </span><br></pre></td></tr></table></figure>

<h4 id="3-魔法变量hostvars"><a href="#3-魔法变量hostvars" class="headerlink" title="3 魔法变量hostvars"></a>3 魔法变量hostvars</h4><p>   临时命令与playbook收集hostvars变量值是不同的</p>
<p>   临时命令不会执行setup模块，所以收集不到事实，PLAYBOOK方法则可以收集到事实和魔法变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ ansible all -m setup &gt; all_host.txt</span><br></pre></td></tr></table></figure>

<h1 id="4-实施任务控制"><a href="#4-实施任务控制" class="headerlink" title="4 实施任务控制"></a>4 实施任务控制</h1><h2 id="4-1-编写循环和条件任务"><a href="#4-1-编写循环和条件任务" class="headerlink" title="4.1 编写循环和条件任务"></a>4.1 编写循环和条件任务</h2><h3 id="利用循环迭代任务"><a href="#利用循环迭代任务" class="headerlink" title="利用循环迭代任务"></a>利用循环迭代任务</h3><p>​       通过利用循环，管理员无需编写多个使用同一模块的任务。例如，不必编写五个任务来确保存在五个用户，而是只需编写一个任务来对含有五个用户的列表迭代，从而确保他们都存在<br>​       Ansible支持使用loop关键字对一组项目迭代任务。可以配置循环以利用列表中各个项目、列表中各个文件的内容、生成的数字序列或更为复杂的结构来重复任务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#loop字段通常在同一缩进的模块下面，对该模块生效，通过item来加载loop循环中的值或变量</span></span><br><span class="line"><span class="comment">#帮助：搜索loop可以搜到相应语法</span></span><br><span class="line">$ https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html</span><br></pre></td></tr></table></figure>

<h4 id="1-简单循环"><a href="#1-简单循环" class="headerlink" title="1 简单循环"></a>1 简单循环</h4><p>  简单循环对一组项目迭代任务</p>
<p>  loop 关键字添加到任务中，将应对其迭代任务的项目列表取为值</p>
<p>  循环变量item保存每个迭代过程中使用的值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.无循环</span></span><br><span class="line">[student@workstation ansible]$ vim loop.yml</span><br><span class="line">---</span><br><span class="line">- name: service</span><br><span class="line">  hosts: servera</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Start service nfs-server</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: nfs-server</span><br><span class="line">      state: started</span><br><span class="line"></span><br><span class="line">  - name: Start service chronyd</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: chronyd</span><br><span class="line">      state: started</span><br><span class="line">     </span><br><span class="line"><span class="comment">#2.使用循环</span></span><br><span class="line">[student@workstation ansible]$ vim loop.yml</span><br><span class="line">---</span><br><span class="line">- name: service</span><br><span class="line">  hosts: servera</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Start service nfs-server&amp;chronyd</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class="line">      state: started</span><br><span class="line">    loop:</span><br><span class="line">    - nfs-server</span><br><span class="line">    - chronyd</span><br><span class="line">    </span><br><span class="line">[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/loop.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout</span><br></pre></td></tr></table></figure>

<h4 id="2-循环使用变量"><a href="#2-循环使用变量" class="headerlink" title="2 循环使用变量"></a>2 循环使用变量</h4><p>   在playbook中通过vars或vars files方式加载变量servers中包含循环列表，模块通过loop字段加载servers变量列表中的值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vars字段</span></span><br><span class="line">[student@workstation ansible]$ vim loop.yml</span><br><span class="line">---</span><br><span class="line">- name: service loop</span><br><span class="line">  hosts: servera</span><br><span class="line">  vars:</span><br><span class="line">    servers:</span><br><span class="line">    - nfs-server</span><br><span class="line">    - chronyd</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Start service</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class="line">      state: stopped</span><br><span class="line">    loop: <span class="string">&quot;&#123;&#123; servers &#125;&#125;&quot;</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">#vars字段也可以替换为vars_files，将变量保存至文件中，加载到Playbook  </span></span><br><span class="line">[student@workstation ansible]$ <span class="built_in">mkdir</span> /home/student/ansible/vars/</span><br><span class="line">[student@workstation ansible]$ vim /home/student/ansible/vars/var.yml</span><br><span class="line">servers:</span><br><span class="line">- nfs-server</span><br><span class="line">- chronyd</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ vim loop.yml</span><br><span class="line">---</span><br><span class="line">- name: service loop</span><br><span class="line">  hosts: servera</span><br><span class="line">  vars_files:</span><br><span class="line">    - /home/student/ansible/vars/var.yml</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Start service</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class="line">      state: stopped</span><br><span class="line">    loop: <span class="string">&quot;&#123;&#123; servers &#125;&#125;&quot;</span></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/loop.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout</span><br></pre></td></tr></table></figure>

<h4 id="3-循环字典列表"><a href="#3-循环字典列表" class="headerlink" title="3 循环字典列表"></a>3 循环字典列表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#循环字典列表保存在loop字段中</span></span><br><span class="line">[student@workstation ansible]$ vim loop.yml</span><br><span class="line">---</span><br><span class="line">- name: service loop</span><br><span class="line">  hosts: servera</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Start service</span><br><span class="line">    ansible.builtin.user:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; item.name &#125;&#125;&quot;</span></span><br><span class="line">      comment: <span class="string">&quot;&#123;&#123; item.comment &#125;&#125;&quot;</span></span><br><span class="line">      state: present</span><br><span class="line">    loop:</span><br><span class="line">      - name: jane</span><br><span class="line">        comment: tom</span><br><span class="line">      - name: joe</span><br><span class="line">        comment: harry</span><br><span class="line">        </span><br><span class="line">[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/loop.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout      </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#循环字典列表保存在play的vars中  </span></span><br><span class="line">[student@workstation ansible]$ vim loop.yml</span><br><span class="line">---</span><br><span class="line">- name: service loop</span><br><span class="line">  hosts: servera</span><br><span class="line">  vars:</span><br><span class="line">    <span class="built_in">users</span>:</span><br><span class="line">    - name: jane</span><br><span class="line">      comment: tom</span><br><span class="line">    - name: joe</span><br><span class="line">      comment: harry</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Start service</span><br><span class="line">    ansible.builtin.user:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; item.name &#125;&#125;&quot;</span></span><br><span class="line">      comment: <span class="string">&quot;&#123;&#123; item.comment &#125;&#125;&quot;</span></span><br><span class="line">      state: present</span><br><span class="line">    loop: <span class="string">&quot;&#123;&#123; users &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/loop.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#循环字典列表保存在play的vars_files中 </span></span><br><span class="line">[student@workstation ansible]$ vim /home/student/ansible/vars/var.yml</span><br><span class="line">servers:</span><br><span class="line"><span class="built_in">users</span>:</span><br><span class="line">- name: jane</span><br><span class="line">  comment: tom</span><br><span class="line">- name: joe</span><br><span class="line">  comment: harry</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ vim loop.yml</span><br><span class="line">---</span><br><span class="line">- name: service loop</span><br><span class="line">  hosts: servera</span><br><span class="line">  vars_files:</span><br><span class="line">  - /home/student/ansible/vars/var.yml</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Start service</span><br><span class="line">    ansible.builtin.user:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; item.name &#125;&#125;&quot;</span></span><br><span class="line">      state: present</span><br><span class="line">      comment: <span class="string">&quot;&#123;&#123; item.comment &#125;&#125;&quot;</span></span><br><span class="line">    loop: <span class="string">&quot;&#123;&#123; users &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"> [student@workstation ansible]$ ansible-navigator run loop.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/loop.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout</span><br></pre></td></tr></table></figure>

<h3 id="有条件地运行任务"><a href="#有条件地运行任务" class="headerlink" title="有条件地运行任务"></a>有条件地运行任务</h3><p><img src="/%E7%BA%A2%E5%B8%BD-Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4.assets/%E6%9C%89%E6%9D%A1%E4%BB%B6%E8%BF%90%E8%A1%8C%E4%BB%BB%E5%8A%A1.png"></p>
<p>​     Ansible可使用conditionals在符合特定条件时运行任务或play。例如，可以使用条件句在Ansible安装或配置某个服务之前，确定受管主机上的可用内存。</p>
<p>​     条件句可帮助区分不同的受管主机，并根据所符合的条件来分配功能角色</p>
<p>​     Playbook变量、注册的变量和Ansible事实都可通过条件句来进行测试。可以使用比较字符串、数字数据和布尔值的运算符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#应用场景：通常主机模式为多个节点时，可以让符合when条件的主机执行模块任务。符合条件则为真，则执行模块。否则为假，跳过模块任务</span></span><br></pre></td></tr></table></figure>

<p>​     when判断对象是模块，和模块在同一下列层次</p>
<p>​     when判断当前模块是否执行，而不是它下面模块是否执行</p>
<p>​     When中引用变量、facts，不需加大括号</p>
<p>​     用于测试条件中相等的&#x3D;&#x3D;运算符不可与变量赋值的&#x3D;运算符混淆</p>
<p>​     一个when语句可用于评估多个值。 可以使用and和or关键字组合条件，或使用括号分组条件</p>
<p>​     1.or是或的关系，任意一个条件为真即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">when: ansible_distribution == <span class="string">&quot;RedHat&quot;</span> or ansible_distribution == <span class="string">&quot;Fedora&quot;</span></span><br></pre></td></tr></table></figure>

<p>​     2.and是与的关系，多个条件需同时为真</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">when: ansible_distribution version == <span class="string">&quot;7.5&quot;</span> and ansible_kernel == <span class="string">&quot;3.10.0-327.el7.x86_64&quot;</span></span><br></pre></td></tr></table></figure>

<p>​     When语句多条件的另外方式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">when:</span><br><span class="line">   -ansible_distribution_version == <span class="string">&quot;7.5&quot;</span></span><br><span class="line">   -ansible_kernel == <span class="string">&quot;3.10.0-327.el7.x86_64&quot;</span></span><br></pre></td></tr></table></figure>

<p>​     使用括号分组条件来表达更复杂的条件语句:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">when:  &gt;</span><br><span class="line">   ( ansible_distribution == <span class="string">&quot;RedHat&quot;</span> and</span><br><span class="line">     ansible_distribution_major_version == <span class="string">&quot;7&quot;</span>)</span><br><span class="line">   or</span><br><span class="line">    ( ansible_distribution == <span class="string">&quot;Fedora&quot;</span> and </span><br><span class="line">      ansible_distribution_major_version == <span class="string">&quot;28&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="简单的有条件任务示例"><a href="#简单的有条件任务示例" class="headerlink" title="简单的有条件任务示例:"></a>简单的有条件任务示例:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ vim when.yml</span><br><span class="line">---</span><br><span class="line">- name: repository</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: latest</span><br><span class="line">    when: ansible_default_ipv4.address == <span class="string">&#x27;172.25.250.10&#x27;</span></span><br><span class="line">    </span><br><span class="line">[student@workstation ansible]$ ansible-navigator run when.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/when.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run when.yml -m stdout</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ vim when-vdb.yml</span><br><span class="line">---</span><br><span class="line">- name: repository</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: latest</span><br><span class="line">    when: ansible_devices.vdb is defined</span><br><span class="line">[student@workstation ansible]$ ansible-navigator run when-vdb.yml -m stdout --syntax-check</span><br><span class="line"></span><br><span class="line">playbook: /home/student/ansible/when-vdb.yml</span><br><span class="line">[student@workstation ansible]$ ansible-navigator run when-vdb.yml -m stdout</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果使用inventory_hostname这个魔法变量，要参考清单中的主机名称。node1位置，单双引号都可以识别为字符串</span></span><br></pre></td></tr></table></figure>

<h4 id="组合循环和有条件任务示例："><a href="#组合循环和有条件任务示例：" class="headerlink" title="组合循环和有条件任务示例："></a>组合循环和有条件任务示例：</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">vim</span> <span class="string">when_loop.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装软件包</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span> <span class="string">of</span> <span class="string">Apache</span></span><br><span class="line">    <span class="attr">ansible.builtin.yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">php</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">==</span> <span class="string">&#x27;servera&#x27;</span> <span class="string">or</span> <span class="string">ansible_hostname</span> <span class="string">==</span> <span class="string">&#x27;serverc&#x27;</span></span><br><span class="line">    </span><br><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">ansible-navigator</span> <span class="string">run</span> <span class="string">when_loop.yml</span> <span class="string">-m</span> <span class="string">stdout</span> <span class="string">--syntax-check</span></span><br><span class="line"><span class="attr">playbook:</span> <span class="string">/home/student/ansible/when_loop.yml</span></span><br><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">ansible-navigator</span> <span class="string">run</span> <span class="string">when_loop.yml</span> <span class="string">-m</span> <span class="string">stdout</span></span><br><span class="line"></span><br><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">vim</span> <span class="string">when_loop2.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">repository</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span> <span class="string">of</span> <span class="string">Apache</span></span><br><span class="line">    <span class="attr">ansible.builtin.yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">&#x27;&quot;52:54:00:00:fa:0a&quot; in ansible_default_ipv4.macaddress&#x27;</span></span><br><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">ansible-navigator</span> <span class="string">run</span> <span class="string">when_loop2.yml</span> <span class="string">-m</span> <span class="string">stdout</span> <span class="string">--syntax-check</span></span><br><span class="line"><span class="attr">playbook:</span> <span class="string">/home/student/ansible/when_loop2.yml</span></span><br><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">ansible-navigator</span> <span class="string">run</span> <span class="string">when_loop2.yml</span> <span class="string">-m</span> <span class="string">stdout</span></span><br></pre></td></tr></table></figure>

<h4 id="常用when条件语句"><a href="#常用when条件语句" class="headerlink" title="常用when条件语句"></a>常用when条件语句</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ ansible all -m debug -a var=<span class="built_in">groups</span></span><br><span class="line">[student@workstation ansible]$ ansible all -m debug -a var=group_names</span><br><span class="line"><span class="comment">#变量值 == &#x27;字符串&#x27;</span></span><br><span class="line">inventory_hostname == <span class="string">&#x27;node1&#x27;</span></span><br><span class="line">inventory_hostname != <span class="string">&#x27;node1&#x27;</span></span><br><span class="line"><span class="string">&#x27;&quot;52:54:00:00:fa:0b&quot; in ansible_default_ipv4.macaddress&#x27;</span></span><br><span class="line">ansible_default_ipv4.address == <span class="string">&#x27;172.25.250.11&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#变量值存在  in  第二个变量</span></span><br><span class="line">inventory_hostname <span class="keyword">in</span> groups.dev    <span class="comment">#可以匹配组</span></span><br><span class="line"><span class="string">&#x27;&quot;dev&quot; in group_names&#x27;</span>              <span class="comment">#可以匹配</span></span><br><span class="line">[student@workstation ansible]$ vim when_loop3.yml</span><br><span class="line">---</span><br><span class="line">- name: repository</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: latest</span><br><span class="line">    when: <span class="string">&#x27;&quot;db&quot; in group_names&#x27;</span></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run when_loop3.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/when_loop3.yml</span><br><span class="line">[student@workstation ansible]$ ansible-navigator run when_loop3.yml -m stdout</span><br><span class="line"></span><br><span class="line"><span class="comment">#default变量查询方法</span></span><br><span class="line"><span class="comment">#搜索引擎中搜索：filters --- Using filters to --- 搜索admin---default(&#x27;admin&#x27;, true) </span></span><br></pre></td></tr></table></figure>

<h2 id="4-2-实施处理程序"><a href="#4-2-实施处理程序" class="headerlink" title="4.2 实施处理程序"></a>4.2 实施处理程序</h2><p>​        handlers是处理程序的一种实现，当对一个Playbook模块改动时，通过监控发现改动，并自动执行后续处理动作。帮助管理员节省管理成本。<br>​        比如一种场景，当修改了服务配置文件时，需要对服务进行重启。可以在配置文件模块位置用notify监视是否修改后，用handlers中的处理程序如:service模块对其重启服务。达到修改文件便自动重启服务的效果。</p>
<h3 id="Ansible处理程序"><a href="#Ansible处理程序" class="headerlink" title="Ansible处理程序"></a>Ansible处理程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ vim handlers.yml</span><br><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  hosts: servera</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: latest</span><br><span class="line">  - name: Copy using inline content</span><br><span class="line">    ansible.builtin.copy:</span><br><span class="line">      content: <span class="string">&#x27;heihei&#x27;</span></span><br><span class="line">      dest: /var/www/html/index.html</span><br><span class="line">    notify: restart			<span class="comment">#notify字段冒号后的名称restart，指向handlers中的描述为restart的模块</span></span><br><span class="line">  - name: Start firewalld</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: firewalld</span><br><span class="line">      state: started</span><br><span class="line"></span><br><span class="line">  handlers:							<span class="comment">#handlers是缩进和tasks对齐</span></span><br><span class="line">  - name: restart</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: restarted</span><br></pre></td></tr></table></figure>

<h2 id="4-3-执行中对错误的处理"><a href="#4-3-执行中对错误的处理" class="headerlink" title="4.3 执行中对错误的处理"></a>4.3 执行中对错误的处理</h2><p>​       Ansible评估各任务的返回代码，从而确定任务是成功还是失败<br>​       通常而言，当任务失败时，ansible将立即在该主机上终止play的其余部分并且跳过所有后续任务<br>​       有些时候，可能希望即使在任务失败时也继续执行play</p>
<h3 id="ignore-errors"><a href="#ignore-errors" class="headerlink" title="ignore_errors"></a>ignore_errors</h3><p>忽略任务失败 ignore_errors</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">vim</span> <span class="string">ignore_errors.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">error</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">servera</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">touch</span> <span class="string">directory</span></span><br><span class="line">    <span class="attr">ansible.builtin.shell:</span> <span class="string">mkdir</span> <span class="string">/a/b</span></span><br><span class="line">    <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">the</span> <span class="string">user</span></span><br><span class="line">    <span class="attr">ansible.builtin.user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">johnd</span></span><br><span class="line">      </span><br><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">ansible-navigator</span> <span class="string">run</span> <span class="string">ignore_errors.yml</span> <span class="string">-m</span> <span class="string">stdout</span> <span class="string">--syntax-check</span></span><br><span class="line">[<span class="string">student@workstation</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">ansible-navigator</span> <span class="string">run</span> <span class="string">ignore_errors.yml</span> <span class="string">-m</span> <span class="string">stdout</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#也可以在任务失败时强制执行处理程序,详见教材</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">error</span></span><br><span class="line">  <span class="attr">force_handlers:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">xxxx</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">haha</span></span><br><span class="line">    <span class="attr">ansible.builtin.service:</span></span><br><span class="line">    <span class="string">xxx</span></span><br><span class="line">    <span class="string">xxx</span></span><br></pre></td></tr></table></figure>

<h2 id="4-4-Ansible块和错误的处理"><a href="#4-4-Ansible块和错误的处理" class="headerlink" title="4.4 Ansible块和错误的处理"></a>4.4 Ansible块和错误的处理</h2><h3 id="block、rescue、always-定义区域中失败的任务"><a href="#block、rescue、always-定义区域中失败的任务" class="headerlink" title="block、rescue、always 定义区域中失败的任务"></a>block、rescue、always 定义区域中失败的任务</h3><p>block:定义要运行的主要任务</p>
<p>rescue:定义要在block子句中定义的任务失败时运行的任务</p>
<p>always:定义始终都在独立运行的任务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">block</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span></span><br><span class="line">      <span class="attr">ansible.builtin.yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">rescue:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span></span><br><span class="line">      <span class="attr">ansible.builtin.yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">inventory_hostname</span> <span class="string">==</span> <span class="string">&#x27;serverb&#x27;</span></span><br><span class="line">    <span class="attr">always:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">service</span> <span class="string">httpd,</span> <span class="string">if</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line">      <span class="attr">ansible.builtin.service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Ansible官方文档：搜索：rescue https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html        </span></span><br></pre></td></tr></table></figure>

<h3 id="block示例"><a href="#block示例" class="headerlink" title="block示例"></a>block示例</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#未使用block时：</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">error</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">touch</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">ansible.builtin.shell:</span> <span class="string">mkdir</span>  <span class="string">-p</span> <span class="string">/a/b</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">inventory_hostname</span> <span class="string">==</span> <span class="string">&quot;servera&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">the</span> <span class="string">user</span></span><br><span class="line">    <span class="attr">ansible.builtin.user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">johnd</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">inventory_hostname</span> <span class="string">==</span> <span class="string">&quot;servera&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用block时</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">error</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">touch</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">ansible.builtin.shell:</span> <span class="string">mkdir</span>  <span class="string">-p</span> <span class="string">/a/b</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">the</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">ansible.builtin.user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">johnd</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">inventory_hostname</span> <span class="string">==</span> <span class="string">&quot;servera&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="5-将文件部署到受管主机"><a href="#5-将文件部署到受管主机" class="headerlink" title="5 将文件部署到受管主机"></a>5 将文件部署到受管主机</h1><h2 id="5-1-修改文件并将其复制到主机"><a href="#5-1-修改文件并将其复制到主机" class="headerlink" title="5.1 修改文件并将其复制到主机"></a>5.1 修改文件并将其复制到主机</h2><h3 id="文件模块介绍"><a href="#文件模块介绍" class="headerlink" title="文件模块介绍"></a>文件模块介绍</h3><p>1.在被管机上创建文件和目录</p>
<p>2.复制文件(或内容)到被管机   control –&gt; node1</p>
<p>3.从被管机复制文件到管理机  node1 –&gt; control</p>
<p>4.修改文件内容</p>
<p>5.查看文件状态</p>
<p>6.修改文件属性(所有者、权限、selinux)</p>
<p>7.文件同步</p>
<h4 id="ansible-builtin-描述文件模块"><a href="#ansible-builtin-描述文件模块" class="headerlink" title="ansible.builtin-描述文件模块"></a>ansible.builtin-描述文件模块</h4><table>
<thead>
<tr>
<th>模块名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>blockinfile</td>
<td>插入、更新 、删除，自定义标记的多行文本块</td>
</tr>
<tr>
<td>file</td>
<td>设置权限、所有者、SElinux上下文及常规文件、符号连接、硬链接等</td>
</tr>
<tr>
<td>copy</td>
<td>远程copy，类似file，可以设置文件属性、SElinux上下文</td>
</tr>
<tr>
<td>fetch</td>
<td>和copy类似，相反工作方式，从远端拷贝到控制节点</td>
</tr>
<tr>
<td>lineinfile</td>
<td>改文件某一行时使用</td>
</tr>
<tr>
<td>stat</td>
<td>检测文件状态，类似linux中stat命令</td>
</tr>
<tr>
<td>synchronize</td>
<td>围绕rsync一个打包程序</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查找模块可使用命令</span></span><br><span class="line">$ ansible-doc -l | grep file</span><br><span class="line">$ ansible-navigator collections -m stdout | grep file$</span><br><span class="line">$ ansible-doc file</span><br><span class="line"><span class="comment">#注意：很多模块已经不在ansible.builtin集合中了，所以需要通过ansible-navigator collections命令搜索。</span></span><br></pre></td></tr></table></figure>

<h4 id="ansible-builtin-file"><a href="#ansible-builtin-file" class="headerlink" title="ansible.builtin.file"></a>ansible.builtin.file</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- name: Change file ownership, group and permissions</span><br><span class="line">  ansible.builtin.file:</span><br><span class="line">    path: /var/www/html/index.html</span><br><span class="line">    owner: apache</span><br><span class="line">    group: apache</span><br><span class="line">    mode: <span class="string">&#x27;0644&#x27;</span></span><br><span class="line">    state: <span class="built_in">touch</span></span><br><span class="line">    setype: default_t</span><br><span class="line">      </span><br><span class="line"><span class="comment">#(Choices: absent, directory, file, hard, link, touch)[Default: file]</span></span><br><span class="line"><span class="comment">#file：修改文件内容，无该文件则不修改</span></span><br><span class="line"><span class="comment">#touch：创建文件</span></span><br><span class="line"><span class="comment">#touch，mkdir，cp，mv，rm，ln，chmod，chown，chcon</span></span><br></pre></td></tr></table></figure>

<h4 id="ansible-builtin-copy"><a href="#ansible-builtin-copy" class="headerlink" title="ansible.builtin.copy"></a>ansible.builtin.copy</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复制本机文件到受管节点</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">file</span> <span class="string">with</span> <span class="string">owner</span> <span class="string">and</span> <span class="string">permissions</span></span><br><span class="line">  <span class="attr">ansible.builtin.copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">/srv/myfiles/foo.conf</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/var/www/html/index.html</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">&#x27;0644&#x27;</span></span><br><span class="line">    <span class="attr">setype:</span>  <span class="string">httpd_sys_content_t</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#复制文本内容testweb至目标文件，文件不存在则创建  </span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">using</span> <span class="string">inline</span> <span class="string">content</span></span><br><span class="line">  <span class="attr">ansible.builtin.copy:</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">&quot;testweb&quot;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/var/www/html/index.html</span></span><br></pre></td></tr></table></figure>

<h4 id="ansible-builtin-lineinfile"><a href="#ansible-builtin-lineinfile" class="headerlink" title="ansible.builtin.lineinfile"></a>ansible.builtin.lineinfile</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ ansible-doc -l | grep line</span><br><span class="line">lineinfile                                     Manage lines <span class="keyword">in</span> text files</span><br><span class="line">[student@workstation ansible]$ ansible-doc lineinfile</span><br><span class="line">[student@workstation ansible]$ vim lineinfile.yml</span><br><span class="line">---</span><br><span class="line">- name: lineinfile</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Ensure SELinux is <span class="built_in">set</span> to enforcing mode</span><br><span class="line">    ansible.builtin.lineinfile:</span><br><span class="line">      path: /etc/selinux/config</span><br><span class="line">      regexp: <span class="string">&#x27;^SELINUX=&#x27;</span></span><br><span class="line">      line: SELINUX=enforcing</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run lineinfile.yml -m stdout --syntax-check</span><br><span class="line">playbook: /home/student/ansible/lineinfile.yml</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-navigator run lineinfile.yml -m stdout</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证:</span></span><br><span class="line">[student@workstation ansible]$ ansible servera -m shell -a <span class="string">&#x27;cat /etc/selinux/config&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#docs.ansible.com 搜索引擎中搜索：filters --- Using filters to --- 搜索admin---default(&#x27;admin&#x27;, true) </span></span><br></pre></td></tr></table></figure>

<h4 id="ansible-builtin-blockinfile"><a href="#ansible-builtin-blockinfile" class="headerlink" title="ansible.builtin.blockinfile"></a>ansible.builtin.blockinfile</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- name: Insert/Update HTML surrounded by custom markers after &lt;body&gt; line</span><br><span class="line">  ansible.builtin.blockinfile:</span><br><span class="line">    path: /opt/index.html</span><br><span class="line">    marker: &quot;&lt;!-- &#123;mark&#125; ANSIBLE MANAGED BLOCK --&gt;&quot;</span><br><span class="line">    insertafter: &quot;&lt;body&gt;&quot;</span><br><span class="line">    block: |</span><br><span class="line">      &lt;h1&gt;Welcome to &#123;&#123; ansible_hostname &#125;&#125;&lt;/h1&gt;</span><br><span class="line">      &lt;p&gt;Last updated on &#123;&#123; ansible_date_time.iso8601 &#125;&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<h4 id="ansible-builtin-template"><a href="#ansible-builtin-template" class="headerlink" title="ansible.builtin.template"></a>ansible.builtin.template</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- name: Template a file to /etc/files.conf</span><br><span class="line">  ansible.builtin.template:</span><br><span class="line">    src: /mytemplates/foo.j2</span><br><span class="line">    dest: /etc/file.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- name: Download foo.conf</span><br><span class="line">  ansible.builtin.get_url:   <span class="comment">#该模块可以将网络上的文件，直接下载至受管节点上。</span></span><br><span class="line">    url: http://materials/hosts.j2   <span class="comment">#源文件</span></span><br><span class="line">    dest: /opt/host.txt  <span class="comment">#目标文件位置</span></span><br></pre></td></tr></table></figure>

<h2 id="5-2-使用Jinja2模板部署自定义文件"><a href="#5-2-使用Jinja2模板部署自定义文件" class="headerlink" title="5.2 使用Jinja2模板部署自定义文件"></a>5.2 使用Jinja2模板部署自定义文件</h2><h3 id="jinja2简介"><a href="#jinja2简介" class="headerlink" title="jinja2简介"></a>jinja2简介</h3><p>​        ansible中可以使用jinja2模板对文件进行部署。再用template模块同步jinja2模板文件至受管节点。该模块和copy模块作用基本一样，都是把某个文件复制到被管主机上，但是区别在于template模块可以获取变量的值和使用循环。<br>​        1.管理文件通常会使用一些模块，copy，file，blockinfile，lineinfile<br>​        2.更好的配置文件管理方式是使用jinja2语法制作模板文件来生成最终使用的配置文件</p>
<p>​        3.jinja2模板文件内，可以通过多种方式编辑或构成，比如魔法变量、事实变量、普通字符、控制语句语法…<br>​        4.使用jinja2模板的方法是，先构建jinja2模板，再通过template模块将j2模板同步至受管节点</p>
<p>​        5.构建模板文件通常名称自定义，以.j2结尾，类似shell脚本的.sh、python脚本的.Py</p>
<h4 id="1-使用分隔符"><a href="#1-使用分隔符" class="headerlink" title="1 使用分隔符"></a>1 使用分隔符</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1、构建jinja2模板</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim jin.j2  <span class="comment">#文件名用.j2结尾</span></span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">&#123;# host file #&#125;    #描述，为管理员做提示作用。用户不可见</span><br><span class="line">haha &#123;&#123; ansible_hostname &#125;&#125;</span><br><span class="line"></span><br><span class="line">2、通过templete模块，同步模板文件至受管主机，同时收集事实变量值，将结果生成至相应文件中。</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim temp.yml</span></span><br><span class="line">---</span><br><span class="line">- name: sync file</span><br><span class="line">  hosts: servera</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Template a file to /etc/files.conf</span><br><span class="line">    ansible.builtin.template:</span><br><span class="line">      src: jin.j2</span><br><span class="line">      dest: /etc/myhosts</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ansible-navigator run temp.yml -m stdout</span></span><br><span class="line"></span><br><span class="line">3、在受管节点上查看文件结果</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ansible servera -m shell -a <span class="string">&#x27;cat /etc/myhosts&#x27;</span></span></span><br><span class="line">servera | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">haha</span><br><span class="line">servera heihei servera.lab.example.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-管理模版文件"><a href="#2-管理模版文件" class="headerlink" title="2 管理模版文件"></a>2 管理模版文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1、在配置文件中定义ansible_managed功能，添加描述信息：“Ansible hahaha”</span><br><span class="line">[greg@control ansible]$ vim ansible.cfg</span><br><span class="line">[defaults]</span><br><span class="line">ansible_managed = Ansible hahaha</span><br><span class="line">变量名 =  变量值</span><br><span class="line"></span><br><span class="line">2、在jinja2模板中调用该功能</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">vim jinja.j2</span></span><br><span class="line">&#123;# host file #&#125;     #&#123;##&#125;注释客户端生成文件是不显示</span><br><span class="line">&#123;&#123; ansible_managed &#125;&#125;  #&#123;&#123;&#125;&#125;描述，客户端生成文件时会显示</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br></pre></td></tr></table></figure>

<h3 id="控制结构-使用循环"><a href="#控制结构-使用循环" class="headerlink" title="控制结构-使用循环"></a>控制结构-使用循环</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-shell</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> `<span class="built_in">ls</span> /`;<span class="keyword">do</span> </span><br><span class="line">   <span class="built_in">echo</span> <span class="variable">$user</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">-jinja2</span><br><span class="line">&#123;% <span class="keyword">for</span> user <span class="keyword">in</span> <span class="built_in">users</span> %&#125;   <span class="comment">#user变量替换为users变量中的所有值，一行一个值。</span></span><br><span class="line">&#123;&#123; user &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line">$ vim jinja2.j2</span><br><span class="line">&#123;% <span class="keyword">for</span> host <span class="keyword">in</span> groups.all %&#125;  <span class="comment">#使用for 或if 时控制结构使用&#123;% %&#125;</span></span><br><span class="line">&#123;&#123; host &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看语法帮助:官网或关键词搜索示例</span></span><br><span class="line">[student@workstation ansible]$ grep -r <span class="string">&#x27;&#123;%&#x27;</span> /etc</span><br></pre></td></tr></table></figure>

<h4 id="1文件的生成方法"><a href="#1文件的生成方法" class="headerlink" title="1文件的生成方法"></a>1文件的生成方法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim debug.yml</span><br><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - ansible.builtin.debug:</span><br><span class="line">      var: hostvars</span><br><span class="line">$ ansible-navigator run debug.yml  -m stdout &gt; 1.txt</span><br></pre></td></tr></table></figure>

<h4 id="生成-etc-hosts"><a href="#生成-etc-hosts" class="headerlink" title="生成&#x2F;etc&#x2F;hosts"></a>生成&#x2F;etc&#x2F;hosts</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">$ vim /home/student/ansible/temp.yml</span><br><span class="line">127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1 localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line">&#123;% <span class="keyword">for</span> host <span class="keyword">in</span> groups.all %&#125;</span><br><span class="line">&#123;&#123; hostvars[host].ansible_default_ipv4.address &#125;&#125; &#123;&#123; hostvars[host].ansible_nodename &#125;&#125; &#123;&#123; hostvars[host].ansible_hostname &#125;&#125; </span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line">vim /home/student/ansible/temp.yml</span><br><span class="line">---</span><br><span class="line">- name: <span class="built_in">sync</span> file</span><br><span class="line">  hosts: all      <span class="comment">#一定要用all，因为要收集5台主机的事实变量</span></span><br><span class="line">  tasks:</span><br><span class="line">  - name: Template a file to /etc/files.conf</span><br><span class="line">    ansible.builtin.template:</span><br><span class="line">      src: hosts.j2</span><br><span class="line">      dest: /etc/myhosts</span><br><span class="line">    when: inventory_hostname <span class="keyword">in</span> groups.dev     <span class="comment">#匹配dev组</span></span><br><span class="line">    </span><br><span class="line">$ ansible-navigator run temp.yml -m stdout</span><br><span class="line">$ ansible  servera -m shell -a <span class="string">&#x27;cat /etc/myhosts&#x27;</span></span><br><span class="line">servera | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line">172.25.250.10 servera.lab.example.com servera</span><br><span class="line">172.25.250.11 serverb.lab.example.com serverb</span><br><span class="line">172.25.250.12 serverc.lab.example.com serverc</span><br><span class="line">172.25.250.13 serverd.lab.example.com serverd</span><br><span class="line"></span><br><span class="line">实验完毕</span><br><span class="line"></span><br><span class="line">[Discovering variables: facts and magic variables — Ansible Documentation](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_vars_facts.html)</span><br><span class="line"></span><br><span class="line">网站中查找关键字：facts  选择：Discovering variables: facts and magic variables   然后搜索hostvars[host]</span><br><span class="line"></span><br><span class="line">以json格式查看：</span><br><span class="line">&#123;&#123; hostvars[i][<span class="string">&#x27;ansible_facts&#x27;</span>] |  to_nice_json &#125;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6-管理大项目"><a href="#6-管理大项目" class="headerlink" title="6 管理大项目"></a>6 管理大项目</h1><h2 id="6-1-引用清单主机"><a href="#6-1-引用清单主机" class="headerlink" title="6.1 引用清单主机"></a>6.1 引用清单主机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">使用主机模式的常见方式：</span><br><span class="line"></span><br><span class="line">1.[ad-hoc:]</span><br><span class="line">ansible dev -m shell </span><br><span class="line"></span><br><span class="line">2.[playbook:]</span><br><span class="line">- name:</span><br><span class="line">  hosts: dev</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1 清单里使用通配符匹配多个主机</span><br><span class="line">[START:END]</span><br><span class="line">192.168.[0:15].[0:255] 表示 192.168.0.0-192.168.15.255</span><br><span class="line">server[a:c].example.com  表示   a-c</span><br><span class="line">server[01:15].example.com  表示   server01.example.com-server15</span><br><span class="line">ipv6也可以通过[a:f]这种方式</span><br><span class="line">all： 所有主机</span><br><span class="line">ungrouped ： 不属于任何一个组的所有主机</span><br><span class="line"></span><br><span class="line">2 主机模式其他方式</span><br><span class="line">hosts： all</span><br><span class="line">hosts： ungrouped</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用特殊字符时，必须添加单引号，否则不生效</span></span><br><span class="line">hosts： <span class="string">&#x27;*&#x27;</span>  和all相同   </span><br><span class="line">hosts：<span class="string">&#x27;*.example.com&#x27;</span></span><br><span class="line">hosts：<span class="string">&#x27;datacenter*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#列表形式</span></span><br><span class="line">hosts：servera,serverb  </span><br><span class="line">hosts：webserver,serverc</span><br><span class="line">hosts：<span class="string">&#x27;devops,server*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#冒号：取代逗号</span></span><br><span class="line">hosts：lab,&amp;datacenter 匹配lab组同时也属于datacenter组，顺序无所谓&amp;符号时同时也属于的意思</span><br><span class="line">hosts：datacenter,!test2.example.com  表示datacenter组，但不包括test2.。。这个主机</span><br><span class="line">hosts：all,!datacenter1  所有组，但不包含datacenter1组</span><br></pre></td></tr></table></figure>

<h2 id="6-2-包含和导入文件"><a href="#6-2-包含和导入文件" class="headerlink" title="6.2 包含和导入文件"></a>6.2 包含和导入文件</h2><h3 id="管理大型Playbook"><a href="#管理大型Playbook" class="headerlink" title="管理大型Playbook"></a>管理大型Playbook</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">如果playbook很长很复杂，可以拆分成较小的文件便于管理，以模块化管理，可以将多个不同功能的play，组合成一个主要的playbook，将文件中的任务列表插入play，这样可以将这种模块化的play应用到不同场景。</span><br><span class="line"></span><br><span class="line">playbook</span><br><span class="line">- httpd</span><br><span class="line">- php</span><br><span class="line">- mysql</span><br></pre></td></tr></table></figure>

<h4 id="1-导入Playbook"><a href="#1-导入Playbook" class="headerlink" title="1.导入Playbook"></a>1.导入Playbook</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">1.将两个playbook加入到主playbook</span><br><span class="line">$ vim one.yml </span><br><span class="line">---</span><br><span class="line">- name: play1</span><br><span class="line">  hosts: node1</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: latest</span><br><span class="line">      </span><br><span class="line">$ vim two.yml      </span><br><span class="line">---</span><br><span class="line">- name: play2</span><br><span class="line">  hosts: node1</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Make sure a service unit is running</span><br><span class="line">    ansible.builtin.systemd:</span><br><span class="line">      state: started</span><br><span class="line">      name: httpd</span><br><span class="line">      enabled: <span class="built_in">yes</span></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">2.在主playbook中和其他play交替使用</span><br><span class="line">$ vim main.yml </span><br><span class="line">---</span><br><span class="line">- name: four</span><br><span class="line">  hosts: node1</span><br><span class="line">  tasks:</span><br><span class="line">  - ansible.builtin.debug:</span><br><span class="line">      msg: haha</span><br><span class="line">  </span><br><span class="line">- name: one  因为加载的是playbook所以需要顶头写无缩进。</span><br><span class="line">  import_playbook: one.yml</span><br><span class="line"></span><br><span class="line">- name: two</span><br><span class="line">  import_playbook: two.yml</span><br></pre></td></tr></table></figure>

<h3 id="包含与导入"><a href="#包含与导入" class="headerlink" title="包含与导入"></a>包含与导入</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Ansible可以支持两种方法将文件放入playbook中：</span></span><br><span class="line"><span class="string">包含：内容是一个动态操作。在playbook运行期间，Ansible会在内容到达时处理所包含的内容。</span></span><br><span class="line"><span class="string">导入：内容是一个静态操作。在运行开始之前，Ansible在最初解析playbook时预处理导入的内容。</span></span><br></pre></td></tr></table></figure>

<h4 id="1-包含和导入"><a href="#1-包含和导入" class="headerlink" title="1.包含和导入"></a>1.包含和导入</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">包含：</span><br><span class="line">1.使用include_tasks功能时，包含时设置的when等条件语句将确定任务是否包含在play中</span><br><span class="line">2.如果运行ansible-playbook --list-tasks以列出playbook中的任务，则不会显示已包含任务文件中的任务。将显示包含任务文件的任务。相比之下，import_tasks功能不会列出导入任务文件的任务，而列出已导入任务文件中的各个任务</span><br><span class="line"><span class="comment">#（[greg@control ansible]$ ansible-playbook playbook.yml --start-at-task webserver）</span></span><br><span class="line">3.不能使用ansible-playbook --start-at-task从已包含任务文件中的任务开始执行playbook</span><br><span class="line"><span class="comment">#（[greg@control ansible]$ ansible-playbook playbook.yml --start-at-task webinstall）</span></span><br><span class="line">4.不能使用notify语句触发已包含任务文件中的处理程序名称。可以在包含整个任务文件的主playbook中触发处理程序，在这种情况下，已包含文件中的所有任务都将运行</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">导入：</span><br><span class="line">1.使用import_tasks功能时，导入时设置的when等条件语句将应用于导入的每个任务</span><br><span class="line">2.无法将循环用于import_tasks功能</span><br><span class="line">3.如果使用变量来指定要导入的文件的名称，则将无法使用主机或组清单变量</span><br></pre></td></tr></table></figure>

<h4 id="2-示例"><a href="#2-示例" class="headerlink" title="2.示例"></a>2.示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">第一个tasks任务</span><br><span class="line">[greg@bastion ansible]$ <span class="built_in">mkdir</span> tasks    <span class="comment">#tasks目录是自定义的，创建的目的只是方便存储管理tasks任务文件。</span></span><br><span class="line">[greg@bastion ansible]$ vim tasks/apache.yml  <span class="comment">#tasks任务文件，文件中没有主机模式</span></span><br><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  ansible.builtin.yum:</span><br><span class="line">    name: httpd</span><br><span class="line">    state: latest</span><br><span class="line">第二个tasks任务</span><br><span class="line">[greg@bastion ansible]$ vim tasks/service.yml </span><br><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  ansible.builtin.service:</span><br><span class="line">    name: httpd</span><br><span class="line">    enabled: <span class="built_in">yes</span></span><br><span class="line">    state: started</span><br><span class="line">  </span><br><span class="line">包含和导入的方式：</span><br><span class="line">[greg@bastion ansible]$ vim main.yml   <span class="comment">#此处main.yml是一个playbook，有主机模式</span></span><br><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  hosts: node1</span><br><span class="line">  tasks:</span><br><span class="line">  - include_tasks: tasks/apache.yml  </span><br><span class="line">  - import_tasks: tasks/service.yml</span><br></pre></td></tr></table></figure>

<h1 id="7-使用角色和Ansible-collections简化Playbook"><a href="#7-使用角色和Ansible-collections简化Playbook" class="headerlink" title="7 使用角色和Ansible collections简化Playbook"></a>7 使用角色和Ansible collections简化Playbook</h1><h2 id="7-1-描述角色结构"><a href="#7-1-描述角色结构" class="headerlink" title="7.1 描述角色结构"></a>7.1 描述角色结构</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ansible中的角色，一个角色是一个结构化的目录组成，可以根据业务需要创建不同的角色，apache的、mysql的等</span></span><br><span class="line"><span class="comment"># 角色的优势是类似将playbook分割成更小的模块，进行模块化管理，简化playbook</span></span><br><span class="line"><span class="comment"># 除了自行编写、使用、重用和共享角色外，您也可以从其他来源获取角色。您可以使用分发包(如Ansible内容集合)查找角色</span></span><br></pre></td></tr></table></figure>

<h2 id="7-2-创建角色"><a href="#7-2-创建角色" class="headerlink" title="7.2 创建角色"></a>7.2 创建角色</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在playbook的项目目录中创建一个角色，并将其作为playbook中某个play的一部分来运行</span><br><span class="line">1.yum install -y httpd            yum模块</span><br><span class="line">2.index.html, fcontext            copy模块</span><br><span class="line">3.httpd service                   service模块</span><br><span class="line">4.firewalld.service               service模块</span><br><span class="line">5.firewalld permit apache         firewalld模块</span><br><span class="line"><span class="comment"># 使用web角色一键部署以上服务</span></span><br></pre></td></tr></table></figure>

<h3 id="角色创建流程"><a href="#角色创建流程" class="headerlink" title="角色创建流程"></a>角色创建流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">创建和使用角色分四步进行:</span><br><span class="line">1.创建角色目录存储路径</span><br><span class="line">2.创建角色</span><br><span class="line">3.定义角色内容</span><br><span class="line">4.在playbook中使用角色</span><br></pre></td></tr></table></figure>

<h4 id="1-创建角色目录存储路径"><a href="#1-创建角色目录存储路径" class="headerlink" title="1.创建角色目录存储路径"></a>1.创建角色目录存储路径</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置ansible.cfg文件中的roles-path,默认ansible会在roles子目录中查找角色</span></span><br><span class="line"><span class="comment">#可以将自己的角色安装在~/ansible/roles子目录中</span></span><br><span class="line">1.默认路径：</span><br><span class="line">[student@workstation ansible]$ ansible-galaxy --<span class="built_in">help</span></span><br><span class="line">positional arguments:</span><br><span class="line">  TYPE</span><br><span class="line">    collection   Manage an Ansible Galaxy collection.</span><br><span class="line">    role         Manage an Ansible Galaxy role.</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-galaxy role --<span class="built_in">help</span>    <span class="comment">#查看角色的子命令帮助</span></span><br><span class="line">positional arguments:</span><br><span class="line">  ROLE_ACTION</span><br><span class="line">    init       Initialize new role with the base structure of a role.</span><br><span class="line">    remove     Delete roles from roles_path.</span><br><span class="line">    delete     Removes the role from Galaxy. It does not remove or alter the actual GitHub repository.</span><br><span class="line">    list       Show the name and version of each role installed <span class="keyword">in</span> the roles_path.</span><br><span class="line">    search     Search the Galaxy database by tags, platforms, author and multiple keywords.</span><br><span class="line">    import     Import a role into a galaxy server</span><br><span class="line">    setup      Manage the integration between Galaxy and the given <span class="built_in">source</span>.</span><br><span class="line">    info       View more details about a specific role.</span><br><span class="line">    install    Install role(s) from file(s), URL(s) or Ansible Galaxy</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-galaxy role list     <span class="comment">#新版本查看角色指令</span></span><br><span class="line">[student@workstation ansible]$ ansible-galaxy list		   <span class="comment">#旧版本查看角色指令</span></span><br><span class="line"><span class="comment"># /usr/share/ansible/roles   -- 系统角色</span></span><br><span class="line"><span class="comment"># /etc/ansible/roles         -- 全局角色路径</span></span><br><span class="line">[WARNING]: - the configured path /home/student/.ansible/roles does not exist.  --默认该目录不存在，需要的话可以根据需求创建</span><br><span class="line">`如果ansible无法找到该位置角色，会按照ansible.cfg中roles_path指定的目录中查找`</span><br><span class="line"></span><br><span class="line">1.创建角色目录存储路径</span><br><span class="line">  使用自定义工作目录时，创建自定义roles(角色)目录，并使用ansible.cfg中roles_path=字段指定角色路径</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">pwd</span>    <span class="comment">#进入自己的工作目录</span></span><br><span class="line">/home/student/ansible</span><br><span class="line"></span><br><span class="line">[student@control ansible]$ <span class="built_in">mkdir</span> roles    <span class="comment">#创建存放角色的目录</span></span><br><span class="line"></span><br><span class="line">[student@control ansible]$ vim ansible.cfg   </span><br><span class="line">roles_path=/home/student/ansible/roles   <span class="comment">#指定角色路径</span></span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-galaxy list    <span class="comment">#一定要在工作目录中使用查看命令，调用当前工作目录配置文件中的角色路径</span></span><br><span class="line"><span class="comment"># /home/student/ansible/roles                         #查询结果应和配置文件的roles_path字段一致   </span></span><br></pre></td></tr></table></figure>

<h4 id="2-创建角色"><a href="#2-创建角色" class="headerlink" title="2.创建角色"></a>2.创建角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[student@workstation ansible]$ ansible-galaxy role init roles/apache    <span class="comment">#创建角色</span></span><br><span class="line">- Role roles/apache was created successfully</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-galaxy role list   <span class="comment">#列出所有角色</span></span><br><span class="line"><span class="comment"># /home/student/ansible/roles</span></span><br><span class="line">- apache, (unknown version)</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ tree roles/apache/</span><br><span class="line">roles/apache</span><br><span class="line">├── defaults                  <span class="comment">#角色默认变量</span></span><br><span class="line">│   └── main.yml</span><br><span class="line">├── files                     <span class="comment">#引用的静态文件，可以是一些文件、网页模板等</span></span><br><span class="line">├── handlers                  <span class="comment">#处理程序，通常通过模块完成的</span></span><br><span class="line">│   └── main.yml</span><br><span class="line">├── meta                      <span class="comment">#作者，许可、兼容性</span></span><br><span class="line">│   └── main.yml</span><br><span class="line">├── README.md</span><br><span class="line">├── tasks                     <span class="comment">#任务，任务的组成就是模块应用，也是角色的主要功能</span></span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates                 <span class="comment">#模板文件，通常使用jinja2模板</span></span><br><span class="line">├── tests                     <span class="comment">#测试</span></span><br><span class="line">│   ├── inventory</span><br><span class="line">│   └── test.yml</span><br><span class="line">└── vars                      <span class="comment">#角色变量</span></span><br><span class="line">    └── main.yml</span><br><span class="line"></span><br><span class="line">8 directories, 8 files</span><br><span class="line"><span class="comment">#用不到的目录可以删除，如defaults、vars、tests</span></span><br></pre></td></tr></table></figure>

<h4 id="3-定义角色内容"><a href="#3-定义角色内容" class="headerlink" title="3.定义角色内容"></a>3.定义角色内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[student@control ansible]$ tree roles/apache (可选，方便查看路径信息)</span><br><span class="line">*[student@control ansible]$ vim roles/apache/tasks/main.yml   <span class="comment">#在tasks目录中完善角色内容</span></span><br><span class="line">---</span><br><span class="line">- name: install apache     <span class="comment">#编写角色时，任务中只有模块任务，没有PLAY</span></span><br><span class="line">  ansible.builtin.yum:</span><br><span class="line">    name: httpd</span><br><span class="line">    state: latest</span><br><span class="line">- name: Start service httpd</span><br><span class="line">  ansible.builtin.service:</span><br><span class="line">    name: httpd</span><br><span class="line">    state: started</span><br><span class="line">    enabled: <span class="built_in">yes</span></span><br><span class="line">- name: create web page</span><br><span class="line">  ansible.builtin.template:</span><br><span class="line">    src: jin2.j2    <span class="comment">#jin2.j2需要手动创建</span></span><br><span class="line">    dest: /var/www/html/index.html</span><br><span class="line">  notify:</span><br><span class="line">  - restart   <span class="comment">#需要时将调用handlers处理程序，需要手动创建，restart通知中的处理程序名要和handlers/main.yml中处理程序描述一致</span></span><br><span class="line">- name: Start service firewalld</span><br><span class="line">  ansible.builtin.service:</span><br><span class="line">    name: firewalld</span><br><span class="line">    state: started</span><br><span class="line">    enabled: <span class="built_in">yes</span></span><br><span class="line">    </span><br><span class="line">- name: permit apache</span><br><span class="line">  ansible.posix.firewalld:    </span><br><span class="line">    service: http</span><br><span class="line">    permanent: <span class="built_in">yes</span></span><br><span class="line">    state: enabled</span><br><span class="line">    immediate: <span class="built_in">yes</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#ansible-navigator collections可以查看posix集合 </span></span><br><span class="line"><span class="comment">#ansible-navigator doc ansible.posix.firewalld -m stdout </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#以上25-30行客替换为如下:</span></span><br><span class="line">- name: permit apache</span><br><span class="line">  ansible.builtin.shell: firewall-cmd --permanent --add-service=http  </span><br><span class="line">- name: permit apache</span><br><span class="line">  ansible.builtin.shell: firewall-cmd --reload</span><br><span class="line">      </span><br><span class="line">[student@control ansible]$ vim roles/apache/templates/jin2.j2  <span class="comment">#编写模板文件</span></span><br><span class="line">ipadd=&#123;&#123; ansible_default_ipv4.address &#125;&#125;  hostname=&#123;&#123; ansible_hostname &#125;&#125;</span><br><span class="line"></span><br><span class="line">[student@control ansible]$ vim roles/apache/handlers/main.yml   <span class="comment">#编写处理程序</span></span><br><span class="line">---</span><br><span class="line">- name: restart </span><br><span class="line">  ansible.builtin.service:</span><br><span class="line">    name: httpd</span><br><span class="line">    state: restarted</span><br></pre></td></tr></table></figure>

<h4 id="4-在playbook中使用角色"><a href="#4-在playbook中使用角色" class="headerlink" title="4.在playbook中使用角色"></a>4.在playbook中使用角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[student@bastion ansible]$ vim roles.yml</span><br><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  hosts: servera</span><br><span class="line">  roles:     <span class="comment">#roles字段用来调用角色</span></span><br><span class="line">  - apache   <span class="comment">#被调用角色的名称</span></span><br><span class="line">  - xxx</span><br><span class="line">[student@bastion ansible]$ ansible-navigator run -m stdout roles.yml  </span><br><span class="line">[student@control ansible]$ curl servera</span><br><span class="line">ipadd=172.25.250.10  hostname=servera</span><br></pre></td></tr></table></figure>

<h2 id="7-3-从外部内容源部署角色"><a href="#7-3-从外部内容源部署角色" class="headerlink" title="7.3 从外部内容源部署角色"></a>7.3 从外部内容源部署角色</h2><p>​        从Git存储库或AnsibleGalaxy 等外部资源中选择和检索角色，并在playbook中使用</p>
<p>​       <a target="_blank" rel="noopener" href="https://galaxy.ansible.com/">https://galaxy.ansible.com</a></p>
<h4 id="1-外部内容来源"><a href="#1-外部内容来源" class="headerlink" title="1.外部内容来源"></a>1.外部内容来源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">角色有多种获取方式：</span><br><span class="line">本地tar包安装</span><br><span class="line">通过网络地址安装</span><br><span class="line">通过文件同时安装网络中多个地址角色（本课介绍）</span><br><span class="line"></span><br><span class="line">roles/requirements.yml</span><br><span class="line">- src： <span class="comment">#角色网址</span></span><br><span class="line">  varsion：#角色版本</span><br><span class="line">  name：#安装在本地的角色名</span><br><span class="line">- src：</span><br><span class="line">  name：</span><br><span class="line"></span><br><span class="line">ansible-galaxy role install -r roles/requirements.yml -p roles</span><br><span class="line">-r 指定文件路径</span><br><span class="line">-p 指定角色安装路径</span><br><span class="line">roles/requirements.yml  角色安装信息，包括地址，角色名称等。</span><br></pre></td></tr></table></figure>

<p>练习</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#软件包参考班级群看板资料里：</span></span><br><span class="line"></span><br><span class="line">1.将phpinfo.tar,haproxy.tar上传到Linux，kiosk家目录下，用kiosk登录</span><br><span class="line">2.将两个角色包拷贝到foundation0的rhel9.0目录中</span><br><span class="line">$ ssh root@localhost <span class="built_in">cp</span> /home/kiosk/&#123;phpinfo.tar,haproxy.tar&#125; /content/courses/rh294/rhel9.0/materials</span><br><span class="line">3.打开foundation0的浏览器输入http://172.25.254.254/materials/就可以看到两个软件包</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实验：</span><br><span class="line">[student@workstation ansible]$ <span class="built_in">mkdir</span> roles</span><br><span class="line">[student@workstation ansible]$ $ vim ansible.cfg</span><br><span class="line">[defaults]</span><br><span class="line">roles_path=/home/student/ansible/roles</span><br><span class="line">[student@workstation ansible]$ vim roles/requirements.yml</span><br><span class="line">---</span><br><span class="line">- src: http://172.25.254.254/materials/haproxy.tar</span><br><span class="line">  name: balancer</span><br><span class="line">- src: http://172.25.254.254/materials/phpinfo.tar</span><br><span class="line">  name: phpinfo</span><br><span class="line"></span><br><span class="line">[student@workstation ansible]$ ansible-galaxy install -r roles/requirements.yml </span><br><span class="line">[student@workstation ansible]$ ansible-galaxy list</span><br><span class="line"><span class="comment"># /home/student/ansible/roles</span></span><br><span class="line">- apache, (unknown version)</span><br><span class="line">- balancer, (unknown version)</span><br><span class="line">- phpinfo, (unknown version)</span><br></pre></td></tr></table></figure>

<h2 id="7-4-从内容集合获取角色和模块"><a href="#7-4-从内容集合获取角色和模块" class="headerlink" title="7.4 从内容集合获取角色和模块"></a>7.4 从内容集合获取角色和模块</h2><p>​      从Ansible 内容集合中获取一组相关角色、补充模块和其他内容，并在playbook中使用</p>
<h3 id="Ansible内容集合"><a href="#Ansible内容集合" class="headerlink" title="Ansible内容集合"></a>Ansible内容集合</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#随着模块数量增加，管理困难。模块需要唯一名称，并保持更新。</span></span><br><span class="line"><span class="comment">#借助Ansible内容集合，Ansible代码可以与模块和插件分开更新</span></span><br><span class="line"><span class="comment">#Ansible 内容集合可提供一组您可在您的playbook中使用的相关模块、角色和其他插件。这种方法便于供应商和开发人员按照自己的节奏维护和分发集合，而不受Ansible版本的影响</span></span><br></pre></td></tr></table></figure>

<h4 id="1-Ansible内容集合的命名空间"><a href="#1-Ansible内容集合的命名空间" class="headerlink" title="1.Ansible内容集合的命名空间"></a>1.Ansible内容集合的命名空间</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#命名空间是集合名称的第一部分。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#由Ansible社区维护的所有集合可能会放入community命名空间中名称类似于:</span></span><br><span class="line"> community.crypto</span><br><span class="line"> community.postgresql</span><br><span class="line"> community.rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment">#红帽直接维护和支持的Ansible内容集合可能使用redhat命名空间有</span></span><br><span class="line">redhat.rhv</span><br><span class="line">redhat.satellite</span><br><span class="line">redhat.insights等名称</span><br></pre></td></tr></table></figure>

<h4 id="2-选择Ansible内容集合的来源"><a href="#2-选择Ansible内容集合的来源" class="headerlink" title="2.选择Ansible内容集合的来源"></a>2.选择Ansible内容集合的来源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">无论您是将ansible-navigator 用于最小自动化执行环境，还是在裸机Ansible Core上使用ansible-playbook，您始终至少有一个可用Ansible内容集合:ansible.builtin。</span><br><span class="line"></span><br><span class="line">此外，您的自动化执行环境可能还内置了其他自动化执行环境，例如，红帽Ansible 自动化平台2.2使用的默认执行环境ee-supported-rhel8。</span><br><span class="line"></span><br><span class="line">如果您需要其他Ansible内容集合，可以将其添加到Ansible 项目的collections 子目录中。您可以从多个来源获取Ansible内容集合:</span><br><span class="line"></span><br><span class="line">自动化中心</span><br><span class="line">私有自动化中心</span><br><span class="line">Ansible Galaxy</span><br><span class="line">第三方Git存储库或存档文件</span><br></pre></td></tr></table></figure>

<h4 id="3-安装Ansible内容集合"><a href="#3-安装Ansible内容集合" class="headerlink" title="3.安装Ansible内容集合"></a>3.安装Ansible内容集合</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible配置文件ansible.cfg中设置了collections_paths选项来指定集合的默认路径：</span><br><span class="line">~/.ansible/collections;/usr/share/ansible/collections 如果消除这两个目录的指定，则ansible-navigator 无法在这些目录的其版本中找到自动化执行环境内提供的Ansible内容集合。</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-galaxy collection install 集合 -p collections</span><br><span class="line"></span><br><span class="line">-p collections 选项会将该集合安装到本地collections 子目录中。或者不适用-p，而在ansible.cfg文件中collections_paths选项来指定集合的默认路径</span><br><span class="line"></span><br><span class="line">集合的来源可以是：</span><br><span class="line">本地  </span><br><span class="line">互联网</span><br><span class="line">git仓库</span><br></pre></td></tr></table></figure>

<h4 id="4-使用要求文件安装Ansible内容集合"><a href="#4-使用要求文件安装Ansible内容集合" class="headerlink" title="4.使用要求文件安装Ansible内容集合"></a>4.使用要求文件安装Ansible内容集合</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1.将三个集合包上传到Linux，kiosk家目录下，用kiosk登录</span><br><span class="line">2.将三个集合包拷贝到foundation0的rhel9.0目录中</span><br><span class="line">$ ssh root@localhost <span class="built_in">cp</span> /home/kiosk/&#123;community-general-5.5.0.tar.gz,redhat-insights-1.0.7.tar.gz,redhat-rhel_system_roles-1.19.3.tar.gz&#125; /content/courses/rh294/rhel9.0/materials</span><br><span class="line">3.打开foundation0的浏览器输入http://172.25.254.254/materials/就可以看到两个软件包</span><br><span class="line"></span><br><span class="line">-------------------------</span><br><span class="line">【workstation】</span><br><span class="line">1.创建存储集合的位置</span><br><span class="line">$ <span class="built_in">mkdir</span> /home/student/ansible/mycollections  </span><br><span class="line">$ vim ansible.cfg</span><br><span class="line">[defaults]</span><br><span class="line">...  </span><br><span class="line"><span class="comment">#集合默认路径不删除，额外添加当前用户工作目录中集合路径</span></span><br><span class="line">collections_path=/home/student/ansible/mycollection:~/.ansible/collections:/usr/share/ansible/collections </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.部署requirements.yml文件</span><br><span class="line">$ vim /home/student/ansible/mycollections/requirements.yml</span><br><span class="line">---</span><br><span class="line">collections:</span><br><span class="line">- name: http://172.25.254.254/materials/community-general-5.5.0.tar.gz</span><br><span class="line">- name: http://172.25.254.254/materials/redhat-insights-1.0.7.tar.gz</span><br><span class="line">- name: http://172.25.254.254/materials/redhat-rhel_system_roles-1.19.3.tar.gz</span><br><span class="line"></span><br><span class="line">3.安装集合</span><br><span class="line">$ ansible-galaxy collection install -r requirements.yml -p /home/student/ansible/collections/mycollections</span><br><span class="line">$ ansible-galaxy collection list</span><br></pre></td></tr></table></figure>

<h2 id="7-5-利用系统角色重用内容"><a href="#7-5-利用系统角色重用内容" class="headerlink" title="7.5 利用系统角色重用内容"></a>7.5 利用系统角色重用内容</h2><p>​        编写利用红帽帽企业Linux的系统角色执行标准操作的 playbook</p>
<h3 id="系统角色"><a href="#系统角色" class="headerlink" title="系统角色"></a>系统角色</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># linux6时间服务ntpd，linux7，chronyd，管理员必须配置两个服务，如果用系统角色system-roles.timesync角色就可以配置6、7的时间同步</span></span><br></pre></td></tr></table></figure>

<h4 id="1-内容集合方式安装系统角色"><a href="#1-内容集合方式安装系统角色" class="headerlink" title="1.内容集合方式安装系统角色"></a>1.内容集合方式安装系统角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#角色以两种形式提供：</span></span><br><span class="line"></span><br><span class="line">1.内容集合 redhat.rhel_system_roles</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">mkdir</span> /home/student/ansible/collections</span><br><span class="line">$ vim /home/student/ansible/collections/requirements.yml</span><br><span class="line">---</span><br><span class="line">collections</span><br><span class="line">name: redhat.rhel system roles</span><br><span class="line"></span><br><span class="line">$ ansible-galaxy collection install -p collections/ -r home/student/ansible/collections/requirements.yml</span><br><span class="line"></span><br><span class="line">此处可以通过文件安装，也可通过直接指定本地tar包安装，可以参考教材练习</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> find ./mycollection/ -name  selinux-playbook.yml <span class="comment">#不安装角色包可以使用该条命令搜索</span></span><br><span class="line">$ find mycollection/ -name <span class="string">&#x27;*.yml&#x27;</span> | grep selinux</span><br><span class="line">$ <span class="built_in">cp</span> /usr/share/ansible/collections/ansible_collections/redhat/rhel_system_roles/docs/selinux/selinux-playbook.yml /home/student/ansible/selinux.yml</span><br></pre></td></tr></table></figure>

<h4 id="2-rpm包方式安装系统角色"><a href="#2-rpm包方式安装系统角色" class="headerlink" title="2.rpm包方式安装系统角色"></a>2.rpm包方式安装系统角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">系统角色使用流程</span><br><span class="line">1.通过软件安装获得系统角色（rhel-system-roles.noarch）</span><br><span class="line">2.定义系统角色路径（存放角色的位置），并将其记录配置文件</span><br><span class="line"><span class="built_in">cd</span> /;ansible-galaxy list   , vim ~/ansible/ansible.cfg/;roles_path=xxxx:xxxx</span><br><span class="line">3.使用系统角色，将系统角色添加至playbook，并修改内容</span><br><span class="line">4.应用</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.安装</span><br><span class="line">系统帮助我们定义了一些角色，有不同的功能，需要通过安装软件包。</span><br><span class="line">[greg@control ansible]$ <span class="built_in">cd</span> /</span><br><span class="line">[greg@control /]$ <span class="built_in">sudo</span> yum search roles</span><br><span class="line">[greg@control /]$ <span class="built_in">sudo</span> yum install -y rhel-system-roles.noarch     </span><br><span class="line">[greg@control /]$ ansible-galaxy list    <span class="comment">#在根目录下查看角色路径，该路径为默认系统角色路径</span></span><br><span class="line"><span class="comment"># /usr/share/ansible/roles     #系统角色路径</span></span><br><span class="line">- linux-system-roles.kdump, (unknown version)</span><br><span class="line">....</span><br><span class="line">- rhel-system-roles.timesync, (unknown version)</span><br><span class="line"><span class="comment"># /etc/ansible/roles</span></span><br><span class="line"> [WARNING]: - the configured path /home/greg/.ansible/roles does not exist.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2.定义角色路径</span><br><span class="line">[greg@control /]$ <span class="built_in">cd</span> ~/ansible/   <span class="comment">#在ansible工作目录中查看时属于greg用户定制的角色路径</span></span><br><span class="line">[greg@control ansible]$ vim ansible.cfg</span><br><span class="line">roles_path    = /home/greg/ansible/roles:/usr/share/ansible/roles <span class="comment">#:冒号分割，并添加系统角色路径</span></span><br><span class="line">[greg@control ansible]$ ansible-galaxy list</span><br><span class="line"><span class="comment"># /home/greg/ansible/roles						#之前定义好的自定义角色路径</span></span><br><span class="line">- apache, (unknown version)</span><br><span class="line"><span class="comment"># /usr/share/ansible/roles  					#系统角色路径</span></span><br><span class="line">- linux-system-roles.kdump, (unknown version)</span><br><span class="line">......</span><br><span class="line">- rhel-system-roles.timesync, (unknown version)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">3.使用系统角色，将系统角色添加至playbook并应用</span><br><span class="line">[greg@control ansible]$ rpm -ql rhel-system-roles.noarch | grep timesync <span class="comment">#看README.md</span></span><br><span class="line">[greg@control ansible]$ <span class="built_in">cp</span> /usr/share/doc/rhel-system-roles/timesync/example-timesync-playbook.yml /home/greg/ansible/timesync.yml   <span class="comment">#找例子，并复制到工作目录中</span></span><br><span class="line">[greg@control ansible]$ vim timesync.yml 	 <span class="comment">#编辑角色</span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  vars:</span><br><span class="line">    timesync_ntp_servers:</span><br><span class="line">      - hostname: 172.25.254.254</span><br><span class="line">        iburst: <span class="built_in">yes</span></span><br><span class="line">  roles:</span><br><span class="line">    - rhel-system-roles.timesync</span><br><span class="line"></span><br><span class="line">4 使用系统角色</span><br><span class="line">[greg@control ansible]$ ansible-playbook timesync.yml</span><br><span class="line"></span><br><span class="line">查询验证</span><br><span class="line">ansible all -a <span class="string">&#x27;chronyc sources -v&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="通过内容集合安装使用系统角色"><a href="#通过内容集合安装使用系统角色" class="headerlink" title="通过内容集合安装使用系统角色"></a>通过内容集合安装使用系统角色</h3><h4 id="1-timesync"><a href="#1-timesync" class="headerlink" title="1.timesync"></a>1.timesync</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cp</span> /usr/share/ansible/collections/ansible_collections/redhat/rhel_system_roles/docs/timesync/multiple-ntp-servers.yml  timesync.yml</span><br><span class="line">$ vim timesync.yml</span><br><span class="line">- hosts: all</span><br><span class="line">  vars:</span><br><span class="line">    timesync_ntp_servers:</span><br><span class="line">      - hostname: 172.25.254.254</span><br><span class="line">        iburst: <span class="built_in">yes</span></span><br><span class="line">  roles:</span><br><span class="line">    - redhat.rhel_system_roles.timesync</span><br><span class="line">$ ansible-navigator run timesync.yml -m stdout</span><br><span class="line">$ ansible all -m shell -a <span class="string">&#x27;chronyc sources -v &#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-selinux"><a href="#2-selinux" class="headerlink" title="2.selinux"></a>2.selinux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cp</span> /usr/share/ansible/collections/ansible_collections/redhat/rhel_system_roles/docs/selinux/selinux-playbook.yml selinux.yml</span><br><span class="line">$ vim selinux.yml</span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  vars:</span><br><span class="line">    selinux_policy: targeted</span><br><span class="line">    selinux_state: permissive</span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">  - redhat.rhel_system_roles.selinux</span><br><span class="line">$ ansible-navigator run selinux.yml  -m stdout</span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">$ ansible all -m shell -a <span class="string">&#x27;grep ^SELINUX= /etc/selinux/config&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="7-6-通过文件安装角色"><a href="#7-6-通过文件安装角色" class="headerlink" title="7.6 通过文件安装角色"></a>7.6 通过文件安装角色</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Ansible官网：https://docs.ansible.com/ansible/2.9/galaxy/user_guide.html#installing-roles-from-galaxy</span><br><span class="line"></span><br><span class="line">https://galaxy.ansible.com/nginxinc/nginx_core  <span class="comment">#该网站可以查看角色包信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#实验需要在模拟考试环境下做，普通环境没有角色包</span></span><br><span class="line">[greg@control ansible]$ vim roles/requirements.yml  <span class="comment">#制作角色部署文件</span></span><br><span class="line">---</span><br><span class="line">- src: http://materials/phpinfo.tar    <span class="comment">#角色在网络中的路径</span></span><br><span class="line">  name: phpinfo						   <span class="comment">#指定安装在系统中的角色名称</span></span><br><span class="line">- src: http://materials/haproxy.tar</span><br><span class="line">  name: balancer</span><br><span class="line">  </span><br><span class="line">[greg@control ansible]$ ansible-galaxy install --<span class="built_in">help</span></span><br><span class="line">[greg@control ansible]$ ansible-galaxy install -r roles/requirements.yml  <span class="comment">#-r 指定角色文件</span></span><br><span class="line">[greg@control ansible]$ ansible-galaxy list   <span class="comment">#检测</span></span><br><span class="line"><span class="comment"># /home/greg/ansible/roles</span></span><br><span class="line">- phpinfo, (unknown version)    <span class="comment">#查看结果</span></span><br><span class="line">- balancer, (unknown version)</span><br></pre></td></tr></table></figure>

<h1 id="8-对Ansible进行故障排除"><a href="#8-对Ansible进行故障排除" class="headerlink" title="8 对Ansible进行故障排除"></a>8 对Ansible进行故障排除</h1><h2 id="8-1-对playbook进行故障排除"><a href="#8-1-对playbook进行故障排除" class="headerlink" title="8.1 对playbook进行故障排除"></a>8.1 对playbook进行故障排除</h2><h3 id="调试Playbook"><a href="#调试Playbook" class="headerlink" title="调试Playbook"></a>调试Playbook</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-rhel8</span><br><span class="line">ansible-playbook debug.yml -v   <span class="comment">#显示详细信息-v -vv -vvv -vvvv</span></span><br><span class="line"></span><br><span class="line">-rhel9</span><br><span class="line">ansible-navigator run playbook.yml -m stdout -v</span><br></pre></td></tr></table></figure>

<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过debug模块打印收集到的变量信息，帮助管理员了解模块执行过程及结果</span></span><br><span class="line">---</span><br><span class="line">- hosts: serverb</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: vsftpd</span><br><span class="line">      state: latest</span><br><span class="line">    register: web_install   <span class="comment">#注册变量收集模块的执行信息</span></span><br><span class="line">  - ansible.builtin.debug:</span><br><span class="line">      var: web_install      <span class="comment">#debug模块可以帮助打印出执行信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#可以一次性将hostvars收集到的所有魔法及事实变量打印出来，并可以记录到文件中</span></span><br><span class="line">[greg@control ansible]$ vim debug.yml</span><br><span class="line">---</span><br><span class="line">- name: <span class="built_in">test</span></span><br><span class="line">  hosts: node1</span><br><span class="line">  tasks:</span><br><span class="line">  - ansible.builtin.debug:</span><br><span class="line">      var: hostvars</span><br><span class="line">[greg@control ansible]$ ansible-navigator run -m stdout debug.yml &gt; 2.txt </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">关闭事实收集</span><br><span class="line">如果要关闭收集，可以编辑配置文件</span><br><span class="line">gathering = explicit</span><br><span class="line">或者在playbook里</span><br><span class="line">gather_facts: <span class="built_in">yes</span>/no  <span class="literal">true</span>/false</span><br></pre></td></tr></table></figure>

<h3 id="检查-Playbook-中的错误"><a href="#检查-Playbook-中的错误" class="headerlink" title="检查 Playbook 中的错误"></a>检查 Playbook 中的错误</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-RHEL8</span><br><span class="line">$ ansible-playbook playbook.yml --syntax-check</span><br><span class="line">playbook: playbook.yml</span><br><span class="line"></span><br><span class="line">-RHEL9</span><br><span class="line">greg@control ansible]$ ansible-navigator run -m stdout debug.yml   --syntax-check</span><br><span class="line">playbook: /home/greg/ansible/debug.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="检查-Playbook的问题并遵循良好实践"><a href="#检查-Playbook的问题并遵循良好实践" class="headerlink" title="检查 Playbook的问题并遵循良好实践"></a>检查 Playbook的问题并遵循良好实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#常见语法问题</span></span><br><span class="line">name：  冒号后面要空格，内容随意</span><br><span class="line">hosts： all 指定的主机不在清单中，报错无partten</span><br><span class="line">syntax-errors：注意格式缩进，2格缩进</span><br><span class="line">变量设置错误，或调用时错误（变量名写错，变量开头要加双引号）  </span><br><span class="line">when条件： （逻辑判断思路错误，或书写错误）</span><br></pre></td></tr></table></figure>

<h3 id="检查Playbook-工件和日志文件"><a href="#检查Playbook-工件和日志文件" class="headerlink" title="检查Playbook 工件和日志文件"></a>检查Playbook 工件和日志文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-navigator 可以生成 playbook工件，以JSON格式存储与 playbook的运行相关的信息。</span><br><span class="line">您可以将与 playbook运行相关的信息记录到系统上您可写入位置处的文本文件中。</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">RHEL9中的ansible自动开启日志功能，可通过配置文件设置及手工设置</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件</span></span><br><span class="line">$ vim ~/.ansible-navigator.yml</span><br><span class="line">---</span><br><span class="line">ansible-navigator:</span><br><span class="line">  execution-environment:</span><br><span class="line">    image: utility.lab.example.com/ee-supported-rhel8:latest</span><br><span class="line">    pull:</span><br><span class="line">      policy: missing</span><br><span class="line">  playbook-artifact:</span><br><span class="line">    <span class="built_in">enable</span>: <span class="literal">false</span>    <span class="comment"># false/true 关闭/打开</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#手工指定</span></span><br><span class="line">--pae  --playbook-artifact-enable</span><br></pre></td></tr></table></figure>

<h3 id="将输出记录到文本文件"><a href="#将输出记录到文本文件" class="headerlink" title="将输出记录到文本文件"></a>将输出记录到文本文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-RHEL8&amp;9</span><br><span class="line"></span><br><span class="line">Ansible 提供了一个内置日志基础架构，可通过ansible.cfg 配置文件 [defaults] 部分中的log_path参数进行配置，或通过<span class="variable">$ANSIBLE_LOG_PATH</span>环境变量进行配置。在进行上面一项或两项配置后，Ansible会以文本形式将ansible-navigator 命令的输出存储到所配置的日志文件中。此机制也适用于ansible-playbook 等早期的工具。</span><br><span class="line">如果您将Ansible配置为将日志文件写入 /var/log，红帽建议您配置 logrotate来管理文件。</span><br></pre></td></tr></table></figure>

<h2 id="8-2-对Ansible受管主机进行故障排除"><a href="#8-2-对Ansible受管主机进行故障排除" class="headerlink" title="8.2 对Ansible受管主机进行故障排除"></a>8.2 对Ansible受管主机进行故障排除</h2><h3 id="对连接进行故障排除"><a href="#对连接进行故障排除" class="headerlink" title="对连接进行故障排除"></a>对连接进行故障排除</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 远程用户（普通，root）</span><br><span class="line">2 远程密码、特权密码问题</span><br><span class="line">3 账号密码有多种设置方案</span><br></pre></td></tr></table></figure>

<h3 id="使用Ansible运行临时命令"><a href="#使用Ansible运行临时命令" class="headerlink" title="使用Ansible运行临时命令"></a>使用Ansible运行临时命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ad-hoc命令可以用于简单部署场景，比如对一组目标部署一个任务，或检索受管节点的运行情况、状态等。</span><br><span class="line">ansible all -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意RHEL9中默认不允许root用户登录，需要修改配置文件允许root登录。所建议使用普通用户作为远程管理用户。</span></span><br><span class="line">解决方法,服务器端：</span><br><span class="line">$ vim /etc/ssh/sshd_config</span><br><span class="line"><span class="comment">#PermitRootLogin prohibit-password</span></span><br><span class="line">PermitRootLogin <span class="built_in">yes</span></span><br><span class="line">$ systemctl  reload sshd</span><br></pre></td></tr></table></figure>

<h4 id="–step-手动控制执行的步骤"><a href="#–step-手动控制执行的步骤" class="headerlink" title="–step 手动控制执行的步骤"></a>–step 手动控制执行的步骤</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook playbook.yml --step</span><br><span class="line">$ ansible-navigator run playbook.yml  -m stdout --step</span><br><span class="line"></span><br><span class="line">PLAY [PLAY1] ********************************************************************************************</span><br><span class="line">Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue: n</span><br><span class="line"></span><br><span class="line">手动输入n  y c来控制playbook中执行的步骤</span><br><span class="line">n 不执行该步骤</span><br><span class="line">y 执行该步骤</span><br><span class="line">c 继续自动执行到结束</span><br><span class="line"></span><br><span class="line">通过该方法，我们可以让有问题的步骤执行，而无关紧要的步骤可以跳过不执行。达到排错的目的。</span><br></pre></td></tr></table></figure>

<h4 id="–start-at-task-从指定步骤执行任务"><a href="#–start-at-task-从指定步骤执行任务" class="headerlink" title="–start-at-task 从指定步骤执行任务"></a>–start-at-task 从指定步骤执行任务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[greg@control ansible]$ ansible-playbook playbook.yml --start-at-task=<span class="string">&#x27;Start service httpd&#x27;</span></span><br><span class="line"></span><br><span class="line">选项“</span><br><span class="line">--start-at-task    <span class="comment">#指定具体执行步骤，等号后面指定模块的描述，如果描述内容中有空格，建议用单或双引号引起来，表示为一个参数。</span></span><br></pre></td></tr></table></figure>

<h4 id="C-–check-烟雾测试"><a href="#C-–check-烟雾测试" class="headerlink" title="-C –check 烟雾测试"></a>-C –check 烟雾测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">烟雾测试：在管理节点执行剧本，显示剧本的真实执行结果，但是不在受管节点上部署。</span><br><span class="line">$ ansible-playbook playbook.yml --<span class="built_in">help</span> | grep \\-C</span><br><span class="line">$ ansible-navigator run playbook.yml  -m stdout -C</span><br><span class="line">[greg@control ansible]$ vim playbook.yml</span><br><span class="line">---</span><br><span class="line">- name: PLAY1</span><br><span class="line">  hosts: node2</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install  apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: latest</span><br><span class="line">  - name: Copy using inline content</span><br><span class="line">    ansible.builtin.copy:</span><br><span class="line">      content: <span class="string">&#x27;test web page&#x27;</span></span><br><span class="line">      dest: /var/www/html/index.html</span><br><span class="line">  - name: Start service httpd</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: started</span><br><span class="line">  - name: Start service firewalld</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: firewalld</span><br><span class="line">      state: started</span><br><span class="line">  - name: permit apache</span><br><span class="line">    ansible.posix.firewalld:</span><br><span class="line">      service: http</span><br><span class="line">      permanent: <span class="built_in">yes</span></span><br><span class="line">      state: enabled</span><br><span class="line">      immediate: <span class="built_in">yes</span></span><br><span class="line">[greg@control ansible]$ ansible-playbook playbook.yml -C</span><br></pre></td></tr></table></figure>

<h4 id="通过发送脚本解决问题"><a href="#通过发送脚本解决问题" class="headerlink" title="通过发送脚本解决问题"></a>通过发送脚本解决问题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ vim test.sh   <span class="comment">#自定义脚本名及内容</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">date</span></span><br><span class="line">$ vim debug.yml <span class="comment">#剧本名自定义</span></span><br><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  hosts: node1</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Run a script</span><br><span class="line">    ansible.builtin.script: /home/greg/ansible/test.sh    <span class="comment">#使用script模块，加脚本文件路径</span></span><br><span class="line">    register: haha   <span class="comment">#register收集上面模块执行结果至 haha（自定义名称）的这个变量中</span></span><br><span class="line">  - ansible.builtin.debug:</span><br><span class="line">      var: haha   <span class="comment">#通过debug模块将haha变量的值打印出来。</span></span><br><span class="line">$ ansible-playbook debug.yml     </span><br><span class="line"></span><br><span class="line">`如果不想写register，可以执行剧本时添加-v 类似：ansible-playbook debug.yml -v`</span><br></pre></td></tr></table></figure>

<h1 id="9-自动执行Linux管理任务"><a href="#9-自动执行Linux管理任务" class="headerlink" title="9 自动执行Linux管理任务"></a>9 自动执行Linux管理任务</h1><h2 id="9-1-管理软件和订阅"><a href="#9-1-管理软件和订阅" class="headerlink" title="9.1 管理软件和订阅"></a>9.1 管理软件和订阅</h2><h3 id="优化多软件包安装"><a href="#优化多软件包安装" class="headerlink" title="优化多软件包安装"></a>优化多软件包安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">ansible.builtin.---</span><br><span class="line"></span><br><span class="line">- name:</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd   <span class="comment">#httpd</span></span><br><span class="line">      state: latest</span><br><span class="line">  - name: install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: php   <span class="comment">#php</span></span><br><span class="line">      state: latest</span><br><span class="line">---------------------------------------------</span><br><span class="line">- name: install the latest version of Apache</span><br><span class="line">  ansible.builtin.yum:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class="line">      state: latest</span><br><span class="line">  loop:　    <span class="comment">#用loop方式简化playbook</span></span><br><span class="line">    - httpd</span><br><span class="line">    - php</span><br><span class="line">      </span><br><span class="line">yum install -y httpd</span><br><span class="line">yum install -y php</span><br><span class="line">---------------------------------------------</span><br><span class="line">- name: install the latest version of Apache</span><br><span class="line">  ansible.builtin.yum:</span><br><span class="line">    name: </span><br><span class="line">    - httpd</span><br><span class="line">    - php</span><br><span class="line">    state: latest</span><br><span class="line">yum install -y httpd php</span><br><span class="line">--------------------------------------------- </span><br><span class="line">- name: ensure a list of packages installed</span><br><span class="line">  ansible.builtin.yum:</span><br><span class="line">    name: <span class="string">&quot;&#123;&#123; packages &#125;&#125;&quot;</span></span><br><span class="line">  vars:</span><br><span class="line">    packages:</span><br><span class="line">    - httpd</span><br><span class="line">    - httpd-tools</span><br><span class="line">--------------------------------------------- </span><br><span class="line">      </span><br><span class="line">等同于：yum install -y httpd php</span><br><span class="line">或</span><br><span class="line">loop的这种方式，系统会执行两次独立事务，对每个事务应用一个软件包</span><br><span class="line"></span><br><span class="line">yum模块：</span><br><span class="line"></span><br><span class="line">state： absent删除, installed,  present确保安装  latest升级到最新版本</span><br><span class="line">latest 等同  yum update</span><br><span class="line"></span><br><span class="line">yum remove  yum install </span><br><span class="line"></span><br><span class="line"> name： <span class="string">&#x27;*&#x27;</span>  代表所有软件包</span><br><span class="line"> name: <span class="string">&quot;@RPM Development tools&quot;</span>   ansible命令里面安装包组要加@</span><br></pre></td></tr></table></figure>

<h3 id="收集有关已安装软件包的事实"><a href="#收集有关已安装软件包的事实" class="headerlink" title="收集有关已安装软件包的事实"></a>收集有关已安装软件包的事实</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  hosts: node1</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Gather the package facts</span><br><span class="line">    ansible.builtin.package_facts:</span><br><span class="line">      manager: auto</span><br><span class="line"></span><br><span class="line">  <span class="comment">#- name: Print the package facts</span></span><br><span class="line">  <span class="comment">#  ansible.builtin.debug:</span></span><br><span class="line">  <span class="comment">#    var: ansible_facts.packages</span></span><br><span class="line"></span><br><span class="line">  - name: Check whether a package called foobar is installed</span><br><span class="line">    ansible.builtin.debug:</span><br><span class="line">      msg: <span class="string">&quot;&#123;&#123; ansible_facts.packages.zip.0.version &#125;&#125;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="查看用于管理软件包的其他模块"><a href="#查看用于管理软件包的其他模块" class="headerlink" title="查看用于管理软件包的其他模块"></a>查看用于管理软件包的其他模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: Install httpd on RHEL 8 and 9</span><br><span class="line">  ansible.builtin.dnf</span><br><span class="line">    name: httpd</span><br><span class="line">    state: present</span><br><span class="line"></span><br><span class="line">- name: Install httpd on RHEL 7 and earlier</span><br><span class="line">  ansible.builtin.yum:</span><br><span class="line">    name:httpd</span><br><span class="line">    state:present</span><br></pre></td></tr></table></figure>

<h3 id="配置RPM软件包存储库"><a href="#配置RPM软件包存储库" class="headerlink" title="配置RPM软件包存储库"></a>配置RPM软件包存储库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-doc -l | grep yum</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  hosts: node1</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Add multiple repositories into the same file (1/2)</span><br><span class="line">    ansible.builtin.yum_repository:</span><br><span class="line">      name: EX294_BASE <span class="comment">#file字段不存在时，默认用name字段代替源文件名称</span></span><br><span class="line">      description: EX294 base software</span><br><span class="line">      file: rhel  <span class="comment">#file选项作用是定义yum源文件名称，无该字段时会用name字段后的值代替文件名 例如：rhel.repo</span></span><br><span class="line">      baseurl: http://content/rhel8.4/x86_64/dvd/BaseOS</span><br><span class="line">      gpgcheck: <span class="built_in">yes</span></span><br><span class="line">      gpgkey: http://content/rhel8.4/x86_64/dvd/RPM-GPG-KEY-redhat-release</span><br><span class="line">      enabled: <span class="built_in">yes</span></span><br><span class="line">      </span><br><span class="line">  - name: Add multiple repositories into the same file (1/2)</span><br><span class="line">    ansible.builtin.yum_repository:</span><br><span class="line">      name: EX294_STREAM</span><br><span class="line">      description: EX294 stream software</span><br><span class="line">      file: rhel  <span class="comment">#多个模块使用同一个file字段的名称时，会将源地址写入到同一个文件中。</span></span><br><span class="line">      baseurl: http://content/rhel8.4/x86_64/dvd/AppStream</span><br><span class="line">      gpgcheck: <span class="built_in">yes</span></span><br><span class="line">      gpgkey: http://content/rhel8.4/x86_64/dvd/RPM-GPG-KEY-redhat-release</span><br><span class="line">      enabled: <span class="built_in">yes</span>  <span class="comment">#enabled默认值为yes，考试时要写该选项。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ansible模块选项和vim配置文件内容对比</span><br><span class="line">  vim：                ansible：</span><br><span class="line">      rhel.repo          file</span><br><span class="line">      [rhel]            * name</span><br><span class="line">      name=rhel         * description</span><br><span class="line">      baseurl=			* baseurl</span><br><span class="line">      gpgcheck=			* gpgcheck</span><br><span class="line">      gpgeky=			* gpgkey</span><br><span class="line">      enabled=			* enabled</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">测试方法：</span><br><span class="line">$ ansible all -a <span class="string">&#x27;yum repolist all&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 受管节点检测</span></span><br><span class="line">$ <span class="built_in">cat</span> rhel.repo</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-doc rpm_key   </span><br><span class="line">- ansible.builtin.rpm_key:</span><br><span class="line">    state: present</span><br><span class="line">    key: http://apt.sw.be/RPM-GPG-KEY.dag.txt</span><br></pre></td></tr></table></figure>

<h2 id="9-2-管理用户和身份验证"><a href="#9-2-管理用户和身份验证" class="headerlink" title="9.2 管理用户和身份验证"></a>9.2 管理用户和身份验证</h2><h3 id="user-模块"><a href="#user-模块" class="headerlink" title="user 模块"></a>user 模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">需求:在servera上创建用户tom 附加组为group1，并设置密码为password tom: tom123用sha512方式哈希，uid =2000</span><br><span class="line">user这个模块类似这些功能： useradd userdel usermod</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> group.yml     </span><br><span class="line">- name:</span><br><span class="line">  hosts: node1</span><br><span class="line">  vars:</span><br><span class="line">  - passwordtom: tom123</span><br><span class="line">  tasks:</span><br><span class="line">  - name:  create group</span><br><span class="line">    ansible.builtin.group:</span><br><span class="line">      name: <span class="string">&quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class="line">    loop:</span><br><span class="line">      - group1</span><br><span class="line">      - group2</span><br><span class="line">  - name: Add the</span><br><span class="line">    ansible.builtin.user:</span><br><span class="line">      name: tom            <span class="comment">#useradd tom</span></span><br><span class="line">      comment: student     <span class="comment">#useradd -c student</span></span><br><span class="line">      uid: 2000            <span class="comment">#useradd -u 2000</span></span><br><span class="line">      password_expire_max: 10     <span class="comment">#passwd -e 10</span></span><br><span class="line">      group: group1             <span class="comment">#useradd -g group1</span></span><br><span class="line">      <span class="built_in">groups</span>: group1,group2     <span class="comment">#-G group1,group2</span></span><br><span class="line">      shell: /bin/bash          <span class="comment">#-s /bin/bash</span></span><br><span class="line">      password: <span class="string">&quot;&#123;&#123; passwordtom | password_hash(&#x27;sha512&#x27;) &#125;&#125;&quot;</span>    passwd tom</span><br><span class="line">      <span class="comment">#passwordtom该密码位置如果是字符串用单引号引起来，如果是变量则不需要单引号</span></span><br><span class="line">      </span><br><span class="line">          </span><br><span class="line"><span class="comment">#验证用户密码过期时间</span></span><br><span class="line">chage -l tom</span><br><span class="line">Password expires					: Jun 11, 2024</span><br><span class="line"><span class="comment">#验证用户密码是否正确，可以从node2登录node1，测试node1上的tom用户</span></span><br><span class="line">ssh tom@node1</span><br><span class="line"></span><br><span class="line">Ansible网页搜索：password_hash--Using filter--网页中查找password_hash，查看密码哈希方式，一定注意是512</span><br><span class="line">Ansible官网：  https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html</span><br><span class="line">      模块中：append: <span class="built_in">yes</span>    如果想额外添加附加群组，此选项需要<span class="built_in">yes</span>(usermod -a -G  grouptest u1) </span><br></pre></td></tr></table></figure>

<h3 id="group模块"><a href="#group模块" class="headerlink" title="group模块"></a>group模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[greg@bastion ansible]$ <span class="built_in">cat</span> group.yml </span><br><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  hosts: dev</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Ensure group <span class="string">&quot;grouptest&quot;</span> exists</span><br><span class="line">    ansible.builtin.group:</span><br><span class="line">      gid: 10000</span><br><span class="line">      name: grouptest</span><br><span class="line">      state: present | absent   <span class="comment">#创建|删除 二选一</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">等同于：groupadd  grouptest</span><br><span class="line">等同于：groupadd -g 10000 grouptest</span><br><span class="line">groupdel</span><br></pre></td></tr></table></figure>

<h2 id="9-3-管理启动过程和调度进程"><a href="#9-3-管理启动过程和调度进程" class="headerlink" title="9.3 管理启动过程和调度进程"></a>9.3 管理启动过程和调度进程</h2><h3 id="at"><a href="#at" class="headerlink" title="at"></a>at</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Schedule</span> <span class="string">a</span> <span class="string">command</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">in</span> <span class="number">20</span> <span class="string">minutes</span> <span class="string">as</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">ansible.posix.at:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">ls</span> <span class="string">-d</span> <span class="string">/</span> <span class="string">&gt;/dev/null</span></span><br><span class="line">      <span class="attr">count:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">units:</span> <span class="string">minutes</span></span><br><span class="line"></span><br><span class="line"><span class="string">默认是创建一个任务，给root，删除的</span>	<span class="string">话使用选项state：absent</span></span><br></pre></td></tr></table></figure>

<h3 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[greg@bastion ansible]$ ansible-doc cron</span><br><span class="line">[greg@bastion ansible]$ <span class="built_in">cat</span> cron.yml </span><br><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Ensure a job that runs at 2 and 5 exists. </span><br><span class="line">    ansible.builtin.cron:</span><br><span class="line">      name: <span class="string">&quot;check dirs&quot;</span>  <span class="comment">#描述  </span></span><br><span class="line">      minute: <span class="string">&quot;*/2&quot;</span>		  <span class="comment">#分钟</span></span><br><span class="line">      hour: <span class="string">&quot;2,5&quot;</span>         <span class="comment">#小时</span></span><br><span class="line">      day: 1-10           <span class="comment">#天</span></span><br><span class="line">      user: harry</span><br><span class="line">      job: <span class="string">&quot;ls -alh &gt; /dev/null&quot;</span></span><br><span class="line">     </span><br><span class="line">[greg@bastion ansible]$ ansible dev -m shell -a <span class="string">&#x27;crontab -u harry -l&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rh134课程练习内容</span></span><br><span class="line">指令： conrtab -u harry -e</span><br><span class="line">1、每年2月2日上午9点执行<span class="built_in">echo</span> hello任务</span><br><span class="line">0	9	2	2    <span class="built_in">echo</span> hello</span><br><span class="line">2、七月每周5的,9点至下午5点，每5分钟执行<span class="built_in">echo</span> hi</span><br><span class="line">*/5	9-17  *	7	5</span><br></pre></td></tr></table></figure>

<h3 id="管理服务"><a href="#管理服务" class="headerlink" title="管理服务"></a>管理服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name:</span><br><span class="line">  hosts: dev</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install the latest version of Apache</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: latest</span><br><span class="line">          </span><br><span class="line">  - name: Start service httpd, <span class="keyword">if</span> not started</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: started</span><br><span class="line">      enabled: <span class="built_in">yes</span>    <span class="comment">#开机自启动</span></span><br><span class="line">~            </span><br><span class="line"></span><br><span class="line">service restart network</span><br></pre></td></tr></table></figure>

<h3 id="systemd"><a href="#systemd" class="headerlink" title="systemd"></a>systemd</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">greg@bastion</span> <span class="string">ansible</span>]<span class="string">$</span> <span class="string">cat</span> <span class="string">systemd.yml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span> <span class="string">of</span> <span class="string">Apache</span></span><br><span class="line">    <span class="attr">ansible.builtin.yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Make</span> <span class="string">sure</span> <span class="string">a</span> <span class="string">service</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">    <span class="attr">ansible.builtin.systemd:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      </span><br><span class="line"><span class="string">测试命令：</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">dev</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;systemctl status httpd&#x27;</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">dev</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;systemctl is-enabled httpd&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-reboot"><a href="#1-reboot" class="headerlink" title="1.reboot"></a>1.reboot</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: Unconditionally reboot the machine with all defaults</span><br><span class="line">  reboot:</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-command-shell-支持更多的特殊字符"><a href="#2-command-shell-支持更多的特殊字符" class="headerlink" title="2.command &amp; shell  支持更多的特殊字符"></a>2.command &amp; shell  支持更多的特殊字符</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ansible servera -m <span class="built_in">command</span> -a <span class="string">&#x27;useradd user1&#x27;</span></span><br><span class="line">$ ansible servera -a <span class="string">&#x27;useradd user2&#x27;</span></span><br><span class="line">$ ansible servera -a <span class="string">&#x27;echo 123456 | passwd --stdin user1&#x27;</span></span><br><span class="line">$ ansible servera -m shell -a <span class="string">&#x27;echo 123456 | passwd --stdin user1&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="9-4-管理存储"><a href="#9-4-管理存储" class="headerlink" title="9.4 管理存储"></a>9.4 管理存储</h2><table>
<thead>
<tr>
<th>模块名</th>
<th>linux指令</th>
<th>Linux实施命令</th>
</tr>
</thead>
<tbody><tr>
<td>community.general.parted</td>
<td>parted</td>
<td>parted &#x2F;dev&#x2F;vdb mkpart part1 2048s 1G</td>
</tr>
<tr>
<td>community.general.lvg</td>
<td>vgcreate</td>
<td>vgcreate -s 16M vg100 &#x2F;dev&#x2F;vdb{1..2}</td>
</tr>
<tr>
<td>community.general.lvol</td>
<td>lvcreate</td>
<td>lvcreate -L 100M -n lv100 vg100</td>
</tr>
<tr>
<td>community.general.filesystem</td>
<td>mkfs</td>
<td>mkfs.ext4 &#x2F;dev&#x2F;vg100&#x2F;lv100</td>
</tr>
<tr>
<td>ansible.posix.mount</td>
<td>&#x2F;etc&#x2F;fstab</td>
<td>echo “&#x2F;dev&#x2F;vg100&#x2F;lv100 ext4 &#x2F;mnt&#x2F;data defaults 0 0” &gt; &#x2F;etc&#x2F;fstab</td>
</tr>
</tbody></table>
<h3 id="通过模块管理存储"><a href="#通过模块管理存储" class="headerlink" title="通过模块管理存储"></a>通过模块管理存储</h3><h4 id="1-纯分区无lvm逻辑卷"><a href="#1-纯分区无lvm逻辑卷" class="headerlink" title="1.纯分区无lvm逻辑卷"></a>1.纯分区无lvm逻辑卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.分区-格式化-挂载</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1-1 分区 community.general.parted   <span class="comment">#先确保community.general集合已经安装，可通过ansibl-galaxy collection list来查看</span></span><br><span class="line"><span class="comment">#创建两个分区每个500M</span></span><br><span class="line">---</span><br><span class="line">- name: parted</span><br><span class="line">  hosts: node2</span><br><span class="line">  tasks:</span><br><span class="line">  - name: part 1 2048s-500M</span><br><span class="line">    community.general.parted:</span><br><span class="line">      device: /dev/vdc</span><br><span class="line">      number: 1</span><br><span class="line">      state: present</span><br><span class="line">      part_end: 500MiB</span><br><span class="line">  - name: part 2 500M-1000M</span><br><span class="line">    community.general.parted:</span><br><span class="line">      device: /dev/vdc</span><br><span class="line">      number: 2</span><br><span class="line">      state: present</span><br><span class="line">      part_start: 500MiB</span><br><span class="line">      part_end: 1GiB</span><br><span class="line"></span><br><span class="line">1-2 格式化 community.general.filesystem</span><br><span class="line"><span class="comment">#两个分区都格式化为ext4文件系统，如果选择不同文件系统，可以分成两个模块。</span></span><br><span class="line">  - name: Create a ext4</span><br><span class="line">    community.general.filesystem:</span><br><span class="line">      fstype: ext4</span><br><span class="line">      dev: <span class="string">&quot;&#123;&#123; item &#125;&#125;&quot;</span> </span><br><span class="line">    loop:</span><br><span class="line">      - /dev/vdc1</span><br><span class="line">      - /dev/vdc2</span><br><span class="line"></span><br><span class="line">1-3 挂载 ansible.posix.mount</span><br><span class="line"><span class="comment">#自动创建挂载点/mnt/part1,再将/dev/vdc1写入/etc/fstab文件最后一行，并挂载。</span></span><br><span class="line">  - name: Mount DVD read-only</span><br><span class="line">    ansible.posix.mount:</span><br><span class="line">      path: /mnt/part1      <span class="comment">#挂载点</span></span><br><span class="line">      src: /dev/vdc1	    <span class="comment">#设备</span></span><br><span class="line">      fstype: ext4		    <span class="comment">#文件系统类型</span></span><br><span class="line">      state: mounted		<span class="comment">#参考下面解释</span></span><br><span class="line">      </span><br><span class="line">-挂载选项解释：</span><br><span class="line"><span class="comment">#absent:     卸载并删除/etc/fstab内容  </span></span><br><span class="line"><span class="comment">#unmounted： 卸载不删除/etc/fstab内容</span></span><br><span class="line"><span class="comment">#present：   将挂在信息写入/etc/fstab，不挂载</span></span><br><span class="line"><span class="comment">#mounted：   将挂在信息写入/etc/fstab，并创建挂载点及挂载</span></span><br><span class="line"><span class="comment">#remounted： 重新挂载</span></span><br></pre></td></tr></table></figure>

<h4 id="2-有lvm逻辑卷实验"><a href="#2-有lvm逻辑卷实验" class="headerlink" title="2.有lvm逻辑卷实验"></a>2.有lvm逻辑卷实验</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">2.分区-lvm（pv,vg,lv）-格式化-挂载</span><br><span class="line">2-1 分区 community.general.parted </span><br><span class="line"><span class="comment">#分两个区每个大约500M，/dev/vdb</span></span><br><span class="line">---</span><br><span class="line">- name: lv</span><br><span class="line">  hosts: node2</span><br><span class="line">  tasks:</span><br><span class="line">  - name: part 1 2048s-500M</span><br><span class="line">    community.general.parted:</span><br><span class="line">      device: /dev/vdb</span><br><span class="line">      number: 1</span><br><span class="line">      state: present</span><br><span class="line">      part_end: 500MiB</span><br><span class="line">  - name: part 2 500M-1000M</span><br><span class="line">    community.general.parted:</span><br><span class="line">      device: /dev/vdb</span><br><span class="line">      number: 2</span><br><span class="line">      state: present</span><br><span class="line">      part_start: 500MiB</span><br><span class="line"></span><br><span class="line">2-2 pv+vg community.general.vg</span><br><span class="line"><span class="comment">#两个分区都加入vg，名称vg100</span></span><br><span class="line"><span class="comment">#ansible-navigator collections -m stdout | grep vg$ 查看帮助</span></span><br><span class="line">  - name: Create a volume group vg100</span><br><span class="line">    community.general.lvg:</span><br><span class="line">      vg: vg100</span><br><span class="line">      pvs: /dev/vdb1,/dev/vdb2</span><br><span class="line">      pesize: 32</span><br><span class="line"></span><br><span class="line">2-3 lv community.general.lvol</span><br><span class="line"><span class="comment">#创建一个lv名为lv100，大小800M</span></span><br><span class="line">  - name: Create a logical volume lv100 size 800M</span><br><span class="line">    community.general.lvol:</span><br><span class="line">      vg: vg100</span><br><span class="line">      lv: lv100</span><br><span class="line">      size: 800</span><br><span class="line">2-4 格式化 community.general.filesystem</span><br><span class="line"><span class="comment">#格式化为xfs文件系统</span></span><br><span class="line"> - name: Create a xfs</span><br><span class="line">    community.general.filesystem:</span><br><span class="line">      fstype: xfs</span><br><span class="line">      dev: /dev/vg100/lv100</span><br><span class="line">2-5 挂载 ansible.posix.mount</span><br><span class="line"><span class="comment">#lv挂载到/mnt/data，并设置为开机自启动。</span></span><br><span class="line">  - name: /mnt/data</span><br><span class="line">    ansible.posix.mount:</span><br><span class="line">      path: /mnt/data</span><br><span class="line">      src: /dev/vg100/lv100</span><br><span class="line">      fstype: xfs</span><br><span class="line">      state: mounted</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line"><span class="comment">#整体配置</span></span><br><span class="line">---</span><br><span class="line">- name: lv</span><br><span class="line">  hosts: node2</span><br><span class="line">  tasks:</span><br><span class="line">  - name: part 1 2048s-500M</span><br><span class="line">    community.general.parted:</span><br><span class="line">      device: /dev/vdb</span><br><span class="line">      number: 1</span><br><span class="line">      state: present</span><br><span class="line">      part_end: 500MiB</span><br><span class="line">  - name: part 2 500M-1000M</span><br><span class="line">    community.general.parted:</span><br><span class="line">      device: /dev/vdb</span><br><span class="line">      number: 2</span><br><span class="line">      state: present</span><br><span class="line">      part_start: 500MiB</span><br><span class="line">  - name: Create a volume group vg100</span><br><span class="line">    community.general.lvg:</span><br><span class="line">      vg: vg100</span><br><span class="line">      pvs: /dev/vdb1,/dev/vdb2</span><br><span class="line">      pesize: 32</span><br><span class="line">  - name: Create a logical volume lv100 size 800M</span><br><span class="line">    community.general.lvol:</span><br><span class="line">      vg: vg100</span><br><span class="line">      lv: lv100</span><br><span class="line">      size: 800</span><br><span class="line">  - name: Create a xfs</span><br><span class="line">    community.general.filesystem:</span><br><span class="line">      fstype: xfs</span><br><span class="line">      dev: /dev/vg100/lv100</span><br><span class="line">  - name: /mnt/data</span><br><span class="line">    ansible.posix.mount:</span><br><span class="line">      path: /mnt/data</span><br><span class="line">      src: /dev/vg100/lv100</span><br><span class="line">      fstype: xfs</span><br><span class="line">      state: mounted</span><br><span class="line"></span><br><span class="line"><span class="comment">#搜索帮助总结</span></span><br><span class="line">nsible-navigator --<span class="built_in">help</span></span><br><span class="line">ansible-navigator collections -m stdout | grep parted$</span><br><span class="line">ansible-navigator collections -m stdout | grep lvg$</span><br><span class="line">ansible-navigator collections -m stdout | grep lvol$</span><br><span class="line">ansible-navigator collections -m stdout | grep filesystem$</span><br><span class="line">ansible-navigator collections -m stdout | grep mount$</span><br><span class="line">ansible all -m shell -a <span class="string">&#x27;lsblk&#x27;</span></span><br><span class="line"></span><br><span class="line">ansible-navigator doc -m stdout community.general.parted</span><br><span class="line">ansible-navigator doc -m stdout community.general.filesystem</span><br><span class="line">ansible-navigator doc -m stdout ansible.posix.mount</span><br><span class="line">ansible-navigator doc -m stdout community.general.lvg</span><br></pre></td></tr></table></figure>

<h3 id="通过系统角色管理存储"><a href="#通过系统角色管理存储" class="headerlink" title="通过系统角色管理存储"></a>通过系统角色管理存储</h3><h4 id="1-磁盘管理角色"><a href="#1-磁盘管理角色" class="headerlink" title="1.磁盘管理角色"></a>1.磁盘管理角色</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当前版本测试失败，暂时不做</span><br></pre></td></tr></table></figure>

<h4 id="2-逻辑卷角色"><a href="#2-逻辑卷角色" class="headerlink" title="2.逻辑卷角色"></a>2.逻辑卷角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[greg@control ansible]$ <span class="built_in">sudo</span> find ./mycollection/ -name <span class="string">&#x27;*.yml&#x27;</span> | grep storage|grep test.yml</span><br><span class="line">./mycollection/ansible_collections/redhat/rhel_system_roles/tests/storage/test.yml</span><br><span class="line">[greg@control ansible]$ <span class="built_in">cp</span> ./mycollection/ansible_collections/redhat/rhel_system_roles/tests/storage/test.yml ./storage.yml</span><br><span class="line">[greg@control ansible]$ vim disk.yml</span><br><span class="line">$ vim storage.yml</span><br><span class="line">---</span><br><span class="line">- hosts: node4</span><br><span class="line">  vars:</span><br><span class="line">    storage_use_partitions: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">    - name: redhat.rhel_system_roles.storage</span><br><span class="line">      storage_pools:</span><br><span class="line">        - name: vg100</span><br><span class="line">          disks:</span><br><span class="line">          - /dev/vdb</span><br><span class="line">          volumes:</span><br><span class="line">            - name: lv100</span><br><span class="line">              size: 200M</span><br><span class="line">              fs_type: ext4</span><br><span class="line">              mount_point: <span class="string">&#x27;/mnt/lvm100&#x27;</span></span><br><span class="line">              state: <span class="string">&quot;present&quot;</span></span><br><span class="line">            - name: lv200</span><br><span class="line">              size: 300M</span><br><span class="line">              fs_type: xfs</span><br><span class="line">              mount_point: <span class="string">&#x27;/mnt/lvm200&#x27;</span></span><br><span class="line">              state: <span class="string">&quot;absent&quot;</span></span><br><span class="line"></span><br><span class="line">$ ansible-navigator run storage.yml  -m stdout</span><br></pre></td></tr></table></figure>

<h2 id="9-5-管理网络"><a href="#9-5-管理网络" class="headerlink" title="9.5 管理网络"></a>9.5 管理网络</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[greg@control ansible]$ <span class="built_in">sudo</span> find ./mycollection/ -name <span class="string">&#x27;*.md&#x27;</span> | grep network</span><br><span class="line">[greg@control ansible]$ vim ./mycollection/ansible_collections/redhat/rhel_system_roles/roles/network/README.md</span><br><span class="line">[greg@control ansible]$ <span class="built_in">sudo</span> find ./mycollection/ -name <span class="string">&#x27;*.yml&#x27;</span> | grep network </span><br><span class="line"></span><br><span class="line">$ vim /usr/share/doc/rhel-system-roles/collection/roles/network/README.md</span><br><span class="line">$ vim playbook.yml</span><br><span class="line">---</span><br><span class="line">- hosts: node5</span><br><span class="line">  vars:</span><br><span class="line">    network_connections:</span><br><span class="line">    - name: eth0</span><br><span class="line">      interface_name: eth0</span><br><span class="line">      <span class="built_in">type</span>: ethernet</span><br><span class="line">      state: up</span><br><span class="line">      autoconnect: <span class="built_in">yes</span></span><br><span class="line">      ip:</span><br><span class="line">        address:</span><br><span class="line">        - 192.0.2.3/24</span><br><span class="line">        dns:</span><br><span class="line">        - 192.0.2.2</span><br><span class="line">        dns_search:</span><br><span class="line">        - example.com</span><br><span class="line">        dhcp4: no</span><br><span class="line">        gateway4: 192.0.2.1</span><br><span class="line">        auto6: no</span><br><span class="line"></span><br><span class="line">  roles:</span><br><span class="line">    - redhat.rhel_system_roles.network</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ansible-navigator run playbook.yml  -m stdout</span><br></pre></td></tr></table></figure>

<h1 id="附加："><a href="#附加：" class="headerlink" title="附加："></a>附加：</h1><h2 id="使用普通用户远程管理受管主机"><a href="#使用普通用户远程管理受管主机" class="headerlink" title="使用普通用户远程管理受管主机"></a>使用普通用户远程管理受管主机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">【超级用户远程管理方式】</span><br><span class="line">vim /home/greg/ansible/ansible.cfg</span><br><span class="line">remote_user=root</span><br><span class="line">host_key_checking = False</span><br><span class="line"></span><br><span class="line">vim /home/greg/ansible/inventory</span><br><span class="line">[all:vars]</span><br><span class="line"><span class="comment">#ansible_user=root</span></span><br><span class="line">ansible_password=redhat</span><br><span class="line"></span><br><span class="line">【普通用户远程管理方式】</span><br><span class="line">需求，请使用greg用户远程管理受管主机</span><br><span class="line">【bastion】控制节点</span><br><span class="line">ansible.cfg</span><br><span class="line">[defaults]</span><br><span class="line">remote_user = greg</span><br><span class="line">host_key_checking = False</span><br><span class="line"></span><br><span class="line">[privilege_escalation]</span><br><span class="line">become=True</span><br><span class="line">become_method=<span class="built_in">sudo</span> </span><br><span class="line">become_user=root</span><br><span class="line">become_ask_pass=<span class="literal">false</span></span><br><span class="line">----------------------------------------以下配置考试环境下已做</span><br><span class="line">管理节点</span><br><span class="line">ssh-keygen </span><br><span class="line">三个回车</span><br><span class="line">ssh-copy-id greg@workstation</span><br><span class="line">ssh greg@workstation</span><br><span class="line"></span><br><span class="line">其他受管主机上每一个主机都做如下操作</span><br><span class="line">[root@workstation ~]# useradd  greg</span><br><span class="line">[root@workstation ~]# <span class="built_in">echo</span> redhat | passwd --stdin greg</span><br><span class="line">[root@workstation ~]# visudo</span><br><span class="line">greg    ALL=(ALL)       NOPASSWD: ALL</span><br></pre></td></tr></table></figure>

</div><div class="recommend-area"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2025/04/15/Linux%E5%9F%BA%E7%A1%80/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Linux基本使用</span></a></div></nav><!--!--><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="罗宇"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">罗宇</p><p class="is-size-6 is-block">用开放的思维，解决封闭的问题</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国-四川-成都</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives/"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories/"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags/"><p class="title">3</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://luovip.github.io" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo官网</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://mirrors.nju.edu.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">南京大学镜像站</span></span><span class="level-right"><span class="level-item tag">mirrors.nju.edu.cn</span></span></a></li><li><a class="level is-mobile" href="https://developer.aliyun.com/mirror/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">阿里云镜像站</span></span><span class="level-right"><span class="level-item tag">developer.aliyun.com</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2025/04/15/podman%E5%AE%B9%E5%99%A8/"><img src="/img/podman.jpg" alt="podman容器"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-04-15T05:50:42.000Z">2025-04-15</time></p><p class="title"><a href="/2025/04/15/podman%E5%AE%B9%E5%99%A8/">podman容器</a></p><p class="categories"><a href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/">容器技术</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/04/15/Linux%E5%9F%BA%E7%A1%80/"><img src="/img/Linux.png" alt="Linux基本使用"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-04-15T05:50:42.000Z">2025-04-15</time></p><p class="title"><a href="/2025/04/15/Linux%E5%9F%BA%E7%A1%80/">Linux基本使用</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/04/15/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"><img src="/img/ansible-cover.jpg" alt="Ansible的基本使用"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-04-15T05:50:42.000Z">2025-04-15</time></p><p class="title"><a href="/2025/04/15/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/">Ansible的基本使用</a></p><p class="categories"><a href="/categories/Ansible/">Ansible</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/"><span class="level-start"><span class="level-item">容器技术</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/04/"><span class="level-start"><span class="level-item">四月 2025</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/podman%E5%AE%B9%E5%99%A8/"><span class="tag">podman容器</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="墨香笔记@技术博客" height="28"></a><p class="size-small"><span>&copy; 2025 罗宇</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">川ICP备88888888号</a><br></span><span>© 版权说明:本网站所有内容均自己创作,方便用于技术交流和日常总结!<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2025/04/17 00:00:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(false){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('undefined','undefined','undefined','undefined',undefined);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>